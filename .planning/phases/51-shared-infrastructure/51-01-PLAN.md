---
phase: 51-shared-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/floating/index.ts
  - packages/core/package.json
  - packages/core/vite.config.ts
autonomous: true

must_haves:
  truths:
    - "Importing from '@lit-ui/core/floating' provides computePosition, autoUpdatePosition, flip, shift, offset, arrow, and size"
    - "computePosition uses composed-offset-position ponyfill so positioning is correct inside nested Shadow DOM"
    - "autoUpdatePosition returns a cleanup function for use in disconnectedCallback"
    - "The floating entry point builds successfully and produces dist/floating/index.js + dist/floating/index.d.ts"
  artifacts:
    - path: "packages/core/src/floating/index.ts"
      provides: "Shadow DOM-safe Floating UI wrapper"
      exports: ["computePosition", "autoUpdatePosition", "flip", "shift", "offset", "arrow", "size", "Placement", "MiddlewareData"]
    - path: "packages/core/package.json"
      provides: "Export map with ./floating entry"
      contains: "./floating"
    - path: "packages/core/vite.config.ts"
      provides: "Build entry for floating/index"
      contains: "floating/index"
  key_links:
    - from: "packages/core/src/floating/index.ts"
      to: "@floating-ui/dom"
      via: "import and re-export with Shadow DOM platform override"
      pattern: "composed-offset-position"
    - from: "packages/core/package.json"
      to: "packages/core/src/floating/index.ts"
      via: "exports map ./floating entry"
      pattern: "./floating"
---

<objective>
Create the `@lit-ui/core/floating` entry point that wraps `@floating-ui/dom` with a Shadow DOM-safe platform configuration using `composed-offset-position`.

Purpose: Tooltip and Popover (Phases 52-53) need element-anchored positioning that works correctly inside nested Shadow DOM trees. This centralizes the Floating UI + Shadow DOM fix so downstream components just import from `@lit-ui/core/floating`.

Output: A new `floating/index.ts` module in core that exports `computePosition`, `autoUpdatePosition`, and all needed middleware, plus updated package.json exports and vite build config.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/51-shared-infrastructure/51-RESEARCH.md

@packages/core/src/tokens/index.ts
@packages/core/package.json
@packages/core/vite.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create floating utility module</name>
  <files>
    packages/core/package.json
    packages/core/src/floating/index.ts
  </files>
  <action>
1. Install `@floating-ui/dom` and `composed-offset-position` as regular dependencies of `@lit-ui/core`:
   ```bash
   pnpm add -F @lit-ui/core @floating-ui/dom composed-offset-position
   ```

2. Create `packages/core/src/floating/index.ts` with:
   - Import `computePosition` (aliased as `_computePosition`), `autoUpdate` (aliased as `_autoUpdate`), `platform`, and types from `@floating-ui/dom`
   - Import `offsetParent` from `composed-offset-position`
   - Create `shadowDomPlatform` object that spreads `platform` and overrides `getOffsetParent` to use `platform.getOffsetParent(element, offsetParent)` -- this is the 3-line Shadow DOM fix
   - Export `computePosition` function that wraps `_computePosition` with `platform: shadowDomPlatform` injected into config
   - Export `autoUpdatePosition` function that wraps `_autoUpdate` and returns the cleanup function
   - Re-export middleware: `flip`, `shift`, `offset`, `arrow`, `size` from `@floating-ui/dom`
   - Re-export types: `Placement`, `MiddlewareData` from `@floating-ui/dom`
   - Follow the exact code pattern from 51-RESEARCH.md Pattern 1 (lines 67-123)

Do NOT externalize `@floating-ui/dom` or `composed-offset-position` in rollup -- they should be bundled into the floating entry point output.
  </action>
  <verify>
    - `cat packages/core/package.json | grep -A2 '"@floating-ui/dom"'` shows the dependency
    - `cat packages/core/package.json | grep -A2 '"composed-offset-position"'` shows the dependency
    - `cat packages/core/src/floating/index.ts` shows the module with all exports
  </verify>
  <done>
    - `@floating-ui/dom` and `composed-offset-position` are in core's dependencies
    - `floating/index.ts` exports computePosition, autoUpdatePosition, flip, shift, offset, arrow, size, Placement, MiddlewareData
    - The shadowDomPlatform uses composed-offset-position's offsetParent
  </done>
</task>

<task type="auto">
  <name>Task 2: Add floating export to package.json and vite build config</name>
  <files>
    packages/core/package.json
    packages/core/vite.config.ts
  </files>
  <action>
1. Add `./floating` export to `packages/core/package.json` exports map (after the `.` entry):
   ```json
   "./floating": {
     "types": "./dist/floating/index.d.ts",
     "import": "./dist/floating/index.js"
   }
   ```

2. Add `floating/index` build entry to `packages/core/vite.config.ts` lib.entry object:
   ```typescript
   entry: {
     index: 'src/index.ts',
     'floating/index': 'src/floating/index.ts',
     'tokens/index': 'src/tokens/index.ts',
     'utils/index': 'src/utils/index.ts',
   },
   ```

3. In `vite.config.ts` rollupOptions.external, do NOT add `@floating-ui/dom` or `composed-offset-position` to the external list. They should be bundled into the floating output. The existing externals (`lit`, `/^lit\//`, `/^@lit\//`, `/^@lit-ui\//`) are correct as-is. However, verify that `@floating-ui/dom` does NOT match `/^@lit-ui\//` (it doesn't -- different prefix).

4. Build core to verify everything compiles:
   ```bash
   pnpm --filter @lit-ui/core build
   ```

5. Verify outputs exist:
   ```bash
   ls packages/core/dist/floating/index.js packages/core/dist/floating/index.d.ts
   ```
  </action>
  <verify>
    - `pnpm --filter @lit-ui/core build` completes without errors
    - `ls packages/core/dist/floating/` shows `index.js` and `index.d.ts`
    - `grep "computePosition" packages/core/dist/floating/index.js` confirms the export is bundled
    - `grep "./floating" packages/core/package.json` confirms the export map entry
  </verify>
  <done>
    - Core builds successfully with the new floating entry point
    - `dist/floating/index.js` and `dist/floating/index.d.ts` exist
    - The package.json exports map includes `./floating`
    - `@floating-ui/dom` and `composed-offset-position` are bundled (not external) in the floating output
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @lit-ui/core build` passes without errors
2. `packages/core/dist/floating/index.js` exists and contains `computePosition`
3. `packages/core/dist/floating/index.d.ts` exists and exports types
4. `packages/core/package.json` has `./floating` in exports
5. No existing tests break: `pnpm test` (if tests exist)
</verification>

<success_criteria>
- `@lit-ui/core/floating` is a valid import path that provides computePosition, autoUpdatePosition, flip, shift, offset, arrow, size
- The computePosition wrapper applies the composed-offset-position Shadow DOM platform fix
- Core package builds successfully with the new entry point
</success_criteria>

<output>
After completion, create `.planning/phases/51-shared-infrastructure/51-01-SUMMARY.md`
</output>
