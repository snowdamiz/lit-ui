---
phase: 45-date-picker-advanced
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/date-picker/src/natural-language.ts
  - packages/date-picker/src/natural-language.test.ts
  - packages/date-picker/src/date-input-parser.ts
  - packages/date-picker/src/date-input-parser.test.ts
autonomous: true

must_haves:
  truths:
    - "Typing 'today' in the date input resolves to the current date"
    - "Typing 'tomorrow' resolves to the next day"
    - "Typing 'next week' resolves to the start of next week (Monday)"
    - "Typing 'yesterday' resolves to the previous day"
    - "Natural language parsing is case-insensitive and whitespace-tolerant"
    - "Non-matching text falls through to format-based parsing unchanged"
  artifacts:
    - path: "packages/date-picker/src/natural-language.ts"
      provides: "Dictionary-based natural language date parser"
      exports: ["parseNaturalLanguage"]
    - path: "packages/date-picker/src/natural-language.test.ts"
      provides: "Test coverage for NL parsing"
      min_lines: 40
  key_links:
    - from: "packages/date-picker/src/date-input-parser.ts"
      to: "packages/date-picker/src/natural-language.ts"
      via: "import parseNaturalLanguage, called before format-based parsing"
      pattern: "parseNaturalLanguage"
---

<objective>
Create a dictionary-based natural language date parser that resolves common English phrases ("today", "tomorrow", "yesterday", "next week") to Date objects using date-fns functions. Integrate it into the existing parseDateInput pipeline so NL phrases are tried before format-based parsing.

Purpose: Satisfies DP-20 (natural language parsing accepts "tomorrow", "next week", "today"). This is a TDD candidate because it has clear inputs (string phrases) and outputs (Date objects).
Output: natural-language.ts with parseNaturalLanguage(), updated date-input-parser.ts, and comprehensive tests.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@packages/date-picker/src/date-input-parser.ts
</context>

<feature>
  <name>Natural Language Date Parser</name>
  <files>
    packages/date-picker/src/natural-language.ts
    packages/date-picker/src/natural-language.test.ts
    packages/date-picker/src/date-input-parser.ts
    packages/date-picker/src/date-input-parser.test.ts
  </files>
  <behavior>
    Dictionary-based parser that maps English phrases to date-fns resolvers:

    Input -> Expected Output:
    - "today" -> startOfDay(new Date())
    - "Tomorrow" -> addDays(startOfDay(new Date()), 1)
    - "YESTERDAY" -> addDays(startOfDay(new Date()), -1)
    - "next week" -> startOfWeek(addWeeks(new Date(), 1), { weekStartsOn: 1 })
    - "  Next  Week  " -> same as "next week" (whitespace normalization)
    - "random text" -> null (no match, falls through)
    - "" -> null

    Integration with parseDateInput:
    - parseDateInput("tomorrow", "en-US") should return tomorrow's date
    - parseDateInput("01/31/2026", "en-US") should still work (format parsing unchanged)

    Implementation details:
    - Create `natural-language.ts` with:
      - `type NLResolver = () => Date;`
      - `NL_PHRASES: Record<string, NLResolver>` dictionary mapping normalized phrases to resolver functions
      - `parseNaturalLanguage(input: string): Date | null` that normalizes input (trim, lowercase, collapse whitespace) and looks up in dictionary
    - Use date-fns imports: `addDays`, `addWeeks`, `startOfWeek`, `startOfDay` (all already available in the project)
    - Each resolver is a function `() => Date` called at evaluation time (NOT at import time) to avoid SSR date issues
    - Update `parseDateInput` in `date-input-parser.ts` to call `parseNaturalLanguage(trimmed)` BEFORE the format loop, returning early if it matches
    - The existing tests for format-based parsing in date-input-parser.test.ts must continue to pass

    For the test file, use Vitest (`describe`, `it`, `expect`) matching the project test setup.
    Mock `new Date()` with `vi.useFakeTimers()` set to a known date (2026-01-31) so tests are deterministic.
  </behavior>
  <implementation>
    RED phase:
    1. Create natural-language.test.ts with tests for all phrases (today, tomorrow, yesterday, next week), case insensitivity, whitespace normalization, and null returns for non-matches
    2. Create date-input-parser.test.ts additions testing that parseDateInput("tomorrow") returns a valid date
    3. Run tests - they MUST fail (modules don't exist yet)

    GREEN phase:
    1. Create natural-language.ts with NL_PHRASES dictionary and parseNaturalLanguage function
    2. Update date-input-parser.ts: add `import { parseNaturalLanguage } from './natural-language.js';` and call it at the top of parseDateInput before the format loop
    3. Run tests - they MUST pass

    REFACTOR (if needed):
    1. Clean up any redundancy
    2. Ensure all tests still pass
  </implementation>
</feature>

<verification>
```bash
cd packages/date-picker && npx vitest run --reporter=verbose
```
- All natural-language.test.ts tests pass
- All date-input-parser.test.ts tests pass (both new NL tests and existing format tests)
- No TypeScript errors: `npx tsc --noEmit`
</verification>

<success_criteria>
- parseNaturalLanguage("today") returns today's date
- parseNaturalLanguage("tomorrow") returns tomorrow's date
- parseNaturalLanguage("yesterday") returns yesterday's date
- parseNaturalLanguage("next week") returns start of next week (Monday)
- parseDateInput("tomorrow", "en-US") integrates NL parsing before format parsing
- parseDateInput("01/31/2026", "en-US") still works (no regression)
- All tests pass with deterministic dates via fake timers
</success_criteria>

<output>
After completion, create `.planning/phases/45-date-picker-advanced/45-01-SUMMARY.md`
</output>
