---
phase: 94-candlestick-chart
plan: 02
type: execute
wave: 2
depends_on: [94-01]
files_modified:
  - packages/charts/src/candlestick/candlestick-chart.ts
  - packages/charts/src/index.ts
autonomous: true
requirements: [CNDL-01, CNDL-02, CNDL-03, CNDL-04]

must_haves:
  truths:
    - "Developer can set bull-color and bear-color attributes on lui-candlestick-chart and see correctly colored candlestick bars"
    - "Developer can set show-volume attribute and see a volume bar panel on a secondary axis below the main chart"
    - "Developer can set moving-averages JSON attribute and see SMA/EMA overlay lines computed from OHLC close prices"
    - "Developer can call pushData({ label, ohlc, volume }) on a candlestick chart and see the chart extend in real time"
    - "LuiCandlestickChart and its types are importable from @lit-ui/charts"
  artifacts:
    - path: "packages/charts/src/candlestick/candlestick-chart.ts"
      provides: "LuiCandlestickChart Lit custom element (lui-candlestick-chart)"
      exports: [LuiCandlestickChart]
    - path: "packages/charts/src/index.ts"
      provides: "Phase 94 public API exports"
      contains: "LuiCandlestickChart"
  key_links:
    - from: "packages/charts/src/candlestick/candlestick-chart.ts"
      to: "packages/charts/src/candlestick/candlestick-registry.ts"
      via: "_registerModules() calls registerCandlestickModules()"
      pattern: "registerCandlestickModules"
    - from: "packages/charts/src/candlestick/candlestick-chart.ts"
      to: "packages/charts/src/shared/candlestick-option-builder.ts"
      via: "_applyData() and _flushBarUpdates() call buildCandlestickOption(this._ohlcBuffer, ...)"
      pattern: "buildCandlestickOption.*_ohlcBuffer"
    - from: "packages/charts/src/index.ts"
      to: "packages/charts/src/candlestick/candlestick-chart.ts"
      via: "export { LuiCandlestickChart }"
      pattern: "LuiCandlestickChart"
---

<objective>
Create LuiCandlestickChart Lit custom element (lui-candlestick-chart) extending BaseChartElement, with pushData() override for multi-series streaming, and add Phase 94 exports to index.ts.

Purpose: Delivers the user-facing candlestick chart component that exercises all four CNDL requirements — OHLC rendering with bull/bear colors, volume panel, MA overlays, and real-time bar streaming.

Output: candlestick-chart.ts (LuiCandlestickChart component) and updated index.ts with Phase 94 public API exports.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/94-candlestick-chart/94-RESEARCH.md
@.planning/phases/93-heatmap-chart/93-02-SUMMARY.md
@.planning/phases/94-candlestick-chart/94-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->
<!-- Plan 01 created these — use them directly. No codebase exploration needed. -->

From packages/charts/src/shared/candlestick-option-builder.ts (created in Plan 01):
```typescript
export type OhlcBar = [number, number, number, number]; // [open, close, low, high]

export type MAConfig = {
  period: number;
  color: string;
  type?: 'sma' | 'ema';
};

export type CandlestickBarPoint = {
  label: string;
  ohlc: OhlcBar;
  volume?: number;
};

export type CandlestickOptionProps = {
  bullColor?: string;
  bearColor?: string;
  showVolume?: boolean;
  movingAverages?: MAConfig[];
};

export function buildCandlestickOption(
  bars: CandlestickBarPoint[],
  props: CandlestickOptionProps
): Record<string, unknown>;
```

From packages/charts/src/candlestick/candlestick-registry.ts (created in Plan 01):
```typescript
export async function registerCandlestickModules(): Promise<void>;
```

From packages/charts/src/heatmap/heatmap-chart.ts (direct model to mirror):
```typescript
// Pattern: own RAF handle + pushData() override + disconnectedCallback() RAF cancel
export class LuiHeatmapChart extends BaseChartElement {
  private _cellRafId?: number;

  override pushData(point: unknown): void {
    // NEVER calls super.pushData()
    // Uses own RAF: _cellRafId = requestAnimationFrame(() => { this._flushCellUpdates(); ... })
  }

  override disconnectedCallback(): void {
    if (this._cellRafId !== undefined) {
      cancelAnimationFrame(this._cellRafId);
      this._cellRafId = undefined;
    }
    super.disconnectedCallback(); // base disposes chart AFTER our RAF is cancelled
  }
}
```

From packages/charts/src/base/base-chart-element.ts (public API available to subclass):
```typescript
export abstract class BaseChartElement extends TailwindElement {
  @property({ attribute: false }) option?: EChartsCoreOption;
  @property({ attribute: false }) data?: unknown;
  @property({ type: Boolean }) loading = false;
  @property({ type: Boolean, attribute: 'enable-gl' }) enableGl = false;
  @property({ type: Number }) maxPoints = 1000;

  protected _chart?: EChartsType;  // undefined until _initChart() completes (SSR safe)

  protected abstract _registerModules(): Promise<void>;

  override updated(changed: PropertyValues): void; // handles option passthrough + loading state
  override disconnectedCallback(): void;           // disposes chart + observers
}
```

From packages/charts/src/index.ts (current tail — append Phase 94 after Phase 93 block):
```typescript
// Phase 93: Heatmap Chart
export { LuiHeatmapChart } from './heatmap/heatmap-chart.js';
export type { HeatmapCell, HeatmapOptionProps } from './shared/heatmap-option-builder.js';

// Phase 94: Candlestick Chart   <-- append here
export { LuiCandlestickChart } from './candlestick/candlestick-chart.js';
export type { OhlcBar, MAConfig, CandlestickBarPoint, CandlestickOptionProps } from './shared/candlestick-option-builder.js';
```

Key property declaration patterns (from project decisions in STATE.md):
- Single string color: `@property({ attribute: 'bull-color' }) bullColor: string | null = null` — no type converter; use `bullColor ?? '#default'` at call site
- Boolean prop: `@property({ type: Boolean, attribute: 'show-volume' }) showVolume = false`
- JSON string prop: `@property({ attribute: 'moving-averages' }) movingAverages: string | null = null` — no type converter; parse in module-level `_parseMovingAverages()` helper
- Array/object props: `@property({ attribute: false })` — cannot serialize as HTML attributes (project convention)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create candlestick-chart.ts</name>
  <files>packages/charts/src/candlestick/candlestick-chart.ts</files>
  <action>
Create `packages/charts/src/candlestick/candlestick-chart.ts` implementing `LuiCandlestickChart` extending `BaseChartElement`.

**File header comment** — document all CNDL requirements and STRM-04 compliance (pushData fully overridden, base path bypassed, _streamingMode irrelevant).

**Module-level helper (NOT exported):**
```typescript
function _parseMovingAverages(raw: string | null): MAConfig[] {
  if (!raw) return [];
  try {
    const parsed = JSON.parse(raw);
    return Array.isArray(parsed) ? parsed : [];
  } catch {
    return [];
  }
}
```

**Class `LuiCandlestickChart extends BaseChartElement`:**

Properties (declare in this order):
- `@property({ attribute: 'bull-color' }) bullColor: string | null = null`
- `@property({ attribute: 'bear-color' }) bearColor: string | null = null`
- `@property({ type: Boolean, attribute: 'show-volume' }) showVolume = false`
- `@property({ attribute: 'moving-averages' }) movingAverages: string | null = null`

Private fields:
- `private _ohlcBuffer: CandlestickBarPoint[] = []` — authoritative OHLC bar store; synced from `this.data` in `_applyData()`; appended to by `pushData()`
- `private _barRafId?: number` — component's own RAF handle; MUST be cancelled in `disconnectedCallback()` before `super.disconnectedCallback()`

Methods:

1. `protected override async _registerModules(): Promise<void>` — calls `await registerCandlestickModules()`

2. `override updated(changed: PropertyValues): void` — call `super.updated(changed)` first (base handles option prop passthrough and loading state). Then: if `this._chart` is falsy, return. Watch `['data', 'bullColor', 'bearColor', 'showVolume', 'movingAverages']` — if any changed, call `this._applyData()`.

3. `private _applyData(): void` — if `!this._chart` return. Sync `_ohlcBuffer` from `this.data`: `this._ohlcBuffer = this.data ? [...(this.data as CandlestickBarPoint[])] : []`. Build option: `buildCandlestickOption(this._ohlcBuffer, { bullColor: this.bullColor ?? undefined, bearColor: this.bearColor ?? undefined, showVolume: this.showVolume, movingAverages: _parseMovingAverages(this.movingAverages) })`. Call `this._chart.setOption(option, { notMerge: false })`.

4. `override pushData(point: unknown): void` — NEVER call `super.pushData()`. Cast: `const bar = point as CandlestickBarPoint`. Append to `_ohlcBuffer`, then trim to `this.maxPoints`: `if (this._ohlcBuffer.length > this.maxPoints) { this._ohlcBuffer = this._ohlcBuffer.slice(-this.maxPoints); }`. Schedule flush via own RAF: `if (this._barRafId === undefined) { this._barRafId = requestAnimationFrame(() => { this._flushBarUpdates(); this._barRafId = undefined; }); }`.

5. `private _flushBarUpdates(): void` — if `!this._chart || this._ohlcBuffer.length === 0` return. Build option with `buildCandlestickOption(this._ohlcBuffer, { ... })` using same props as `_applyData()`. Call `this._chart.setOption(option, { lazyUpdate: true } as object)`. Note: `lazyUpdate: true` (not `notMerge: false`) for streaming flush — preserves DataZoom state while batching the update to next render cycle.

6. `override disconnectedCallback(): void` — cancel `_barRafId` BEFORE calling `super.disconnectedCallback()`. Pattern: `if (this._barRafId !== undefined) { cancelAnimationFrame(this._barRafId); this._barRafId = undefined; } super.disconnectedCallback();`

**Custom element registration** (after class, same guard pattern as all other chart components):
```typescript
if (typeof customElements !== 'undefined' && !customElements.get('lui-candlestick-chart')) {
  customElements.define('lui-candlestick-chart', LuiCandlestickChart);
}

declare global {
  interface HTMLElementTagNameMap {
    'lui-candlestick-chart': LuiCandlestickChart;
  }
}
```

Run `npx tsc --noEmit -p packages/charts/tsconfig.json` — zero errors required.
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components && npx tsc --noEmit -p packages/charts/tsconfig.json 2>&1 | head -30</automated>
  </verify>
  <done>packages/charts/src/candlestick/candlestick-chart.ts exists; LuiCandlestickChart exported; lui-candlestick-chart registered as custom element; TypeScript compiles with zero errors</done>
</task>

<task type="auto">
  <name>Task 2: Add Phase 94 exports to index.ts</name>
  <files>packages/charts/src/index.ts</files>
  <action>
Append the Phase 94 export block to the end of `packages/charts/src/index.ts`, after the existing Phase 93 exports:

```typescript
// Phase 94: Candlestick Chart
export { LuiCandlestickChart } from './candlestick/candlestick-chart.js';
export type { OhlcBar, MAConfig, CandlestickBarPoint, CandlestickOptionProps } from './shared/candlestick-option-builder.js';
```

After editing, run the full build to confirm zero errors and that the new exports appear in the dist type declarations:

```bash
cd packages/charts && npm run build
```

Then verify the dist output contains the new declarations:
```bash
grep "LuiCandlestickChart\|OhlcBar\|CandlestickBarPoint" packages/charts/dist/index.d.ts
```
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components/packages/charts && npm run build 2>&1 | tail -10 && grep "LuiCandlestickChart\|OhlcBar\|CandlestickBarPoint" dist/index.d.ts</automated>
  </verify>
  <done>index.ts exports LuiCandlestickChart and all four Phase 94 types; full build passes; dist/index.d.ts contains LuiCandlestickChart, OhlcBar, CandlestickBarPoint declarations</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npx tsc --noEmit -p packages/charts/tsconfig.json` — zero errors
2. `cd packages/charts && npm run build` — build passes, reports built dist
3. `grep "LuiCandlestickChart\|OhlcBar\|MAConfig\|CandlestickBarPoint\|CandlestickOptionProps" packages/charts/dist/index.d.ts` — all five names present
4. `grep "_barRafId\|cancelAnimationFrame\|super.disconnectedCallback" packages/charts/src/candlestick/candlestick-chart.ts` — confirms RAF cancellation pattern
5. `grep "super.pushData" packages/charts/src/candlestick/candlestick-chart.ts` — must return NO matches (NEVER calls super.pushData)
</verification>

<success_criteria>
- LuiCandlestickChart (lui-candlestick-chart) custom element registered and exported
- All four CNDL properties declared: bull-color, bear-color, show-volume, moving-averages
- pushData() override: never calls super.pushData(); uses _barRafId RAF handle; trims to maxPoints
- _flushBarUpdates(): calls buildCandlestickOption(_ohlcBuffer, ...) with lazyUpdate: true
- disconnectedCallback(): cancels _barRafId before super.disconnectedCallback()
- _applyData(): syncs _ohlcBuffer from this.data, calls buildCandlestickOption, setOption notMerge:false
- index.ts exports LuiCandlestickChart + OhlcBar + MAConfig + CandlestickBarPoint + CandlestickOptionProps
- Full build: zero errors, dist/index.d.ts contains all Phase 94 declarations
</success_criteria>

<output>
After completion, create `.planning/phases/94-candlestick-chart/94-02-SUMMARY.md`
</output>
