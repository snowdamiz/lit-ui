---
phase: 89-line-chart-area-chart
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/charts/src/shared/line-option-builder.ts
  - packages/charts/src/line/line-registry.ts
  - packages/charts/src/line/line-chart.ts
autonomous: true
requirements: [LINE-01, LINE-02, LINE-03]

must_haves:
  truths:
    - "Developer can pass a `data` prop with one or more named series and see a multi-series line chart render"
    - "Developer can set `smooth`, `zoom`, and `markLines` props and see curve interpolation, drag-to-zoom, and threshold mark lines"
    - "Developer can call `pushData(point)` on a line chart and see the series extend in real time without a full re-render flash"
  artifacts:
    - path: "packages/charts/src/shared/line-option-builder.ts"
      provides: "Pure buildLineOption() helper and LineChartSeries/MarkLineSpec/LineOptionProps types"
      exports: ["buildLineOption", "LineChartSeries", "MarkLineSpec", "LineOptionProps"]
    - path: "packages/charts/src/line/line-registry.ts"
      provides: "registerLineModules() — registers LineChart ECharts module exactly once via _lineRegistered guard"
      exports: ["registerLineModules"]
    - path: "packages/charts/src/line/line-chart.ts"
      provides: "LuiLineChart Lit custom element extending BaseChartElement"
      exports: ["LuiLineChart"]
  key_links:
    - from: "packages/charts/src/line/line-chart.ts"
      to: "packages/charts/src/shared/line-option-builder.ts"
      via: "import { buildLineOption, LineChartSeries, MarkLineSpec }"
      pattern: "buildLineOption"
    - from: "packages/charts/src/line/line-chart.ts"
      to: "packages/charts/src/line/line-registry.ts"
      via: "_registerModules() calls registerLineModules()"
      pattern: "registerLineModules"
    - from: "packages/charts/src/line/line-chart.ts"
      to: "packages/charts/src/base/base-chart-element.ts"
      via: "extends BaseChartElement"
      pattern: "extends BaseChartElement"
---

<objective>
Create the shared line/area option builder, per-chart ECharts module registry, and the LuiLineChart Lit component — covering all three LINE requirements.

Purpose: Establish the shared infrastructure (option builder + registry) that both line and area charts depend on, then ship the first concrete chart component.
Output: `line-option-builder.ts`, `line-registry.ts`, `line-chart.ts` — LuiLineChart ready for use as `<lui-line-chart>`.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/89-line-chart-area-chart/89-RESEARCH.md
@.planning/phases/88-package-foundation-basechartelement/88-03-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from Phase 88 codebase. -->
<!-- Executor should use these directly — no codebase exploration needed. -->

From packages/charts/src/base/base-chart-element.ts:
```typescript
export abstract class BaseChartElement extends TailwindElement {
  @property({ attribute: false }) option?: EChartsCoreOption;
  @property({ attribute: false }) data?: unknown;
  @property({ type: Boolean }) loading = false;
  @property({ type: Boolean, attribute: 'enable-gl' }) enableGl = false;
  @property({ type: Number }) maxPoints = 1000;

  protected _chart: EChartsType | null = null;
  protected _streamingMode: 'appendData' | 'buffer' = 'buffer';

  protected abstract _registerModules(): Promise<void>;

  getChart(): EChartsType | undefined;
  pushData(point: unknown): void;  // RAF-coalesced; routes to appendData or buffer per _streamingMode

  // Lifecycle hooks concrete classes may override:
  override updated(changed: PropertyValues): void; // base handles 'option' and 'loading' changes
}
// _flushPendingData() internally calls: appendData({ seriesIndex: 0, data: points }) for 'appendData' mode
```

From packages/charts/src/registry/canvas-core.ts:
```typescript
export async function registerCanvasCore(): Promise<void>;
// Registers: CanvasRenderer, TitleComponent, TooltipComponent, GridComponent,
// LegendComponent, DataZoomComponent, MarkLineComponent, MarkAreaComponent,
// ToolboxComponent, LabelLayout, UniversalTransition
// Guard: _registered module-level flag — safe to call from multiple chart instances
```

From packages/charts/src/index.ts (current exports):
```typescript
export { BaseChartElement } from './base/base-chart-element.js';
export { ThemeBridge } from './base/theme-bridge.js';
export { registerCanvasCore } from './registry/canvas-core.js';
export type { EChartsOption } from './base/base-chart-element.js';
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared line-option-builder.ts</name>
  <files>packages/charts/src/shared/line-option-builder.ts</files>
  <action>
Create `packages/charts/src/shared/line-option-builder.ts` with the following exact exports. This is the single source of truth for line/area ECharts option construction — shared by both LuiLineChart and LuiAreaChart.

```typescript
// packages/charts/src/shared/line-option-builder.ts

export type LineChartSeries = {
  name: string;
  data: (number | [number | string, number] | null)[];
};

export type MarkLineSpec = {
  value: number;
  label?: string;
  color?: string;
};

export type LineOptionProps = {
  smooth?: boolean | number;
  zoom?: boolean;
  markLines?: MarkLineSpec[];
  stacked?: boolean;   // area chart only — ignored in 'line' mode
  opacity?: number;    // area chart only — default 0.6
};

export function buildLineOption(
  series: LineChartSeries[],
  props: LineOptionProps,
  mode: 'line' | 'area'
): Record<string, unknown> {
  const isArea = mode === 'area';

  const echartsSeriesArray = series.map((s, i) => ({
    name: s.name,
    type: 'line' as const,
    data: s.data,
    smooth: props.smooth ?? false,
    // Area mode: add areaStyle with semi-transparency for readability
    areaStyle: isArea ? { opacity: props.opacity ?? 0.6 } : undefined,
    // Stacking: all series share the same group string — boolean true would NOT work (ECharts pitfall)
    stack: isArea && props.stacked ? 'total' : undefined,
    // markLine only on the first series to prevent duplicate threshold lines per series
    markLine:
      i === 0 && props.markLines?.length
        ? {
            silent: false,
            data: props.markLines.map((ml) => ({
              yAxis: ml.value,
              name: ml.label ?? '',
              lineStyle: ml.color ? { color: ml.color } : undefined,
            })),
          }
        : undefined,
  }));

  const option: Record<string, unknown> = {
    legend: { show: series.length > 1 },
    tooltip: { trigger: 'axis' },
    xAxis: { type: 'category', boundaryGap: false },
    yAxis: { type: 'value' },
    series: echartsSeriesArray,
  };

  if (props.zoom) {
    option['dataZoom'] = [
      { type: 'inside', xAxisIndex: 0 },
      { type: 'slider', xAxisIndex: 0, bottom: 0 },
    ];
  }

  return option;
}
```

Key correctness notes:
- `stack` MUST be a string ('total'), never boolean — boolean values do NOT activate ECharts stacking
- `markLine` on index 0 only — prevents duplicate mark lines when multiple series are present
- `areaStyle.opacity: 0.6` default — prevents lower series being hidden behind upper ones in stacked mode
- `xAxis.type: 'category'` is correct for static data prop; streaming via pushData uses the base appendData path which appends raw values
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components && npx tsc --noEmit -p packages/charts/tsconfig.json 2>&1 | head -30</automated>
  </verify>
  <done>File exists at packages/charts/src/shared/line-option-builder.ts with all four exports (LineChartSeries, MarkLineSpec, LineOptionProps, buildLineOption). TypeScript compiles without errors for this file.</done>
</task>

<task type="auto">
  <name>Task 2: Create line-registry.ts and line-chart.ts (LuiLineChart)</name>
  <files>
    packages/charts/src/line/line-registry.ts
    packages/charts/src/line/line-chart.ts
  </files>
  <action>
Create two files in the new `packages/charts/src/line/` directory.

**File 1: packages/charts/src/line/line-registry.ts**

```typescript
/**
 * Line chart ECharts module registry.
 *
 * Called by LuiLineChart._registerModules() and LuiAreaChart._registerModules().
 * Area charts use the same LineChart ECharts module — ECharts has no separate AreaChart type.
 *
 * _lineRegistered guard prevents double-registration when multiple line/area chart
 * instances are on the same page. registerCanvasCore() has its own guard, so calling
 * it here and from area-chart.ts is safe.
 */

let _lineRegistered = false;

export async function registerLineModules(): Promise<void> {
  if (_lineRegistered) return;
  _lineRegistered = true;

  // registerCanvasCore() is always called first — it registers CanvasRenderer + shared components.
  // Its own _registered guard makes double-call safe from area-chart.ts.
  const { registerCanvasCore } = await import('../registry/canvas-core.js');
  await registerCanvasCore();

  const [{ LineChart }, { use }] = await Promise.all([
    import('echarts/charts'),
    import('echarts/core'),
  ]);

  use([LineChart]);
}
```

**File 2: packages/charts/src/line/line-chart.ts**

```typescript
/**
 * LuiLineChart — Line chart component extending BaseChartElement.
 *
 * LINE-01: Multi-series line chart via `data` prop (array of { name, data[] })
 * LINE-02: smooth, zoom, markLines props for curve interpolation, zoom/pan, threshold lines
 * LINE-03: Real-time streaming via inherited pushData() + appendData path
 *
 * CRITICAL-03 compliance: setOption is called ONLY in _applyData() which is only safe
 * before any appendData streaming has started. After pushData() begins, prop changes
 * to smooth/zoom/markLines will reset the chart (dispose + reinit).
 */

import { property } from 'lit/decorators.js';
import type { PropertyValues } from 'lit';
import { BaseChartElement } from '../base/base-chart-element.js';
import { registerLineModules } from './line-registry.js';
import {
  buildLineOption,
  type LineChartSeries,
  type MarkLineSpec,
} from '../shared/line-option-builder.js';

export class LuiLineChart extends BaseChartElement {
  constructor() {
    super();
    // STRM-04: Line chart uses native appendData path for real-time streaming.
    // Base class defaults to 'buffer'; override here per REQUIREMENTS.md STRM-04.
    this._streamingMode = 'appendData';
  }

  // LINE-02: Smooth Catmull-Rom spline interpolation
  @property({ type: Boolean }) smooth = false;

  // LINE-02: DataZoom inside (mouse wheel) + slider (scrubber) — already registered in canvas-core
  @property({ type: Boolean }) zoom = false;

  // LINE-02: Threshold mark lines — { value, label?, color? }[]
  // attribute: false — prevents lossy JSON.parse; set via JS property only
  @property({ attribute: false }) markLines?: MarkLineSpec[];

  protected override async _registerModules(): Promise<void> {
    await registerLineModules();
  }

  override updated(changed: PropertyValues): void {
    super.updated(changed); // base handles this.option and this.loading
    if (!this._chart) return;
    const lineProps = ['data', 'smooth', 'zoom', 'markLines'] as const;
    if (lineProps.some((k) => changed.has(k))) {
      this._applyData();
    }
  }

  private _applyData(): void {
    if (!this._chart || !this.data) return;
    const option = buildLineOption(
      this.data as LineChartSeries[],
      { smooth: this.smooth, zoom: this.zoom, markLines: this.markLines },
      'line'
    );
    // CRITICAL-03: Only call setOption before streaming starts (before first pushData call).
    // After appendData has run, setOption would wipe streamed data.
    this._chart.setOption(option, { notMerge: false });
  }
}

// Custom element registration — same guard pattern as all other @lit-ui packages
if (typeof customElements !== 'undefined' && !customElements.get('lui-line-chart')) {
  customElements.define('lui-line-chart', LuiLineChart);
}

declare global {
  interface HTMLElementTagNameMap {
    'lui-line-chart': LuiLineChart;
  }
}
```

Important implementation notes:
- `_streamingMode = 'appendData'` is set in the constructor (not `_registerModules`) — base class `pushData()` checks this field before modules are loaded, so constructor assignment is the correct location
- `super.updated(changed)` is called first — base class handles `this.option` passthrough and `this.loading` state
- `markLines` uses `attribute: false` to avoid JSON.parse on prop — must be set via JS property, not HTML attribute
- The `data` prop is typed `unknown` in the base class; the cast `as LineChartSeries[]` in `_applyData()` is intentional (consumer responsibility to provide correct shape)
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components && npx tsc --noEmit -p packages/charts/tsconfig.json 2>&1 | head -40 && pnpm --filter @lit-ui/charts build 2>&1 | tail -10</automated>
  </verify>
  <done>
    - `packages/charts/src/line/line-registry.ts` exists and exports `registerLineModules`
    - `packages/charts/src/line/line-chart.ts` exists, exports `LuiLineChart`, registers `lui-line-chart` custom element
    - TypeScript compiles without errors
    - `pnpm build` in packages/charts succeeds (dist/index.js updated)
  </done>
</task>

</tasks>

<verification>
Run the full build to confirm all three new files compile and the package builds cleanly:

```bash
cd /Users/sn0w/Documents/dev/lit-components && pnpm --filter @lit-ui/charts build
```

Expected: Zero TypeScript errors, dist/index.js produced. The build should not be significantly larger than Phase 88's 11.6 kB base since LuiLineChart is not yet exported from index.ts (that happens in Plan 02).
</verification>

<success_criteria>
- `packages/charts/src/shared/line-option-builder.ts` exists with `buildLineOption`, `LineChartSeries`, `MarkLineSpec`, `LineOptionProps` exports
- `packages/charts/src/line/line-registry.ts` exists with `registerLineModules` export and `_lineRegistered` guard
- `packages/charts/src/line/line-chart.ts` exists, exports `LuiLineChart`, defines `lui-line-chart` custom element
- `_streamingMode = 'appendData'` set in LuiLineChart constructor
- `smooth`, `zoom`, `markLines` props present on LuiLineChart
- TypeScript compiles cleanly (zero errors)
- `pnpm build` in packages/charts succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/89-line-chart-area-chart/89-01-SUMMARY.md`
</output>
