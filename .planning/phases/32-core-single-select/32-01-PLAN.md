---
phase: 32-core-single-select
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/select/src/option.ts
  - packages/select/src/select.ts
  - packages/select/src/index.ts
autonomous: true

must_haves:
  truths:
    - "User clicks select trigger and dropdown opens"
    - "User sees options rendered in the listbox"
    - "User clicks option and selection appears in trigger"
    - "User clicks outside and dropdown closes"
  artifacts:
    - path: "packages/select/src/option.ts"
      provides: "lui-option component with value, label, disabled props"
      exports: ["Option", "OptionElement"]
    - path: "packages/select/src/select.ts"
      provides: "Select component with dropdown, options property, click handling"
      contains: "role=\"listbox\""
    - path: "packages/select/src/index.ts"
      provides: "lui-option registration and exports"
  key_links:
    - from: "packages/select/src/select.ts"
      to: "packages/select/src/option.ts"
      via: "Options property and rendering"
      pattern: "SelectOption\\[\\]"
---

<objective>
Implement dropdown infrastructure with lui-option component, listbox rendering, and click-to-select functionality.

Purpose: Enable users to see options and make selections via mouse click - the foundational interaction pattern.
Output: Working dropdown that opens on click, shows options, allows selection, and closes on outside click.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-core-single-select/32-RESEARCH.md
@.planning/phases/31-select-infrastructure/31-02-SUMMARY.md
@packages/select/src/select.ts
@packages/select/src/index.ts
@packages/input/src/input.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lui-option component</name>
  <files>packages/select/src/option.ts</files>
  <action>
Create the Option component class in packages/select/src/option.ts:

```typescript
/**
 * lui-option - An option within a lui-select component
 */
import { html, css } from 'lit';
import { property } from 'lit/decorators.js';
import { TailwindElement, tailwindBaseStyles } from '@lit-ui/core';

export class Option extends TailwindElement {
  @property({ type: String }) value = '';
  @property({ type: String }) label = '';
  @property({ type: Boolean, reflect: true }) disabled = false;
  @property({ type: Boolean, reflect: true }) selected = false;

  // Unique ID for aria-activedescendant
  private optionId = `lui-option-${Math.random().toString(36).substr(2, 9)}`;

  static override styles = [
    ...tailwindBaseStyles,
    css`
      :host {
        display: block;
      }

      :host([disabled]) {
        pointer-events: none;
      }

      .option {
        display: flex;
        align-items: center;
        padding: var(--ui-select-option-padding-y, 0.5rem) var(--ui-select-option-padding-x, 0.75rem);
        cursor: pointer;
        color: var(--ui-select-option-text);
        background-color: transparent;
        transition: background-color 150ms;
      }

      .option:hover:not(.option-disabled) {
        background-color: var(--ui-select-option-bg-hover);
      }

      .option-active {
        background-color: var(--ui-select-option-bg-active);
      }

      .option-selected {
        color: var(--ui-select-option-text-selected);
        font-weight: 500;
      }

      .option-disabled {
        color: var(--ui-select-option-text-disabled);
        cursor: not-allowed;
        opacity: 0.5;
      }

      .check-icon {
        width: 1em;
        height: 1em;
        margin-right: 0.5rem;
        color: var(--ui-select-option-check);
        visibility: hidden;
      }

      .option-selected .check-icon {
        visibility: visible;
      }
    `,
  ];

  getId(): string {
    return this.optionId;
  }

  override render() {
    const classes = ['option'];
    if (this.disabled) classes.push('option-disabled');
    if (this.selected) classes.push('option-selected');

    return html`
      <div
        id=${this.optionId}
        role="option"
        aria-selected=${this.selected ? 'true' : 'false'}
        aria-disabled=${this.disabled ? 'true' : 'false'}
        class=${classes.join(' ')}
      >
        <svg class="check-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" aria-hidden="true">
          <path d="M3 8l4 4 6-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span>${this.label || this.value}</span>
      </div>
    `;
  }
}
```

The component has value for form submission, label for display (falls back to value), disabled for non-selectable options, and selected for current selection state.
  </action>
  <verify>File exists with Option class, role="option", aria-selected, aria-disabled attributes</verify>
  <done>lui-option component renders with proper ARIA attributes and visual states</done>
</task>

<task type="auto">
  <name>Task 2: Extend Select with dropdown and options</name>
  <files>packages/select/src/select.ts</files>
  <action>
Extend the skeleton Select component to add:

1. **Add imports and types:**
```typescript
import { state, query } from 'lit/decorators.js';

export interface SelectOption {
  value: string;
  label: string;
  disabled?: boolean;
}
```

2. **Add reactive properties and state:**
```typescript
@property({ type: Array }) options: SelectOption[] = [];

@state() private open = false;
@state() private activeIndex = -1;
@state() private touched = false;
@state() private showError = false;

@query('.trigger') private triggerEl!: HTMLElement;
@query('.listbox') private listboxEl!: HTMLElement;

// Unique ID for ARIA references
private selectId = `lui-select-${Math.random().toString(36).substr(2, 9)}`;
```

3. **Add click-outside handling:**
```typescript
private handleDocumentClick = (e: MouseEvent): void => {
  if (!e.composedPath().includes(this)) {
    this.closeDropdown();
  }
};

override connectedCallback(): void {
  super.connectedCallback();
  if (!isServer) {
    document.addEventListener('click', this.handleDocumentClick);
  }
}

override disconnectedCallback(): void {
  super.disconnectedCallback();
  if (!isServer) {
    document.removeEventListener('click', this.handleDocumentClick);
  }
}
```

4. **Add dropdown control methods:**
```typescript
private openDropdown(): void {
  if (this.disabled || this.open) return;
  this.open = true;
  // Set active to selected option or first enabled
  const selectedIdx = this.options.findIndex(o => o.value === this.value);
  this.activeIndex = selectedIdx >= 0 ? selectedIdx : this.findFirstEnabledIndex();
  this.requestUpdate();
  // Position after render
  this.updateComplete.then(() => this.positionDropdown(this.triggerEl, this.listboxEl));
}

private closeDropdown(): void {
  if (!this.open) return;
  this.open = false;
  this.activeIndex = -1;
  this.triggerEl?.focus();
}

private findFirstEnabledIndex(): number {
  return this.options.findIndex(o => !o.disabled);
}

private handleTriggerClick(): void {
  if (this.open) {
    this.closeDropdown();
  } else {
    this.openDropdown();
  }
}
```

5. **Add option selection:**
```typescript
private selectOption(index: number): void {
  const option = this.options[index];
  if (!option || option.disabled) return;

  this.value = option.value;
  this.internals?.setFormValue(this.value);
  this.closeDropdown();

  // Dispatch change event
  this.dispatchEvent(new CustomEvent('change', {
    detail: { value: this.value },
    bubbles: true,
    composed: true
  }));
}

private handleOptionClick(e: MouseEvent, index: number): void {
  e.stopPropagation();
  this.selectOption(index);
}
```

6. **Add CSS for dropdown:**
```css
.listbox {
  position: fixed;
  z-index: var(--ui-select-z-index, 50);
  min-width: 100%;
  max-height: var(--ui-select-dropdown-max-height, 240px);
  overflow-y: auto;
  border-radius: var(--ui-select-dropdown-radius);
  border: 1px solid var(--ui-select-dropdown-border);
  background-color: var(--ui-select-dropdown-bg);
  box-shadow: var(--ui-select-dropdown-shadow);
}

.listbox[hidden] {
  display: none;
}

.option {
  display: flex;
  align-items: center;
  padding: var(--ui-select-option-padding-y, 0.5rem) var(--ui-select-option-padding-x, 0.75rem);
  cursor: pointer;
  transition: background-color 150ms;
}

.option:hover:not(.option-disabled) {
  background-color: var(--ui-select-option-bg-hover);
}

.option-active {
  background-color: var(--ui-select-option-bg-active);
}

.option-selected {
  font-weight: 500;
}

.option-disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.check-icon {
  width: 1em;
  height: 1em;
  margin-right: 0.5rem;
  visibility: hidden;
}

.option-selected .check-icon {
  visibility: visible;
  color: var(--ui-select-option-check);
}

/* Chevron rotation when open */
.chevron-open {
  transform: rotate(180deg);
}
```

7. **Update render method:**
```typescript
private getSelectedLabel(): string {
  const selected = this.options.find(o => o.value === this.value);
  return selected?.label || selected?.value || '';
}

override render() {
  const selectedLabel = this.getSelectedLabel();
  const listboxId = `${this.selectId}-listbox`;

  return html`
    <div
      class=${this.getTriggerClasses()}
      role="combobox"
      aria-expanded=${this.open ? 'true' : 'false'}
      aria-haspopup="listbox"
      aria-controls=${listboxId}
      aria-activedescendant=${this.open && this.activeIndex >= 0 ? `${this.selectId}-option-${this.activeIndex}` : ''}
      aria-disabled=${this.disabled ? 'true' : 'false'}
      tabindex=${this.disabled ? '-1' : '0'}
      @click=${this.handleTriggerClick}
    >
      ${selectedLabel
        ? html`<span class="selected-value">${selectedLabel}</span>`
        : html`<span class="placeholder">${this.placeholder}</span>`}
      <svg
        class="chevron ${this.open ? 'chevron-open' : ''}"
        viewBox="0 0 16 16"
        fill="none"
        stroke="currentColor"
        aria-hidden="true"
      >
        <path d="M4 6l4 4 4-4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>

    <div
      id=${listboxId}
      class="listbox"
      role="listbox"
      aria-labelledby=${this.selectId}
      ?hidden=${!this.open}
    >
      ${this.options.map((option, index) => {
        const isActive = index === this.activeIndex;
        const isSelected = option.value === this.value;
        const classes = ['option'];
        if (isActive) classes.push('option-active');
        if (isSelected) classes.push('option-selected');
        if (option.disabled) classes.push('option-disabled');

        return html`
          <div
            id="${this.selectId}-option-${index}"
            role="option"
            aria-selected=${isSelected ? 'true' : 'false'}
            aria-disabled=${option.disabled ? 'true' : 'false'}
            class=${classes.join(' ')}
            @click=${(e: MouseEvent) => this.handleOptionClick(e, index)}
          >
            <svg class="check-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" aria-hidden="true">
              <path d="M3 8l4 4 6-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>${option.label || option.value}</span>
          </div>
        `;
      })}
    </div>
  `;
}
```
  </action>
  <verify>
Build passes: `pnpm --filter @lit-ui/select build`
Verify select.ts contains:
- `role="listbox"` in template
- `aria-controls` (NOT aria-owns) referencing listbox
- `aria-activedescendant` for virtual focus
- Click handler opens/closes dropdown
- composedPath() for click-outside detection
  </verify>
  <done>Select component renders dropdown with options, opens on click, selects on click, closes on outside click</done>
</task>

<task type="auto">
  <name>Task 3: Update index.ts exports</name>
  <files>packages/select/src/index.ts</files>
  <action>
Update the index.ts to export the new types and potentially the Option component:

1. Add SelectOption type export:
```typescript
export type { SelectOption } from './select.js';
```

2. For now, options are rendered inline (not as slotted lui-option elements) to simplify implementation. The Option component file was created for potential future slot-based usage but is not registered in Phase 32.

The index.ts should export:
- Select class
- SelectSize type
- SelectOption type (new)
- TailwindElement and isServer re-exports
  </action>
  <verify>TypeScript compiles: `pnpm --filter @lit-ui/select build`</verify>
  <done>SelectOption type is exported from @lit-ui/select</done>
</task>

</tasks>

<verification>
1. Build succeeds: `pnpm --filter @lit-ui/select build`
2. dist/index.js exports Select, SelectSize, SelectOption
3. Select component:
   - Has role="combobox" on trigger
   - Has role="listbox" on dropdown
   - Uses aria-controls (not aria-owns)
   - Uses aria-activedescendant for virtual focus
   - Opens dropdown on trigger click
   - Shows options in listbox
   - Selects option on click, displays in trigger
   - Closes on outside click (composedPath)
</verification>

<success_criteria>
- Build passes with no TypeScript errors
- Select renders trigger with placeholder
- Click trigger opens dropdown with options
- Click option selects it and closes dropdown
- Selected option label displays in trigger
- Click outside closes dropdown
- ARIA roles and attributes match W3C APG pattern
</success_criteria>

<output>
After completion, create `.planning/phases/32-core-single-select/32-01-SUMMARY.md`
</output>
