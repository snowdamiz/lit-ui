---
phase: 32-core-single-select
plan: 03
type: execute
wave: 2
depends_on: ["32-01"]
files_modified:
  - packages/select/src/select.ts
autonomous: true

must_haves:
  truths:
    - "Form submission includes select value in FormData"
    - "Required select shows error when empty on form submit"
    - "Select shows focus ring on keyboard focus"
    - "Select shows error visual state when invalid"
    - "Select shows placeholder when no selection"
    - "Size variants render with correct padding and font"
  artifacts:
    - path: "packages/select/src/select.ts"
      provides: "Form participation, validation, visual states"
      contains: ["setFormValue", "setValidity", "formResetCallback"]
  key_links:
    - from: "packages/select/src/select.ts"
      to: "ElementInternals"
      via: "Form participation"
      pattern: "internals\\.setFormValue|internals\\.setValidity"
---

<objective>
Implement form participation via ElementInternals with required validation, error states, focus ring, and size variants.

Purpose: Enable developers to use the select in native HTML forms with proper validation and visual feedback.
Output: Select that participates in form submission, validates required fields, and shows appropriate visual states.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-core-single-select/32-RESEARCH.md
@.planning/phases/32-core-single-select/32-01-SUMMARY.md
@packages/select/src/select.ts
@packages/input/src/input.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement form participation and validation</name>
  <files>packages/select/src/select.ts</files>
  <action>
Add form participation methods and validation to the Select component:

1. **Add label property for form association:**
```typescript
@property({ type: String })
label = '';
```

2. **Add validation method:**
```typescript
private validate(): boolean {
  if (!this.internals) return true;

  if (this.required && !this.value) {
    this.internals.setValidity(
      { valueMissing: true },
      'Please select an option',
      this.triggerEl
    );
    return false;
  }

  // Clear validity when valid
  this.internals.setValidity({});
  return true;
}
```

3. **Add form lifecycle callbacks:**
```typescript
/**
 * Form lifecycle callback: reset the select to initial state.
 */
formResetCallback(): void {
  this.value = '';
  this.touched = false;
  this.showError = false;
  this.internals?.setFormValue('');
  this.internals?.setValidity({});
}

/**
 * Form lifecycle callback: handle disabled state from form.
 */
formDisabledCallback(disabled: boolean): void {
  this.disabled = disabled;
}
```

4. **Update selectOption to set form value:**
```typescript
private selectOption(index: number): void {
  const option = this.options[index];
  if (!option || option.disabled) return;

  this.value = option.value;

  // Update form value
  this.internals?.setFormValue(this.value);

  // Validate after selection
  if (this.touched) {
    const isValid = this.validate();
    this.showError = !isValid;
  }

  this.closeDropdown();

  // Dispatch change event
  this.dispatchEvent(new CustomEvent('change', {
    detail: { value: this.value },
    bubbles: true,
    composed: true
  }));
}
```

5. **Add blur handling for validation timing:**
```typescript
private handleBlur(): void {
  this.touched = true;
  const isValid = this.validate();
  this.showError = !isValid;
}
```

And add @blur=${this.handleBlur} to the trigger element.

6. **Sync initial value to form on connectedCallback:**
```typescript
override connectedCallback(): void {
  super.connectedCallback();
  if (!isServer) {
    document.addEventListener('click', this.handleDocumentClick);
    // Sync initial value to form
    if (this.value) {
      this.internals?.setFormValue(this.value);
    }
  }
}
```
  </action>
  <verify>
Build passes: `pnpm --filter @lit-ui/select build`
select.ts contains:
- validate() method with setValidity()
- formResetCallback() and formDisabledCallback()
- setFormValue() called on selection
- Blur handler for validation timing
  </verify>
  <done>Select participates in forms, validates required, resets on form reset</done>
</task>

<task type="auto">
  <name>Task 2: Add visual states (error, focus, disabled)</name>
  <files>packages/select/src/select.ts</files>
  <action>
Add CSS and template updates for visual states:

1. **Add CSS for error state:**
```css
.trigger-error {
  border-color: var(--ui-select-border-error);
}

.trigger-error:focus {
  border-color: var(--ui-select-border-error);
}

/* Error text below select */
.error-text {
  font-size: 0.875em;
  color: var(--ui-select-text-error, var(--color-destructive));
  margin-top: 0.25rem;
}
```

2. **Add CSS for focus-visible ring:**
(Already in skeleton, but verify it's correct)
```css
.trigger:focus-visible {
  outline: 2px solid var(--ui-select-ring);
  outline-offset: 2px;
}
```

3. **Update getTriggerClasses to include error:**
```typescript
private getTriggerClasses(): string {
  const classes = ['trigger', `trigger-${this.size}`];
  if (this.disabled) {
    classes.push('trigger-disabled');
  }
  if (this.showError) {
    classes.push('trigger-error');
  }
  return classes.join(' ');
}
```

4. **Add aria-invalid attribute:**
```typescript
aria-invalid=${this.showError ? 'true' : nothing}
```

5. **Add wrapper and error message to template:**
Update render to wrap in container with optional label and error:
```typescript
private get errorMessage(): string {
  return this.internals?.validationMessage || '';
}

override render() {
  const selectedLabel = this.getSelectedLabel();
  const listboxId = `${this.selectId}-listbox`;

  return html`
    <div class="select-wrapper">
      ${this.label
        ? html`
            <label for=${this.selectId} class="select-label label-${this.size}">
              ${this.label}
              ${this.required ? html`<span class="required-indicator">*</span>` : nothing}
            </label>
          `
        : nothing}

      <div
        id=${this.selectId}
        class=${this.getTriggerClasses()}
        role="combobox"
        aria-expanded=${this.open ? 'true' : 'false'}
        aria-haspopup="listbox"
        aria-controls=${listboxId}
        aria-activedescendant=${this.open && this.activeIndex >= 0 ? `${this.selectId}-option-${this.activeIndex}` : ''}
        aria-disabled=${this.disabled ? 'true' : 'false'}
        aria-invalid=${this.showError ? 'true' : nothing}
        tabindex=${this.disabled ? '-1' : '0'}
        @click=${this.handleTriggerClick}
        @keydown=${this.handleKeydown}
        @blur=${this.handleBlur}
      >
        ${selectedLabel
          ? html`<span class="selected-value">${selectedLabel}</span>`
          : html`<span class="placeholder">${this.placeholder}</span>`}
        <svg
          class="chevron ${this.open ? 'chevron-open' : ''}"
          viewBox="0 0 16 16"
          fill="none"
          stroke="currentColor"
          aria-hidden="true"
        >
          <path d="M4 6l4 4 4-4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>

      <!-- Dropdown listbox -->
      <div
        id=${listboxId}
        class="listbox"
        role="listbox"
        aria-labelledby=${this.selectId}
        ?hidden=${!this.open}
      >
        ${this.options.map((option, index) => this.renderOption(option, index))}
      </div>

      ${this.showError && this.errorMessage
        ? html`<span class="error-text" role="alert">${this.errorMessage}</span>`
        : nothing}
    </div>

    <!-- ARIA live region -->
    <div role="status" aria-live="polite" aria-atomic="true" class="visually-hidden">
      ${this.open && this.activeIndex >= 0
        ? `${this.getActiveOptionLabel()}, ${this.activeIndex + 1} of ${this.getEnabledOptionsCount()}`
        : ''}
    </div>
  `;
}

private renderOption(option: SelectOption, index: number) {
  const isActive = index === this.activeIndex;
  const isSelected = option.value === this.value;
  const classes = ['option'];
  if (isActive) classes.push('option-active');
  if (isSelected) classes.push('option-selected');
  if (option.disabled) classes.push('option-disabled');

  return html`
    <div
      id="${this.selectId}-option-${index}"
      role="option"
      aria-selected=${isSelected ? 'true' : 'false'}
      aria-disabled=${option.disabled ? 'true' : 'false'}
      class=${classes.join(' ')}
      @click=${(e: MouseEvent) => this.handleOptionClick(e, index)}
    >
      <svg class="check-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" aria-hidden="true">
        <path d="M3 8l4 4 6-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span>${option.label || option.value}</span>
    </div>
  `;
}
```

6. **Add CSS for label and wrapper:**
```css
.select-wrapper {
  display: flex;
  flex-direction: column;
}

.select-label {
  font-weight: 500;
  color: var(--ui-select-text);
  margin-bottom: 0.25rem;
}

.label-sm {
  font-size: var(--ui-select-font-size-sm);
}

.label-md {
  font-size: var(--ui-select-font-size-md);
}

.label-lg {
  font-size: var(--ui-select-font-size-lg);
}

.required-indicator {
  color: var(--ui-select-text-error, var(--color-destructive));
  margin-left: 0.125rem;
}

.selected-value {
  color: var(--ui-select-text);
}
```
  </action>
  <verify>
Build passes: `pnpm --filter @lit-ui/select build`
select.ts contains:
- trigger-error CSS class with error border color
- aria-invalid attribute
- Error text with role="alert"
- Label rendering with required indicator
- Size variant classes for label
  </verify>
  <done>Error state shows red border and message, focus shows ring, label renders with required indicator</done>
</task>

<task type="auto">
  <name>Task 3: Verify size variants and disabled state</name>
  <files>packages/select/src/select.ts</files>
  <action>
Ensure size variants (sm, md, lg) and disabled state work correctly:

1. **Verify size CSS is applied correctly:**
Already have trigger-sm, trigger-md, trigger-lg classes from skeleton.
Ensure they use the correct tokens:
```css
.trigger-sm {
  padding: var(--ui-select-padding-y-sm) var(--ui-select-padding-x-sm);
  font-size: var(--ui-select-font-size-sm);
}

.trigger-md {
  padding: var(--ui-select-padding-y-md) var(--ui-select-padding-x-md);
  font-size: var(--ui-select-font-size-md);
}

.trigger-lg {
  padding: var(--ui-select-padding-y-lg) var(--ui-select-padding-x-lg);
  font-size: var(--ui-select-font-size-lg);
}
```

2. **Verify disabled state:**
Already have:
- `pointer-events: none` on :host([disabled])
- `trigger-disabled` class with disabled colors
- `aria-disabled` attribute
- `tabindex="-1"` when disabled

3. **Add test that disabled prevents opening:**
Already in openDropdown():
```typescript
if (this.disabled || this.open) return;
```

4. **Ensure chevron transition:**
```css
.chevron {
  flex-shrink: 0;
  width: 1em;
  height: 1em;
  opacity: 0.5;
  transition: transform 150ms;
}

.chevron-open {
  transform: rotate(180deg);
}
```

No additional changes needed - verify existing implementation covers requirements.
  </action>
  <verify>
Build passes: `pnpm --filter @lit-ui/select build`
Size variants sm/md/lg use correct CSS tokens
Disabled state prevents interaction
Chevron rotates when open
  </verify>
  <done>Size variants render correctly, disabled prevents all interaction</done>
</task>

</tasks>

<verification>
1. Build succeeds: `pnpm --filter @lit-ui/select build`
2. Form participation works:
   - Select value included in FormData on form submit
   - Required select prevents form submission when empty
   - Form reset clears select value
3. Visual states work:
   - Focus ring visible on keyboard focus
   - Error border and message shown when invalid
   - Disabled state grays out and prevents interaction
4. Size variants render correctly:
   - sm: smaller padding and font
   - md: default size
   - lg: larger padding and font
5. Label renders above select with required indicator when applicable
</verification>

<success_criteria>
- Form submission includes select value
- Required validation shows error when empty
- Focus ring visible on keyboard focus (not mouse)
- Error state shows red border and message
- Disabled prevents all interaction
- All three size variants render correctly
- Label with required indicator renders
</success_criteria>

<output>
After completion, create `.planning/phases/32-core-single-select/32-03-SUMMARY.md`
</output>
