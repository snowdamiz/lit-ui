---
phase: 56-accordion-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/accordion/package.json
  - packages/accordion/tsconfig.json
  - packages/accordion/vite.config.ts
  - packages/accordion/src/vite-env.d.ts
  - packages/accordion/src/accordion.ts
  - packages/accordion/src/accordion-item.ts
  - packages/accordion/src/index.ts
  - packages/accordion/src/jsx.d.ts
  - pnpm-workspace.yaml
autonomous: true

must_haves:
  truths:
    - "Clicking an accordion header expands its panel in single-expand mode and auto-collapses the previously open panel"
    - "Setting multiple attribute allows multiple panels open simultaneously"
    - "Accordion container discovers items via slotchange and handles dynamic add/remove"
    - "Accordion dispatches ui-change event with value and expandedItems on expand/collapse"
    - "Accordion supports controlled (value) and uncontrolled (default-value) modes"
  artifacts:
    - path: "packages/accordion/src/accordion.ts"
      provides: "Accordion container element with state management"
      contains: "class Accordion extends TailwindElement"
    - path: "packages/accordion/src/accordion-item.ts"
      provides: "Accordion item element with header and collapsible panel"
      contains: "class AccordionItem extends TailwindElement"
    - path: "packages/accordion/src/index.ts"
      provides: "Element registration and exports"
      contains: "customElements.define"
    - path: "packages/accordion/package.json"
      provides: "Package configuration with peer deps"
      contains: "@lit-ui/accordion"
  key_links:
    - from: "packages/accordion/src/accordion.ts"
      to: "packages/accordion/src/accordion-item.ts"
      via: "slotchange child discovery + syncChildStates"
      pattern: "handleSlotChange.*LUI-ACCORDION-ITEM"
    - from: "packages/accordion/src/accordion-item.ts"
      to: "packages/accordion/src/accordion.ts"
      via: "ui-accordion-toggle internal event"
      pattern: "dispatchCustomEvent.*ui-accordion-toggle"
---

<objective>
Create the accordion package with container (lui-accordion) and item (lui-accordion-item) elements implementing the core expand/collapse state management.

Purpose: Establish the package scaffold and parent-child container pattern so that Plan 02 can layer keyboard navigation, ARIA, disabled states, and CSS theming on top.
Output: Working accordion with click-to-toggle, single/multi-expand modes, collapsible flag, controlled/uncontrolled modes, CSS Grid height animation, and slotchange-based child discovery.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/56-accordion-core/56-RESEARCH.md

# Primary reference implementations:
@packages/radio/src/radio-group.ts
@packages/radio/src/radio.ts
@packages/radio/src/index.ts
@packages/radio/src/jsx.d.ts
@packages/radio/package.json
@packages/radio/vite.config.ts
@packages/radio/tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Package scaffold and accordion-item element</name>
  <files>
    packages/accordion/package.json
    packages/accordion/tsconfig.json
    packages/accordion/vite.config.ts
    packages/accordion/src/vite-env.d.ts
    packages/accordion/src/accordion-item.ts
  </files>
  <action>
    **1. Create package scaffold** by cloning packages/radio structure:
    - `package.json`: name `@lit-ui/accordion`, same structure as radio package.json. Peer deps on `lit ^3.0.0` and `@lit-ui/core ^1.0.0`. Dev deps: workspace refs to core, typescript-config, vite-config, plus @tailwindcss/vite, lit, tailwindcss, typescript, vite, vite-plugin-dts (same versions as radio).
    - `tsconfig.json`: extends `@lit-ui/typescript-config/library.json`, outDir `./dist`, rootDir `./src`, include `["src"]`.
    - `vite.config.ts`: `import { createLibraryConfig } from '@lit-ui/vite-config/library'; export default createLibraryConfig({ entry: 'src/index.ts' });`
    - `src/vite-env.d.ts`: `/// <reference types="vite/client" />`

    **2. Add to pnpm workspace** if not already included (check pnpm-workspace.yaml has `packages/accordion` covered by glob pattern `packages/*`).

    **3. Create AccordionItem class** in `accordion-item.ts`:
    - Extends TailwindElement. NOT form-associated. No attachInternals.
    - Generate shadow-internal unique ID: `private itemId = \`lui-ai-${Math.random().toString(36).substr(2, 9)}\`;`
    - Properties (all @property):
      - `value: string = ''` — Unique identifier for this item
      - `expanded: boolean = false` (reflect: true) — Set by parent, NEVER self-toggled
      - `disabled: boolean = false` (reflect: true) — Whether item is disabled
      - `headingLevel: number = 3` (attribute: 'heading-level') — ARIA heading level
    - Static styles using tailwindBaseStyles + component css:
      - `:host { display: block; }`
      - `:host([disabled]) { pointer-events: none; }` (disabled items still focusable via keyboard, pointer-events disabled for click only)
      - `.header-button` — full-width button, no native button styling, flex row, cursor pointer, padding via `var(--ui-accordion-header-padding)`, font-weight via `var(--ui-accordion-header-font-weight)`, font-size via `var(--ui-accordion-header-font-size)`, color via `var(--ui-accordion-header-text)`, bg via `var(--ui-accordion-header-bg)`, border: none, text-align: left, width: 100%
      - `.header-button:hover` — bg via `var(--ui-accordion-header-hover-bg)`
      - `.header-button:focus-visible` — outline: none, box-shadow: `0 0 0 2px var(--ui-accordion-ring)`
      - `.panel-wrapper` — `display: grid; grid-template-rows: 0fr; transition: grid-template-rows var(--ui-accordion-transition) ease;`
      - `:host([expanded]) .panel-wrapper` — `grid-template-rows: 1fr;`
      - `.panel-content` — `min-height: 0; overflow: clip;`
      - `.panel-inner` — `padding: var(--ui-accordion-panel-padding); color: var(--ui-accordion-panel-text);`
      - `@media (prefers-reduced-motion: reduce) { .panel-wrapper { transition-duration: 0ms; } }` (ACRD-05)
    - `handleToggle()` method — if disabled, return. Otherwise dispatch internal event: `dispatchCustomEvent(this, 'ui-accordion-toggle', { value: this.value });`
    - render() method outputs the three-layer CSS Grid animation DOM structure:
      ```
      <div role="heading" aria-level="${this.headingLevel}">
        <button
          id="${this.itemId}-header"
          class="header-button"
          aria-expanded="${this.expanded ? 'true' : 'false'}"
          aria-controls="${this.itemId}-panel"
          tabindex="-1"
          @click=${this.handleToggle}
        >
          <slot name="header"></slot>
        </button>
      </div>
      <div class="panel-wrapper">
        <div class="panel-content">
          <div
            class="panel-inner"
            role="region"
            aria-labelledby="${this.itemId}-header"
            id="${this.itemId}-panel"
          >
            <slot></slot>
          </div>
        </div>
      </div>
      ```
    - NOTE: aria-disabled attribute is NOT added yet (Plan 02 handles full ARIA). tabindex is set to -1 by default (parent manages roving tabindex in Plan 02). The button click and basic aria-expanded/aria-controls are included here because they are inseparable from the toggle behavior.
  </action>
  <verify>
    Run `pnpm install` from monorepo root to link the new package. Then run `pnpm --filter @lit-ui/accordion build` and verify it compiles without errors.
  </verify>
  <done>
    - AccordionItem class exists with value, expanded, disabled, headingLevel properties
    - CSS Grid three-layer animation structure renders in shadow DOM
    - Click on header dispatches ui-accordion-toggle event (does NOT self-toggle expanded)
    - Package scaffold matches radio package structure
  </done>
</task>

<task type="auto">
  <name>Task 2: Accordion container and index/JSX registration</name>
  <files>
    packages/accordion/src/accordion.ts
    packages/accordion/src/index.ts
    packages/accordion/src/jsx.d.ts
  </files>
  <action>
    **1. Create Accordion container class** in `accordion.ts`:
    - Extends TailwindElement. NOT form-associated (accordion is layout, not form input).
    - Properties (@property):
      - `value: string = ''` — Comma-separated list of expanded item values (controlled mode)
      - `defaultValue: string = ''` (attribute: 'default-value') — Initial expanded items (uncontrolled mode)
      - `multiple: boolean = false` — Allow multiple panels open simultaneously (ACRD-02)
      - `collapsible: boolean = false` — Allow all panels to close in single-expand mode (ACRD-03). When false + single-expand, clicking the open panel is a no-op.
      - `disabled: boolean = false` (reflect: true) — Disable all child items (ACRD-15)
    - Private state:
      - `items: AccordionItem[] = []` — Discovered child items
    - Computed getter `expandedItems`: `get expandedItems(): Set<string>` — parses `this.value` into a Set by splitting on comma, trimming, filtering empty strings.
    - connectedCallback: call super, then if `defaultValue && !value`, set `this.value = this.defaultValue`.
    - firstUpdated: SSR slotchange workaround — query `slot:not([name])` from shadowRoot and dispatch `new Event('slotchange')` on it if found. This ensures child discovery after SSR hydration (ACRD-14).
    - updated(changedProperties):
      - If `value` changed: call `syncChildStates()`
      - If `disabled` changed: call `syncDisabledState()`
    - `handleSlotChange(e: Event)`: Discover children (ACRD-14). Get assigned elements from slot, filter for `el.tagName === 'LUI-ACCORDION-ITEM'`, cast to `AccordionItem[]`, store in `this.items`. Call `syncChildStates()` and `syncDisabledState()`.
    - `handleItemToggle(e: CustomEvent)`: Listen for `ui-accordion-toggle` internal events (ACRD-01, ACRD-02, ACRD-03):
      - `e.stopPropagation()` (internal event, don't leak)
      - Extract `itemValue = e.detail.value as string`
      - If `this.multiple`:
        - Toggle itemValue in a Set copy of expandedItems
        - Set `this.value` to joined result
      - Else (single-expand):
        - If expandedItems has itemValue (already open):
          - If collapsible: set `this.value = ''`
          - Else: return (no-op)
        - Else: set `this.value = itemValue`
      - Call `syncChildStates()`
      - Dispatch consumer event: `dispatchCustomEvent(this, 'ui-change', { value: this.value, expandedItems: [...this.expandedItems] })` (ACRD-13)
    - `syncChildStates()`: For each item in `this.items`, set `item.expanded = this.expandedItems.has(item.value)`.
    - `syncDisabledState()`: If `this.disabled`, set `item.disabled = true` for all items.
    - Static styles: tailwindBaseStyles + css`:host { display: block; }` and `:host([disabled]) { opacity: 0.5; }`
    - render():
      ```
      <div @ui-accordion-toggle=${this.handleItemToggle}>
        <slot @slotchange=${this.handleSlotChange}></slot>
      </div>
      ```

    **2. Create index.ts** following `packages/radio/src/index.ts` pattern exactly:
    - `/// <reference path="./jsx.d.ts" />`
    - Export Accordion, AccordionItem classes
    - Re-export TailwindElement, isServer from @lit-ui/core
    - Safe registration of `lui-accordion` and `lui-accordion-item` with collision detection
    - Declare global HTMLElementTagNameMap

    **3. Create jsx.d.ts** following `packages/radio/src/jsx.d.ts` pattern:
    - LuiAccordionAttributes: value?, defaultValue?, multiple?, collapsible?, disabled?
    - LuiAccordionItemAttributes: value?, expanded?, disabled?, headingLevel?
    - React, Vue, Svelte type declarations for both elements
    - Svelte events: `on:ui-change` for accordion, `on:ui-accordion-toggle` for accordion-item
  </action>
  <verify>
    Run `pnpm --filter @lit-ui/accordion build` and confirm it compiles without errors. Verify the dist output contains index.js, index.d.ts, accordion.js, accordion-item.js.
  </verify>
  <done>
    - Accordion container discovers items via slotchange, syncs expanded state to children
    - Single-expand mode: opening one panel closes others
    - Multi-expand mode: multiple panels open simultaneously
    - Collapsible flag controls whether last panel can close in single mode
    - Controlled (value) and uncontrolled (default-value) modes work
    - ui-change event dispatched on expand/collapse
    - SSR slotchange workaround in firstUpdated
    - Custom elements registered, JSX types declared
    - Package builds successfully
  </done>
</task>

</tasks>

<verification>
1. `pnpm install` succeeds at monorepo root (new package linked)
2. `pnpm --filter @lit-ui/accordion build` compiles without errors
3. dist/ contains index.js, index.d.ts, accordion.js, accordion-item.js (and .d.ts counterparts)
4. AccordionItem renders heading+button+panel DOM structure with CSS Grid animation styles
5. Accordion container handles ui-accordion-toggle events and syncs child expanded state
</verification>

<success_criteria>
- Package @lit-ui/accordion exists with correct structure matching other packages
- AccordionItem has three-layer CSS Grid animation DOM (wrapper > content > inner)
- Accordion manages expand state: single-expand with auto-collapse, multi-expand, collapsible
- Child items are discovered via slotchange with SSR hydration workaround
- ui-change event fires on every expand/collapse action
- Package compiles and builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/56-accordion-core/56-01-SUMMARY.md`
</output>
