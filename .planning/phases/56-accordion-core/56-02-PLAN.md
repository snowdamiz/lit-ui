---
phase: 56-accordion-core
plan: 02
type: execute
wave: 2
depends_on: ["56-01"]
files_modified:
  - packages/accordion/src/accordion.ts
  - packages/accordion/src/accordion-item.ts
  - packages/core/src/styles/tailwind.css
autonomous: true

must_haves:
  truths:
    - "Arrow keys (Up/Down) navigate between accordion headers with wrapping, Home/End jump to first/last"
    - "Enter and Space toggle the focused accordion panel"
    - "Screen reader announces aria-expanded state, heading level, and panel association correctly"
    - "Disabled items are focusable but not activatable (click and keyboard toggle are no-ops)"
    - "Parent disabled state propagates to all child items"
    - "Accordion renders with --ui-accordion-* CSS custom properties and responds to dark mode"
  artifacts:
    - path: "packages/accordion/src/accordion.ts"
      provides: "Keyboard navigation and disabled state propagation"
      contains: "handleKeyDown"
    - path: "packages/accordion/src/accordion-item.ts"
      provides: "ARIA attributes and disabled styling"
      contains: "aria-disabled"
    - path: "packages/core/src/styles/tailwind.css"
      provides: "Accordion CSS custom properties in :root and .dark blocks"
      contains: "--ui-accordion-"
  key_links:
    - from: "packages/accordion/src/accordion.ts"
      to: "packages/accordion/src/accordion-item.ts"
      via: "keyboard focus management with roving tabindex"
      pattern: "updateRovingTabindex|moveFocusTo"
    - from: "packages/core/src/styles/tailwind.css"
      to: "packages/accordion/src/accordion-item.ts"
      via: "CSS custom properties consumed in component styles"
      pattern: "var\\(--ui-accordion-"
---

<objective>
Add keyboard navigation, full ARIA attributes, disabled state handling, and CSS custom property theming to the accordion components created in Plan 01.

Purpose: Complete the accordion's accessibility story (ACRD-06 through ACRD-11, ACRD-15) and visual theming (ACRD-20, ACRD-21) so all Phase 56 success criteria are met.
Output: Fully accessible accordion with keyboard nav, screen reader support, disabled states, and project-consistent CSS theming with dark mode.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/56-accordion-core/56-RESEARCH.md
@.planning/phases/56-accordion-core/56-01-SUMMARY.md

# Reference implementations for keyboard nav and CSS tokens:
@packages/radio/src/radio-group.ts
@packages/core/src/styles/tailwind.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Keyboard navigation and disabled states on accordion container</name>
  <files>
    packages/accordion/src/accordion.ts
    packages/accordion/src/accordion-item.ts
  </files>
  <action>
    **1. Add keyboard navigation to Accordion container** (accordion.ts):

    Add `handleKeyDown(e: KeyboardEvent)` method on the container wrapper div (alongside existing @ui-accordion-toggle listener):
    - Filter enabled items: `const enabledItems = this.items.filter(i => !i.disabled);`
    - If no enabled items, return.
    - Find current focused index: `enabledItems.findIndex(i => i.tabIndex === 0)` — if -1, default to 0.
    - Key handling (ACRD-07, ACRD-08):
      - `ArrowDown`: preventDefault, move focus to next enabled item (wrapping). IMPORTANT: Arrow keys ONLY move focus, they do NOT toggle panels (this differs from RadioGroup where arrows select).
      - `ArrowUp`: preventDefault, move focus to previous enabled item (wrapping).
      - `Home`: preventDefault, move focus to first enabled item.
      - `End`: preventDefault, move focus to last enabled item.
    - Focus movement: Update roving tabindex — set all items to tabindex=-1, set target item to tabindex=0, call `target.focus()` which should focus the button inside the shadow DOM. Add a `focusHeader()` method to AccordionItem that calls `this.shadowRoot?.querySelector('.header-button')?.focus()` — then call `targetItem.focusHeader()` from the container.
    - NOTE: Enter/Space are NOT handled here. They naturally trigger the button's click event in AccordionItem, which already calls handleToggle -> dispatches ui-accordion-toggle. No extra keyboard handling needed for activation (ACRD-06).

    Add `updateRovingTabindex()` method:
    - Filter enabled items from `this.items`
    - If no enabled items, return
    - Find which item should have tabindex=0: the first expanded enabled item, or the first enabled item if none expanded
    - Set all items' tabIndex to -1
    - Set the focus target's tabIndex to 0

    Call `updateRovingTabindex()` from:
    - `handleSlotChange()` (after discovering items)
    - `updated()` when `value` changes (after syncChildStates)
    - `updated()` when `disabled` changes (after syncDisabledState)

    Update the render template to add `@keydown=${this.handleKeyDown}` on the wrapper div.

    **2. Add aria-disabled to AccordionItem** (accordion-item.ts):

    Update the button in AccordionItem's render to include:
    - `aria-disabled="${this.disabled ? 'true' : nothing}"` (using `nothing` import from lit to omit attribute when false)

    Update `handleToggle()` in AccordionItem:
    - Already guards `if (this.disabled) return;` — verify this is present.

    Add `focusHeader()` public method to AccordionItem:
    ```typescript
    focusHeader(): void {
      const btn = this.shadowRoot?.querySelector('.header-button') as HTMLElement | null;
      btn?.focus();
    }
    ```

    **3. Disabled state refinements** (ACRD-11, ACRD-15):

    In AccordionItem styles, update disabled styling:
    - Remove `pointer-events: none` from `:host([disabled])` — disabled items MUST be focusable for keyboard navigation (APG spec says disabled items are focusable but not activatable).
    - Instead add: `:host([disabled]) .header-button { cursor: not-allowed; opacity: 0.5; }`

    In Accordion container, verify `syncDisabledState()` propagates parent disabled to all children. Also ensure that when parent is NOT disabled, it does NOT clear individually-disabled items (only set disabled=true when parent.disabled, don't touch children's disabled when parent is enabled).
  </action>
  <verify>
    Run `pnpm --filter @lit-ui/accordion build` and confirm it compiles without errors. Manually verify in the built output that handleKeyDown, updateRovingTabindex, focusHeader, and aria-disabled are present.
  </verify>
  <done>
    - Arrow Up/Down navigate between accordion headers with wrapping
    - Home/End jump to first/last header
    - Enter/Space toggle panels (via native button click -> handleToggle)
    - Disabled items are focusable but not activatable
    - Parent disabled propagates to all children
    - Roving tabindex ensures single tab stop into accordion
    - AccordionItem has aria-disabled attribute when disabled
  </done>
</task>

<task type="auto">
  <name>Task 2: CSS custom properties for accordion theming with dark mode</name>
  <files>
    packages/core/src/styles/tailwind.css
    packages/accordion/src/accordion-item.ts
  </files>
  <action>
    **1. Add accordion CSS custom properties to tailwind.css** (ACRD-20, ACRD-21):

    Add the following block to the `:root` section in `packages/core/src/styles/tailwind.css`, placed after the existing component token blocks (after the last component's tokens, likely toast or tooltip). Add a section comment:

    ```css
    /* -------------------------------------------------------------------------
     * Accordion Component
     * ------------------------------------------------------------------------- */

    /* Layout */
    --ui-accordion-border: var(--color-border, var(--ui-color-border));
    --ui-accordion-border-width: 1px;
    --ui-accordion-radius: 0.375rem;
    --ui-accordion-gap: 0;

    /* Header */
    --ui-accordion-header-padding: 1rem;
    --ui-accordion-header-font-weight: 500;
    --ui-accordion-header-font-size: 1rem;
    --ui-accordion-header-text: var(--color-foreground, var(--ui-color-foreground));
    --ui-accordion-header-bg: transparent;
    --ui-accordion-header-hover-bg: var(--color-muted, var(--ui-color-muted));

    /* Panel */
    --ui-accordion-panel-padding: 0 1rem 1rem;
    --ui-accordion-panel-text: var(--color-muted-foreground, var(--ui-color-muted-foreground));

    /* Animation */
    --ui-accordion-transition: 200ms;

    /* Focus */
    --ui-accordion-ring: var(--color-ring, var(--ui-color-ring));
    ```

    Add dark mode overrides in the `.dark` section:

    ```css
    /* Accordion dark mode */
    --ui-accordion-header-text: var(--color-gray-50);
    --ui-accordion-header-hover-bg: var(--color-gray-800);
    --ui-accordion-border: var(--color-gray-800);
    --ui-accordion-panel-text: var(--color-gray-400);
    ```

    **2. Add border styling to Accordion container** (accordion.ts):

    Update the Accordion container's static styles to add border styling on the wrapper:
    ```css
    .accordion-wrapper {
      border: var(--ui-accordion-border-width) solid var(--ui-accordion-border);
      border-radius: var(--ui-accordion-radius);
      overflow: hidden;
    }
    ```
    Update the render template's wrapper div to use `class="accordion-wrapper"`.

    Also add `:host-context(.dark)` rule in AccordionItem if needed — but since all colors use CSS custom properties that are overridden in the .dark block of tailwind.css, no :host-context rules should be needed in the component itself. The CSS custom properties handle dark mode automatically.

    **3. Add item border separators** (accordion-item.ts):

    Add a border-bottom on each item to separate them visually:
    ```css
    :host {
      display: block;
      border-bottom: var(--ui-accordion-border-width) solid var(--ui-accordion-border);
    }
    :host(:last-of-type) {
      border-bottom: none;
    }
    ```

    **4. Verify all existing CSS custom property references** in accordion-item.ts styles match the tokens defined above. Ensure every `var(--ui-accordion-*)` used in the component has a corresponding token in tailwind.css.
  </action>
  <verify>
    Run `pnpm --filter @lit-ui/accordion build` to confirm compilation. Then run `pnpm --filter @lit-ui/core build` to confirm tailwind.css compiles with new tokens. Grep for `--ui-accordion-` in both built outputs to verify tokens are present.
  </verify>
  <done>
    - tailwind.css :root block contains all --ui-accordion-* custom properties
    - tailwind.css .dark block contains dark mode overrides for accordion
    - AccordionItem styles consume --ui-accordion-* tokens for all visual properties
    - Accordion container has border styling from CSS tokens
    - Items separated by border-bottom (except last)
    - Dark mode works automatically via CSS custom property overrides
    - Both packages build successfully
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @lit-ui/accordion build` compiles without errors
2. `pnpm --filter @lit-ui/core build` compiles with new accordion tokens
3. Arrow keys navigate between headers, Home/End work, Enter/Space toggle panels
4. aria-expanded, aria-controls, aria-labelledby, aria-disabled, role="heading", role="region" are all present in AccordionItem shadow DOM
5. Disabled items receive aria-disabled="true" and have reduced opacity but remain focusable
6. CSS custom properties exist in tailwind.css :root and .dark blocks
7. Accordion visually has border, border-radius, and item separators
</verification>

<success_criteria>
- Full keyboard navigation: ArrowUp/Down with wrapping, Home/End, Enter/Space toggle
- Complete ARIA: aria-expanded, aria-controls, aria-labelledby, aria-disabled, role="heading" with configurable level, role="region"
- Disabled items: focusable but not activatable, parent disabled propagates
- CSS theming: all visual properties use --ui-accordion-* tokens
- Dark mode: .dark block overrides in tailwind.css
- prefers-reduced-motion: animation disabled
- Both @lit-ui/accordion and @lit-ui/core build successfully
</success_criteria>

<output>
After completion, create `.planning/phases/56-accordion-core/56-02-SUMMARY.md`
</output>
