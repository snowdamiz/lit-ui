---
phase: 42-calendar-display-foundation
plan: 09
type: execute
wave: 4
depends_on: ["42-01", "42-02", "42-03", "42-04", "42-05", "42-06", "42-07", "42-08"]
files_modified:
  - packages/calendar/src/calendar.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can navigate the calendar using keyboard (arrow keys, Home/End, Page Up/Down) with roving tabindex"
    - "KeyboardNavigationManager.moveFocus() updates tabindex dynamically on navigation"
    - "navigationManager.setInitialFocus() is called when month changes to reset tabindex"
    - "Roving tabindex is managed by KeyboardNavigationManager, not by focusedIndex state in render"
  artifacts:
    - path: "packages/calendar/src/calendar.ts"
      provides: "Calendar with proper roving tabindex implementation"
      contains: "navigationManager.moveFocus() calls in handleKeyDown"
      contains: "navigationManager.setInitialFocus() call when month changes"
  key_links:
    - from: "packages/calendar/src/calendar.ts"
      to: "packages/calendar/src/keyboard-nav.ts"
      via: "KeyboardNavigationManager method calls for tabindex management"
      pattern: "navigationManager\\.(setInitialFocus|moveFocus)\\("
---

<objective>
Fix roving tabindex implementation to use KeyboardNavigationManager for dynamic tabindex updates instead of static tabindex based on focusedIndex state.

Purpose: The current implementation uses `tabindex=${isFocused ? '0' : '-1'}` in renderDayCell based on focusedIndex state, which doesn't implement true roving tabindex. The KeyboardNavigationManager class exists with moveFocus() and setInitialFocus() methods but they are not being used properly to update tabindex dynamically.

Output: Calendar with proper roving tabindex where KeyboardNavigationManager manages tabindex updates.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-calendar-display-foundation/42-05-PLAN.md
@/Users/sn0w/Documents/dev/lit-components/packages/calendar/src/calendar.ts
@/Users/sn0w/Documents/dev/lit-components/packages/calendar/src/keyboard-nav.ts
</context>

<tasks>

<task type="auto">
  <name>Update renderDayCell to remove static tabindex based on focusedIndex</name>
  <files>packages/calendar/src/calendar.ts</files>
  <action>
    In packages/calendar/src/calendar.ts, update the renderDayCell method to remove static tabindex assignment:

    Current code (line ~646):
    ```typescript
    tabindex=${isFocused ? '0' : '-1'}
    ```

    Change to:
    ```typescript
    tabindex=${index === 0 ? '0' : '-1'}
    ```

    This sets initial tabindex to 0 on first cell only. The KeyboardNavigationManager will dynamically update tabindex via moveFocus() calls.

    Keep the isFocused variable for focus-visible styling but remove it from tabindex assignment.

    Reference: packages/calendar/src/keyboard-nav.ts lines 143-146 show moveFocus() updates tabindex when called.
  </action>
  <verify>grep "tabindex=" packages/calendar/src/calendar.ts shows tabindex based on index === 0, not isFocused</verify>
  <done>renderDayCell no longer sets tabindex based on focusedIndex state</done>
</task>

<task type="auto">
  <name>Add live tabindex updates via navigationManager.moveFocus()</name>
  <files>packages/calendar/src/calendar.ts</files>
  <action>
    In packages/calendar/src/calendar.ts, update the handleKeyDown method to properly use navigationManager.moveFocus() results.

    Current code (lines ~693-736) calls navigationManager.moveFocus() but doesn't use the tabindex updates it performs.

    After each navigationManager.moveFocus() call, the tabindex is already updated by the manager (see keyboard-nav.ts lines 143-146). The code at line 734 already updates this.focusedIndex = nextIndex, and line 736 calls nextElement?.focus().

    The issue is that render() re-renders with static tabindex. We need to ensure the DOM elements keep their tabindex after moveFocus() updates them.

    Add a new method to sync Lit state with DOM tabindex after navigation:

    ```typescript
    /**
     * Sync focusedIndex with DOM tabindex after keyboard navigation.
     * Called after navigationManager.moveFocus() updates DOM.
     */
    private syncFocusedIndex(): void {
      const cells = Array.from(this.gridCells);
      const tabIndexZeroIndex = cells.findIndex(cell => cell.getAttribute('tabindex') === '0');
      if (tabIndexZeroIndex !== -1) {
        this.focusedIndex = tabIndexZeroIndex;
      }
    }
    ```

    Then call this.syncFocusedIndex() after each navigationManager.moveFocus() call in handleKeyDown, before nextElement?.focus().

    Reference: packages/calendar/src/keyboard-nav.ts lines 143-146 show moveFocus() updates DOM tabindex directly.
  </action>
  <verify>grep -A 3 "syncFocusedIndex" packages/calendar/src/calendar.ts shows method is called after navigation moves</verify>
  <done>focusedIndex state syncs with DOM tabindex after keyboard navigation</done>
</task>

<task type="auto">
  <name>Call navigationManager.setInitialFocus() when month changes</name>
  <files>packages/calendar/src/calendar.ts</files>
  <action>
    In packages/calendar/src/calendar.ts, ensure navigationManager.setInitialFocus() is called when month changes.

    The updated() lifecycle method at lines 263-266 already calls initializeNavigationManager() when currentMonth changes. The initializeNavigationManager() method at lines 208-243 calls setInitialFocus() at line 242.

    However, verify this is working correctly by ensuring:
    1. The grid cells query (@query('[role="gridcell"]')) returns elements after render
    2. setInitialFocus() is called with the correct index (selected date or today)
    3. The tabindex attributes are set on DOM elements

    The initializeNavigationManager method already does this correctly. The issue is that render() re-renders with static tabindex which overrides the DOM changes.

    To fix this, we need to store the initial focus index in state and use it in render:

    Add a new state property:
    ```typescript
    @state()
    private initialFocusIndex: number = 0;
    ```

    Update initializeNavigationManager to set this state:
    ```typescript
    this.initialFocusIndex = initialIndex;
    this.navigationManager.setInitialFocus(initialIndex);
    ```

    Update renderDayCell to use this state:
    ```typescript
    tabindex=${index === this.initialFocusIndex ? '0' : '-1'}
    ```

    This ensures render() respects the initial focus set by the navigation manager.
  </action>
  <verify>grep "initialFocusIndex" packages/calendar/src/calendar.ts shows state is used in renderDayCell tabindex</verify>
  <done>Month changes reset tabindex to initial focus via navigationManager.setInitialFocus()</done>
</task>

</tasks>

<verification>
After completing all tasks, verify:

1. renderDayCell uses initialFocusIndex for tabindex, not isFocused
2. syncFocusedIndex() method updates focusedIndex state after keyboard navigation
3. initializeNavigationManager() sets initialFocusIndex state when month changes
4. navigationManager.setInitialFocus() is called with correct index (selected or today)
5. navigationManager.moveFocus() updates DOM tabindex directly
6. focusedIndex state stays in sync with DOM tabindex via syncFocusedIndex()
7. Test keyboard navigation: Arrow keys move focus and update tabindex
8. Test month change: Tabindex resets to initial cell (selected or today)
</verification>

<success_criteria>
1. Roving tabindex implemented via KeyboardNavigationManager methods
2. Tabindex updates dynamically on keyboard navigation (not static based on state)
3. Month changes trigger setInitialFocus() to reset tabindex
4. All keyboard navigation works with proper tabindex management
</success_criteria>

<output>
After completion, create `.planning/phases/42-calendar-display-foundation/42-09-SUMMARY.md`
</output>
