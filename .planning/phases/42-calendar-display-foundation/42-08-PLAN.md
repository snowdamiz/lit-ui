---
phase: 42-calendar-display-foundation
plan: 08
type: execute
wave: 4
depends_on: ["42-04", "42-05", "42-06"]
files_modified:
  - packages/calendar/src/calendar.ts
  - packages/calendar/src/jsx.d.ts
  - packages/calendar/src/index.ts
  - packages/core/src/styles/tailwind.css

autonomous: true

must_haves:
  truths:
    - "Calendar renders correctly in dark mode via :host-context(.dark)"
    - "Calendar renders via SSR with Declarative Shadow DOM (isServer guards on all DOM APIs)"
    - "CSS custom properties (--ui-calendar-*) are defined in core tailwind.css"
    - "JSX types support React, Vue, and Svelte frameworks"
  artifacts:
    - path: "packages/calendar/src/calendar.ts"
      provides: "Calendar with dark mode and SSR support"
      contains: "host-context(.dark)"
    - path: "packages/calendar/src/jsx.d.ts"
      provides: "JSX type declarations for lui-calendar"
      contains: "lui-calendar"
    - path: "packages/core/src/styles/tailwind.css"
      provides: "Calendar CSS custom property tokens"
      contains: "--ui-calendar-"
  key_links:
    - from: "packages/core/src/styles/tailwind.css"
      to: "packages/calendar/src/calendar.ts"
      via: "CSS custom properties cascade into Shadow DOM"
      pattern: "--ui-calendar-"
---

<objective>
Add dark mode support, SSR compatibility verification, CSS design tokens in core tailwind.css, JSX type declarations, and finalize package exports.

Purpose: All LitUI components must support dark mode, SSR, and have proper CSS tokens and framework type definitions. This plan brings the calendar to production parity with other components.
Output: Calendar with dark mode, SSR guards, CSS tokens, JSX types, and clean package exports.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-calendar-display-foundation/42-RESEARCH.md
@.planning/phases/42-calendar-display-foundation/42-01-SUMMARY.md

Reference patterns from:
@packages/checkbox/src/jsx.d.ts (JSX type declarations template)
@packages/core/src/styles/tailwind.css (CSS token pattern with --ui-switch-* etc.)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dark mode styles and CSS design tokens</name>
  <files>
    packages/calendar/src/calendar.ts
    packages/core/src/styles/tailwind.css
  </files>
  <action>
    1. **Add CSS custom property tokens to `packages/core/src/styles/tailwind.css`:**
       - Find the `:root` or `@theme` block where other component tokens are defined (near --ui-switch-* tokens)
       - Add calendar tokens in a clearly commented section:
         ```css
         /* Calendar Component Tokens */
         --ui-calendar-width: 320px;
         --ui-calendar-day-size: 2.5rem;
         --ui-calendar-gap: 0.125rem;
         --ui-calendar-radius: 0.375rem;
         --ui-calendar-bg: var(--color-background, var(--ui-color-background));
         --ui-calendar-text: var(--color-foreground, var(--ui-color-foreground));
         --ui-calendar-border: var(--color-border, var(--ui-color-border));
         --ui-calendar-hover-bg: var(--color-muted, var(--ui-color-muted));
         --ui-calendar-selected-bg: var(--color-primary, var(--ui-color-primary));
         --ui-calendar-selected-text: var(--color-primary-foreground, var(--ui-color-primary-foreground));
         --ui-calendar-today-border: var(--color-primary, var(--ui-color-primary));
         --ui-calendar-disabled-opacity: 0.5;
         --ui-calendar-outside-opacity: 0.4;
         --ui-calendar-focus-ring: var(--color-ring, var(--ui-color-ring));
         --ui-calendar-weekday-color: var(--color-muted-foreground, var(--ui-color-muted-foreground));
         --ui-calendar-nav-color: var(--color-foreground, var(--ui-color-foreground));
         ```
       - IMPORTANT: Place these tokens INSIDE the existing @theme block, near other --ui-* component tokens. Follow the exact pattern of existing tokens (--ui-switch-*, --ui-checkbox-*, etc.)

    2. **Add dark mode styles to `packages/calendar/src/calendar.ts`:**
       - Add `:host-context(.dark)` CSS rules following the established pattern from switch/checkbox:
         ```css
         :host-context(.dark) .calendar {
           color: var(--ui-calendar-text);
         }
         :host-context(.dark) .date-button:hover:not(:disabled):not([aria-disabled="true"]) {
           background-color: var(--ui-calendar-hover-bg);
         }
         :host-context(.dark) .month-select,
         :host-context(.dark) .year-select {
           background-color: var(--ui-calendar-bg);
           border-color: var(--ui-calendar-border);
           color: var(--ui-calendar-text);
         }
         :host-context(.dark) .nav-button:hover {
           background-color: var(--ui-calendar-hover-bg);
         }
         :host-context(.dark) .help-dialog {
           background-color: var(--ui-calendar-bg);
           border-color: var(--ui-calendar-border);
           color: var(--ui-calendar-text);
         }
         ```
       - The CSS custom properties reference semantic color tokens that automatically adapt in dark mode, so the dark mode rules mainly ensure backgrounds and borders switch correctly within Shadow DOM.

    Build packages: `pnpm --filter @lit-ui/core build && pnpm --filter @lit-ui/calendar build`

    3. **Cross-component verification:** Verify that core changes don't break existing components:
       - `pnpm --filter @lit-ui/button build`
       - `pnpm --filter @lit-ui/checkbox build`
       If either fails, the core CSS token additions have a syntax error or conflict — fix before proceeding.
  </action>
  <verify>
    - `pnpm --filter @lit-ui/core build && pnpm --filter @lit-ui/calendar build` succeeds
    - `pnpm --filter @lit-ui/button build && pnpm --filter @lit-ui/checkbox build` succeeds (cross-component verification)
    - `grep "ui-calendar-" packages/core/src/styles/tailwind.css` shows calendar tokens
    - `grep "host-context(.dark)" packages/calendar/src/calendar.ts` confirms dark mode rules
    - Count of --ui-calendar-* tokens is at least 12
  </verify>
  <done>Calendar CSS tokens defined in core tailwind.css, dark mode styles use :host-context(.dark) following established pattern</done>
</task>

<task type="auto">
  <name>Task 2: Add SSR guards, JSX types, and finalize exports</name>
  <files>
    packages/calendar/src/calendar.ts
    packages/calendar/src/jsx.d.ts
    packages/calendar/src/index.ts
  </files>
  <action>
    1. **Verify SSR guards in `packages/calendar/src/calendar.ts`:**
       - `firstUpdated()` must have `if (isServer) return;` as first line
       - Any `requestAnimationFrame`, `querySelector`, `focus()`, `showModal()` calls must be guarded with isServer check
       - `updated()` lifecycle hooks that access DOM must also have isServer guards
       - Verify `isServer` is imported from 'lit'
       - The component should render its template on the server (HTML output) but skip all imperative DOM manipulation

    2. **Create `packages/calendar/src/jsx.d.ts`:**
       - Follow the exact pattern from `packages/checkbox/src/jsx.d.ts`:
         ```typescript
         /**
          * JSX type declarations for lui-calendar custom element.
          * Provides type support for React, Vue, and Svelte.
          */
         import type { Calendar } from './calendar.js';

         interface LuiCalendarAttributes {
           value?: string;
           locale?: string;
           'min-date'?: string;
           'max-date'?: string;
           'first-day-of-week'?: string;
           // NOTE: display-month and hide-navigation are Phase 43 features.
           // Do NOT add them here — they will be added when their backing
           // @property() declarations are created in Phase 43.
         }

         // React JSX support
         declare global {
           namespace JSX {
             interface IntrinsicElements {
               'lui-calendar': React.DetailedHTMLProps<
                 React.HTMLAttributes<Calendar> & LuiCalendarAttributes & {
                   'onui-date-select'?: (e: CustomEvent) => void;
                   'onui-month-change'?: (e: CustomEvent) => void;
                 },
                 Calendar
               >;
             }
           }
         }

         // Vue support
         declare module 'vue' {
           export interface GlobalComponents {
             'lui-calendar': import('vue').DefineComponent<LuiCalendarAttributes>;
           }
         }

         // Svelte support
         declare namespace svelteHTML {
           interface IntrinsicElements {
             'lui-calendar': LuiCalendarAttributes & {
               'on:ui-date-select'?: (e: CustomEvent) => void;
               'on:ui-month-change'?: (e: CustomEvent) => void;
             };
           }
         }

         export {};
         ```

    3. **Update `packages/calendar/src/index.ts`:**
       - Uncomment the `/// <reference path="./jsx.d.ts" />` line (was commented in Plan 01)
       - Ensure all public exports are listed:
         - `export { Calendar } from './calendar.js'`
         - `export { KeyboardNavigationManager } from './keyboard-nav.js'`
         - `export { getCalendarDays, getMonthYearLabel, intlFirstDayToDateFns } from './date-utils.js'`
         - `export { getFirstDayOfWeek, getWeekdayNames, getMonthNames } from './intl-utils.js'`
         - `export type { DateConstraints } from './calendar.js'` (if the interface was exported)
       - Re-export TailwindElement and isServer from @lit-ui/core
       - Safe element registration for 'lui-calendar' already exists from Plan 01

    Build: `pnpm --filter @lit-ui/calendar build`
  </action>
  <verify>
    - `pnpm --filter @lit-ui/calendar build` succeeds
    - `grep "isServer" packages/calendar/src/calendar.ts` shows guards in lifecycle methods
    - `ls packages/calendar/src/jsx.d.ts` exists
    - `grep "lui-calendar" packages/calendar/src/jsx.d.ts` confirms JSX types
    - `grep "reference.*jsx" packages/calendar/src/index.ts` confirms JSX reference
    - `grep "KeyboardNavigationManager\|getCalendarDays\|getWeekdayNames" packages/calendar/src/index.ts` confirms all exports
  </verify>
  <done>SSR guards verified on all DOM operations, JSX types support React/Vue/Svelte, package exports include all public APIs (Calendar, KeyboardNavigationManager, date/intl utilities)</done>
</task>

</tasks>

<verification>
- Both core and calendar packages build without errors
- Calendar tokens (--ui-calendar-*) defined in core tailwind.css
- Dark mode styles use :host-context(.dark) pattern
- isServer guards prevent DOM operations during SSR
- JSX types cover all Calendar attributes and events
- Package exports include Calendar class, utilities, and types
</verification>

<success_criteria>
1. Dark mode works via :host-context(.dark) with proper color switching
2. SSR renders HTML template without errors (isServer guards on all DOM APIs)
3. At least 12 CSS custom properties (--ui-calendar-*) defined in core
4. JSX types support React, Vue, and Svelte with calendar attributes and events
5. Package exports all public APIs: Calendar, KeyboardNavigationManager, utilities
6. Package builds cleanly with full TypeScript declarations
</success_criteria>

<output>
After completion, create `.planning/phases/42-calendar-display-foundation/42-08-SUMMARY.md`
</output>
