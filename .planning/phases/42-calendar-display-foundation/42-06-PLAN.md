---
phase: 42-calendar-display-foundation
plan: 06
type: execute
wave: 3
depends_on: ["42-01", "42-02"]
files_modified:
  - packages/calendar/src/calendar.ts
  - packages/calendar/src/date-utils.ts
autonomous: true

must_haves:
  truths:
    - "Dates before minDate are disabled and non-interactive"
    - "Dates after maxDate are disabled and non-interactive"
    - "Disabled dates have visual reduced opacity styling"
    - "Disabled dates have aria-disabled='true' attribute"
    - "Disabled dates include reason in aria-label if provided"
    - "Weekend dates can be disabled via disableWeekends prop"
  artifacts:
    - path: "packages/calendar/src/calendar.ts"
      provides: "Calendar with date constraint support"
      contains: "minDate"
      contains: "maxDate"
      contains: "disabledDates"
    - path: "packages/calendar/src/date-utils.ts"
      provides: "Date validation utilities"
      exports: ["isDateDisabled"]
  key_links:
    - from: "packages/calendar/src/calendar.ts"
      to: "packages/calendar/src/date-utils.ts"
      via: "isDateDisabled validation"
      pattern: "isDateDisabled"
    - from: "packages/calendar/src/calendar.ts"
      to: "WAI-ARIA disabled state"
      via: "aria-disabled attribute"
      pattern: "aria-disabled"
---

<objective>
Add date constraints (min/max dates, disabled dates, weekend disabling) with visual and ARIA accessibility. Users need to see which dates are unavailable and why.

Purpose: Date constraints prevent invalid selections. Disabled dates must be visually distinct and accessibility-compliant.

Output: Calendar with minDate, maxDate, disabledDates, and disableWeekends props that disable cells with proper ARIA.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-calendar-display-foundation/42-RESEARCH.md
@/Users/sn0w/Documents/dev/lit-components/packages/button/src/button.ts
</context>

<tasks>

<task type="auto">
  <name>Add date validation utilities</name>
  <files>packages/calendar/src/date-utils.ts</files>
  <action>
    Update packages/calendar/src/date-utils.ts to add date validation:

    1. Import isWeekend, isBefore, isAfter, parseISO from date-fns

    2. Export isDateDisabled function:
       ```typescript
       export interface DateConstraints {
         minDate?: Date;
         maxDate?: Date;
         disabledDates?: Date[];
       }

       export function isDateDisabled(
         date: Date,
         constraints: DateConstraints
       ): boolean {
         const { minDate, maxDate, disabledDates } = constraints;

         // Check minimum date
         if (minDate && isBefore(date, minDate)) {
           return true;
         }

         // Check maximum date
         if (maxDate && isAfter(date, maxDate)) {
           return true;
         }

         // Check disabled dates
         if (disabledDates?.some(d => isSameDay(date, d))) {
           return true;
         }

         return false;
       }
       ```

    3. Export isWeekendDate function:
       ```typescript
       export function isWeekendDate(date: Date): boolean {
         return isWeekend(date);
       }
       ```

    Follow CAL-11, CAL-12, CAL-13 requirements: Min/max, specific dates, and weekend disabling.
  </action>
  <verify>grep "isDateDisabled\|isWeekendDate" packages/calendar/src/date-utils.ts shows validation functions</verify>
  <done>date-utils.ts exports date validation functions</done>
</task>

<task type="auto">
  <name>Add date constraint properties to calendar</name>
  <files>packages/calendar/src/calendar.ts</files>
  <action>
    Update packages/calendar/src/calendar.ts to add date constraint properties:

    1. Add @property decorators for constraints:
       ```typescript
       @property({ type: String, attribute: 'min-date' })
       minDate?: string; // ISO 8601 format (YYYY-MM-DD)

       @property({ type: String, attribute: 'max-date' })
       maxDate?: string; // ISO 8601 format (YYYY-MM-DD)

       @property({ type: Array, attribute: 'disabled-dates' })
       disabledDates?: string[]; // Array of ISO date strings

       @property({ type: Boolean, attribute: 'disable-weekends' })
       disableWeekends = false;
       ```

    2. Add @state() to store parsed Date objects:
       ```typescript
       @state()
       private parsedMinDate?: Date;

       @state()
       private parsedMaxDate?: Date;

       @state()
       private parsedDisabledDates?: Date[];
       ```

    3. In updated(changedProperties), parse ISO strings to Date objects:
       ```typescript
       override updated(changedProperties: PropertyValues) {
       super.updated(changedProperties);

       // Parse minDate
       if (this.minDate) {
         this.parsedMinDate = parseDate(this.minDate);
       }

       // Parse maxDate
       if (this.maxDate) {
         this.parsedMaxDate = parseDate(this.maxDate);
       }

       // Parse disabledDates
       if (this.disabledDates) {
         this.parsedDisabledDates = this.disabledDates.map(d => parseDate(d));
       }
       }
       ```

    Follow property pattern from button.ts (reflect attributes, type conversion).
  </action>
  <verify>grep "minDate\|maxDate\|disableWeekends" packages/calendar/src/calendar.ts shows constraint properties</verify>
  <done>Calendar has minDate, maxDate, disabledDates, disableWeekends properties</done>
</task>

<task type="auto">
  <name>Add disabled state rendering to calendar cells</name>
  <files>packages/calendar/src/calendar.ts</files>
  <action>
    Update packages/calendar/src/calendar.ts to render disabled cells:

    1. Add private isCellDisabled(date: Date): boolean method:
       ```typescript
       private isCellDisabled(date: Date): boolean {
         const constraints = {
           minDate: this.parsedMinDate,
           maxDate: this.parsedMaxDate,
           disabledDates: this.parsedDisabledDates
         };

         if (isDateDisabled(date, constraints)) {
           return true;
         }

         if (this.disableWeekends && isWeekendDate(date)) {
           return true;
         }

         return false;
       }
       ```

    2. Update renderDayCell to check disabled state:
       ```typescript
       private renderDayCell(date: Date) {
         const isToday = isDateToday(date);
         const isSelected = this.selectedDate === formatDate(date);
         const isDisabled = this.isCellDisabled(date);

         // Generate aria-label with disabled reason
         let ariaLabel = String(date.getDate());
         if (isDisabled) {
           const reason = this.getDisabledReason(date);
           ariaLabel = `${date.getDate()}, ${reason}`;
         }

         return html`
           <div
             role="gridcell"
             class="calendar-cell ${isToday ? 'today' : ''} ${isSelected ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}"
             aria-current=${isToday ? 'date' : nothing}
             aria-selected=${isSelected ? 'true' : nothing}
             aria-disabled=${isDisabled ? 'true' : nothing}
             aria-label=${ariaLabel}
             @click=${isDisabled ? nothing : () => this.handleDateClick(date)}
             tabindex=${isSelected ? '0' : '-1'}
           >
             ${date.getDate()}
           </div>
         `;
       }
       ```

    3. Add private getDisabledReason(date: Date): string method:
       ```typescript
       private getDisabledReason(date: Date): string {
         if (this.parsedMinDate && isBefore(date, this.parsedMinDate)) {
           return 'before minimum date';
         }
         if (this.parsedMaxDate && isAfter(date, this.parsedMaxDate)) {
           return 'after maximum date';
         }
         if (this.parsedDisabledDates?.some(d => isSameDay(date, d))) {
           return 'unavailable';
         }
         if (this.disableWeekends && isWeekendDate(date)) {
           return 'weekend';
         }
         return 'not available';
       }
       ```

    4. Add disabled cell styles:
       ```css
       .calendar-cell.disabled {
         opacity: var(--ui-calendar-disabled-opacity);
         pointer-events: none;
       }
       ```

    Follow CAL-11, CAL-12, CAL-13, CAL-14 requirements: Visual styling, aria-disabled, aria-label with reason.
  </action>
  <verify>grep "isCellDisabled\|aria-disabled" packages/calendar/src/calendar.ts shows disabled state handling</verify>
  <done>Disabled dates have visual styling and ARIA attributes</done>
</task>

</tasks>

<verification>
After completing all tasks, verify:

1. minDate: Dates before minDate are disabled
2. maxDate: Dates after maxDate are disabled
3. disabledDates: Specific dates in array are disabled
4. disableWeekends: Saturday/Sunday are disabled when true
5. Visual styling: Disabled cells have reduced opacity
6. ARIA disabled: aria-disabled="true" on disabled cells
7. ARIA label: Disabled cells include reason in aria-label
8. Non-interactive: Clicking disabled cells does nothing (pointer-events: none)
9. SSR safety: No client-only API calls without isServer guard
</verification>

<success_criteria>
1. Dates before minDate are disabled and non-interactive
2. Dates after maxDate are disabled and non-interactive
3. Specific dates in disabledDates array are disabled
4. Weekend dates disabled when disableWeekends=true
5. Disabled dates have reduced opacity visual style
6. Disabled dates have aria-disabled="true"
7. Disabled dates include reason in aria-label
</success_criteria>

<output>
After completion, create `.planning/phases/42-calendar-display-foundation/42-06-SUMMARY.md`
</output>
