---
phase: 42-calendar-display-foundation
plan: 04
type: execute
wave: 3
depends_on: ["42-02", "42-03"]
files_modified:
  - packages/calendar/src/keyboard-nav.ts
  - packages/calendar/src/calendar.ts

autonomous: true

must_haves:
  truths:
    - "Arrow keys move focus between date cells in the grid (left/right by day, up/down by week)"
    - "Home/End keys move focus to first/last day of the current week row"
    - "PageUp/PageDown navigate to previous/next month"
    - "Only the focused date cell has tabindex='0'; all others have tabindex='-1' (roving tabindex)"
    - "Focus management is imperative (not in Lit templates) to avoid re-render loops"
  artifacts:
    - path: "packages/calendar/src/keyboard-nav.ts"
      provides: "KeyboardNavigationManager for imperative roving tabindex"
      exports: ["KeyboardNavigationManager"]
    - path: "packages/calendar/src/calendar.ts"
      provides: "Calendar with keyboard navigation integration"
      contains: "KeyboardNavigationManager"
  key_links:
    - from: "packages/calendar/src/calendar.ts"
      to: "packages/calendar/src/keyboard-nav.ts"
      via: "import KeyboardNavigationManager"
      pattern: "import.*KeyboardNavigationManager.*keyboard-nav"
---

<objective>
Implement keyboard navigation for the calendar grid using the WAI-ARIA APG Grid Pattern with roving tabindex, managed imperatively to avoid Lit re-render loops.

Purpose: Keyboard accessibility is essential for screen reader users and power users. The roving tabindex pattern ensures only one cell is tabbable at a time per WAI-ARIA APG.
Output: KeyboardNavigationManager class and calendar integration with full arrow key, Home/End, and PageUp/PageDown navigation.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-calendar-display-foundation/42-RESEARCH.md
@.planning/phases/42-calendar-display-foundation/42-01-SUMMARY.md
@.planning/phases/42-calendar-display-foundation/42-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create KeyboardNavigationManager class</name>
  <files>packages/calendar/src/keyboard-nav.ts</files>
  <action>
    Create `packages/calendar/src/keyboard-nav.ts`:

    Export class `KeyboardNavigationManager` with:

    1. **Properties (private):**
       - `cells: HTMLElement[] = []` — the focusable date button elements
       - `focusedIndex: number = 0` — current focused cell index
       - `columns: number = 7` — grid column count (7 for month view)

    2. **Constructor:** `constructor(columns: number = 7)` — stores column count

    3. **Public methods:**
       - `setCells(cells: HTMLElement[]): void` — Updates cell list, clamps focusedIndex to valid range, calls updateTabindexes()
       - `setFocusedIndex(index: number): void` — Sets focusedIndex (clamped to valid range), calls updateTabindexes()
       - `getFocusedIndex(): number` — Returns current focusedIndex
       - `moveFocus(direction: 'left' | 'right' | 'up' | 'down' | 'home' | 'end'): number` — Computes new index based on direction:
         - `left`: focusedIndex - 1
         - `right`: focusedIndex + 1
         - `up`: focusedIndex - columns
         - `down`: focusedIndex + columns
         - `home`: first cell of current row (Math.floor(focusedIndex / columns) * columns)
         - `end`: last cell of current row (Math.min(row start + columns - 1, cells.length - 1))
         - Returns -1 if new index is out of bounds (signals month boundary crossing to caller)
         - If valid: updates focusedIndex, calls updateTabindexes(), calls cells[focusedIndex].focus(), returns new index
       - `focusCurrent(): void` — Focuses the current cell (for use after month navigation)

    4. **Private methods:**
       - `updateTabindexes(): void` — Iterates all cells, sets tabIndex to 0 for focusedIndex and -1 for all others

    CRITICAL: This class must NOT be a Lit reactive property. It manages focus imperatively to avoid re-render loops (Phase 42-09 decision). focusedIndex is a plain number, not @state().
  </action>
  <verify>
    - `grep "export class KeyboardNavigationManager" packages/calendar/src/keyboard-nav.ts` confirms export
    - `grep "moveFocus" packages/calendar/src/keyboard-nav.ts` confirms method
    - `grep "updateTabindexes" packages/calendar/src/keyboard-nav.ts` confirms imperative tabindex management
    - No `@state()` or `@property()` decorators in keyboard-nav.ts
  </verify>
  <done>KeyboardNavigationManager class handles roving tabindex imperatively with directional navigation and boundary detection</done>
</task>

<task type="auto">
  <name>Task 2: Integrate keyboard navigation into Calendar component</name>
  <files>packages/calendar/src/calendar.ts</files>
  <action>
    Update `packages/calendar/src/calendar.ts`:

    1. **Import KeyboardNavigationManager** from './keyboard-nav.js'

    2. **Private fields (NOT @state):**
       - `private navigationManager: KeyboardNavigationManager | null = null`
       - `private focusedIndex: number = 0` — tracks which cell should be focused

    3. **Lifecycle hooks:**
       - `override firstUpdated(): void`:
         - Guard with `if (isServer) return;`
         - Create `this.navigationManager = new KeyboardNavigationManager(7)`
         - Call `this.setupCells()` inside `requestAnimationFrame` to ensure DOM is rendered

       - `override updated(changedProperties: PropertyValues): void`:
         - After existing logic, if currentMonth changed, call `requestAnimationFrame(() => this.setupCells())`

    4. **setupCells() method:**
       - Query all date buttons: `const buttons = Array.from(this.renderRoot.querySelectorAll('.date-button:not(.outside-month)')) as HTMLElement[]`
       - Call `this.navigationManager?.setCells(buttons)`
       - Set initial focus to today (if in current month) or first day of month

    5. **Keyboard event handler:**
       - Add `@keydown="${this.handleKeydown}"` to the calendar-grid div
       - `private handleKeydown(e: KeyboardEvent): void`:
         - Map keys to directions:
           - ArrowLeft -> 'left', ArrowRight -> 'right', ArrowUp -> 'up', ArrowDown -> 'down'
           - Home -> 'home', End -> 'end'
         - For arrow keys and Home/End: `e.preventDefault()`, call `this.navigationManager!.moveFocus(direction)`
           - If returns -1: navigation crossed boundary, trigger month change (left/up beyond start -> navigatePrevMonth(), right/down beyond end -> navigateNextMonth()), then focus appropriate cell after month renders
         - PageUp: `e.preventDefault()`, call `this.navigatePrevMonth()`, after render focus same relative position
         - PageDown: `e.preventDefault()`, call `this.navigateNextMonth()`, after render focus same relative position
         - Enter/Space: `e.preventDefault()`, trigger date selection on focused cell
         - Escape: no action in this plan (will be used in Phase 43 for view drilling)

    6. **Set initial tabindex in the Lit template for keyboard discoverability.**
       - In the template's date-button rendering, add a computed tabindex so the FIRST current-month cell gets `tabindex="0"` and all others get `tabindex="-1"`. This ensures the grid is keyboard-discoverable before firstUpdated() runs (critical for SSR and progressive enhancement).
       - Use a simple index tracker or helper: for each day in the grid, if it's the first `isSameMonth(day, currentMonth)` cell, render `tabindex="0"`, otherwise `tabindex="-1"`.
       - After firstUpdated(), KeyboardNavigationManager takes over and manages tabindex imperatively from that point forward, overriding the template values.
       - This two-phase approach (declarative initial state -> imperative management) satisfies both SSR/accessibility requirements AND avoids re-render loops.

    Build: `pnpm --filter @lit-ui/calendar build`
  </action>
  <verify>
    - `pnpm --filter @lit-ui/calendar build` succeeds
    - `grep "KeyboardNavigationManager" packages/calendar/src/calendar.ts` confirms import and usage
    - `grep "handleKeydown" packages/calendar/src/calendar.ts` confirms keyboard handler
    - `grep "requestAnimationFrame" packages/calendar/src/calendar.ts` confirms post-render setup
    - `grep "tabindex" packages/calendar/src/calendar.ts` confirms initial tabindex="0" on first current-month cell and tabindex="-1" on others in the template
    - `grep "@state.*navigationManager\|@state.*focusedIndex" packages/calendar/src/calendar.ts` returns EMPTY (not reactive)
  </verify>
  <done>Calendar supports full keyboard navigation: arrow keys move by day/week, Home/End move to row boundaries, PageUp/PageDown navigate months, Enter/Space select date. Roving tabindex managed imperatively.</done>
</task>

</tasks>

<verification>
- Package builds without errors
- KeyboardNavigationManager is a standalone class with no Lit decorators
- Calendar integrates keyboard handler on the grid element
- Tabindex is NOT set in Lit templates (managed imperatively)
- Arrow keys, Home/End, PageUp/PageDown, Enter/Space all handled
- Month boundary crossing triggers month navigation
</verification>

<success_criteria>
1. Arrow keys move focus left/right by day and up/down by week
2. Home/End move focus to first/last day of the row
3. PageUp/PageDown navigate to previous/next month
4. Enter/Space select the focused date
5. Only focused cell has tabindex="0", all others have tabindex="-1"
6. No re-render loop from focus changes (imperative management)
</success_criteria>

<output>
After completion, create `.planning/phases/42-calendar-display-foundation/42-04-SUMMARY.md`
</output>
