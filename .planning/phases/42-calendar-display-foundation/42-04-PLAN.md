---
phase: 42-calendar-display-foundation
plan: 04
type: execute
wave: 2
depends_on: ["42-01", "42-02"]
files_modified:
  - packages/calendar/src/calendar.ts
  - packages/calendar/src/keyboard-nav.ts
autonomous: true

must_haves:
  truths:
    - "User navigates grid with arrow keys (Left/Right/Up/Down)"
    - "User moves to first/last cell in row with Home/End keys"
    - "User changes months with Page Up/Down keys"
    - "Only one cell has tabindex='0' at a time (roving tabindex)"
    - "Focus moves visibly between cells with keyboard navigation"
  artifacts:
    - path: "packages/calendar/src/keyboard-nav.ts"
      provides: "Roving tabindex utilities"
      min_lines: 80
      exports: ["RovingTabindex", "KeyboardNavigationManager"]
    - path: "packages/calendar/src/calendar.ts"
      provides: "Calendar with keyboard navigation"
      contains: "handleKeyDown"
      contains: "roving tabindex"
  key_links:
    - from: "packages/calendar/src/calendar.ts"
      to: "packages/calendar/src/keyboard-nav.ts"
      via: "ES module import"
      pattern: "from './keyboard-nav'"
    - from: "packages/calendar/src/calendar.ts"
      to: "WAI-ARIA Grid Pattern"
      via: "Keyboard event handling"
      pattern: "ArrowRight|ArrowLeft|ArrowUp|ArrowDown"
---

<objective>
Implement keyboard navigation with roving tabindex for the calendar grid. Users must navigate dates using keyboard without touching the mouse.

Purpose: Keyboard navigation is required for WCAG 2.1 Level AA compliance. Roving tabindex ensures only one cell is in tab sequence at a time.

Output: Calendar grid navigable via arrow keys, Home/End, Page Up/Down with roving tabindex implementation.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-calendar-display-foundation/42-RESEARCH.md
@/Users/sn0w/Documents/dev/lit-components/packages/button/src/button.ts
</context>

<tasks>

<task type="auto">
  <name>Create roving tabindex utility module</name>
  <files>packages/calendar/src/keyboard-nav.ts</files>
  <action>
    Create packages/calendar/src/keyboard-nav.ts with roving tabindex utilities:

    Export a class KeyboardNavigationManager:

    1. Constructor takes array of focusable elements
    2. Method setInitialFocus(selectedIndex: number): void - sets tabindex="0" on selected element, "-1" on others
    3. Method moveFocus(fromIndex: number, direction: 'up' | 'down' | 'left' | 'right' | 'home' | 'end'): number - calculates next index and updates tabindex
    4. Method getElement(index: number): HTMLElement | null - returns element at index

    Grid navigation math:
    - Right: currentIndex + 1 (if not at row end)
    - Left: currentIndex - 1 (if not at row start)
    - Down: currentIndex + 7 (one week down)
    - Up: currentIndex - 7 (one week up)
    - Home: (Math.floor(currentIndex / 7) * 7) - first cell in current row
    - End: (Math.floor(currentIndex / 7) * 7) + 6 - last cell in current row

    Include boundary checks to prevent focus moving outside grid.

    Follow RESEARCH.md "Pattern 2: Roving Tabindex Implementation".
  </action>
  <verify>grep "setInitialFocus\|moveFocus" packages/calendar/src/keyboard-nav.ts shows roving tabindex methods</verify>
  <done>keyboard-nav.ts exports KeyboardNavigationManager class</done>
</task>

<task type="auto">
  <name>Add keyboard event handler to calendar</name>
  <files>packages/calendar/src/calendar.ts</files>
  <action>
    Update packages/calendar/src/calendar.ts to add keyboard navigation:

    1. Add @query('[role="gridcell"]') gridCells!: NodeListOf<HTMLElement>

    2. Add @state() private focusedIndex: number = 0

    3. Add @state() private navigationManager: KeyboardNavigationManager | null = null

    4. In connectedCallback() (with !isServer guard):
       - Initialize navigationManager with Array.from(this.gridCells)
       - Set initial focus to selected date or today

    5. In updated(changedProperties: PropertyValues):
       - If gridCells changed, reinitialize navigationManager
       - Call navigationManager.setInitialFocus(this.focusedIndex)

    6. Add private handleKeyDown(event: KeyboardEvent) method:
       ```typescript
       private handleKeyDown(event: KeyboardEvent) {
         const currentIndex = this.focusedIndex;
         let nextIndex = currentIndex;

         switch (event.key) {
           case 'ArrowRight':
             nextIndex = this.navigationManager?.moveFocus(currentIndex, 'right') ?? currentIndex;
             break;
           case 'ArrowLeft':
             nextIndex = this.navigationManager?.moveFocus(currentIndex, 'left') ?? currentIndex;
             break;
           case 'ArrowDown':
             nextIndex = this.navigationManager?.moveFocus(currentIndex, 'down') ?? currentIndex;
             break;
           case 'ArrowUp':
             nextIndex = this.navigationManager?.moveFocus(currentIndex, 'up') ?? currentIndex;
             break;
           case 'Home':
             nextIndex = this.navigationManager?.moveFocus(currentIndex, 'home') ?? currentIndex;
             break;
           case 'End':
             nextIndex = this.navigationManager?.moveFocus(currentIndex, 'end') ?? currentIndex;
             break;
           case 'PageDown':
             this.handleNextMonth();
             return;
           case 'PageUp':
             this.handlePreviousMonth();
             return;
           case 'Enter':
           case ' ':
             this.handleDateClick(this.getMonthDays()[currentIndex]);
             return;
           default:
             return;
         }

         event.preventDefault();
         this.focusedIndex = nextIndex;
         const nextElement = this.navigationManager?.getElement(nextIndex);
         nextElement?.focus();
       }
       ```

    7. Attach keyboard handler to grid: @keydown=${this.handleKeyDown} on grid element

    Follow CAL-07 and CAL-08 requirements: Arrow keys, Home/End, Page Up/Down with roving tabindex.
  </action>
  <verify>grep "handleKeyDown\|ArrowRight\|roving" packages/calendar/src/calendar.ts shows keyboard navigation</verify>
  <done>Calendar grid navigable via keyboard with roving tabindex</done>
</task>

<task type="auto">
  <name>Add Enter/Space key handling for date selection</name>
  <files>packages/calendar/src/calendar.ts</files>
  <action>
    Update packages/calendar/src/calendar.ts to add Enter/Space key handling:

    1. In handleKeyDown, add cases for 'Enter' and ' ' (Space):
       - Both keys should select the focused date
       - Call this.handleDateClick(date) where date is the focused cell's date
       - Get date from this.getMonthDays()[this.focusedIndex]

    2. Ensure preventDefault() is called for Enter/Space to prevent scroll

    This follows WAI-ARIA Grid Pattern where Enter/Space activates the focused cell.

    Pattern:
    ```typescript
    case 'Enter':
    case ' ':
      const days = this.getMonthDays();
      const focusedDate = days[this.focusedIndex];
      this.handleDateClick(focusedDate);
      event.preventDefault();
      break;
    ```

    Verify: Pressing Enter or Space on focused cell selects the date.
  </action>
  <verify>grep "case 'Enter'\|case ' '" packages/calendar/src/calendar.ts shows activation keys</verify>
  <done>Enter/Space keys select focused date</done>
</task>

</tasks>

<verification>
After completing all tasks, verify:

1. Arrow keys: Navigate between cells in all 4 directions
2. Home/End: Move to first/last cell in current row
3. Page Up/Down: Change to previous/next month
4. Roving tabindex: Only one cell has tabindex="0" at any time
5. Focus visible: Focused cell has visible focus indicator
6. Enter/Space: Select the focused date
7. Tab navigation: Tab key enters grid at focused cell, Shift+Tab exits
8. SSR safety: Keyboard handlers only attached on client (!isServer)
</verification>

<success_criteria>
1. Arrow keys move focus between grid cells
2. Home/End move to row start/end
3. Page Up/Down change months
4. Enter/Space select focused date
5. Only one cell has tabindex="0" at a time
6. Focus moves visibly between cells
</success_criteria>

<output>
After completion, create `.planning/phases/42-calendar-display-foundation/42-04-SUMMARY.md`
</output>
