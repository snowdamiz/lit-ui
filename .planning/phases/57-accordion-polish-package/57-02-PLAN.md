---
phase: 57-accordion-polish-package
plan: 02
type: execute
wave: 2
depends_on: ["57-01"]
files_modified:
  - packages/accordion/src/accordion-item.ts
  - packages/accordion/package.json
autonomous: true

must_haves:
  truths:
    - "Accordion renders correctly via Declarative Shadow DOM on the server and hydrates on the client"
    - "@lit-ui/accordion package has correct exports, peer dependencies, and publishable structure"
  artifacts:
    - path: "packages/accordion/src/accordion-item.ts"
      provides: "SSR-safe chevron and lazy rendering"
      contains: "isServer"
    - path: "packages/accordion/package.json"
      provides: "Publishable npm package configuration"
      contains: "exports"
  key_links:
    - from: "packages/accordion/src/accordion-item.ts"
      to: "SSR output"
      via: "isServer guard for data-state"
      pattern: "isServer"
    - from: "packages/accordion/package.json"
      to: "npm registry"
      via: "exports, files, peerDependencies fields"
      pattern: "exports"
---

<objective>
Verify SSR compatibility for the accordion's new features (chevron, data-state, lazy mounting) and audit the @lit-ui/accordion package for publishability.

Purpose: Ensures the accordion works correctly in SSR environments (Declarative Shadow DOM) and the package is ready to publish to npm, completing ACRD-19 and INTG-01.
Output: SSR-verified accordion-item.ts and audited package.json.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/57-accordion-polish-package/57-01-SUMMARY.md
@packages/accordion/src/accordion-item.ts
@packages/accordion/src/accordion.ts
@packages/accordion/package.json
@packages/accordion/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: SSR compatibility verification and fixes</name>
  <files>packages/accordion/src/accordion-item.ts</files>
  <action>
Verify and fix SSR compatibility for the three new features added in Plan 57-01.

**1. Chevron SVG (should work automatically)**
The chevron SVG is inline in the shadow DOM template. Declarative Shadow DOM serializes the full shadow DOM including the SVG, so this works out of the box. No changes needed.

Verify: The chevron SVG is part of the `render()` return, not dynamically inserted.

**2. data-state attribute (needs SSR guard)**
The `connectedCallback()` and `updated()` calls to `this.setAttribute('data-state', ...)` need an `isServer` guard. On the server, `setAttribute` on the host is acceptable in Lit SSR, but data-state is a convenience attribute -- it's safer to only set it client-side to avoid potential SSR mismatches.

Import `isServer` from lit (add to existing import):
```typescript
import { html, css, nothing, isServer, type PropertyValues } from 'lit';
```

Guard the `connectedCallback()` data-state set:
```typescript
override connectedCallback(): void {
  super.connectedCallback();
  if (!isServer) {
    this.setAttribute('data-state', this.expanded ? 'open' : 'closed');
  }
}
```

Guard the `updated()` data-state set:
```typescript
protected override updated(changedProperties: PropertyValues): void {
  if (changedProperties.has('expanded')) {
    if (!isServer) {
      this.setAttribute('data-state', this.expanded ? 'open' : 'closed');
    }
    if (this.expanded) {
      this._hasBeenExpanded = true;
    }
  }
}
```

**3. Lazy mounting (works automatically)**
When `lazy` is true and item is collapsed on server: slot is omitted from SSR output (correct -- no content to show). When `lazy` is false: slot renders normally. The `nothing` sentinel from Lit renders as empty in DSD. No changes needed.

**4. Verify existing SSR patterns**
Confirm accordion.ts already has:
- `isServer` import
- `firstUpdated()` slotchange workaround (dispatches slotchange event after hydration)
- No `document` or `window` references outside isServer guards

These were implemented in Phase 56. Just verify they're intact.
  </action>
  <verify>Run `cd packages/accordion && npx tsc --noEmit` to verify TypeScript compiles. Grep for `isServer` in accordion-item.ts to confirm guards are present. Grep for `document` and `window` in all accordion src files to ensure no unguarded browser APIs.</verify>
  <done>data-state setAttribute calls are guarded with isServer checks. Chevron and lazy mounting work in SSR without modification. No unguarded browser APIs in accordion source.</done>
</task>

<task type="auto">
  <name>Task 2: Package publishability audit and build verification</name>
  <files>packages/accordion/package.json</files>
  <action>
Audit the @lit-ui/accordion package.json for publishability by comparing against other published packages in the monorepo (e.g., @lit-ui/select, @lit-ui/core).

**Checklist to verify (read existing package.json and compare):**

1. `name`: "@lit-ui/accordion" -- correct
2. `version`: "1.0.0" -- correct for first publish
3. `type`: "module" -- correct
4. `main`: "dist/index.js" -- correct
5. `module`: "dist/index.js" -- correct
6. `types`: "dist/index.d.ts" -- correct
7. `exports`: Has "." entry with import and types -- correct
8. `files`: ["dist"] -- correct
9. `sideEffects`: true -- correct (custom element registration)
10. `peerDependencies`: lit ^3.0.0 and @lit-ui/core ^1.0.0 -- correct
11. `keywords`: Should include "accordion" -- add if missing

If "accordion" is not in keywords, add it. If all fields are present and correct, no changes needed.

**Build verification:**
Run the full build to confirm dist output is correct:
```bash
cd packages/accordion && pnpm build
```

Verify the dist directory contains:
- index.js (ESM bundle)
- index.d.ts (TypeScript declarations)
- accordion.js and accordion-item.js (or bundled into index.js)

Run a final TypeScript check:
```bash
cd packages/accordion && npx tsc --noEmit
```
  </action>
  <verify>Run `cd packages/accordion && pnpm build` -- build succeeds. Check `ls packages/accordion/dist/` for output files. Run `cd packages/accordion && npx tsc --noEmit` -- no errors. Verify package.json has all required fields for npm publish.</verify>
  <done>Package builds successfully with correct dist output. package.json has all required fields for npm publishability. TypeScript compiles without errors.</done>
</task>

</tasks>

<verification>
1. `cd packages/accordion && npx tsc --noEmit` -- TypeScript compiles
2. `cd packages/accordion && pnpm build` -- Build succeeds
3. `ls packages/accordion/dist/` -- Contains .js and .d.ts files
4. Grep for `isServer` in accordion-item.ts -- data-state guards present
5. No unguarded `document`/`window` references in accordion src files
6. package.json has: name, version, type, main, module, types, exports, files, sideEffects, peerDependencies
</verification>

<success_criteria>
- Accordion SSR: chevron renders in DSD output, data-state is client-only (isServer guarded), lazy mounting omits slot correctly
- Package: builds successfully, dist contains JS and DTS, package.json has all publishable fields
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/57-accordion-polish-package/57-02-SUMMARY.md`
</output>
