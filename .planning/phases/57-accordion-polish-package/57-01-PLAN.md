---
phase: 57-accordion-polish-package
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/accordion/src/accordion-item.ts
  - packages/accordion/src/jsx.d.ts
autonomous: true

must_haves:
  truths:
    - "Accordion items display an animated chevron that rotates 180deg on expand/collapse"
    - "Accordion items expose data-state='open' when expanded and data-state='closed' when collapsed"
    - "Accordion panel content with lazy attribute is not mounted until first expand, then preserved after collapse"
  artifacts:
    - path: "packages/accordion/src/accordion-item.ts"
      provides: "Chevron SVG, data-state reflection, lazy mounting logic"
      contains: "chevron"
    - path: "packages/accordion/src/jsx.d.ts"
      provides: "lazy attribute type declaration"
      contains: "lazy"
  key_links:
    - from: "packages/accordion/src/accordion-item.ts"
      to: "host element"
      via: "setAttribute in updated()"
      pattern: "data-state"
    - from: "packages/accordion/src/accordion-item.ts"
      to: "default slot"
      via: "conditional render with _hasBeenExpanded flag"
      pattern: "_hasBeenExpanded"
---

<objective>
Add chevron indicator with CSS rotation animation, data-state attribute reflection, and lazy mounting to accordion items.

Purpose: These three features complete the accordion's visual polish and developer ergonomics -- the chevron provides visual affordance for expand/collapse, data-state enables CSS-only consumer styling, and lazy mounting defers heavy panel content until needed.
Output: Updated accordion-item.ts with all three features and updated jsx.d.ts with lazy attribute type.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/accordion/src/accordion-item.ts
@packages/accordion/src/jsx.d.ts
@packages/select/src/select.ts (chevron SVG pattern reference -- search for `.chevron` CSS and `class="chevron"` in render)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Chevron indicator with CSS rotation animation</name>
  <files>packages/accordion/src/accordion-item.ts</files>
  <action>
Add an inline SVG chevron to the header button in accordion-item.ts, positioned after the header slot content.

**SVG markup** (place inside the button, after `<slot name="header"></slot>`):
```html
<svg
  class="chevron"
  viewBox="0 0 16 16"
  fill="none"
  stroke="currentColor"
  aria-hidden="true"
  part="chevron"
>
  <path
    d="M4 6l4 4 4-4"
    stroke-width="2"
    stroke-linecap="round"
    stroke-linejoin="round"
  />
</svg>
```

**CSS additions** (add to the existing static styles):
```css
.chevron {
  flex-shrink: 0;
  width: 1em;
  height: 1em;
  margin-left: auto;
  transition: transform var(--ui-accordion-transition, 200ms) ease;
}

:host([expanded]) .chevron {
  transform: rotate(180deg);
}
```

Also add to the existing `@media (prefers-reduced-motion: reduce)` block:
```css
.chevron {
  transition-duration: 0ms;
}
```

Key constraints:
- Use `part="chevron"` so consumers can style it via `::part(chevron)`
- Use `aria-hidden="true"` since the chevron is purely decorative
- Use `margin-left: auto` to push chevron to the right edge of the flex header button
- Use the SAME `--ui-accordion-transition` variable as the panel animation to keep them in sync
- The `.header-button` already has `display: flex; align-items: center;` so the chevron will vertically center automatically
  </action>
  <verify>Run `cd packages/accordion && npx tsc --noEmit` to verify TypeScript compiles. Visually inspect the render() method to confirm SVG is inside the button after the header slot.</verify>
  <done>Chevron SVG renders inside the header button with CSS rotation keyed to the expanded attribute, and prefers-reduced-motion disables the transition.</done>
</task>

<task type="auto">
  <name>Task 2: data-state attribute reflection and lazy mounting</name>
  <files>packages/accordion/src/accordion-item.ts, packages/accordion/src/jsx.d.ts</files>
  <action>
**Part A: data-state attribute**

Add an `updated()` lifecycle override to AccordionItem that sets `data-state` on the host element:

```typescript
protected override updated(changedProperties: PropertyValues): void {
  if (changedProperties.has('expanded')) {
    this.setAttribute('data-state', this.expanded ? 'open' : 'closed');
  }
}
```

Import `PropertyValues` from lit (add to the existing import: `import { html, css, nothing, type PropertyValues } from 'lit';`).

Also set the initial data-state in `connectedCallback()`:
```typescript
override connectedCallback(): void {
  super.connectedCallback();
  this.setAttribute('data-state', this.expanded ? 'open' : 'closed');
}
```

**Part B: Lazy mounting**

Add a `lazy` boolean property (NOT reflected, NOT reactive state):
```typescript
@property({ type: Boolean })
lazy = false;
```

Add a private flag (plain class field, NOT @state or @property):
```typescript
private _hasBeenExpanded = false;
```

In `updated()`, set the flag when expanded first becomes true:
```typescript
if (changedProperties.has('expanded') && this.expanded) {
  this._hasBeenExpanded = true;
}
```

In the render method, replace the bare `<slot></slot>` with a conditional:
```typescript
${this.lazy && !this._hasBeenExpanded && !this.expanded
  ? nothing
  : html`<slot></slot>`}
```

This means:
- If NOT lazy: always render the slot (existing behavior preserved)
- If lazy AND never expanded AND not currently expanded: render nothing (no DOM)
- If lazy AND has been expanded once: always render the slot (content preserved)

**Part C: Update jsx.d.ts**

Add `lazy?: boolean;` to the `LuiAccordionItemAttributes` interface.

Key constraints:
- `_hasBeenExpanded` is a plain class field, NOT `@state()` -- this avoids redundant re-renders since `expanded` changing already triggers re-render
- data-state must be on the HOST element (using `this.setAttribute`), not on a shadow DOM internal
- data-state is set client-side only (acceptable for SSR -- consumers can use `[expanded]` attribute for SSR styling)
  </action>
  <verify>Run `cd packages/accordion && npx tsc --noEmit` to verify TypeScript compiles. Grep for `data-state` and `_hasBeenExpanded` in accordion-item.ts to confirm both features are present. Grep for `lazy` in jsx.d.ts.</verify>
  <done>Accordion items reflect data-state="open"/"closed" on the host element when expanded changes. Lazy mounting gates default slot rendering behind a _hasBeenExpanded flag. jsx.d.ts includes the lazy attribute.</done>
</task>

</tasks>

<verification>
1. `cd packages/accordion && npx tsc --noEmit` -- TypeScript compiles without errors
2. `cd packages/accordion && pnpm build` -- Vite build succeeds
3. Verify accordion-item.ts contains:
   - SVG with `class="chevron"` and `part="chevron"` inside the header button
   - CSS for `.chevron` with transition and `:host([expanded]) .chevron` with rotate(180deg)
   - `this.setAttribute('data-state', ...)` in updated()
   - `lazy` property and `_hasBeenExpanded` field
   - Conditional slot rendering with `nothing` sentinel
4. Verify jsx.d.ts contains `lazy?: boolean` in LuiAccordionItemAttributes
</verification>

<success_criteria>
- Chevron SVG appears in header button after slot, rotates 180deg on expand via CSS transition
- data-state="open"/"closed" reflects on host element
- Lazy mounting prevents slot rendering until first expand, then preserves content
- TypeScript compiles and Vite build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/57-accordion-polish-package/57-01-SUMMARY.md`
</output>
