---
phase: 36-async-loading
plan: 06
type: execute
wave: 4
depends_on: ["36-02", "36-03", "36-04", "36-05"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "All async loading features verified working by human tester"
    - "Promise-based options show loading then resolve correctly"
    - "Error state with retry is functional"
    - "Async search debounces and cancels properly"
    - "Virtual scrolling maintains 60fps with large datasets"
    - "Infinite scroll loads more options at 80% scroll"
    - "Keyboard navigation works with all async modes"
---

<objective>
Human verification checkpoint for all Phase 36 async loading features.

Purpose: Ensure all async loading capabilities work correctly before completing the phase. This includes Promise-based options, error handling, async search, virtual scrolling, and infinite scroll pagination.

Output: Human-verified confirmation that all async features work as expected.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/36-async-loading/36-CONTEXT.md
@.planning/phases/36-async-loading/36-02-SUMMARY.md
@.planning/phases/36-async-loading/36-03-SUMMARY.md
@.planning/phases/36-async-loading/36-04-SUMMARY.md
@.planning/phases/36-async-loading/36-05-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete async loading functionality for Select component:

1. **Promise-based options (ASYNC-01, ASYNC-02)**
   - Options prop accepts Promise<SelectOption[]>
   - Skeleton loading placeholders during load
   - Resolved options display correctly

2. **Error handling with retry (ASYNC-03)**
   - Error state displays when Promise rejects
   - Retry button re-fetches options
   - Error slot for customization
   - Selection cleared on error

3. **Async search with debounce (ASYNC-04)**
   - asyncSearch callback with configurable debounce (300ms default)
   - minSearchLength threshold
   - AbortController prevents race conditions
   - Skeleton loading during search

4. **Virtual scrolling (ASYNC-06)**
   - VirtualizerController from @tanstack/lit-virtual
   - Always enabled for async modes
   - Smooth 60fps scrolling with large datasets
   - Keyboard navigation with scrollToIndex

5. **Infinite scroll pagination (ASYNC-05)**
   - loadMore callback for pagination
   - IntersectionObserver triggers at 80% scroll
   - Skeleton rows during loading more
   - Integrates with virtual scrolling
  </what-built>

  <how-to-verify>
Start the docs app and test async loading features:
```bash
cd /Users/sn0w/Documents/dev/lit-components
pnpm dev
```

Create a test page or use browser console on docs site:

**Test 1: Promise-based options with loading state**
```javascript
const select = document.createElement('lui-select');
select.placeholder = 'Loading...';
select.options = new Promise(resolve => {
  setTimeout(() => resolve([
    {value: '1', label: 'Apple'},
    {value: '2', label: 'Banana'},
    {value: '3', label: 'Cherry'}
  ]), 2000);
});
document.body.appendChild(select);
```
- [ ] Click select to open dropdown
- [ ] Verify skeleton placeholders appear for 2 seconds
- [ ] Verify options display after loading completes
- [ ] Verify selection works normally

**Test 2: Error state with retry**
```javascript
let attempts = 0;
const select2 = document.createElement('lui-select');
select2.placeholder = 'Error test';
select2.options = new Promise((_, reject) => {
  setTimeout(() => reject(new Error('Network error')), 1000);
});
document.body.appendChild(select2);
```
- [ ] Click select to open dropdown
- [ ] Verify error message appears after 1 second
- [ ] Verify "Try again" button is visible
- [ ] Click retry and verify loading state shows

**Test 3: Async search with debounce**
```javascript
const select3 = document.createElement('lui-select');
select3.searchable = true;
select3.debounceDelay = 500;
select3.minSearchLength = 2;
select3.asyncSearch = async (query, signal) => {
  console.log('Searching:', query);
  await new Promise(r => setTimeout(r, 800));
  signal.throwIfAborted();
  return [
    {value: 'r1', label: `Result for "${query}" - 1`},
    {value: 'r2', label: `Result for "${query}" - 2`}
  ];
};
document.body.appendChild(select3);
```
- [ ] Type "a" - should not trigger search (below minSearchLength)
- [ ] Type "ab" - should show loading after 500ms debounce
- [ ] Type "abc" quickly - should cancel previous and only show final results
- [ ] Verify skeleton placeholders during loading
- [ ] Verify results display correctly

**Test 4: Virtual scrolling with large dataset**
```javascript
const select4 = document.createElement('lui-select');
select4.placeholder = 'Virtual scroll test';
select4.options = new Promise(resolve => {
  const options = Array.from({length: 10000}, (_, i) => ({
    value: String(i),
    label: `Option ${i + 1}`
  }));
  resolve(options);
});
document.body.appendChild(select4);
```
- [ ] Open dropdown and verify smooth scrolling (no jank)
- [ ] Scroll rapidly up and down - should remain smooth
- [ ] Use keyboard (Arrow Down) to navigate - should scroll to follow focus
- [ ] Press End to jump to last option - should scroll smoothly
- [ ] Press Home to jump back to first option

**Test 5: Infinite scroll pagination**
```javascript
let page = 0;
const select5 = document.createElement('lui-select');
select5.placeholder = 'Infinite scroll test';
select5.options = new Promise(resolve => {
  resolve(Array.from({length: 30}, (_, i) => ({
    value: String(i),
    label: `Page 1 - Option ${i + 1}`
  })));
});
select5.loadMore = async () => {
  page++;
  console.log('Loading page:', page + 1);
  await new Promise(r => setTimeout(r, 1000));
  if (page >= 3) return []; // Stop after 4 pages
  return Array.from({length: 30}, (_, i) => ({
    value: String(page * 30 + i),
    label: `Page ${page + 1} - Option ${i + 1}`
  }));
};
document.body.appendChild(select5);
```
- [ ] Open dropdown and scroll down
- [ ] Verify loading skeletons appear when near bottom (~80%)
- [ ] Verify new options append to list after loading
- [ ] Continue scrolling to load more pages
- [ ] Verify loading stops after page 4 (loadMore returns [])

**Test 6: Multi-select with async features**
```javascript
const select6 = document.createElement('lui-select');
select6.multiple = true;
select6.searchable = true;
select6.placeholder = 'Multi async test';
select6.asyncSearch = async (query, signal) => {
  await new Promise(r => setTimeout(r, 500));
  signal.throwIfAborted();
  return Array.from({length: 50}, (_, i) => ({
    value: String(i),
    label: `${query} result ${i + 1}`
  }));
};
document.body.appendChild(select6);
```
- [ ] Type to search, verify loading state
- [ ] Select multiple options
- [ ] Verify checkbox indicators work
- [ ] Clear search and verify selections persist
- [ ] Use keyboard Space to toggle selections

**Test 7: Keyboard navigation in virtualized list**
- [ ] Navigate with Arrow Up/Down through entire virtualized list
- [ ] Verify active option always visible (scroll follows)
- [ ] Test Page Up/Down if implemented
- [ ] Test Home/End keys
- [ ] Test Enter to select
- [ ] Test Escape to close
  </how-to-verify>

  <resume-signal>
Type "approved" if all tests pass, or describe any issues found.
  </resume-signal>
</task>

</tasks>

<verification>
Human tester confirms all async loading features work correctly.
</verification>

<success_criteria>
- All 7 test scenarios pass
- Loading states show skeleton placeholders
- Error state with retry is functional
- Async search debounces correctly
- Virtual scrolling is smooth at 60fps
- Infinite scroll loads at 80% threshold
- Keyboard navigation works with all modes
- Multi-select works with async features
</success_criteria>

<output>
After completion, create `.planning/phases/36-async-loading/36-06-SUMMARY.md`
</output>
