---
phase: 21-theme-system-foundation
plan: 05
type: execute
wave: 3
depends_on: ["21-03", "21-04"]
files_modified:
  - packages/cli/src/theme/index.ts
  - packages/cli/tests/theme/integration.test.ts
autonomous: true

must_haves:
  truths:
    - "Full pipeline works: config -> encode -> decode -> CSS"
    - "Partial config with just primary color produces complete CSS"
    - "Theme module has clean public API"
    - "All exports documented with JSDoc"
  artifacts:
    - path: "packages/cli/src/theme/index.ts"
      provides: "Public API barrel file"
      exports: ["ThemeConfig", "themeConfigSchema", "defaultTheme", "encodeThemeConfig", "decodeThemeConfig", "generateThemeCSS"]
    - path: "packages/cli/tests/theme/integration.test.ts"
      provides: "End-to-end pipeline tests"
  key_links:
    - from: "packages/cli/src/theme/index.ts"
      to: "packages/cli/src/theme/schema.ts"
      via: "re-exports schema and types"
      pattern: "export.*from.*schema"
    - from: "packages/cli/src/theme/index.ts"
      to: "packages/cli/src/theme/encoding.ts"
      via: "re-exports encoding functions"
      pattern: "export.*from.*encoding"
    - from: "packages/cli/src/theme/index.ts"
      to: "packages/cli/src/theme/css-generator.ts"
      via: "re-exports CSS generator"
      pattern: "export.*from.*css-generator"
---

<objective>
Finalize the theme module with integration tests and clean public API.

Purpose: Verify the complete pipeline works end-to-end and ensure the module is ready for consumption by Phase 22 (CLI integration). This is the capstone that proves all components work together.

Output: Clean barrel file with documented exports and integration tests proving the full workflow.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-theme-system-foundation/21-CONTEXT.md
@.planning/phases/21-theme-system-foundation/21-RESEARCH.md
@.planning/phases/21-theme-system-foundation/21-01-SUMMARY.md
@.planning/phases/21-theme-system-foundation/21-02-SUMMARY.md
@.planning/phases/21-theme-system-foundation/21-03-SUMMARY.md
@.planning/phases/21-theme-system-foundation/21-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Finalize barrel file with JSDoc</name>
  <files>packages/cli/src/theme/index.ts</files>
  <action>
    Update packages/cli/src/theme/index.ts to be the definitive public API:

    1. Re-export types and schema from ./schema:
       - ThemeConfig (type)
       - themeConfigSchema (for advanced validation use)

    2. Re-export defaults from ./defaults:
       - defaultTheme

    3. Re-export encoding from ./encoding:
       - encodeThemeConfig
       - decodeThemeConfig

    4. Re-export CSS generation from ./css-generator:
       - generateThemeCSS

    5. Add JSDoc comments for each export explaining its purpose

    6. Add module-level JSDoc describing the theme system

    Note: Color scale utilities (generateScale, deriveDarkMode, deriveForeground)
    are internal implementation details, NOT exported from the public API.
    The css-generator uses them internally.
  </action>
  <verify>TypeScript compiles: pnpm exec tsc --noEmit -p packages/cli/tsconfig.json</verify>
  <done>Barrel file exports all public APIs with documentation</done>
</task>

<task type="auto">
  <name>Task 2: Write integration tests</name>
  <files>packages/cli/tests/theme/integration.test.ts</files>
  <action>
    Create integration tests that verify the complete pipeline:

    1. Full pipeline test:
       - Create a ThemeConfig
       - Encode it
       - Decode it (verify round-trip)
       - Generate CSS
       - Verify CSS contains expected variables

    2. Partial config test:
       - Create minimal config (just primary color)
       - Merge with defaults using defu
       - Generate CSS
       - Verify all variables present (defaults filled in)

    3. CLI simulation test:
       - Simulate what Phase 22 will do:
         - Parse encoded string from "command line"
         - Decode and validate
         - Generate CSS
         - Verify output is complete and valid

    4. Error propagation test:
       - Invalid encoded string -> descriptive error
       - Verify error message is actionable for CLI users

    Use vitest for testing (check if already in CLI package, otherwise add).
  </action>
  <verify>pnpm test --filter @lit-ui/cli</verify>
  <done>Integration tests pass, proving end-to-end pipeline works</done>
</task>

<task type="auto">
  <name>Task 3: Verify test infrastructure</name>
  <files>packages/cli/package.json, packages/cli/vitest.config.ts</files>
  <action>
    Ensure test infrastructure is in place:

    1. Check if vitest is already a dev dependency
       - If not: pnpm add -D vitest --filter @lit-ui/cli

    2. Check for vitest.config.ts
       - If not present, create minimal config:
         ```typescript
         import { defineConfig } from 'vitest/config';
         export default defineConfig({
           test: {
             globals: true,
           },
         });
         ```

    3. Add test script to package.json if not present:
       "test": "vitest run"
       "test:watch": "vitest"

    4. Run full test suite to verify all tests pass
  </action>
  <verify>pnpm test --filter @lit-ui/cli -- runs all tests successfully</verify>
  <done>Test infrastructure verified, all tests passing</done>
</task>

</tasks>

<verification>
```bash
# Run all theme tests
pnpm test --filter @lit-ui/cli

# Verify exports work
pnpm exec tsc --noEmit -p packages/cli/tsconfig.json

# Verify build works
pnpm build --filter @lit-ui/cli
```
</verification>

<success_criteria>
- All integration tests pass
- Full pipeline: encode -> decode -> CSS works
- Partial config merges correctly with defaults
- Error messages are descriptive
- Clean public API documented with JSDoc
- Build completes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/21-theme-system-foundation/21-05-SUMMARY.md`
</output>
