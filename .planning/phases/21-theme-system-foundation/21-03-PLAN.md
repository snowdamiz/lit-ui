---
phase: 21-theme-system-foundation
plan: 03
type: tdd
wave: 2
depends_on: ["21-01"]
files_modified:
  - packages/cli/src/theme/encoding.ts
  - packages/cli/tests/theme/encoding.test.ts
autonomous: true

must_haves:
  truths:
    - "Encoding produces URL-safe base64url string"
    - "Decoding reconstructs exact same config object"
    - "Invalid encoded strings fail with descriptive error"
    - "Malformed JSON in encoded string fails validation"
  artifacts:
    - path: "packages/cli/src/theme/encoding.ts"
      provides: "URL encoding/decoding utilities"
      exports: ["encodeThemeConfig", "decodeThemeConfig"]
  key_links:
    - from: "packages/cli/src/theme/encoding.ts"
      to: "packages/cli/src/theme/schema.ts"
      via: "imports schema for validation"
      pattern: "import.*themeConfigSchema.*from.*schema"
---

<objective>
Implement URL-safe encoding and decoding utilities for theme configurations.

Purpose: Enable theme configs to be passed as CLI parameters (--theme=<encoded>) without special characters breaking URLs or shell escaping. The encoded string must be decodable with standard tools for debugging.

Output: Tested encoding/decoding utilities using base64url that round-trip correctly and fail gracefully on invalid input.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-theme-system-foundation/21-CONTEXT.md
@.planning/phases/21-theme-system-foundation/21-RESEARCH.md
@.planning/phases/21-theme-system-foundation/21-01-SUMMARY.md
</context>

<feature>
  <name>Theme Config Encoding</name>
  <files>
    packages/cli/src/theme/encoding.ts
    packages/cli/tests/theme/encoding.test.ts
  </files>
  <behavior>
    encodeThemeConfig(config: ThemeConfig) -> string:
    - Input: Valid ThemeConfig object
    - Output: URL-safe base64url string (no +, /, or = padding)
    - Format: JSON.stringify -> Buffer.from(json, 'utf-8').toString('base64url')

    decodeThemeConfig(encoded: string) -> ThemeConfig:
    - Input: base64url encoded string
    - Output: Validated ThemeConfig object
    - Process: base64url decode -> JSON.parse -> Zod validate
    - Throws descriptive error for:
      - Invalid base64 (not decodable)
      - Invalid JSON (malformed after decode)
      - Invalid schema (doesn't match ThemeConfig)

    Round-trip guarantee:
    - decodeThemeConfig(encodeThemeConfig(config)) === config (deep equal)

    Error messages:
    - "Invalid theme encoding: unable to decode base64"
    - "Invalid theme encoding: malformed JSON"
    - "Invalid theme config: [zod error details]"
  </behavior>
  <implementation>
    1. Create packages/cli/src/theme/encoding.ts with:
       - Import themeConfigSchema, ThemeConfig from ./schema
       - encodeThemeConfig: JSON.stringify + Buffer base64url
       - decodeThemeConfig: Try/catch wrapper with descriptive errors
         - Decode base64url to string
         - Parse JSON
         - Validate with themeConfigSchema.safeParse()
         - Throw with detailed error if any step fails
    2. Write tests:
       - Round-trip with valid config
       - Encoding produces no URL-special chars
       - Decode invalid base64 -> specific error
       - Decode invalid JSON -> specific error
       - Decode invalid schema -> specific error
    3. Update theme/index.ts to export encoding utilities
  </implementation>
</feature>

<verification>
```bash
# Run tests
pnpm test --filter @lit-ui/cli

# Verify encoded strings are URL-safe
# Test should check: no '+', '/', or '=' in output
```
</verification>

<success_criteria>
- All encoding tests pass
- Round-trip works for valid configs
- Error messages are descriptive and actionable
- No URL-special characters in encoded output
</success_criteria>

<output>
After completion, create `.planning/phases/21-theme-system-foundation/21-03-SUMMARY.md`
</output>
