---
phase: 21-theme-system-foundation
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/cli/src/theme/color-scale.ts
  - packages/cli/tests/theme/color-scale.test.ts
  - packages/cli/package.json
autonomous: true

must_haves:
  truths:
    - "Scale generation produces 11 steps (50-950) from a base color"
    - "Generated colors remain within sRGB gamut"
    - "Achromatic colors (gray) do not produce NaN hue"
    - "Dark mode derivation inverts lightness correctly"
  artifacts:
    - path: "packages/cli/src/theme/color-scale.ts"
      provides: "OKLCH color manipulation utilities"
      exports: ["generateScale", "deriveDarkMode", "deriveForeground"]
  key_links:
    - from: "packages/cli/src/theme/color-scale.ts"
      to: "colorjs.io"
      via: "import Color from 'colorjs.io'"
      pattern: "import Color from 'colorjs.io'"
---

<objective>
Implement OKLCH color manipulation utilities for scale generation and dark mode derivation.

Purpose: These utilities transform base colors into full shade scales and automatically derive dark mode variants. This is the color science foundation that makes single-color input work for full theming.

Output: Tested color utilities using colorjs.io that produce correct OKLCH scales and handle edge cases (gamut clipping, achromatic colors).
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-theme-system-foundation/21-CONTEXT.md
@.planning/phases/21-theme-system-foundation/21-RESEARCH.md
@packages/core/src/styles/tailwind.css
</context>

<feature>
  <name>OKLCH Color Utilities</name>
  <files>
    packages/cli/src/theme/color-scale.ts
    packages/cli/tests/theme/color-scale.test.ts
  </files>
  <behavior>
    generateScale(baseColor: string) -> Record<string, string>:
    - Input: "oklch(0.62 0.18 250)" (brand-500 equivalent)
    - Output: { "50": "oklch(...)", "100": "oklch(...)", ..., "950": "oklch(...)" }
    - Scale follows lightness progression: 50 is lightest (~0.97), 950 is darkest (~0.20)
    - Chroma modulated to prevent oversaturation at extremes
    - All output colors are valid sRGB (gamut-mapped if needed)

    deriveDarkMode(lightColor: string) -> string:
    - Input: "oklch(0.62 0.18 250)"
    - Output: OKLCH string with inverted lightness (~0.38)
    - Chroma slightly reduced for dark mode (factor ~0.9)

    deriveForeground(backgroundColor: string) -> string:
    - Input: "oklch(0.62 0.18 250)"
    - Output: High-contrast foreground (light for dark bg, dark for light bg)
    - Uses lightness threshold (~0.5) to determine contrast direction

    Edge cases:
    - Achromatic input "oklch(0.5 0 0)" -> handles NaN hue, preserves gray
    - High chroma "oklch(0.6 0.4 30)" -> gamut-maps to displayable color
  </behavior>
  <implementation>
    1. Install colorjs.io: pnpm add colorjs.io --filter @lit-ui/cli
    2. Create packages/cli/src/theme/color-scale.ts with:
       - Import Color from colorjs.io
       - generateScale: Create 11 steps using lightness array [0.97, 0.94, 0.88, 0.79, 0.70, 0.62, 0.54, 0.46, 0.38, 0.28, 0.20]
       - Modulate chroma with sine wave or linear scale factor
       - Check inGamut('srgb') and call toGamut('srgb') if needed
       - Handle NaN hue explicitly: const hue = isNaN(color.oklch.h) ? 0 : color.oklch.h
       - deriveDarkMode: Invert lightness, reduce chroma
       - deriveForeground: Return near-white or near-black based on bg lightness
    3. Write comprehensive tests covering all behaviors
    4. Export from theme/index.ts (update barrel file)
  </implementation>
</feature>

<verification>
```bash
# Run tests
pnpm test --filter @lit-ui/cli

# Verify no TypeScript errors
pnpm exec tsc --noEmit -p packages/cli/tsconfig.json
```
</verification>

<success_criteria>
- All color utility tests pass
- Generated scales produce valid OKLCH strings
- Edge cases (achromatic, high chroma) handled without errors
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/21-theme-system-foundation/21-02-SUMMARY.md`
</output>
