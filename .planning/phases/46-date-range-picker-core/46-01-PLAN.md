---
phase: 46-date-range-picker-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/date-range-picker/package.json
  - packages/date-range-picker/tsconfig.json
  - packages/date-range-picker/vite.config.ts
  - packages/date-range-picker/src/vite-env.d.ts
  - packages/date-range-picker/src/range-utils.ts
  - packages/date-range-picker/src/range-utils.test.ts
  - packages/date-range-picker/src/date-range-picker.ts
  - packages/date-range-picker/src/index.ts
  - pnpm-workspace.yaml
autonomous: true

must_haves:
  truths:
    - "Range utility functions correctly compute isInRange, validateRangeDuration, and formatISOInterval"
    - "Date range picker component has two-click state machine (idle -> start-selected -> complete)"
    - "Package builds without errors and tests pass"
  artifacts:
    - path: "packages/date-range-picker/package.json"
      provides: "Package configuration with correct peer/dev dependencies"
      contains: "@lit-ui/date-range-picker"
    - path: "packages/date-range-picker/src/range-utils.ts"
      provides: "Range utility functions"
      exports: ["isDateInRange", "validateRangeDuration", "formatISOInterval", "RangeValidation"]
    - path: "packages/date-range-picker/src/date-range-picker.ts"
      provides: "DateRangePicker component class with state machine"
      exports: ["DateRangePicker"]
  key_links:
    - from: "packages/date-range-picker/src/date-range-picker.ts"
      to: "packages/date-range-picker/src/range-utils.ts"
      via: "import { isDateInRange, validateRangeDuration, formatISOInterval }"
      pattern: "import.*range-utils"
---

<objective>
Set up the @lit-ui/date-range-picker package with build infrastructure, range utility functions (with tests), and the core DateRangePicker component class with two-click range selection state machine.

Purpose: Foundation for the date range picker — package structure, tested utilities, and selection logic must exist before UI rendering.
Output: Buildable package with range-utils (tested), and DateRangePicker class with state machine handling date clicks.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/date-picker/package.json — Package structure pattern (peerDeps, devDeps, scripts, exports)
@packages/date-picker/tsconfig.json — TypeScript config pattern
@packages/date-picker/vite.config.ts — Vite config pattern
@packages/date-picker/src/date-picker.ts — ElementInternals pattern, property declarations
@packages/calendar/src/calendar.ts — DayCellState interface, renderDay callback API
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create package scaffolding</name>
  <files>
    packages/date-range-picker/package.json
    packages/date-range-picker/tsconfig.json
    packages/date-range-picker/vite.config.ts
    packages/date-range-picker/src/vite-env.d.ts
    pnpm-workspace.yaml
  </files>
  <action>
    Create the `packages/date-range-picker/` directory and scaffold package files following the exact pattern from `@lit-ui/date-picker`:

    1. **package.json**: Name `@lit-ui/date-range-picker`, version `1.0.0`, type `module`. Copy structure from date-picker's package.json exactly:
       - `main`, `module`, `types` pointing to `dist/index.js` and `dist/index.d.ts`
       - `exports` with `.` entry for import and types
       - `sideEffects: true`
       - `scripts`: `dev` (vite build --watch), `build` (vite build)
       - `peerDependencies`: `@lit-ui/calendar: ^1.0.0`, `@lit-ui/core: ^1.0.0`, `date-fns: ^4.0.0`, `lit: ^3.0.0`
       - `dependencies`: `@floating-ui/dom: ^1.7.4`
       - `devDependencies`: `@lit-ui/calendar: workspace:*`, `@lit-ui/core: workspace:*`, `@lit-ui/typescript-config: workspace:*`, `@lit-ui/vite-config: workspace:*`, `@tailwindcss/vite: ^4.1.18`, `date-fns: ^4.1.0`, `lit: ^3.3.2`, `tailwindcss: ^4.1.18`, `typescript: ^5.9.3`, `vite: ^7.3.1`, `vite-plugin-dts: ^4.5.4`, `vitest: ^4.0.18`
       - `keywords`: lit, web-components, ui, tailwind, ssr, date-range-picker, date-fns

    2. **tsconfig.json**: `extends: @lit-ui/typescript-config/library.json`, outDir `./dist`, rootDir `./src`, include `["src"]`

    3. **vite.config.ts**: `import { createLibraryConfig } from '@lit-ui/vite-config/library'; export default createLibraryConfig({ entry: 'src/index.ts' });`

    4. **src/vite-env.d.ts**: `/// <reference types="vite/client" />`

    5. **pnpm-workspace.yaml**: Verify `packages/date-range-picker` is included (it should already be covered by `packages/*` glob, but confirm).

    6. Run `pnpm install` from workspace root to link the new package.
  </action>
  <verify>
    Run `ls packages/date-range-picker/src/vite-env.d.ts` succeeds.
    Run `cat packages/date-range-picker/package.json | grep '@lit-ui/date-range-picker'` shows the package name.
  </verify>
  <done>Package directory exists with correct package.json, tsconfig.json, vite.config.ts, and vite-env.d.ts. pnpm install succeeds.</done>
</task>

<task type="auto">
  <name>Task 2: Range utility functions with tests</name>
  <files>
    packages/date-range-picker/src/range-utils.ts
    packages/date-range-picker/src/range-utils.test.ts
  </files>
  <action>
    Create `range-utils.ts` with the following exported functions and types:

    ```typescript
    import { parseISO, differenceInCalendarDays, isWithinInterval, isBefore, isAfter, startOfDay } from 'date-fns';

    export interface RangeValidation {
      valid: boolean;
      error: string;
    }

    /**
     * Check if a date falls within a start-end range (inclusive).
     * Returns false if either start or end is missing.
     */
    export function isDateInRange(dateISO: string, startISO: string, endISO: string): boolean

    /**
     * Validate range duration against optional min/max day constraints.
     * Returns { valid: true, error: '' } if valid.
     */
    export function validateRangeDuration(startISO: string, endISO: string, minDays?: number, maxDays?: number): RangeValidation

    /**
     * Format start and end dates as ISO 8601 interval: YYYY-MM-DD/YYYY-MM-DD
     * Returns empty string if either date is missing.
     */
    export function formatISOInterval(startISO: string, endISO: string): string

    /**
     * Check if a date falls within a hover preview range (from start to hovered, or hovered to start if before).
     * Returns false if rangeState is not 'start-selected' or hovered is empty.
     */
    export function isDateInPreview(dateISO: string, startISO: string, hoveredISO: string): boolean

    /**
     * Auto-swap start and end if end is before start. Returns [start, end] in correct order.
     */
    export function normalizeRange(startISO: string, endISO: string): [string, string]
    ```

    Implementation notes:
    - Use `parseISO` from date-fns to convert ISO strings to Date objects
    - Use `isWithinInterval` for range checks (handles edge cases)
    - Use `differenceInCalendarDays` for duration validation
    - Use `isBefore` for swap detection
    - All functions are pure (no side effects)

    Create `range-utils.test.ts` with vitest tests covering:
    - `isDateInRange`: date inside range, date outside, date on start/end boundary, missing start/end
    - `validateRangeDuration`: valid range, below minDays, above maxDays, negative duration, exact boundary
    - `formatISOInterval`: complete range, missing start, missing end, both missing
    - `isDateInPreview`: during start-selected state, hovered before start, hovered after start, empty hovered
    - `normalizeRange`: already ordered, needs swap, same date
  </action>
  <verify>
    Run `cd packages/date-range-picker && npx vitest run src/range-utils.test.ts` — all tests pass.
  </verify>
  <done>Range utility functions exported and all tests pass. Functions handle edge cases (boundary dates, missing values, auto-swap).</done>
</task>

<task type="auto">
  <name>Task 3: DateRangePicker component class with state machine</name>
  <files>
    packages/date-range-picker/src/date-range-picker.ts
    packages/date-range-picker/src/index.ts
  </files>
  <action>
    Create `date-range-picker.ts` with the DateRangePicker class extending TailwindElement. This plan focuses on the component shell with state machine — rendering comes in Plan 02.

    ```typescript
    import { html, css, nothing, isServer, type PropertyValues, type CSSResultGroup } from 'lit';
    import { property, state, query } from 'lit/decorators.js';
    import { TailwindElement, tailwindBaseStyles, dispatchCustomEvent } from '@lit-ui/core';
    import { parseISO, addMonths, subMonths, format } from 'date-fns';
    import { normalizeRange, validateRangeDuration, formatISOInterval, isDateInRange, isDateInPreview } from './range-utils.js';
    ```

    **State machine type:**
    ```typescript
    type RangeState = 'idle' | 'start-selected' | 'complete';
    ```

    **Properties (reflected attributes):**
    - `startDate: string = ''` — attribute: `start-date`, reflect: true. ISO 8601 start date.
    - `endDate: string = ''` — attribute: `end-date`, reflect: true. ISO 8601 end date.
    - `name: string = ''` — Form field name
    - `locale: string = ''` — BCP 47 locale tag
    - `placeholder: string = ''` — Custom placeholder
    - `label: string = ''` — Accessible label
    - `helperText: string = ''` — attribute: `helper-text`
    - `minDate: string = ''` — attribute: `min-date`. Minimum selectable date.
    - `maxDate: string = ''` — attribute: `max-date`. Maximum selectable date.
    - `minDays: number = 0` — attribute: `min-days`. Minimum range duration in days.
    - `maxDays: number = 0` — attribute: `max-days`. Maximum range duration in days (0 = unlimited).
    - `required: boolean = false` — reflect: true
    - `disabled: boolean = false` — reflect: true
    - `error: string = ''` — External error message

    **Internal state (@state):**
    - `rangeState: RangeState = 'idle'`
    - `hoveredDate: string = ''` — ISO string of currently hovered date for preview
    - `isOpen: boolean = false` — Popup state
    - `currentMonth: Date = new Date()` — First calendar's displayed month
    - `internalError: string = ''` — Validation error

    **Key methods (implement logic, rendering placeholder for now):**

    1. `handleDateClick(isoString: string)` — The state machine:
       - If `rangeState === 'idle' || rangeState === 'complete'`: set startDate = isoString, endDate = '', rangeState = 'start-selected'
       - If `rangeState === 'start-selected'`: use `normalizeRange(startDate, isoString)` for auto-swap (DRP-09), set both dates, rangeState = 'complete', clear hoveredDate, call `validateAndEmit()`

    2. `validateAndEmit()` — Validate with `validateRangeDuration` using minDays/maxDays, update internalError, dispatch `change` event with `{ startDate, endDate, isoInterval: formatISOInterval(...) }`, update form value.

    3. `handleDayHover(dateStr: string)` — If rangeState === 'start-selected', set hoveredDate.

    4. `clearHoverPreview()` — Set hoveredDate = ''.

    5. `handleClear()` — Reset all state to idle, dispatch change with null values.

    6. `get effectiveLocale(): string` — Return `this.locale || (!isServer ? navigator.language : 'en-US')`.

    7. `get hasError(): boolean` — Return `!!(this.error || this.internalError)`.

    8. `get displayError(): string` — Return `this.error || this.internalError`.

    **Render:** For now, render a minimal placeholder `html\`<div class="date-range-picker">Date Range Picker (rendering in Plan 02)</div>\`` — Plan 02 adds the full UI.

    **Styles:** Just `...tailwindBaseStyles` and `:host { display: block; }` for now.

    Create `index.ts` as a minimal stub:
    ```typescript
    // @lit-ui/date-range-picker
    export { DateRangePicker } from './date-range-picker.js';
    export { isDateInRange, isDateInPreview, validateRangeDuration, formatISOInterval, normalizeRange } from './range-utils.js';
    export type { RangeValidation } from './range-utils.js';
    export { TailwindElement, isServer } from '@lit-ui/core';
    import '@lit-ui/calendar';
    ```

    Do NOT register the custom element yet (Plan 05).

    Verify the package builds: `cd packages/date-range-picker && pnpm build`.
  </action>
  <verify>
    Run `cd packages/date-range-picker && pnpm build` — builds without errors.
    Run `ls packages/date-range-picker/dist/index.js` — dist exists.
  </verify>
  <done>DateRangePicker class exists with full state machine logic, properties, and utility imports. Package builds successfully. State machine handles idle -> start-selected -> complete transitions with auto-swap.</done>
</task>

</tasks>

<verification>
1. `cd packages/date-range-picker && pnpm build` — builds without TypeScript errors
2. `cd packages/date-range-picker && npx vitest run src/range-utils.test.ts` — all utility tests pass
3. `grep -r "handleDateClick" packages/date-range-picker/src/date-range-picker.ts` — state machine method exists
4. `grep -r "normalizeRange" packages/date-range-picker/src/date-range-picker.ts` — auto-swap integration exists
</verification>

<success_criteria>
- Package scaffolding matches date-picker pattern exactly
- Range utility functions are exported and all tests pass
- DateRangePicker class has properties, state machine, and builds without errors
- State machine transitions: idle -> start-selected -> complete with auto-swap
</success_criteria>

<output>
After completion, create `.planning/phases/46-date-range-picker-core/46-01-SUMMARY.md`
</output>
