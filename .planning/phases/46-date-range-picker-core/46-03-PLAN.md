---
phase: 46-date-range-picker-core
plan: 03
type: execute
wave: 3
depends_on: ["46-02"]
files_modified:
  - packages/date-range-picker/src/date-range-picker.ts
autonomous: true

must_haves:
  truths:
    - "User sees input field showing selected range as formatted text"
    - "User can open calendar popup by clicking input or calendar icon"
    - "User sees popup positioned via Floating UI with flip/shift"
    - "User can close popup with Escape key or clicking outside"
    - "User experiences focus trap inside popup and focus restoration on close"
  artifacts:
    - path: "packages/date-range-picker/src/date-range-picker.ts"
      provides: "Input field, popup with Floating UI, click-outside, focus trap"
      contains: "computePosition"
  key_links:
    - from: "packages/date-range-picker/src/date-range-picker.ts"
      to: "@floating-ui/dom"
      via: "computePosition with flip, shift, offset middleware"
      pattern: "computePosition"
---

<objective>
Add the input field display, calendar popup with Floating UI positioning, click-outside detection, focus trap, and Escape key handling to the DateRangePicker.

Purpose: The input field is the trigger UI for opening the calendar popup. Popup positioning, click-outside, and focus management are required for the component to be usable as a form control.
Output: Complete popup interaction — open, position, focus trap, close with Escape/click-outside, focus restoration.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-date-range-picker-core/46-01-SUMMARY.md
@.planning/phases/46-date-range-picker-core/46-02-SUMMARY.md
@packages/date-picker/src/date-picker.ts — Floating UI pattern (computePosition, flip, shift, offset), click-outside (composedPath), focus trap (Tab preventDefault + refocus), Escape handling, popup open/close, input rendering, trigger tracking
@.planning/phases/46-date-range-picker-core/46-RESEARCH.md — Pitfall 2 (event names), Pitfall 5 (keyboard hover preview)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Input field, display formatting, and popup toggle</name>
  <files>packages/date-range-picker/src/date-range-picker.ts</files>
  <action>
    Update the render() method to wrap the dual-calendar layout inside a popup container, and add an input field that triggers the popup.

    **Input field rendering:**
    - Add a label element (if `this.label` is set) using `<label for="${this.inputId}">`
    - Add an `.input-container` div containing:
      - A read-only `<input>` element displaying the formatted range (e.g., "Jan 15 – Jan 22, 2026")
      - A calendar icon button (SVG) as popup trigger
      - A clear button (X icon) when range is complete (rendered conditionally)
    - The input value is computed by a `get displayValue(): string` getter that formats start/end dates using `Intl.DateTimeFormat` with the effective locale (matching date-picker's approach — use Intl, not date-fns format)
    - Input has `readonly` attribute since users select via calendar, not typing
    - Input shows placeholder when no range selected

    **Display value formatting:**
    ```typescript
    private get displayValue(): string {
      if (!this.startDate || !this.endDate) {
        if (this.startDate) return this.formatDisplayDate(this.startDate) + ' – ...';
        return '';
      }
      return `${this.formatDisplayDate(this.startDate)} – ${this.formatDisplayDate(this.endDate)}`;
    }

    private formatDisplayDate(isoString: string): string {
      const date = parseISO(isoString);
      return new Intl.DateTimeFormat(this.effectiveLocale, {
        month: 'short', day: 'numeric', year: 'numeric'
      }).format(date);
    }
    ```

    **Popup toggle:**
    - `openPopup()`: Set `isOpen = true`, store trigger element for focus restoration, call `positionPopup()` after render (use `this.updateComplete.then(...)`)
    - `closePopup()`: Set `isOpen = false`, clear hover preview, restore focus to trigger element via `requestAnimationFrame`
    - `togglePopup()`: Toggle based on current state
    - Input click and calendar icon click both call `openPopup()`

    **Popup container:**
    - Wrap the dual-calendar layout in a `.popup` div with `display: ${this.isOpen ? 'block' : 'none'}`
    - The popup div contains the range-header, calendars-wrapper, and (in Plan 04) a footer with clear button
    - Use `position: fixed` for the popup (Floating UI fixed strategy)

    **Query refs:**
    - `@query('.input-container') inputContainerEl!: HTMLElement`
    - `@query('.popup') popupEl!: HTMLElement`
    - `@query('input') inputEl!: HTMLInputElement`

    **Unique input ID:**
    ```typescript
    private inputId = `lui-date-range-picker-${Math.random().toString(36).substr(2, 9)}`;
    ```

    **Styles additions:**
    ```css
    .input-container {
      display: flex; align-items: center; gap: 0.5rem;
      border: 1px solid var(--ui-range-border, #d1d5db);
      border-radius: var(--ui-range-radius, 0.375rem);
      padding: 0.5rem 0.75rem;
      background: var(--ui-range-bg, white);
      cursor: pointer;
    }
    .input-container:focus-within {
      outline: 2px solid var(--ui-range-focus-ring, var(--color-ring, #3b82f6));
      outline-offset: 2px;
    }
    input {
      border: none; outline: none; background: transparent;
      flex: 1; font: inherit; cursor: pointer;
      color: var(--ui-range-text, currentColor);
    }
    input::placeholder { color: var(--ui-range-placeholder, #9ca3af); }
    .popup {
      position: fixed; z-index: 50;
      background: var(--ui-range-popup-bg, white);
      border: 1px solid var(--ui-range-popup-border, #e5e7eb);
      border-radius: var(--ui-range-popup-radius, 0.5rem);
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
      padding: 0.75rem;
    }
    .icon-button {
      display: flex; align-items: center; justify-content: center;
      width: 1.5rem; height: 1.5rem;
      border: none; background: none; cursor: pointer;
      color: var(--ui-range-icon-color, #6b7280);
      border-radius: 0.25rem; padding: 0;
    }
    .icon-button:hover { color: var(--ui-range-icon-hover, #374151); }
    label {
      display: block; font-size: 0.875rem; font-weight: 500;
      margin-bottom: 0.25rem;
      color: var(--ui-range-label-color, currentColor);
    }
    ```

    **SVG icons:** Use inline SVG for the calendar icon (copy from date-picker) and X icon (copy from date-picker's clear button).
  </action>
  <verify>
    Run `cd packages/date-range-picker && pnpm build` — builds without errors.
    Grep for `inputContainerEl` — query ref exists.
    Grep for `Intl.DateTimeFormat` — display formatting uses Intl.
    Grep for `readonly` — input is readonly.
  </verify>
  <done>Input field renders with formatted range text, calendar icon trigger, and popup toggle. Display uses Intl.DateTimeFormat for locale-aware formatting.</done>
</task>

<task type="auto">
  <name>Task 2: Floating UI positioning, click-outside, focus trap, and Escape</name>
  <files>packages/date-range-picker/src/date-range-picker.ts</files>
  <action>
    Add popup positioning via Floating UI, click-outside detection, focus trap, and Escape key handling. Follow the **exact patterns** from `lui-date-picker` (Phase 44-03 and 44-04).

    **Floating UI positioning (Phase 44-03 pattern):**
    ```typescript
    import { computePosition, flip, shift, offset } from '@floating-ui/dom';

    private async positionPopup(): Promise<void> {
      if (!this.inputContainerEl || !this.popupEl) return;
      const { x, y } = await computePosition(this.inputContainerEl, this.popupEl, {
        placement: 'bottom-start',
        strategy: 'fixed',
        middleware: [offset(4), flip({ fallbackPlacements: ['top-start'] }), shift({ padding: 8 })],
      });
      Object.assign(this.popupEl.style, { left: `${x}px`, top: `${y}px` });
    }
    ```

    **Click-outside detection (Phase 44-03 pattern):**
    ```typescript
    private handleDocumentClick = (e: Event): void => {
      if (!this.isOpen) return;
      const path = e.composedPath();
      if (!path.includes(this)) {
        this.closePopup();
      }
    };
    ```
    - Add listener in `openPopup()`: `document.addEventListener('click', this.handleDocumentClick, true)`
    - Remove in `closePopup()`: `document.removeEventListener('click', this.handleDocumentClick, true)`
    - Also remove in `disconnectedCallback()`

    **Focus trap (Phase 44-04 pattern):**
    ```typescript
    private handlePopupKeydown = (e: KeyboardEvent): void => {
      if (e.key === 'Escape') {
        // Check if calendar view is drilling (defaultPrevented means calendar handled it)
        if (!e.defaultPrevented) {
          this.closePopup();
        }
        return;
      }
      if (e.key === 'Tab') {
        // Trap focus inside popup
        e.preventDefault();
        // Refocus the first calendar
        const calendar = this.popupEl?.querySelector('lui-calendar');
        if (calendar) {
          (calendar as HTMLElement).focus();
        }
      }
    };
    ```
    - Attach on popup div: `@keydown="${this.handlePopupKeydown}"`

    **Focus management:**
    - `openPopup()`: Store `this.triggerElement = document.activeElement as HTMLElement`, after positioning focus the first calendar in the popup
    - `closePopup()`: Restore focus via `requestAnimationFrame(() => this.triggerElement?.focus())`

    **Lifecycle:**
    - `disconnectedCallback()`: Remove document click listener if popup is open
    - When `isOpen` changes to true in `updated()`, call `positionPopup()` and focus first calendar

    **Disabled state:** If `this.disabled`, clicking the input does nothing. Add `aria-disabled` on the input container.
  </action>
  <verify>
    Run `cd packages/date-range-picker && pnpm build` — builds without errors.
    Grep for `computePosition` — Floating UI used.
    Grep for `composedPath` — click-outside detection.
    Grep for `Tab.*preventDefault` — focus trap.
    Grep for `triggerElement` — focus restoration tracking.
  </verify>
  <done>Popup positioned via Floating UI with flip/shift. Click-outside closes popup. Tab key trapped inside popup. Escape closes popup (unless calendar view drilling). Focus restored to trigger on close.</done>
</task>

</tasks>

<verification>
1. `cd packages/date-range-picker && pnpm build` — builds without errors
2. Input field shows formatted date range using Intl.DateTimeFormat
3. Popup positions via Floating UI with offset(4), flip, shift(8)
4. Click-outside uses `composedPath().includes(this)` for Shadow DOM compatibility
5. Tab key is trapped inside popup (preventDefault + refocus calendar)
6. Escape closes popup with focus restoration via requestAnimationFrame
</verification>

<success_criteria>
- Input field renders with formatted range text and calendar icon trigger
- Calendar popup opens on click and positions via Floating UI
- Click-outside closes popup
- Focus trap keeps Tab inside popup
- Escape key closes popup (respects calendar view drilling via defaultPrevented)
- Focus restores to trigger element after close
</success_criteria>

<output>
After completion, create `.planning/phases/46-date-range-picker-core/46-03-SUMMARY.md`
</output>
