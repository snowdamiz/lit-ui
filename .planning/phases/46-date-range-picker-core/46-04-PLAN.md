---
phase: 46-date-range-picker-core
plan: 04
type: execute
wave: 4
depends_on: ["46-03"]
files_modified:
  - packages/date-range-picker/src/date-range-picker.ts
autonomous: true

must_haves:
  truths:
    - "User can clear the selected range with a clear button"
    - "User sees validation error for min/max range duration violations"
    - "User can submit form with ISO 8601 interval value (YYYY-MM-DD/YYYY-MM-DD)"
    - "Form reset clears the range and resets state"
    - "Required validation prevents empty form submission"
  artifacts:
    - path: "packages/date-range-picker/src/date-range-picker.ts"
      provides: "Form integration, validation, clear button, error display"
      contains: "formAssociated"
  key_links:
    - from: "packages/date-range-picker/src/date-range-picker.ts"
      to: "ElementInternals"
      via: "setFormValue with ISO interval, setValidity for required/duration"
      pattern: "setFormValue.*formatISOInterval"
---

<objective>
Add form integration via ElementInternals (ISO 8601 interval submission), range duration validation (min/max days), clear button, error display, and helper text to the DateRangePicker.

Purpose: Form integration makes the component usable in real applications. Validation ensures data quality. Clear button provides reset capability.
Output: Fully form-integrated date range picker with validation feedback and clear functionality.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-date-range-picker-core/46-01-SUMMARY.md
@.planning/phases/46-date-range-picker-core/46-02-SUMMARY.md
@.planning/phases/46-date-range-picker-core/46-03-SUMMARY.md
@packages/date-picker/src/date-picker.ts — ElementInternals pattern (formAssociated, attachInternals, setFormValue, setValidity, formResetCallback, formStateRestoreCallback), error display, helper text, validation states
@.planning/phases/46-date-range-picker-core/46-RESEARCH.md — Pitfall 4 (auto-swap before validation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: ElementInternals form integration</name>
  <files>packages/date-range-picker/src/date-range-picker.ts</files>
  <action>
    Add full form participation via ElementInternals following the exact pattern from `lui-date-picker`.

    **Static property:**
    ```typescript
    static formAssociated = true;
    ```

    **Constructor (or connectedCallback with isServer guard):**
    ```typescript
    constructor() {
      super();
      if (!isServer) {
        this.internals = this.attachInternals();
      }
    }
    ```

    **updateFormValue() method:**
    ```typescript
    private updateFormValue(): void {
      if (!this.internals) return;
      if (this.startDate && this.endDate) {
        const isoInterval = formatISOInterval(this.startDate, this.endDate);
        this.internals.setFormValue(isoInterval);
      } else {
        this.internals.setFormValue(null);
      }
    }
    ```

    **Validation via setValidity():**
    Create a `validate()` method that checks:
    1. **Required:** If `this.required` and no complete range, set `valueMissing: true` with "Please select a date range"
    2. **Duration validation:** If range is complete and minDays/maxDays are set, use `validateRangeDuration()`. If invalid, set `customError: true` with the error message.
    3. **Valid:** Clear validity with `{}`

    ```typescript
    private validate(): void {
      if (!this.internals) return;
      const anchor = this.inputEl ?? undefined;

      if (this.required && (!this.startDate || !this.endDate)) {
        this.internals.setValidity({ valueMissing: true }, 'Please select a date range', anchor);
        this.internalError = this.required ? 'Please select a date range' : '';
        return;
      }

      if (this.startDate && this.endDate) {
        const result = validateRangeDuration(
          this.startDate,
          this.endDate,
          this.minDays || undefined,
          this.maxDays || undefined
        );
        if (!result.valid) {
          this.internals.setValidity({ customError: true }, result.error, anchor);
          this.internalError = result.error;
          return;
        }
      }

      this.internals.setValidity({});
      this.internalError = '';
    }
    ```

    **IMPORTANT — Pitfall 4:** In `validateAndEmit()`, validation MUST run AFTER auto-swap. The `handleDateClick` method already calls `normalizeRange()` before `validateAndEmit()`, so the final start/end values are validated.

    **Form lifecycle callbacks:**
    ```typescript
    formResetCallback(): void {
      this.startDate = '';
      this.endDate = '';
      this.hoveredDate = '';
      this.rangeState = 'idle';
      this.internalError = '';
      this.internals?.setFormValue(null);
      this.internals?.setValidity({});
    }

    formStateRestoreCallback(state: string): void {
      if (state && state.includes('/')) {
        const [start, end] = state.split('/');
        this.startDate = start;
        this.endDate = end;
        this.rangeState = 'complete';
        this.updateFormValue();
      }
    }
    ```

    **Update validateAndEmit():** After normalizing the range and setting startDate/endDate:
    1. Call `this.updateFormValue()`
    2. Call `this.validate()`
    3. Dispatch change event: `dispatchCustomEvent(this, 'change', { startDate: this.startDate, endDate: this.endDate, isoInterval: formatISOInterval(this.startDate, this.endDate) })`
    4. If validation passes and popup is open, close it

    **updated() lifecycle:** Call `validate()` when startDate, endDate, required, minDays, or maxDays change to keep validation in sync.
  </action>
  <verify>
    Grep for `formAssociated` — static property exists.
    Grep for `setFormValue` — form value updates.
    Grep for `setValidity` — validation updates.
    Grep for `formResetCallback` — form reset handler.
    Run `cd packages/date-range-picker && pnpm build` — builds without errors.
  </verify>
  <done>ElementInternals form integration complete. Form value submits as ISO 8601 interval (YYYY-MM-DD/YYYY-MM-DD). Required and duration validation with setValidity. Form reset clears all state.</done>
</task>

<task type="auto">
  <name>Task 2: Clear button, error display, and helper text</name>
  <files>packages/date-range-picker/src/date-range-picker.ts</files>
  <action>
    Add the clear button UI, error message display, and helper text to the component rendering.

    **Clear button (DRP-13):**
    - Render a clear (X) button inside the input container, visible only when `this.startDate` is truthy (range selection has begun)
    - On click, call `handleClear()` which resets all state, clears form value, and dispatches change with null values
    - Use the same X icon SVG as date-picker's clear button
    - Also add a clear button in the popup footer area for discoverability

    **handleClear() implementation:**
    ```typescript
    private handleClear(e?: Event): void {
      e?.stopPropagation(); // Prevent opening popup when clearing
      this.startDate = '';
      this.endDate = '';
      this.hoveredDate = '';
      this.rangeState = 'idle';
      this.internalError = '';
      this.updateFormValue();
      this.validate();
      this.inputEl?.focus();
      dispatchCustomEvent(this, 'change', {
        startDate: null,
        endDate: null,
        isoInterval: '',
      });
    }
    ```

    **Error display:**
    - Below the input container, render an error message div when `this.hasError`:
    ```html
    ${this.hasError ? html`
      <div class="error-message" role="alert">
        ${this.displayError}
      </div>
    ` : nothing}
    ```
    - Add `aria-invalid="true"` to the input when `hasError` is true
    - Add `aria-describedby` linking input to error message

    **Helper text:**
    - Below the input (and below error if both exist), render helper text:
    ```html
    ${this.helperText && !this.hasError ? html`
      <div class="helper-text">${this.helperText}</div>
    ` : nothing}
    ```

    **Selection status in popup:**
    - In the popup footer, show a status message:
      - idle: "Click a date to start selection"
      - start-selected: "Click a date to complete the range"
      - complete: show the formatted range with clear button

    **Styles additions:**
    ```css
    .error-message {
      font-size: 0.75rem;
      color: var(--ui-range-error-color, #ef4444);
      margin-top: 0.25rem;
    }
    .helper-text {
      font-size: 0.75rem;
      color: var(--ui-range-helper-color, #6b7280);
      margin-top: 0.25rem;
    }
    .input-container[aria-invalid="true"] {
      border-color: var(--ui-range-error-border, #ef4444);
    }
    .popup-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 0 0;
      margin-top: 0.5rem;
      border-top: 1px solid var(--ui-range-popup-border, #e5e7eb);
      font-size: 0.75rem;
      color: var(--ui-range-helper-color, #6b7280);
    }
    .clear-button {
      display: flex; align-items: center; gap: 0.25rem;
      font-size: 0.75rem; border: none; background: none;
      cursor: pointer; color: var(--ui-range-clear-color, #6b7280);
      padding: 0.25rem 0.5rem; border-radius: 0.25rem;
    }
    .clear-button:hover {
      background-color: var(--ui-range-clear-hover-bg, #f3f4f6);
      color: var(--ui-range-clear-hover-color, #374151);
    }
    ```

    **ARIA attributes on input container:**
    - Add `aria-invalid="${this.hasError}"` on the input element
    - Add `aria-label` or `aria-labelledby` linking to the label
    - Add `role="group"` on the host for semantic grouping
  </action>
  <verify>
    Run `cd packages/date-range-picker && pnpm build` — builds without errors.
    Grep for `handleClear` — clear handler exists.
    Grep for `error-message.*role="alert"` — accessible error display.
    Grep for `aria-invalid` — invalid state on input.
    Grep for `popup-footer` — popup footer with status and clear button.
  </verify>
  <done>Clear button resets range and dispatches change event. Error messages display with role="alert". Helper text shows below input. Popup footer shows selection status. Form validation triggers aria-invalid on error.</done>
</task>

</tasks>

<verification>
1. `cd packages/date-range-picker && pnpm build` — builds without errors
2. Form value is ISO 8601 interval format (YYYY-MM-DD/YYYY-MM-DD) via ElementInternals
3. Required validation prevents empty submission with "Please select a date range"
4. Min/max days validation shows appropriate error messages
5. Clear button resets all state and dispatches change with null values
6. Error display uses role="alert" for screen reader announcement
7. Validation runs AFTER auto-swap (Pitfall 4 addressed)
</verification>

<success_criteria>
- ElementInternals form integration with ISO 8601 interval value
- Required and duration validation with setValidity
- Form reset clears all state via formResetCallback
- Clear button visible when range started, resets everything
- Error messages display accessibly with aria-invalid and role="alert"
- Helper text and selection status messages render correctly
</success_criteria>

<output>
After completion, create `.planning/phases/46-date-range-picker-core/46-04-SUMMARY.md`
</output>
