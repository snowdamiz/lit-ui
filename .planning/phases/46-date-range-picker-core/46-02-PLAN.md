---
phase: 46-date-range-picker-core
plan: 02
type: execute
wave: 2
depends_on: ["46-01"]
files_modified:
  - packages/date-range-picker/src/date-range-picker.ts
autonomous: true

must_haves:
  truths:
    - "User sees two side-by-side calendars showing consecutive months"
    - "User can navigate months with prev/next buttons controlling both calendars"
    - "User can click a date on either calendar to start range selection"
    - "Selected range is visually highlighted between start and end dates"
    - "Start date shows rounded-left styling, end date shows rounded-right styling"
  artifacts:
    - path: "packages/date-range-picker/src/date-range-picker.ts"
      provides: "Full rendering with dual calendars, navigation, range CSS, and renderDay callback"
      contains: "renderRangeDay"
  key_links:
    - from: "packages/date-range-picker/src/date-range-picker.ts"
      to: "lui-calendar"
      via: "renderDay property binding and @change event listener"
      pattern: "\\.renderDay.*renderRangeDay"
    - from: "packages/date-range-picker/src/date-range-picker.ts"
      to: "range-utils.ts"
      via: "isDateInRange for highlighting"
      pattern: "isDateInRange"
---

<objective>
Implement the full rendering for the DateRangePicker: dual calendar layout with synchronized navigation, range highlighting via renderDay callback with inline styles, and start/end visual distinction with rounded corners.

Purpose: This is the core visual output — two calendars with range highlighting. Without this, the component has no UI.
Output: Fully rendered date range picker with clickable dual calendars, range CSS, and month navigation.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-date-range-picker-core/46-01-SUMMARY.md
@packages/calendar/src/calendar.ts — DayCellState interface, renderDay callback pattern
@packages/calendar/src/calendar-multi.ts — Dual calendar layout, nav button styles, display-month usage
@packages/date-picker/src/date-picker.ts — Popup pattern, input container, Floating UI usage
@.planning/phases/46-date-range-picker-core/46-RESEARCH.md — Pitfall 1 (Shadow DOM CSS), Pitfall 6 (same month)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dual calendar layout with synchronized navigation</name>
  <files>packages/date-range-picker/src/date-range-picker.ts</files>
  <action>
    Replace the placeholder render() in DateRangePicker with the full dual-calendar layout. Follow the CalendarMulti pattern from `calendar-multi.ts` but with custom renderDay integration.

    **Navigation header:**
    - Single row with prev button, range heading (e.g., "January – February 2026"), next button
    - Heading uses Intl.DateTimeFormat for month names, en-dash between months, year appended
    - If months span years, show both years: "December 2025 – January 2026"
    - Prev/next buttons use `addMonths`/`subMonths` on `this.currentMonth`

    **Calendar wrapper:**
    - Two `lui-calendar` instances side-by-side in a flexbox container
    - Left calendar: `display-month="${format(this.currentMonth, 'yyyy-MM-dd')}"`
    - Right calendar: `display-month="${format(addMonths(this.currentMonth, 1), 'yyyy-MM-dd')}"`
    - Both: `hide-navigation`, `.renderDay="${this.renderRangeDay}"`, `.locale="${this.effectiveLocale}"`
    - Both: forward `min-date`, `max-date` from host properties
    - Both: `@change="${this.handleCalendarSelect}"` — this calls `handleDateClick` with the ISO string from the event detail

    **handleCalendarSelect(e: Event):**
    ```typescript
    private handleCalendarSelect(e: Event): void {
      const detail = (e as CustomEvent).detail;
      if (!detail?.isoString) return;
      this.handleDateClick(detail.isoString);
    }
    ```

    **Styles (static CSS):**
    Use the same styling pattern as CalendarMulti for the header/nav, plus add range-specific styles.

    Container styles:
    ```css
    :host { display: block; }
    .range-header { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; }
    .range-heading { font-size: 0.875rem; font-weight: 600; }
    .calendars-wrapper { display: flex; gap: 1rem; flex-wrap: wrap; }
    .calendars-wrapper > * { min-width: 240px; flex: 1 1 280px; }
    ```

    Nav button styles: Copy exactly from CalendarMulti (`.nav-button` with hover, focus-visible, using --ui-calendar-* tokens).

    **IMPORTANT — Pitfall 6:** The second calendar MUST always show `addMonths(currentMonth, 1)`. Navigation moves `currentMonth`, second calendar follows.
  </action>
  <verify>
    Run `cd packages/date-range-picker && pnpm build` — builds without errors.
    Grep for `display-month` in date-range-picker.ts — two instances found (one per calendar).
    Grep for `hide-navigation` — both calendars have it.
  </verify>
  <done>Two lui-calendar instances render side-by-side with synchronized prev/next navigation. Navigation buttons control currentMonth, second calendar always shows currentMonth + 1.</done>
</task>

<task type="auto">
  <name>Task 2: Range highlighting via renderDay callback with inline styles</name>
  <files>packages/date-range-picker/src/date-range-picker.ts</files>
  <action>
    Implement the `renderRangeDay` callback method that `lui-calendar` calls for each day cell. This is the key mechanism for range visualization.

    **CRITICAL — Pitfall 1 (Shadow DOM CSS):** CSS classes defined in the date-range-picker's styles CANNOT reach inside the calendar's Shadow DOM. The renderDay callback renders INSIDE the calendar's Shadow DOM. Therefore, use **inline styles** on the rendered elements, not CSS classes. Use CSS custom properties for theming (they DO cascade through Shadow DOM).

    **renderRangeDay implementation:**
    ```typescript
    private renderRangeDay = (state: DayCellState) => {
      const dateStr = state.formattedDate; // 'yyyy-MM-dd' format
      const isStart = dateStr === this.startDate;
      const isEnd = dateStr === this.endDate;
      const inRange = this.startDate && this.endDate && isDateInRange(dateStr, this.startDate, this.endDate);
      const inPreview = this.rangeState === 'start-selected' && this.hoveredDate && isDateInPreview(dateStr, this.startDate, this.hoveredDate);

      // Build inline styles for Shadow DOM compatibility
      const styles: string[] = [
        'display: flex',
        'align-items: center',
        'justify-content: center',
        'width: 100%',
        'height: 100%',
        'transition: background-color 150ms',
      ];

      if (isStart && isEnd) {
        // Single day range - full circle
        styles.push('border-radius: 9999px');
        styles.push('background-color: var(--ui-range-selected-bg, var(--color-primary, #3b82f6))');
        styles.push('color: var(--ui-range-selected-text, white)');
      } else if (isStart) {
        // Start date - rounded left (DRP-07)
        styles.push('border-radius: 9999px 0 0 9999px');
        styles.push('background-color: var(--ui-range-selected-bg, var(--color-primary, #3b82f6))');
        styles.push('color: var(--ui-range-selected-text, white)');
      } else if (isEnd) {
        // End date - rounded right (DRP-08)
        styles.push('border-radius: 0 9999px 9999px 0');
        styles.push('background-color: var(--ui-range-selected-bg, var(--color-primary, #3b82f6))');
        styles.push('color: var(--ui-range-selected-text, white)');
      } else if (inRange) {
        // In-range days (DRP-03)
        styles.push('border-radius: 0');
        styles.push('background-color: var(--ui-range-highlight-bg, #dbeafe)');
        styles.push('color: var(--ui-range-highlight-text, inherit)');
      } else if (inPreview) {
        // Hover preview (DRP-06)
        styles.push('border-radius: 0');
        styles.push('background-color: var(--ui-range-preview-bg, #eff6ff)');
      }

      return html`
        <span
          style="${styles.join('; ')}"
          @mouseenter="${() => this.handleDayHover(dateStr)}"
        >
          ${state.date.getDate()}
        </span>
      `;
    };
    ```

    **Add @mouseleave on calendars wrapper (Pitfall 3):**
    On the `.calendars-wrapper` div, add `@mouseleave="${this.clearHoverPreview}"` to clear the hover preview when mouse leaves the calendar area.

    Import `DayCellState` type from `@lit-ui/calendar`:
    ```typescript
    import type { DayCellState } from '@lit-ui/calendar';
    ```

    Also import `html` from lit (already imported) and ensure `isDateInRange`, `isDateInPreview` are imported from range-utils.
  </action>
  <verify>
    Run `cd packages/date-range-picker && pnpm build` — builds without errors.
    Grep for `renderRangeDay` in date-range-picker.ts — method exists.
    Grep for `@mouseenter` — hover handler on day cells.
    Grep for `@mouseleave` — clear handler on wrapper.
    Grep for `inline.*style\|style=` — inline styles used (not CSS classes).
  </verify>
  <done>renderRangeDay callback renders day cells with inline styles for range-start (rounded-left), range-end (rounded-right), in-range (highlight), and in-preview (lighter highlight). Shadow DOM compatible via inline styles with CSS custom property fallbacks. Hover preview clears on mouse leave.</done>
</task>

</tasks>

<verification>
1. `cd packages/date-range-picker && pnpm build` — builds without errors
2. Two `lui-calendar` instances in render output with `display-month` and `hide-navigation`
3. `renderRangeDay` callback uses inline styles (not CSS classes) for Shadow DOM compatibility
4. Start date uses `border-radius: 9999px 0 0 9999px`, end date uses `0 9999px 9999px 0`
5. `@mouseleave` handler on calendars wrapper clears hover preview
</verification>

<success_criteria>
- Dual calendar layout renders with synchronized month navigation
- Range highlighting shows via inline styles through renderDay callback
- Start/end dates have distinct rounded corner styles (DRP-07, DRP-08)
- In-range days show highlight background (DRP-03)
- Hover preview shows lighter background during selection (DRP-06)
- Package builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/46-date-range-picker-core/46-02-SUMMARY.md`
</output>
