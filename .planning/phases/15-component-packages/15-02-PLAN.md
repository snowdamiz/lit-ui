---
phase: 15-component-packages
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/dialog/src/index.ts
  - packages/dialog/src/dialog.ts
  - packages/dialog/package.json
autonomous: true

must_haves:
  truths:
    - "Consumer can import Dialog from @lit-ui/dialog"
    - "Dialog showModal() works on client (no-op during SSR)"
    - "lui-dialog custom element is registered on import"
    - "TypeScript shows DialogSize, CloseReason autocomplete"
  artifacts:
    - path: "packages/dialog/src/dialog.ts"
      provides: "Dialog component with SSR guards"
      contains: "isServer"
    - path: "packages/dialog/src/index.ts"
      provides: "Package exports with safe registration"
      exports: ["Dialog", "DialogSize", "CloseReason"]
  key_links:
    - from: "packages/dialog/src/dialog.ts"
      to: "@lit-ui/core"
      via: "extends TailwindElement"
      pattern: "extends TailwindElement"
    - from: "packages/dialog/src/dialog.ts"
      to: "lit"
      via: "isServer import"
      pattern: "import.*isServer.*from 'lit'"
---

<objective>
Migrate Dialog component to @lit-ui/dialog package with SSR compatibility

Purpose: Enable consumers to install @lit-ui/dialog and use the Dialog component with full modal functionality on client-side, gracefully degraded during SSR.

Output: Complete Dialog component with SSR guards for showModal/close, type exports, and safe custom element registration
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-component-packages/15-CONTEXT.md
@.planning/phases/15-component-packages/15-RESEARCH.md

# Source component to migrate
@src.old/components/dialog/dialog.ts

# Core package for imports
@packages/core/src/index.ts
@packages/core/src/tailwind-element.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Dialog Component with SSR Guards</name>
  <files>packages/dialog/src/dialog.ts</files>
  <action>
Migrate dialog.ts from src.old/components/dialog/dialog.ts with these changes:

1. Update imports:
   - Change `import { TailwindElement } from '../../base/tailwind-element'` to `import { TailwindElement } from '@lit-ui/core'`
   - Add `import { isServer } from 'lit'` for SSR guards

2. Add isServer guards in updated() lifecycle:
   ```typescript
   override updated(changedProperties: Map<string, unknown>) {
     if (changedProperties.has('open')) {
       // Skip DOM manipulation during SSR
       if (isServer) return;

       if (this.open && !this.dialogEl.open) {
         this.dialogEl.showModal();
       } else if (!this.open && this.dialogEl.open) {
         this.dialogEl.close();
       }
     }
   }
   ```

3. Add isServer guard in show() method:
   ```typescript
   show() {
     // Only access document during client-side execution
     if (!isServer) {
       this.triggerElement = document.activeElement as HTMLElement;
     }
     this.open = true;
   }
   ```

4. Add isServer guard in handleNativeClose() for focus restoration:
   - Only attempt focus restoration when !isServer

5. Remove the @customElement decorator - registration will be in index.ts

6. Change tag name reference in HTMLElementTagNameMap from 'ui-dialog' to 'lui-dialog'

7. Export the types (DialogSize, CloseReason) from the class file

Keep all existing functionality: sizes, animations, backdrop click, escape handling, close button, slots.

Per CONTEXT.md decisions: Use simple no-op approach for SSR (no queueing).
  </action>
  <verify>
File exists at packages/dialog/src/dialog.ts with:
- `import { TailwindElement } from '@lit-ui/core'`
- `import { isServer } from 'lit'`
- `if (isServer) return` in updated() method
- isServer check in show() method
- No @customElement decorator
- `'lui-dialog': Dialog` in HTMLElementTagNameMap
  </verify>
  <done>Dialog component migrated with SSR-safe showModal/close pattern</done>
</task>

<task type="auto">
  <name>Task 2: Create Package Entry Point with Safe Registration</name>
  <files>packages/dialog/src/index.ts</files>
  <action>
Replace the stub index.ts with full package exports and safe custom element registration:

```typescript
// @lit-ui/dialog - Dialog component with SSR support
import { isServer } from 'lit';

// Export component class and types
export { Dialog } from './dialog.js';
export type { DialogSize, CloseReason } from './dialog.js';

// Re-export TailwindElement for convenience
export { TailwindElement, isServer } from '@lit-ui/core';

// Safe custom element registration with collision detection
import { Dialog } from './dialog.js';

if (!isServer && typeof customElements !== 'undefined') {
  if (!customElements.get('lui-dialog')) {
    customElements.define('lui-dialog', Dialog);
  } else if (process.env.NODE_ENV === 'development') {
    console.warn(
      '[lui-dialog] Custom element already registered. ' +
      'This may indicate duplicate imports or version conflicts.'
    );
  }
}

// TypeScript global type registration
declare global {
  interface HTMLElementTagNameMap {
    'lui-dialog': Dialog;
  }
}
```

Key patterns:
- Guard registration with !isServer check (no customElements during SSR)
- Check customElements.get() before define() to prevent collision errors
- Development warning for duplicate registration
- Re-export isServer and TailwindElement for consumer convenience
  </action>
  <verify>
File exists at packages/dialog/src/index.ts with:
- Export Dialog class and types
- isServer guard around customElements.define
- customElements.get() check before define
- HTMLElementTagNameMap declaration
  </verify>
  <done>Package entry point with safe custom element registration</done>
</task>

<task type="auto">
  <name>Task 3: Update Package.json Peer Dependencies</name>
  <files>packages/dialog/package.json</files>
  <action>
Update package.json to have @lit-ui/core as peer dependency (not regular dependency):

1. Move @lit-ui/core from dependencies to peerDependencies
2. Add @lit-ui/core to devDependencies as workspace:* for local development
3. Ensure lit is already in peerDependencies (it should be)

Final structure:
```json
{
  "peerDependencies": {
    "lit": "^3.0.0",
    "@lit-ui/core": "^0.0.1"
  },
  "devDependencies": {
    "@lit-ui/core": "workspace:*",
    // ... rest of dev deps
  }
}
```

Remove the dependencies field if it only had @lit-ui/core.

This ensures consumers don't get duplicate copies of core package.
  </action>
  <verify>
Run: `cat packages/dialog/package.json | grep -A5 peerDependencies`
Should show both "lit" and "@lit-ui/core" in peerDependencies
  </verify>
  <done>Package.json has correct peer dependency on @lit-ui/core</done>
</task>

</tasks>

<verification>
After all tasks:
1. `pnpm --filter @lit-ui/dialog build` succeeds without errors
2. `ls packages/dialog/dist/` shows index.js, index.d.ts, dialog.js, dialog.d.ts
3. `grep -l "isServer" packages/dialog/src/*.ts` shows dialog.ts and index.ts
4. `grep "lui-dialog" packages/dialog/src/index.ts` shows registration code
</verification>

<success_criteria>
- Dialog component has isServer guards for showModal(), close(), document access
- Safe custom element registration with collision detection
- @lit-ui/core is peer dependency, not regular dependency
- Build produces .js and .d.ts files
- No @customElement decorator (registration is in index.ts)
</success_criteria>

<output>
After completion, create `.planning/phases/15-component-packages/15-02-SUMMARY.md`
</output>
