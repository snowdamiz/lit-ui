---
phase: 19-publishing
plan: 03
type: execute
wave: 2
depends_on: ["19-01", "19-02"]
files_modified:
  - .github/workflows/release.yml
autonomous: true

must_haves:
  truths:
    - "Push to main triggers release workflow"
    - "Workflow creates version PR when changesets exist"
    - "Merging version PR publishes to npm"
    - "GitHub Releases created with changelog"
  artifacts:
    - path: ".github/workflows/release.yml"
      provides: "Changesets release automation"
      min_lines: 30
      contains: "changesets/action"
  key_links:
    - from: ".github/workflows/release.yml"
      to: "npm registry"
      via: "pnpm ci:publish script"
      pattern: "ci:publish"
    - from: ".github/workflows/release.yml"
      to: "GitHub Releases"
      via: "createGithubReleases flag"
      pattern: "createGithubReleases"
---

<objective>
Create GitHub Actions workflow for automated npm publishing.

Purpose: Automate version bumping, changelog generation, and npm publishing via changesets/action.
Output: Working CI/CD pipeline that publishes on merge to main.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-publishing/19-CONTEXT.md
@.planning/phases/19-publishing/19-RESEARCH.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions release workflow</name>
  <files>.github/workflows/release.yml</files>
  <action>
Create the .github/workflows directory and release.yml file:

```yaml
name: Release

on:
  push:
    branches:
      - main

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for changelog generation

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build

      - name: Create Release PR or Publish
        uses: changesets/action@v1
        with:
          publish: pnpm ci:publish
          title: 'chore: version packages'
          commit: 'chore: version packages'
          createGithubReleases: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
```

Key decisions (per CONTEXT.md and RESEARCH.md):
- fetch-depth: 0 for full git history (changelog generation)
- pnpm@10 matches packageManager in root package.json
- Uses existing ci:publish script which includes --access public
- createGithubReleases: true creates GitHub Releases automatically
- NPM_TOKEN secret required (human action in next plan)
  </action>
  <verify>
```bash
test -f .github/workflows/release.yml && echo "Workflow exists"
cat .github/workflows/release.yml | grep -E "(changesets/action|ci:publish|NPM_TOKEN)" | wc -l
```
Should show 3 (all three patterns present).
  </verify>
  <done>release.yml exists with changesets/action, ci:publish, NPM_TOKEN configuration</done>
</task>

<task type="auto">
  <name>Task 2: Verify full build and changeset configuration</name>
  <files>No files modified - verification only</files>
  <action>
Run verification commands to ensure publishing infrastructure is ready:

1. Build all packages:
```bash
pnpm build
```

2. Verify changeset config recognizes all packages:
```bash
pnpm changeset status
```

3. Check that published files are correct:
```bash
# List what would be published for each package
for pkg in core button dialog ssr cli; do
  echo "=== packages/$pkg ==="
  npm pack --dry-run --pack-destination /tmp ./packages/$pkg 2>&1 | head -20
done
```

4. Verify workflow syntax:
```bash
# Just check YAML is valid (GitHub Actions will validate further)
cat .github/workflows/release.yml | head -50
```

If any errors occur, fix them before marking complete.
  </action>
  <verify>
```bash
pnpm build && echo "Build passed"
```
All packages build successfully.
  </verify>
  <done>All packages build, changeset config valid, workflow ready for NPM_TOKEN</done>
</task>

</tasks>

<verification>
1. .github/workflows/release.yml exists and is valid YAML
2. Workflow uses changesets/action@v1
3. Workflow references NPM_TOKEN secret
4. All packages build successfully
5. pnpm changeset status shows all packages
</verification>

<success_criteria>
- `.github/workflows/release.yml` exists
- `pnpm build` succeeds
- Workflow contains changesets/action, NPM_TOKEN, ci:publish
</success_criteria>

<output>
After completion, create `.planning/phases/19-publishing/19-03-SUMMARY.md`
</output>
