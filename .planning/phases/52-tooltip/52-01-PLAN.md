---
phase: 52-tooltip
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/tooltip/package.json
  - packages/tooltip/tsconfig.json
  - packages/tooltip/vite.config.ts
  - packages/tooltip/src/vite-env.d.ts
  - packages/tooltip/src/delay-group.ts
  - packages/tooltip/src/tooltip.ts
  - packages/tooltip/src/index.ts
  - packages/tooltip/src/jsx.d.ts
autonomous: true

must_haves:
  truths:
    - "Hovering a trigger element shows a tooltip after a configurable delay (default 300ms), positioned with Floating UI collision avoidance and an optional arrow"
    - "Keyboard-focusing the trigger shows the tooltip, pressing Escape dismisses it, and screen readers announce tooltip content via aria-describedby"
    - "Moving between adjacent tooltips skips the show delay within 300ms of last close (delay group behavior)"
    - "Touch device pointer events (pointerType === 'touch') do not trigger tooltip display"
    - "The tooltip component extends TailwindElement with CSS custom properties (--ui-tooltip-*) and SSR safety via isServer guard"
    - "AbortController cleans up document-level listeners in disconnectedCallback, autoUpdate cleanup prevents memory leaks"
  artifacts:
    - path: "packages/tooltip/package.json"
      provides: "@lit-ui/tooltip package definition"
      contains: "@lit-ui/tooltip"
    - path: "packages/tooltip/src/tooltip.ts"
      provides: "Main tooltip web component"
      exports: ["Tooltip"]
    - path: "packages/tooltip/src/delay-group.ts"
      provides: "Module-level delay group singleton"
      exports: ["delayGroup"]
    - path: "packages/tooltip/src/index.ts"
      provides: "Public exports with custom element registration"
      contains: "customElements.define"
  key_links:
    - from: "packages/tooltip/src/tooltip.ts"
      to: "@lit-ui/core/floating"
      via: "import computePosition, autoUpdatePosition, flip, shift, offset, arrow"
      pattern: "computePosition"
    - from: "packages/tooltip/src/tooltip.ts"
      to: "packages/tooltip/src/delay-group.ts"
      via: "import delayGroup singleton for delay coordination"
      pattern: "delayGroup"
    - from: "packages/tooltip/src/index.ts"
      to: "packages/tooltip/src/tooltip.ts"
      via: "re-export and custom element registration"
      pattern: "lui-tooltip"
---

<objective>
Create the `@lit-ui/tooltip` package with the full tooltip web component implementation covering all 17 requirements (TIP-01 through TIP-16). This is the core component authoring plan -- all infrastructure (Floating UI wrapper, CSS tokens, animation patterns) was built in Phase 51.

Purpose: Deliver a complete, accessible tooltip component that developers can use via `<lui-tooltip content="text"><button>Trigger</button></lui-tooltip>`.

Output: A fully functional `packages/tooltip/` package with tooltip component, delay group module, package scaffolding, and JSX type declarations.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52-tooltip/52-RESEARCH.md
@.planning/phases/51-shared-infrastructure/51-02-SUMMARY.md

# Key reference files for conventions
@packages/switch/package.json
@packages/switch/tsconfig.json
@packages/switch/vite.config.ts
@packages/switch/src/index.ts
@packages/switch/src/jsx.d.ts
@packages/switch/src/vite-env.d.ts
@packages/core/src/floating/index.ts
@packages/core/src/tokens/index.ts
@packages/core/src/styles/overlay-animation.css
@packages/dialog/src/dialog.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tooltip package scaffolding and delay group module</name>
  <files>
    packages/tooltip/package.json
    packages/tooltip/tsconfig.json
    packages/tooltip/vite.config.ts
    packages/tooltip/src/vite-env.d.ts
    packages/tooltip/src/delay-group.ts
  </files>
  <action>
    Create the `packages/tooltip/` directory and scaffolding files following the exact conventions from `packages/switch/`:

    **package.json:** Copy the switch package.json pattern exactly. Change name to `@lit-ui/tooltip`, description to "Accessible tooltip component built with Lit and Tailwind CSS". Same peerDependencies (`lit: ^3.0.0`, `@lit-ui/core: ^1.0.0`), same devDependencies (workspace refs for core, typescript-config, vite-config; same versions of tailwindcss, vite, typescript, vite-plugin-dts, @tailwindcss/vite), same scripts (dev/build), same exports map, same sideEffects/type/module/main/types/files fields. Repository directory: `packages/tooltip`.

    **tsconfig.json:** Identical to switch -- extends `@lit-ui/typescript-config/library.json`, outDir `./dist`, rootDir `./src`, baseUrl `.`, include `["src"]`.

    **vite.config.ts:** Identical to switch -- `import { createLibraryConfig } from '@lit-ui/vite-config/library'; export default createLibraryConfig({ entry: 'src/index.ts' });`

    **vite-env.d.ts:** `/// <reference types="vite/client" />`

    **delay-group.ts:** Implement the `TooltipDelayGroup` class as a module-level singleton (see RESEARCH.md Pattern 2):
    - Private `lastCloseTimestamp: number = 0`
    - Private `activeInstance: { hide(): void } | null = null` (tracks currently-open tooltip to force-close on new open)
    - Private `windowMs: number = 300` (delay group window)
    - `notifyClosed()`: Sets `lastCloseTimestamp = Date.now()`, clears `activeInstance`
    - `isInGroupWindow()`: Returns `Date.now() - this.lastCloseTimestamp < this.windowMs`
    - `setActive(instance)`: If `activeInstance` exists and differs from new instance, calls `activeInstance.hide()`. Then sets `activeInstance = instance`.
    - `clearActive(instance)`: If `activeInstance === instance`, sets to null.
    - Export `const delayGroup = new TooltipDelayGroup()` singleton.
    - Export the interface type `TooltipInstance = { hide(): void }` so tooltip.ts can implement it.

    After creating files, run `pnpm install` from the workspace root to link the new package.
  </action>
  <verify>
    Run `ls packages/tooltip/src/` to confirm all files exist. Run `pnpm install` succeeds. Run `pnpm --filter @lit-ui/tooltip build` -- it will fail (no index.ts/tooltip.ts yet) but the package should be recognized by pnpm.
  </verify>
  <done>
    Package scaffolding files exist with correct conventions. delay-group.ts exports `delayGroup` singleton and `TooltipInstance` type. pnpm recognizes the @lit-ui/tooltip workspace package.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement tooltip component with full accessibility and positioning</name>
  <files>
    packages/tooltip/src/tooltip.ts
    packages/tooltip/src/index.ts
    packages/tooltip/src/jsx.d.ts
  </files>
  <action>
    **tooltip.ts** -- Create the `Tooltip` class extending `TailwindElement` with all requirements TIP-01 through TIP-16. Follow the Dialog component pattern for structure. Use `css` tagged template literal for static styles (NOT external CSS file -- inline in the component like dialog.ts).

    **Properties (reactive):**
    - `@property({ type: String }) content = ''` -- tooltip text content
    - `@property({ type: String }) placement: Placement = 'top'` -- 12 Floating UI placement options (TIP-04)
    - `@property({ type: Number, attribute: 'show-delay' }) showDelay = 300` -- hover show delay in ms (TIP-01)
    - `@property({ type: Number, attribute: 'hide-delay' }) hideDelay = 100` -- hide delay for cursor bridge (TIP-11)
    - `@property({ type: Boolean }) arrow = true` -- show arrow indicator (TIP-05)
    - `@property({ type: Number }) offset = 8` -- distance from trigger in px
    - `@property({ type: Boolean }) rich = false` -- rich tooltip variant with title+description (TIP-10)
    - `@property({ type: String }) title = ''` -- title for rich variant (TIP-10) -- NOTE: use a different internal name to avoid conflict with HTMLElement.title; use `@property({ attribute: 'tooltip-title' })` or similar. Actually, since this is Shadow DOM and the property won't conflict, name it `tooltipTitle` with attribute `tooltip-title`.
    - `@property({ type: Boolean }) disabled = false` -- disable tooltip display

    **Internal state:**
    - `@state() private open = false`
    - Private fields: `triggerEl: HTMLElement | null`, `showTimeout`, `hideTimeout`, `cleanupAutoUpdate`, `abortController`

    **Render method:**
    Use the wrapper pattern from RESEARCH.md Pattern 1:
    - Outer `<div class="tooltip-trigger" part="trigger">` wrapping a `<slot>` with event handlers (`@slotchange`, `@pointerenter`, `@pointerleave`, `@focusin`, `@focusout`, `@keydown`)
    - Conditionally render tooltip panel when `this.open && !isServer` (TIP-14 SSR safety):
      ```
      ${this.open && !isServer ? html`<div id="tooltip" role="tooltip" part="tooltip" class="tooltip-panel" @pointerenter=${...} @pointerleave=${...}>...</div>` : nothing}
      ```
    - Inside tooltip panel: content div with text content. For rich variant (`this.rich`), render title div + description div. Support both property text and named slots (`slot="title"`, `slot="content"`).
    - Arrow element when `this.arrow` is true: `<div class="tooltip-arrow" part="arrow"></div>`

    **Event handlers:**
    Implement all handlers from RESEARCH.md "Complete Show/Hide State Machine":
    - `handleSlotChange(e)`: Find first assigned element, store as `this.triggerEl`.
    - `handlePointerEnter(e: PointerEvent)`: Bail if `e.pointerType === 'touch'` (TIP-12) or `this.disabled`. Call `scheduleShow()`.
    - `handlePointerLeave(e: PointerEvent)`: Bail if `e.pointerType === 'touch'`. Call `scheduleHide()`.
    - `handleFocusIn()`: Call `scheduleShow()` (TIP-02).
    - `handleFocusOut()`: Call `scheduleHide()`.
    - `handleKeyDown(e: KeyboardEvent)`: If Escape and open, prevent default, call `hide()`, notify delay group (TIP-03).
    - `handleTooltipPointerEnter()`: Cancel scheduled hide (TIP-11 cursor bridge).
    - `handleTooltipPointerLeave()`: Call `scheduleHide()`.

    **Show/hide state machine:**
    - `scheduleShow()`: Clear hide timeout. If already open, return. Check `delayGroup.isInGroupWindow()` for 0 delay vs `this.showDelay` (TIP-09). Set show timeout.
    - `scheduleHide()`: Clear show timeout. If not open, return. Set hide timeout that calls `hide()` then `delayGroup.notifyClosed()`.
    - `show()`: Set `this.open = true`. Set `aria-describedby="tooltip"` on `this.triggerEl` (TIP-06). Call `delayGroup.setActive(this)`. After `this.updateComplete`, call `updatePosition()` then `startAutoUpdate()` (TIP-08).
    - `hide()`: Set `this.open = false`. Remove `aria-describedby` from `this.triggerEl`. Call `this.cleanupAutoUpdate?.()`. Call `delayGroup.clearActive(this)`. Clear both timeouts.

    **Positioning (TIP-04, TIP-05, TIP-08):**
    - `updatePosition()`: Query `this.renderRoot.querySelector('#tooltip')` for tooltipEl and `.tooltip-arrow` for arrowEl. Build middleware array: `[offset(this.offset), flip(), shift({ padding: 8 })]`. If `this.arrow && arrowEl`, push `arrow({ element: arrowEl, padding: 4 })`. Call `computePosition(this.triggerEl, tooltipEl, { placement: this.placement, strategy: 'fixed', middleware })`. Apply x/y to tooltipEl.style. If arrow, position arrow element using `middlewareData.arrow` data -- calculate staticSide from resolved placement (top->bottom, bottom->top, left->right, right->left), apply x/y and staticSide offset of `-4px`.
    - `startAutoUpdate()`: Call `autoUpdatePosition(this.triggerEl, tooltipEl, () => this.updatePosition())`. Store cleanup function.

    **Lifecycle (TIP-15):**
    - `connectedCallback()`: Call super. If isServer, return. Create `this.abortController = new AbortController()`.
    - `disconnectedCallback()`: Call super. `this.abortController?.abort()`. `this.cleanupAutoUpdate?.()`. Clear both timeouts. If open, hide and notify delay group.

    **Static styles:**
    Use `css` tagged template with all styles from RESEARCH.md "CSS Styles with Token Variables" section:
    - `:host { display: inline-block; position: relative; }`
    - `.tooltip-panel` with `position: fixed`, `z-index: var(--ui-tooltip-z-index)`, `pointer-events: auto`, `max-width: var(--ui-tooltip-max-width)`, fade animation using `@starting-style` pattern from overlay-animation.css tooltip example.
    - `.tooltip-content` with token variables for bg, text, radius, padding, font-size, shadow.
    - Rich variant styles (`:host([rich]) .tooltip-content` with larger padding, `.tooltip-title` bold, `.tooltip-description` slightly transparent).
    - Arrow styles with absolute positioning, rotation, background matching tooltip bg.
    - `@media (prefers-reduced-motion: reduce)` disabling transitions (TIP-13).
    - Include `tailwindBaseStyles` from `@lit-ui/core` in the styles array: `static styles = [tailwindBaseStyles, css\`...\`]`.

    **Imports:**
    ```typescript
    import { html, css, nothing, type PropertyValues } from 'lit';
    import { property, state } from 'lit/decorators.js';
    import { TailwindElement, tailwindBaseStyles, isServer } from '@lit-ui/core';
    import { computePosition, autoUpdatePosition, flip, shift, offset, arrow, type Placement } from '@lit-ui/core/floating';
    import { delayGroup, type TooltipInstance } from './delay-group.js';
    ```

    Export `Tooltip` class and `type Placement` re-export for consumer convenience.

    **index.ts** -- Follow the switch/index.ts pattern exactly:
    - `/// <reference path="./jsx.d.ts" />`
    - Import isServer from lit
    - Export `{ Tooltip }` from `./tooltip.js`
    - Export `type { Placement }` from `./tooltip.js`
    - Re-export `{ TailwindElement, isServer }` from `@lit-ui/core`
    - Import Tooltip, safe custom element registration with `lui-tooltip` tag
    - Global HTMLElementTagNameMap declaration

    **jsx.d.ts** -- Follow the switch/jsx.d.ts pattern:
    - Import `Tooltip` type from `./tooltip.js` and `Placement` from `@lit-ui/core/floating`
    - `LuiTooltipAttributes` interface with: `content?: string`, `placement?: Placement`, `'show-delay'?: number`, `'hide-delay'?: number`, `arrow?: boolean`, `offset?: number`, `rich?: boolean`, `'tooltip-title'?: string`, `disabled?: boolean`
    - React JSX `IntrinsicElements` for `'lui-tooltip'`
    - Vue `GlobalComponents` for `'lui-tooltip'`
    - Svelte `svelteHTML.IntrinsicElements` for `'lui-tooltip'`
  </action>
  <verify>
    Run `pnpm --filter @lit-ui/tooltip build` -- must succeed with no errors. Verify `packages/tooltip/dist/index.js` exists and contains the Tooltip class. Verify `packages/tooltip/dist/index.d.ts` exists with type exports. Check that the built output references `@lit-ui/core/floating` as an external (not bundled).
  </verify>
  <done>
    The @lit-ui/tooltip package builds successfully. tooltip.ts implements all requirements TIP-01 through TIP-16: hover trigger with delay (TIP-01), focus trigger (TIP-02), Escape dismissal (TIP-03), Floating UI positioning with 12 placements (TIP-04), arrow indicator (TIP-05), aria-describedby (TIP-06), non-interactive content (TIP-07), autoUpdate repositioning (TIP-08), delay group (TIP-09), rich variant (TIP-10), hide delay cursor bridge (TIP-11), touch device filtering (TIP-12), reduced-motion respect (TIP-13), SSR safety (TIP-14), AbortController cleanup (TIP-15), CSS custom properties (TIP-16).
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @lit-ui/tooltip build` succeeds with zero errors
2. `ls packages/tooltip/dist/` shows index.js, index.d.ts, tooltip.js, tooltip.d.ts, delay-group.js, delay-group.d.ts
3. Built output externalizes `@lit-ui/core`, `@lit-ui/core/floating`, and `lit` (not bundled)
4. `grep -r "role=\"tooltip\"" packages/tooltip/src/tooltip.ts` confirms ARIA role
5. `grep -r "aria-describedby" packages/tooltip/src/tooltip.ts` confirms ARIA linking
6. `grep -r "pointerType.*touch" packages/tooltip/src/tooltip.ts` confirms touch filtering
7. `grep -r "AbortController" packages/tooltip/src/tooltip.ts` confirms cleanup pattern
8. `grep -r "prefers-reduced-motion" packages/tooltip/src/tooltip.ts` confirms motion respect
9. `grep -r "isServer" packages/tooltip/src/tooltip.ts` confirms SSR guard
</verification>

<success_criteria>
The @lit-ui/tooltip package exists with a fully implemented tooltip component that:
- Builds cleanly as part of the pnpm workspace
- Implements all 16 functional requirements (TIP-01 through TIP-16)
- Uses @lit-ui/core/floating for Shadow DOM-safe positioning
- Uses --ui-tooltip-* CSS custom properties for theming
- Has proper TypeScript types and JSX declarations for React/Vue/Svelte
</success_criteria>

<output>
After completion, create `.planning/phases/52-tooltip/52-01-SUMMARY.md`
</output>
