---
phase: 29-textarea-component
plan: 02
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - packages/textarea/src/textarea.ts
  - packages/textarea/src/jsx.d.ts
  - packages/input/src/input.ts
  - packages/input/src/jsx.d.ts
autonomous: true

must_haves:
  truths:
    - "Textarea with autoresize grows taller as user types more lines"
    - "Textarea with autoresize never shrinks below initial rows value"
    - "Textarea with maxlength and showCount displays character count"
    - "Character count updates as user types"
    - "Input with maxlength and showCount displays character count"
  artifacts:
    - path: "packages/textarea/src/textarea.ts"
      provides: "Auto-resize and character counter functionality"
      contains: "autoresize|showCount|adjustHeight"
    - path: "packages/input/src/input.ts"
      provides: "Character counter for Input component"
      contains: "showCount|character-count"
  key_links:
    - from: "packages/textarea/src/textarea.ts"
      to: "scrollHeight"
      via: "auto-resize calculation"
      pattern: "scrollHeight"
    - from: "packages/textarea/src/textarea.ts"
      to: "maxlength"
      via: "character count display"
      pattern: "showCount.*maxlength|maxlength.*showCount"
---

<objective>
Add auto-resize functionality and character counter to Textarea, and add character counter to Input.

Purpose: Enable developers to create textareas that grow with content and show remaining character counts for user feedback.
Output: Textarea with smooth auto-resize and character counter; Input with character counter (INPUT-17).
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/29-textarea-component/29-CONTEXT.md
@.planning/phases/29-textarea-component/29-RESEARCH.md
@.planning/phases/29-textarea-component/29-01-SUMMARY.md
@packages/textarea/src/textarea.ts
@packages/input/src/input.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add auto-resize functionality to Textarea</name>
  <files>packages/textarea/src/textarea.ts</files>
  <action>
Add auto-resize behavior that grows the textarea to fit content.

**New Properties:**
```typescript
/**
 * Whether the textarea auto-resizes to fit content.
 * When enabled, resize handle is hidden.
 * @default false
 */
@property({ type: Boolean })
autoresize = false;

/**
 * Maximum number of rows when auto-resizing.
 * Takes precedence after maxHeight.
 */
@property({ type: Number, attribute: 'max-rows' })
maxRows?: number;

/**
 * Maximum height when auto-resizing (CSS value like "200px" or "10rem").
 * Takes precedence over maxRows if both are set.
 */
@property({ type: String, attribute: 'max-height' })
maxHeight?: string;
```

**Auto-Resize Implementation:**

Add to `firstUpdated()`:
```typescript
protected firstUpdated() {
  if (this.autoresize) {
    this.adjustHeight();
  }
}
```

Add `adjustHeight()` method:
```typescript
/**
 * Adjust textarea height to fit content.
 * Only active when autoresize is enabled.
 */
private adjustHeight(): void {
  if (!this.autoresize || !this.textareaEl) return;

  const textarea = this.textareaEl;
  const minHeight = this.getMinHeight();

  // Reset height to get accurate scrollHeight
  textarea.style.height = 'auto';

  // Calculate new height
  let newHeight = textarea.scrollHeight;

  // Apply max height constraint if set
  const maxHeightPx = this.getMaxHeightPx();
  if (maxHeightPx && newHeight > maxHeightPx) {
    newHeight = maxHeightPx;
    textarea.style.overflowY = 'auto';
  } else {
    textarea.style.overflowY = 'hidden';
  }

  // Never shrink below initial rows
  if (newHeight < minHeight) {
    newHeight = minHeight;
  }

  textarea.style.height = `${newHeight}px`;
}

/**
 * Get minimum height based on rows attribute.
 */
private getMinHeight(): number {
  const computed = getComputedStyle(this.textareaEl);
  const lineHeight = parseFloat(computed.lineHeight) || 20;
  const paddingTop = parseFloat(computed.paddingTop) || 0;
  const paddingBottom = parseFloat(computed.paddingBottom) || 0;
  const borderTop = parseFloat(computed.borderTopWidth) || 0;
  const borderBottom = parseFloat(computed.borderBottomWidth) || 0;
  return (this.rows * lineHeight) + paddingTop + paddingBottom + borderTop + borderBottom;
}

/**
 * Get max height in pixels from maxHeight or maxRows.
 * maxHeight takes precedence if both are set.
 */
private getMaxHeightPx(): number | null {
  if (this.maxHeight) {
    // Parse CSS value - create temp element for conversion
    const temp = document.createElement('div');
    temp.style.height = this.maxHeight;
    temp.style.position = 'absolute';
    temp.style.visibility = 'hidden';
    document.body.appendChild(temp);
    const height = temp.offsetHeight;
    document.body.removeChild(temp);
    return height > 0 ? height : null;
  }
  if (this.maxRows) {
    const computed = getComputedStyle(this.textareaEl);
    const lineHeight = parseFloat(computed.lineHeight) || 20;
    const paddingTop = parseFloat(computed.paddingTop) || 0;
    const paddingBottom = parseFloat(computed.paddingBottom) || 0;
    const borderTop = parseFloat(computed.borderTopWidth) || 0;
    const borderBottom = parseFloat(computed.borderBottomWidth) || 0;
    return (this.maxRows * lineHeight) + paddingTop + paddingBottom + borderTop + borderBottom;
  }
  return null;
}
```

**Update handleInput:**
Add `this.adjustHeight();` after value update:
```typescript
private handleInput(e: Event): void {
  const textarea = e.target as HTMLTextAreaElement;
  this.value = textarea.value;
  this.updateFormValue();

  // Auto-resize if enabled
  if (this.autoresize) {
    this.adjustHeight();
  }

  // Re-validate if already touched
  if (this.touched) {
    const isValid = this.validate();
    this.showError = !isValid;
  }
}
```

**Update formResetCallback:**
Add height adjustment after reset:
```typescript
formResetCallback(): void {
  this.value = '';
  this.touched = false;
  this.showError = false;
  this.internals?.setFormValue('');
  this.internals?.setValidity({});
  if (this.autoresize) {
    // Use requestAnimationFrame to ensure DOM updated
    requestAnimationFrame(() => this.adjustHeight());
  }
}
```

**Update CSS:**
Add autoresize styles:
```css
/* Auto-resize mode - hide resize handle, smooth transition */
textarea.autoresize {
  resize: none;
  overflow-y: hidden;
  transition: height 150ms ease-out,
              border-color var(--ui-textarea-transition),
              box-shadow var(--ui-textarea-transition);
}
```

**Update getTextareaClasses:**
```typescript
private getTextareaClasses(): string {
  const classes = [`textarea-${this.size}`];

  if (this.autoresize) {
    classes.push('autoresize');
  } else {
    classes.push(`resize-${this.resize}`);
  }

  if (this.showError) {
    classes.push('textarea-error');
  }

  return classes.join(' ');
}
```
  </action>
  <verify>
```bash
grep -E "autoresize|adjustHeight|maxRows|maxHeight|scrollHeight" packages/textarea/src/textarea.ts
```
Shows autoresize property, adjustHeight method, and scrollHeight usage.
  </verify>
  <done>Textarea auto-resizes when autoresize attribute is set, respects min rows and max height.</done>
</task>

<task type="auto">
  <name>Task 2: Add character counter to Textarea</name>
  <files>packages/textarea/src/textarea.ts</files>
  <action>
Add character counter display for textareas with maxlength.

**New Property:**
```typescript
/**
 * Whether to show character count when maxlength is set.
 * Displays "current/max" format (e.g., "45/200").
 * @default false
 */
@property({ type: Boolean, attribute: 'show-count' })
showCount = false;
```

**Add CSS for character counter:**
```css
/* Character counter - positioned inside textarea bottom-right */
.textarea-container {
  position: relative;
  display: inline-block;
  width: 100%;
}

.character-count {
  position: absolute;
  bottom: 0.5rem;
  right: 0.75rem;
  font-size: 0.75rem;
  color: var(--color-muted-foreground);
  pointer-events: none;
  background: var(--ui-textarea-bg);
  padding: 0 0.25rem;
}

/* Extra bottom padding when counter is shown to avoid text overlap */
textarea.has-counter {
  padding-bottom: 1.75rem;
}
```

**Add renderCharacterCount method:**
```typescript
/**
 * Render the character counter if showCount and maxlength are set.
 */
private renderCharacterCount() {
  if (!this.showCount || !this.maxlength) return nothing;

  return html`
    <span class="character-count" part="counter">
      ${this.value.length}/${this.maxlength}
    </span>
  `;
}
```

**Update getTextareaClasses:**
Add `has-counter` class when counter is shown:
```typescript
if (this.showCount && this.maxlength) {
  classes.push('has-counter');
}
```

**Update render template:**
Wrap textarea in container div and add character count:
```typescript
render() {
  return html`
    <div class="textarea-wrapper" part="wrapper">
      ${this.label ? html`...` : nothing}
      ${this.helperText ? html`...` : nothing}

      <div class="textarea-container">
        <textarea ...></textarea>
        ${this.renderCharacterCount()}
      </div>

      ${this.showError && this.errorMessage ? html`...` : nothing}
    </div>
  `;
}
```
  </action>
  <verify>
```bash
grep -E "showCount|character-count|renderCharacterCount" packages/textarea/src/textarea.ts
```
Shows showCount property, character-count CSS class, and render method.
  </verify>
  <done>Textarea displays character count when showCount=true and maxlength is set.</done>
</task>

<task type="auto">
  <name>Task 3: Add character counter to Input component</name>
  <files>
    packages/input/src/input.ts
    packages/input/src/jsx.d.ts
    packages/textarea/src/jsx.d.ts
  </files>
  <action>
Add character counter to Input component (INPUT-17 requirement).

**packages/input/src/input.ts:**

Add property:
```typescript
/**
 * Whether to show character count when maxlength is set.
 * Displays "current/max" format (e.g., "45/200").
 * @default false
 */
@property({ type: Boolean, attribute: 'show-count' })
showCount = false;
```

Add CSS (after .suffix-slot styles):
```css
/* Character counter */
.character-count {
  font-size: 0.75rem;
  color: var(--color-muted-foreground);
  padding-right: var(--ui-input-padding-x-md);
  white-space: nowrap;
}

.container-sm .character-count {
  padding-right: var(--ui-input-padding-x-sm);
}

.container-lg .character-count {
  padding-right: var(--ui-input-padding-x-lg);
}
```

Add renderCharacterCount method:
```typescript
/**
 * Render the character counter if showCount and maxlength are set.
 */
private renderCharacterCount() {
  if (!this.showCount || !this.maxlength) return nothing;

  return html`
    <span class="character-count" part="counter">
      ${this.value.length}/${this.maxlength}
    </span>
  `;
}
```

Update render() - add after clear button and before suffix slot:
```typescript
${this.clearable && this.value ? this.renderClearButton() : nothing}
${this.renderCharacterCount()}
<slot name="suffix" part="suffix" class="input-slot suffix-slot"></slot>
```

**packages/input/src/jsx.d.ts:**

Add to LuiInputAttributes interface:
```typescript
'show-count'?: boolean;
```

**packages/textarea/src/jsx.d.ts:**

Add to LuiTextareaAttributes interface:
```typescript
autoresize?: boolean;
'max-rows'?: number;
'max-height'?: string;
'show-count'?: boolean;
```
  </action>
  <verify>
```bash
grep -E "showCount|show-count" packages/input/src/input.ts packages/input/src/jsx.d.ts packages/textarea/src/jsx.d.ts
```
Shows showCount property in both components and JSX type declarations.
  </verify>
  <done>Input component displays character counter when showCount=true and maxlength is set; JSX types updated.</done>
</task>

</tasks>

<verification>
After all tasks complete:

```bash
# Rebuild both packages
cd /Users/sn0w/Documents/dev/lit-components && pnpm --filter @lit-ui/textarea build && pnpm --filter @lit-ui/input build

# Verify both builds succeed
ls packages/textarea/dist/index.js packages/input/dist/index.js

# TypeScript check both packages
pnpm --filter @lit-ui/textarea exec tsc --noEmit && pnpm --filter @lit-ui/input exec tsc --noEmit

# Grep for key features
grep -E "autoresize|showCount|adjustHeight|scrollHeight" packages/textarea/src/textarea.ts
grep -E "showCount|character-count" packages/input/src/input.ts
```

Both packages build successfully with auto-resize and character counter features.
</verification>

<success_criteria>
1. Textarea autoresize property enables auto-growing behavior
2. Textarea respects rows as minimum height, maxRows/maxHeight as maximum
3. Textarea height transitions smoothly (150ms) when content changes
4. Textarea showCount displays "current/max" character count
5. Input showCount displays "current/max" character count
6. Both packages build without TypeScript errors
7. JSX type declarations include new properties
</success_criteria>

<output>
After completion, create `.planning/phases/29-textarea-component/29-02-SUMMARY.md`
</output>
