---
phase: 47-date-range-picker-advanced
plan: 04
type: execute
wave: 3
depends_on: ["47-02", "47-03"]
files_modified:
  - packages/date-range-picker/src/date-range-picker.ts
autonomous: true

must_haves:
  truths:
    - "User can enable comparison mode via comparison property"
    - "User sees toggle buttons to switch between Primary Range and Comparison Range"
    - "User can select a comparison range independently from the primary range"
    - "Comparison range uses distinct amber/orange color scheme"
    - "Form submission includes both ranges as pipe-delimited ISO intervals"
    - "Change event payload includes compareStartDate, compareEndDate, compareIsoInterval when comparison mode active"
  artifacts:
    - path: "packages/date-range-picker/src/date-range-picker.ts"
      provides: "Comparison mode with dual range selection and distinct styling"
      contains: "selectionTarget"
  key_links:
    - from: "renderRangeDay"
      to: "comparison range styling"
      via: "Checks both primary and comparison ranges for styling"
      pattern: "compareStartDate|compareEndDate|inCompareRange"
    - from: "comparison toggle"
      to: "selectionTarget state"
      via: "Buttons toggle between 'primary' and 'comparison'"
      pattern: "selectionTarget"
    - from: "handleDateClick"
      to: "selectionTarget"
      via: "Routes date selection to primary or comparison range based on target"
      pattern: "this.selectionTarget"
    - from: "validateAndEmit"
      to: "setFormValue"
      via: "Pipe-delimited format when comparison active"
      pattern: "\\|"
---

<objective>
Add comparison mode to the date range picker for selecting two independent date ranges.

Purpose: Comparison mode enables analytics use cases like "compare this month vs last month" (DRP-20), a critical feature for data analysis workflows.
Output: Updated date-range-picker.ts with comparison properties, toggle UI, dual-range rendering, and updated form/event payloads.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/date-range-picker/src/date-range-picker.ts
@packages/date-range-picker/src/range-utils.ts
@.planning/phases/47-date-range-picker-advanced/47-02-SUMMARY.md
@.planning/phases/47-date-range-picker-advanced/47-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add comparison mode properties, state, and selection routing</name>
  <files>packages/date-range-picker/src/date-range-picker.ts</files>
  <action>
    Add comparison mode to the DateRangePicker component:

    1. Add public properties for comparison mode:
    ```typescript
    @property({ type: Boolean, reflect: true })
    comparison = false;

    @property({ type: String, reflect: true, attribute: 'compare-start-date' })
    compareStartDate = '';

    @property({ type: String, reflect: true, attribute: 'compare-end-date' })
    compareEndDate = '';
    ```

    2. Add internal state for which range is being selected:
    ```typescript
    @state()
    private selectionTarget: 'primary' | 'comparison' = 'primary';

    @state()
    private compareRangeState: RangeState = 'idle';
    ```

    3. Update handleDateClick to route selection based on selectionTarget:
    The existing method handles primary range. Add branching at the top:
    ```typescript
    handleDateClick(isoString: string): void {
      if (this.disabled) return;

      if (this.comparison && this.selectionTarget === 'comparison') {
        this.handleComparisonDateClick(isoString);
        return;
      }

      // ...existing primary range logic unchanged...
    }
    ```

    4. Add handleComparisonDateClick with same state machine pattern:
    ```typescript
    private handleComparisonDateClick(isoString: string): void {
      if (this.compareRangeState === 'idle' || this.compareRangeState === 'complete') {
        this.compareStartDate = isoString;
        this.compareEndDate = '';
        this.compareRangeState = 'start-selected';
      } else if (this.compareRangeState === 'start-selected') {
        const [normalizedStart, normalizedEnd] = normalizeRange(this.compareStartDate, isoString);
        this.compareStartDate = normalizedStart;
        this.compareEndDate = normalizedEnd;
        this.hoveredDate = '';
        this.compareRangeState = 'complete';
        this.validateAndEmit();
      }
    }
    ```

    5. Update handleDragStart and handleDragEnd to also route based on selectionTarget. In handleDragStart, if comparison and selectionTarget is comparison, set compareStartDate instead of startDate. In handleDragEnd, similarly complete the comparison range.

    6. Update handleDayHover to track hover for whichever range is being selected:
    ```typescript
    handleDayHover(dateStr: string): void {
      const activeState = this.comparison && this.selectionTarget === 'comparison'
        ? this.compareRangeState
        : this.rangeState;
      if (activeState === 'start-selected') {
        this.hoveredDate = dateStr;
      }
    }
    ```

    7. Update validateAndEmit to include comparison fields in event payload:
    ```typescript
    // In the dispatchCustomEvent call:
    dispatchCustomEvent(this, 'change', {
      startDate: this.startDate,
      endDate: this.endDate,
      isoInterval: formatISOInterval(this.startDate, this.endDate),
      ...(this.comparison ? {
        compareStartDate: this.compareStartDate,
        compareEndDate: this.compareEndDate,
        compareIsoInterval: formatISOInterval(this.compareStartDate, this.compareEndDate),
      } : {}),
    });
    ```

    8. Update updateFormValue for comparison mode — pipe-delimited format:
    ```typescript
    private updateFormValue(): void {
      const primaryInterval = formatISOInterval(this.startDate, this.endDate);
      if (this.comparison && this.compareStartDate && this.compareEndDate) {
        const compareInterval = formatISOInterval(this.compareStartDate, this.compareEndDate);
        this.internals?.setFormValue(primaryInterval ? `${primaryInterval}|${compareInterval}` : null);
      } else {
        this.internals?.setFormValue(primaryInterval || null);
      }
    }
    ```

    9. Update handleClear to also clear comparison range when comparison mode is active:
    Add to handleClear: if (this.comparison) { this.compareStartDate = ''; this.compareEndDate = ''; this.compareRangeState = 'idle'; this.selectionTarget = 'primary'; }

    10. Update formResetCallback to also reset comparison state.

    11. Update updated() lifecycle to also sync compareRangeState when comparison dates change externally.

    12. Update handlePresetSelect to route to comparison range when selectionTarget is comparison:
    ```typescript
    private handlePresetSelect(preset: DateRangePreset): void {
      const { start, end } = preset.resolve();
      const startISO = format(start, 'yyyy-MM-dd');
      const endISO = format(end, 'yyyy-MM-dd');

      if (this.comparison && this.selectionTarget === 'comparison') {
        this.compareStartDate = startISO;
        this.compareEndDate = endISO;
        this.compareRangeState = 'complete';
      } else {
        this.startDate = startISO;
        this.endDate = endISO;
        this.rangeState = 'complete';
      }
      this.validateAndEmit();
    }
    ```
  </action>
  <verify>cd packages/date-range-picker && npx tsc --noEmit</verify>
  <done>
    - comparison, compare-start-date, compare-end-date properties exist
    - selectionTarget and compareRangeState state properties exist
    - Date clicks route to correct range based on selectionTarget
    - Change event includes comparison fields when comparison mode active
    - Form submission uses pipe-delimited format for dual ranges
    - Preset selection routes to active range
    - Clear and form reset handle comparison state
  </done>
</task>

<task type="auto">
  <name>Task 2: Add comparison toggle UI and dual-range rendering</name>
  <files>packages/date-range-picker/src/date-range-picker.ts</files>
  <action>
    Add the comparison toggle buttons and update renderRangeDay for dual-range styling.

    1. Add comparison toggle rendering in renderCalendarContent(), between range-header and popup-body:
    ```html
    ${this.comparison ? html`
      <div class="comparison-toggle">
        <button
          type="button"
          class="toggle-button ${this.selectionTarget === 'primary' ? 'toggle-active toggle-primary' : ''}"
          @click="${() => { this.selectionTarget = 'primary'; }}"
        >Primary Range</button>
        <button
          type="button"
          class="toggle-button ${this.selectionTarget === 'comparison' ? 'toggle-active toggle-comparison' : ''}"
          @click="${() => { this.selectionTarget = 'comparison'; }}"
        >Comparison Range</button>
      </div>
    ` : nothing}
    ```

    2. Update renderRangeDay to check both primary and comparison ranges:
    After existing primary range logic (isStart, isEnd, inRange, inPreview), add comparison range checks:
    ```typescript
    const isCompareStart = this.comparison && dateStr === this.compareStartDate;
    const isCompareEnd = this.comparison && dateStr === this.compareEndDate;
    const inCompareRange = this.comparison && isDateInRange(dateStr, this.compareStartDate, this.compareEndDate);
    const inComparePreview = this.comparison && this.selectionTarget === 'comparison' && this.compareRangeState === 'start-selected'
      ? isDateInPreview(dateStr, this.compareStartDate, this.hoveredDate)
      : false;
    ```

    Style comparison range with amber/orange colors using CSS custom properties:
    - Compare start: --ui-range-compare-bg (default #f59e0b), rounded left
    - Compare end: --ui-range-compare-bg, rounded right
    - In compare range: --ui-range-compare-highlight-bg (default #fef3c7)
    - Compare preview: --ui-range-compare-preview-bg (default #fffbeb)

    Priority order for overlapping days: primary range takes precedence (check primary conditions first in the if/else chain). Comparison styles only apply when no primary style applies to that day.

    3. Update selectionStatus getter to show status for the active selection target:
    ```typescript
    get selectionStatus(): string {
      if (this.comparison && this.selectionTarget === 'comparison') {
        if (this.compareRangeState === 'idle') return 'Click a date to start comparison range';
        if (this.compareRangeState === 'start-selected') return 'Click another date to complete comparison';
        if (this.compareRangeState === 'complete') return this.displayValue;
      }
      // ...existing primary status logic...
    }
    ```

    4. Update durationText to show duration for comparison range when that's the active target:
    When comparison mode and selectionTarget is comparison and compareRangeState is complete, show comparison duration.

    5. Add CSS for comparison toggle and comparison range custom properties:
    ```css
    .comparison-toggle {
      display: flex;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      border-bottom: 1px solid var(--ui-date-picker-popup-border, #e5e7eb);
    }

    .toggle-button {
      flex: 1;
      font-size: 0.75rem;
      padding: 0.375rem 0.5rem;
      border: 1px solid var(--ui-date-picker-border, var(--ui-input-border, #d1d5db));
      border-radius: 0.25rem;
      background: transparent;
      color: var(--ui-date-picker-text, var(--ui-input-text, inherit));
      cursor: pointer;
      transition: background-color 150ms, border-color 150ms;
    }

    .toggle-button:hover {
      background-color: var(--color-muted, #f3f4f6);
    }

    .toggle-button:focus-visible {
      outline: 2px solid var(--color-ring, #3b82f6);
      outline-offset: 1px;
    }

    .toggle-active.toggle-primary {
      background-color: var(--ui-range-selected-bg, var(--color-primary, #3b82f6));
      color: var(--ui-range-selected-text, white);
      border-color: var(--ui-range-selected-bg, var(--color-primary, #3b82f6));
    }

    .toggle-active.toggle-comparison {
      background-color: var(--ui-range-compare-bg, #f59e0b);
      color: var(--ui-range-compare-text, white);
      border-color: var(--ui-range-compare-bg, #f59e0b);
    }
    ```

    6. Add CSS custom properties for comparison range colors in the :host rule:
    These are defined as CSS custom properties so consumers can override them:
    - --ui-range-compare-bg: var(--color-warning, #f59e0b)
    - --ui-range-compare-text: white
    - --ui-range-compare-highlight-bg: #fef3c7
    - --ui-range-compare-preview-bg: #fffbeb
  </action>
  <verify>
    1. cd packages/date-range-picker && npx tsc --noEmit
    2. pnpm --filter @lit-ui/date-range-picker build
  </verify>
  <done>
    - Comparison toggle renders when comparison property is true
    - Toggle buttons switch selectionTarget between primary/comparison
    - Primary toggle shows blue active state, comparison shows amber
    - renderRangeDay shows both primary (blue) and comparison (amber) ranges
    - Primary range takes visual precedence on overlapping days
    - Comparison range uses distinct amber/orange CSS custom properties
    - Duration and status reflect the active selection target
  </done>
</task>

</tasks>

<verification>
1. `cd packages/date-range-picker && npx tsc --noEmit` — TypeScript compiles
2. `pnpm --filter @lit-ui/date-range-picker build` — builds successfully
3. `pnpm --filter @lit-ui/date-range-picker test` — existing tests still pass
4. comparison=true shows toggle buttons
5. Selecting dates routes to the active range
6. Form submission includes pipe-delimited intervals when comparison active
</verification>

<success_criteria>
- comparison property enables dual-range mode
- Toggle buttons switch between Primary Range and Comparison Range
- Both ranges independently follow the two-click state machine
- Comparison range uses amber/orange colors (distinct from primary blue)
- Form submission format: YYYY-MM-DD/YYYY-MM-DD|YYYY-MM-DD/YYYY-MM-DD
- Change event includes compareStartDate, compareEndDate, compareIsoInterval
- Preset clicks route to the active selection target
</success_criteria>

<output>
After completion, create `.planning/phases/47-date-range-picker-advanced/47-04-SUMMARY.md`
</output>
