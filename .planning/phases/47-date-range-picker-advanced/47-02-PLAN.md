---
phase: 47-date-range-picker-advanced
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/date-range-picker/src/date-range-picker.ts
autonomous: true

must_haves:
  truths:
    - "User can pointerdown on a day cell to start range selection"
    - "User can pointerup on a different day cell to complete range selection"
    - "Existing two-click selection still works alongside drag"
    - "Drag does not cause text selection (preventDefault on pointerdown)"
    - "Drag started but released outside calendar falls back to click-to-complete"
  artifacts:
    - path: "packages/date-range-picker/src/date-range-picker.ts"
      provides: "Drag selection via pointer events on renderRangeDay spans"
      contains: "isDragging"
  key_links:
    - from: "renderRangeDay"
      to: "handleDragStart/handleDragEnd"
      via: "pointerdown/pointerup event listeners on day cell spans"
      pattern: "@pointerdown.*handleDragStart"
    - from: "handleDragStart"
      to: "rangeState"
      via: "Sets start date and enters start-selected state (reuses state machine)"
      pattern: "this.rangeState = 'start-selected'"
---

<objective>
Add mouse drag selection to the date range picker using Pointer Events.

Purpose: Users can create ranges by clicking and dragging instead of two separate clicks, providing a more intuitive interaction for range selection (DRP-18).
Output: Updated date-range-picker.ts with drag support via pointerdown/pointerup on day cells.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/date-range-picker/src/date-range-picker.ts
@packages/date-range-picker/src/range-utils.ts
@packages/calendar/src/gesture-handler.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add isDragging state and drag handler methods</name>
  <files>packages/date-range-picker/src/date-range-picker.ts</files>
  <action>
    Add drag selection to the DateRangePicker component. The drag reuses the existing two-click state machine transitions:

    1. Add @state() property:
       ```
       @state()
       private isDragging = false;
       ```

    2. Add handleDragStart method:
       ```
       private handleDragStart(isoString: string): void {
         if (this.disabled) return;
         this.isDragging = true;
         // Enter start-selected state (same as first click)
         this.startDate = isoString;
         this.endDate = '';
         this.internalError = '';
         this.rangeState = 'start-selected';
       }
       ```

    3. Add handleDragEnd method:
       ```
       private handleDragEnd(isoString: string): void {
         if (!this.isDragging) return;
         this.isDragging = false;
         if (this.rangeState === 'start-selected' && isoString !== this.startDate) {
           // Complete range (same as second click)
           const [normalizedStart, normalizedEnd] = normalizeRange(this.startDate, isoString);
           this.startDate = normalizedStart;
           this.endDate = normalizedEnd;
           this.hoveredDate = '';
           this.rangeState = 'complete';
           this.validateAndEmit();
         }
         // If released on same cell as start, stay in start-selected for click-to-complete
       }
       ```

    4. Add handleDragCancel method for releases outside calendar:
       ```
       private handleDragCancel(): void {
         if (this.isDragging) {
           this.isDragging = false;
           // Stay in start-selected state — user can still click to complete
         }
       }
       ```

    5. Update renderRangeDay to add pointer events on the span element. Add @pointerdown, @pointerup handlers. Call e.preventDefault() on pointerdown to prevent text selection during drag (Pitfall 1 from research):
       - @pointerdown: calls e.preventDefault() then this.handleDragStart(dateStr)
       - @pointerup: calls this.handleDragEnd(dateStr)
       The existing @mouseenter for hover preview already provides visual feedback during drag.

    6. Add @pointerup listener on the popup container (the div.popup element in render()) to catch releases outside day cells. In the popup's existing @keydown handler area, add @pointerup="${this.handleDragCancel}". This ensures releasing outside a day cell cancels the drag but keeps start-selected state.

    7. Add CSS for user-select prevention during drag. In the static styles, add:
       ```css
       .calendars-wrapper.dragging {
         user-select: none;
         -webkit-user-select: none;
       }
       ```

    8. Update the calendars-wrapper div in renderCalendarContent() to conditionally add the 'dragging' class:
       ```
       class="calendars-wrapper ${this.isDragging ? 'dragging' : ''}"
       ```

    Important: The existing handleDateClick method continues to work for regular two-click selection. Drag selection is additive — it uses the same state machine transitions.
  </action>
  <verify>
    1. `cd packages/date-range-picker && npx tsc --noEmit` — compiles without errors
    2. `pnpm --filter @lit-ui/date-range-picker build` — builds successfully
  </verify>
  <done>
    - isDragging state property exists
    - renderRangeDay spans have @pointerdown and @pointerup handlers
    - pointerdown calls preventDefault to prevent text selection
    - Drag start enters start-selected state (same as first click)
    - Drag end on different cell completes range (same as second click)
    - Release outside day cells cancels drag but keeps start-selected state
    - calendars-wrapper gets 'dragging' class with user-select: none during drag
  </done>
</task>

</tasks>

<verification>
1. `cd packages/date-range-picker && npx tsc --noEmit` — TypeScript compiles
2. `pnpm --filter @lit-ui/date-range-picker build` — builds successfully
3. `pnpm --filter @lit-ui/date-range-picker test` — existing tests still pass
</verification>

<success_criteria>
- Pointer events (pointerdown/pointerup) added to day cell spans in renderRangeDay
- Drag start sets start date and enters start-selected state
- Drag end normalizes range and enters complete state
- Text selection prevented during drag (user-select: none + preventDefault)
- Existing two-click selection unaffected
- TypeScript compiles and build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/47-date-range-picker-advanced/47-02-SUMMARY.md`
</output>
