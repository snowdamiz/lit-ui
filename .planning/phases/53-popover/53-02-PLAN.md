---
phase: 53-popover
plan: 02
type: execute
wave: 2
depends_on: ["53-01"]
files_modified:
  - packages/cli/src/registry/registry.json
  - packages/cli/src/templates/index.ts
autonomous: true

must_haves:
  truths:
    - "Running npx lit-ui add popover in copy-source mode produces a working standalone popover component"
    - "Running npm install @lit-ui/popover in npm mode installs the package correctly"
    - "The full workspace builds successfully with the popover package integrated"
  artifacts:
    - path: "packages/cli/src/registry/registry.json"
      provides: "CLI registry entry for popover component"
      contains: "popover"
    - path: "packages/cli/src/templates/index.ts"
      provides: "Copy-source template for popover component"
      contains: "POPOVER_TEMPLATE"
  key_links:
    - from: "packages/cli/src/registry/registry.json"
      to: "packages/cli/src/templates/index.ts"
      via: "Registry files array maps to template keys in COMPONENT_TEMPLATES"
      pattern: "popover"
    - from: "packages/cli/src/templates/index.ts"
      to: "@floating-ui/dom"
      via: "Inlined shadow DOM platform in template (no @lit-ui/core/floating dependency in copy mode)"
      pattern: "shadowDomPlatform|composed-offset-position"
---

<objective>
Add CLI registry entry and copy-source template for the popover component, enabling installation via both `npx lit-ui add popover` (copy-source) and `npm install @lit-ui/popover` (npm mode).

Purpose: Complete POP-18 by making the popover component available through the CLI distribution system, matching the established pattern from tooltip (52-02).

Output: Updated registry.json with popover entry and templates/index.ts with POPOVER_TEMPLATE, verified by full workspace build.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan summary -- popover component implementation details
@.planning/phases/53-popover/53-01-SUMMARY.md

# Reference -- tooltip CLI integration (exact pattern to follow)
@.planning/phases/52-tooltip/52-02-SUMMARY.md

# Files to modify
@packages/cli/src/registry/registry.json
@packages/cli/src/templates/index.ts

# Source component to template-ify
@packages/popover/src/popover.ts
@packages/popover/src/index.ts

# Floating UI wrapper that must be inlined in copy-source template
@packages/core/src/floating/index.ts

# Key decision: Copy-source template inlines shadowDomPlatform (no core dependency)
# See decision 52-02-inline-platform in STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CLI registry entry and copy-source template for popover</name>
  <files>
    packages/cli/src/registry/registry.json
    packages/cli/src/templates/index.ts
  </files>
  <action>
    Follow the exact pattern established by tooltip in 52-02:

    **1. Registry entry (registry.json):**
    Add a `popover` entry to the components object with:
    - `name`: "popover"
    - `description`: "Accessible popover component with click triggers, focus management, and nested support"
    - `dependencies`: `["@floating-ui/dom", "composed-offset-position"]` (same as tooltip -- needed for copy-source Floating UI positioning)
    - `peerDependencies`: `["lit"]`
    - `files`: `["popover.ts"]` (single file component, unlike tooltip which also had delay-group)
    - `registryDependencies`: `[]` (popover is standalone, uses @lit-ui/core tokens via CSS custom properties which are inherited)

    **2. Copy-source template (templates/index.ts):**
    Create `POPOVER_TEMPLATE` constant containing a string-escaped version of the popover component that:
    - Replaces `import { TailwindElement, tailwindBaseStyles } from '@lit-ui/core'` with `import { LitElement, html, css, nothing } from 'lit'` and uses LitElement directly (copy-source has no @lit-ui/core)
    - Replaces `import { computePosition, autoUpdatePosition, flip, shift, offset, arrow, size, type Placement } from '@lit-ui/core/floating'` with direct imports from `@floating-ui/dom` plus inlined `shadowDomPlatform` using `composed-offset-position` (same pattern as tooltip template)
    - Inlines the `shadowDomPlatform` object: `import { offsetParent } from 'composed-offset-position'; const shadowDomPlatform = { ...platform, getOffsetParent: (element) => offsetParent(element) };`
    - Uses `autoUpdate` from `@floating-ui/dom` directly instead of `autoUpdatePosition` wrapper
    - Passes `platform: shadowDomPlatform` to `computePosition` calls
    - Replaces `tailwindBaseStyles` with an empty array or inline base styles
    - Includes the `@customElement('lui-popover')` decorator for self-registration
    - Preserves all behavioral logic, CSS, ARIA, and focus management unchanged
    - Uses proper template string escaping matching existing patterns (backticks escaped as `\``, `${` escaped as `\${`)

    Add the template to the `COMPONENT_TEMPLATES` map with the key `"popover.ts"` mapping to `POPOVER_TEMPLATE`.

    **Escaping rules (critical -- match existing template patterns):**
    - Backticks inside the template string: escape with `\``
    - Template literal interpolations `${...}`: escape as `\${...}`
    - Regular single/double quotes: no escaping needed
    - Look at how TOOLTIP_TEMPLATE handles these escapes and match exactly
  </action>
  <verify>
    Run `cd packages/cli && pnpm build` (or the CLI's build command) -- builds without errors.
    Grep registry.json for `"popover"` -- entry exists.
    Grep templates/index.ts for `POPOVER_TEMPLATE` -- template exists.
    Grep templates/index.ts for `shadowDomPlatform` in the popover template section -- platform is inlined.
    Grep COMPONENT_TEMPLATES for `"popover.ts"` -- mapping exists.
  </verify>
  <done>CLI registry has popover entry with correct dependencies, and POPOVER_TEMPLATE is a standalone copy-source component with inlined Floating UI shadow DOM platform.</done>
</task>

<task type="auto">
  <name>Task 2: Verify full workspace build and integration</name>
  <files></files>
  <action>
    Run the full workspace build to verify the popover package integrates correctly:

    1. Run `pnpm build` from the workspace root
    2. Verify all packages build successfully (expect pre-existing docs app TS errors for date-picker/date-range-picker/time-picker module declarations -- these are known tech debt, not new issues)
    3. Verify `packages/popover/dist/index.js` exists and contains the popover component
    4. Verify `packages/cli/dist/` contains the updated registry and templates

    If build fails with new errors (not the pre-existing docs app ones), fix them before proceeding.
  </action>
  <verify>
    Run `pnpm build` from workspace root -- all packages build (except known docs app TS errors).
    Run `ls packages/popover/dist/index.js` -- popover dist exists.
    The workspace is in a clean, buildable state with popover fully integrated.
  </verify>
  <done>Full workspace builds successfully with @lit-ui/popover integrated. The component is available via both npm install and CLI copy-source modes.</done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds for all packages (except known docs app pre-existing errors)
2. `packages/popover/dist/index.js` and `dist/index.d.ts` exist
3. `packages/cli/src/registry/registry.json` contains popover entry
4. `packages/cli/src/templates/index.ts` contains POPOVER_TEMPLATE with inlined shadowDomPlatform
5. COMPONENT_TEMPLATES map has `"popover.ts"` key
</verification>

<success_criteria>
POP-18 is complete: The popover component ships as @lit-ui/popover with a CLI registry entry and copy-source template. The full workspace builds successfully.
</success_criteria>

<output>
After completion, create `.planning/phases/53-popover/53-02-SUMMARY.md`
</output>
