---
phase: 53-popover
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/popover/package.json
  - packages/popover/tsconfig.json
  - packages/popover/vite.config.ts
  - packages/popover/src/vite-env.d.ts
  - packages/popover/src/popover.ts
  - packages/popover/src/index.ts
  - packages/popover/src/jsx.d.ts
autonomous: true

must_haves:
  truths:
    - "Clicking a trigger element toggles the popover open and closed"
    - "Pressing Escape dismisses the popover and returns focus to the trigger"
    - "Clicking outside the popover dismisses it (light dismiss via Popover API auto mode)"
    - "The popover positions itself near the trigger with Floating UI collision avoidance across 12 placements"
    - "An optional arrow indicator tracks placement flips"
    - "Focus moves into the popover on open and returns to trigger on close"
    - "Modal mode traps focus within the popover"
    - "Controlled mode (open property + open-changed event) and uncontrolled mode both work"
    - "Nested popovers work -- opening a child keeps parent open, closing parent closes children"
    - "The popover renders in the top layer via native Popover API with position:fixed fallback"
    - "ARIA attributes (aria-expanded, aria-haspopup, role=dialog) are correctly applied"
    - "CSS custom properties (--ui-popover-*) control all visual theming"
    - "SSR renders trigger only with popover hidden"
    - "All listeners cleaned up via AbortController on disconnect"
  artifacts:
    - path: "packages/popover/src/popover.ts"
      provides: "Popover component class with full behavior"
      min_lines: 200
    - path: "packages/popover/src/index.ts"
      provides: "Registration and exports"
      exports: ["Popover"]
    - path: "packages/popover/package.json"
      provides: "Package metadata for @lit-ui/popover"
      contains: "@lit-ui/popover"
  key_links:
    - from: "packages/popover/src/popover.ts"
      to: "@lit-ui/core/floating"
      via: "computePosition, autoUpdatePosition, flip, shift, offset, arrow, size imports"
      pattern: "from '@lit-ui/core/floating'"
    - from: "packages/popover/src/popover.ts"
      to: "Popover API"
      via: "showPopover()/hidePopover() JS calls on panel element"
      pattern: "showPopover|hidePopover"
    - from: "packages/popover/src/index.ts"
      to: "customElements registry"
      via: "customElements.define('lui-popover', Popover)"
      pattern: "customElements.define"
---

<objective>
Implement the `@lit-ui/popover` package with full component behavior covering all 17 functional requirements (POP-01 through POP-17).

Purpose: Provide a click-triggered interactive overlay component that positions with Floating UI, uses the native Popover API for top-layer rendering and light dismiss, manages focus correctly, supports nesting, and works in both controlled and uncontrolled modes.

Output: A complete `packages/popover/` package with `popover.ts` component, `index.ts` registration, JSX types, and build configuration.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Reference implementation -- tooltip follows the exact same wrapper + Floating UI pattern
@packages/tooltip/src/tooltip.ts
@packages/tooltip/src/index.ts
@packages/tooltip/package.json
@packages/tooltip/tsconfig.json
@packages/tooltip/vite.config.ts
@packages/tooltip/src/jsx.d.ts

# Floating UI shared utilities (computePosition, autoUpdatePosition, flip, shift, offset, arrow, size)
@packages/core/src/floating/index.ts

# CSS tokens already defined for popover (--ui-popover-bg, --ui-popover-text, etc.)
@packages/core/src/styles/tailwind.css (lines 707-718 for popover tokens, lines 208-212 for dark mode)

# Token type definitions already defined
@packages/core/src/tokens/index.ts (PopoverToken type)

# Overlay animation reference pattern
@packages/core/src/styles/overlay-animation.css

# Select component for click-outside pattern reference
@packages/select/src/select.ts (handleDocumentClick with composedPath)

# Dialog for focus trap / modal reference
@packages/dialog/src/dialog.ts

# Phase 53 research with architecture decisions and code examples
@.planning/phases/53-popover/53-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold popover package with build configuration</name>
  <files>
    packages/popover/package.json
    packages/popover/tsconfig.json
    packages/popover/vite.config.ts
    packages/popover/src/vite-env.d.ts
  </files>
  <action>
    Create the `packages/popover/` directory and scaffold all build configuration files by copying the exact patterns from `packages/tooltip/`:

    1. **package.json** -- Copy from tooltip. Change:
       - `name` to `@lit-ui/popover`
       - `description` to "Accessible popover component built with Lit and Tailwind CSS"
       - `directory` to `packages/popover`
       - Everything else stays identical (same peerDeps on lit + @lit-ui/core, same devDeps, same scripts, same exports structure)

    2. **tsconfig.json** -- Identical to tooltip's tsconfig.json (extends @lit-ui/typescript-config/library.json)

    3. **vite.config.ts** -- Identical to tooltip's vite.config.ts (`createLibraryConfig({ entry: 'src/index.ts' })`)

    4. **src/vite-env.d.ts** -- Identical to tooltip (triple-slash reference to vite/client)

    Register the workspace package by adding `"@lit-ui/popover": "workspace:*"` to the root `pnpm-workspace.yaml` if needed (check if auto-detected), then run `pnpm install` to link the workspace.
  </action>
  <verify>
    Run `ls packages/popover/package.json packages/popover/tsconfig.json packages/popover/vite.config.ts packages/popover/src/vite-env.d.ts` -- all 4 files exist.
    Run `pnpm ls --filter @lit-ui/popover` -- package is recognized in the workspace.
  </verify>
  <done>The @lit-ui/popover package exists in the workspace with correct build configuration matching the tooltip pattern.</done>
</task>

<task type="auto">
  <name>Task 2: Implement popover component with all behavioral requirements</name>
  <files>
    packages/popover/src/popover.ts
    packages/popover/src/index.ts
    packages/popover/src/jsx.d.ts
  </files>
  <action>
    Implement the full Popover component in `packages/popover/src/popover.ts` following the tooltip component pattern but with these key differences:

    **Architecture:** Wrapper component with two slots: default slot for trigger, `content` named slot for popover content. The trigger gets click handling (not hover). The content panel uses native Popover API (`popover="auto"`) for top-layer rendering and light dismiss.

    **Properties:**
    - `placement: Placement = 'bottom'` -- 12 Floating UI placement options (POP-04)
    - `open: boolean = false` (reflect: true) -- controlled mode property (POP-08)
    - `arrow: boolean = false` -- optional arrow indicator (POP-05)
    - `modal: boolean = false` -- modal focus trapping mode (POP-07)
    - `offset: number = 8` -- distance from trigger
    - `matchTriggerWidth: boolean = false` (attribute: `match-trigger-width`) -- width matching (POP-12)
    - `disabled: boolean = false` -- disable opening

    **Internal state:**
    - `_internalOpen: boolean = false` -- actual open state
    - `_controlled: boolean = false` -- tracks if user has set `open` property externally
    - `_currentPlacement: Placement` -- resolved placement after flip

    **Popover API integration (POP-11):**
    - Feature detect `'popover' in HTMLElement.prototype`
    - If supported: set `popover="auto"` on the panel element, use `showPopover()`/`hidePopover()` JS APIs (NOT declarative `popovertarget` -- shadow DOM spec issues)
    - If not supported: fall back to `position: fixed` with manual click-outside detection using `composedPath()` (like select component)
    - Override UA styles on panel: `margin: 0; position: fixed;` so Floating UI coordinates work correctly

    **Click-to-toggle trigger (POP-01):**
    - Listen for click on the default slot wrapper
    - Toggle `_internalOpen` state
    - Also handle Enter/Space keydown on trigger to toggle (accessibility)

    **Escape key dismissal (POP-02):**
    - If Popover API is active, the `toggle` event with `newState === 'closed'` handles this automatically
    - For fallback mode: add keydown listener for Escape on the document (with signal from AbortController)

    **Light dismiss (POP-03):**
    - If Popover API `auto` mode: handled automatically by the browser
    - For fallback: document click listener with `composedPath().includes()` check (like select component)

    **Floating UI positioning (POP-04, POP-13):**
    - Import `computePosition`, `autoUpdatePosition`, `flip`, `shift`, `offset`, `arrow`, `size` from `@lit-ui/core/floating`
    - Apply positioning after `updateComplete` (avoid race with Lit async render)
    - Start `autoUpdatePosition` when open, cleanup when closed

    **Arrow indicator (POP-05):**
    - Conditional render of arrow element when `this.arrow` is true
    - Use `arrow` middleware from Floating UI
    - Position arrow based on resolved placement (same logic as tooltip)

    **Focus management (POP-06):**
    - On open: after positioning, move focus to the first focusable element inside the popover content, or to the panel itself if no focusable children
    - On close: restore focus to the trigger element
    - Non-modal default: tabbing out of the popover closes it (listen for focusout, check if relatedTarget is outside popover using composedPath)

    **Modal mode (POP-07):**
    - When `modal` is true, implement focus trapping with sentinel elements
    - Add two visually-hidden focusable sentinel divs (tabindex=0) at the start and end of the popover content
    - On focus of start sentinel: move focus to last focusable element
    - On focus of end sentinel: move focus to first focusable element
    - When modal, do NOT close on focusout (override the non-modal behavior)
    - Set `aria-modal="true"` when modal

    **Controlled/uncontrolled mode (POP-08):**
    - Track `_controlled` flag: set to true when `open` property is externally set (detect in `updated()` lifecycle)
    - In uncontrolled mode: component manages `_internalOpen` directly
    - In controlled mode: `_internalOpen` syncs from `open` property. Dispatch `open-changed` CustomEvent with `{ detail: { open: boolean } }` on every state change. Let the parent control the actual state.
    - Use property setter/getter pattern for `open`:
      ```
      @property({ type: Boolean, reflect: true })
      set open(val) { this._controlled = true; this._internalOpen = val; }
      get open() { return this._internalOpen; }
      ```

    **Nested popover support (POP-09):**
    - With Popover API `auto` mode: nesting should work if child popover is a DOM descendant. When child opens inside parent's content, the browser keeps parent open.
    - For cross-shadow-root nesting: walk up the composed DOM tree (`composedPath` or `getRootNode()` traversal) to find ancestor `lui-popover` elements. When closing, dispatch a `popover-close-children` custom event that children listen for.
    - When a parent popover closes, children must close too.

    **ARIA (POP-10):**
    - Set `aria-expanded` on the trigger element (true when open, false when closed)
    - Set `aria-haspopup="dialog"` on the trigger element
    - Set `role="dialog"` on the popover panel
    - Generate unique IDs for aria-controls linking

    **Trigger width matching (POP-12):**
    - When `matchTriggerWidth` is true, add `size` middleware that sets the floating element width to match the reference element width
    - Also expose as `--ui-popover-trigger-width` CSS custom property

    **Reduced motion (POP-14):**
    - Use CSS `@media (prefers-reduced-motion: reduce)` to disable transitions (same as tooltip)

    **SSR safety (POP-15):**
    - Guard all DOM APIs with `isServer` check
    - Render trigger only during SSR (no popover panel)
    - Return early from `connectedCallback` if `isServer`

    **AbortController cleanup (POP-16):**
    - Create in `connectedCallback`, abort in `disconnectedCallback`
    - All event listeners use `{ signal }` option
    - Clean up autoUpdate on disconnect

    **CSS custom properties (POP-17):**
    - Use tokens already defined in tailwind.css: `--ui-popover-bg`, `--ui-popover-text`, `--ui-popover-border`, `--ui-popover-radius`, `--ui-popover-padding`, `--ui-popover-shadow`, `--ui-popover-arrow-size`, `--ui-popover-max-width`, `--ui-popover-z-index`

    **CSS styles:** Use `css` tagged template in static styles array with `tailwindBaseStyles` spread. Panel styles:
    ```css
    .popover-panel {
      margin: 0; border: none; padding: 0; background: transparent;
      position: fixed;
      z-index: var(--ui-popover-z-index);
      opacity: 0; transform: scale(0.95);
      transition: opacity 150ms ease-out, transform 150ms ease-out,
        display 150ms allow-discrete, overlay 150ms allow-discrete;
    }
    .popover-panel:popover-open,
    .popover-panel[data-open] { opacity: 1; transform: scale(1); }
    @starting-style { .popover-panel:popover-open, .popover-panel[data-open] { opacity: 0; transform: scale(0.95); } }
    @media (prefers-reduced-motion: reduce) { .popover-panel { transition: none; } }
    ```

    **Render template:**
    - Trigger wrapper div with default slot + click/keydown handlers + slotchange handler
    - Conditional popover panel (only when `_internalOpen && !isServer`)
    - Panel has `popover="auto"` attribute (or `popover="manual"` for nested children if needed), `role="dialog"`, CSS parts
    - Content wrapper inside panel with named `content` slot
    - Optional arrow element
    - Modal sentinel elements if `modal` is true

    **index.ts:** Follow tooltip pattern exactly:
    - Export Popover class and Placement type
    - Re-export TailwindElement and isServer from @lit-ui/core
    - Safe customElements.define with collision detection
    - Global HTMLElementTagNameMap declaration

    **jsx.d.ts:** Follow tooltip pattern:
    - LuiPopoverAttributes interface with all public properties
    - React, Vue, Svelte type declarations
    - Include `open-changed` event type for React (`onOpenChanged`)
  </action>
  <verify>
    Run `cd packages/popover && pnpm build` -- builds without errors.
    Run `ls packages/popover/dist/index.js packages/popover/dist/index.d.ts` -- output files exist.
    Grep for key patterns: `showPopover`, `hidePopover`, `aria-expanded`, `aria-haspopup`, `role="dialog"`, `popover="auto"`, `AbortController`, `isServer`, `computePosition`, `autoUpdatePosition`, `open-changed`, `prefers-reduced-motion`.
  </verify>
  <done>
    The popover component implements all 17 functional requirements:
    - POP-01: Click-to-toggle via trigger click handler
    - POP-02: Escape dismissal via Popover API toggle event + fallback keydown
    - POP-03: Light dismiss via Popover API auto mode + fallback composedPath click-outside
    - POP-04: 12 Floating UI placements with collision avoidance
    - POP-05: Optional arrow with Floating UI arrow middleware
    - POP-06: Focus into popover on open, return to trigger on close
    - POP-07: Modal focus trap with sentinel elements
    - POP-08: Controlled (open + open-changed) and uncontrolled modes
    - POP-09: Nested popover support with parent-child tracking
    - POP-10: aria-expanded, aria-haspopup, role=dialog
    - POP-11: Native Popover API with position:fixed fallback
    - POP-12: Trigger width matching via size middleware
    - POP-13: autoUpdatePosition for scroll/resize
    - POP-14: prefers-reduced-motion respect
    - POP-15: SSR safe with isServer guards
    - POP-16: AbortController cleanup
    - POP-17: CSS custom properties for theming
    The package builds successfully and produces dist/index.js and dist/index.d.ts.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build --filter @lit-ui/popover` succeeds without errors
2. `dist/index.js` and `dist/index.d.ts` exist in packages/popover/dist/
3. The component class exports `Popover` and registers as `lui-popover`
4. Key Popover API integration: `showPopover()`, `hidePopover()`, `popover="auto"` present in source
5. Focus management: focus moves to content on open, returns to trigger on close
6. ARIA: `aria-expanded`, `aria-haspopup="dialog"`, `role="dialog"` in render template
7. AbortController created in connectedCallback, aborted in disconnectedCallback
8. isServer guard prevents DOM API calls during SSR
9. CSS uses `--ui-popover-*` custom properties matching existing token definitions
10. `prefers-reduced-motion` media query disables transitions
</verification>

<success_criteria>
The @lit-ui/popover package builds successfully with a fully functional Popover component that:
- Toggles on trigger click with Floating UI positioning
- Uses native Popover API for top-layer rendering and light dismiss
- Manages focus correctly (into popover on open, back to trigger on close)
- Supports modal mode with focus trapping
- Works in both controlled and uncontrolled modes
- Handles nested popovers
- Has full ARIA, SSR safety, AbortController cleanup, and CSS custom property theming
</success_criteria>

<output>
After completion, create `.planning/phases/53-popover/53-01-SUMMARY.md`
</output>
