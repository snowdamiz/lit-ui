---
phase: 03-dialog-component
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/dialog/dialog.ts
autonomous: true

must_haves:
  truths:
    - "Focus returns to trigger element when dialog closes"
    - "Clicking backdrop closes the dialog (when dismissible)"
    - "Non-dismissible dialog cannot be closed via Escape or backdrop"
    - "Close event emits with reason (escape, backdrop, programmatic)"
  artifacts:
    - path: "src/components/dialog/dialog.ts"
      provides: "Focus return, backdrop click, close event with reason"
      contains: "triggerElement"
  key_links:
    - from: "close event"
      to: "parent components"
      via: "CustomEvent with composed: true"
      pattern: "composed:\\s*true"
---

<objective>
Add focus return to trigger element, backdrop click-to-close, and close event with reason to the dialog component.

Purpose: Complete the accessibility pattern by returning focus after close (WCAG requirement) and provide flexible dismissal options with event details for parent components.

Output: Dialog component with full focus management, backdrop interaction, and informative close events.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dialog-component/03-RESEARCH.md
@.planning/phases/03-dialog-component/03-01-SUMMARY.md
@src/components/dialog/dialog.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement focus return to trigger element</name>
  <files>src/components/dialog/dialog.ts</files>
  <action>
Add focus return functionality following RESEARCH.md Pattern 7:

1. **Add private property:**
   ```typescript
   private triggerElement: HTMLElement | null = null;
   ```

2. **Update show() method:**
   ```typescript
   show() {
     this.triggerElement = document.activeElement as HTMLElement;
     this.open = true;
   }
   ```

3. **Add focus restoration in close flow:**
   When dialog closes (either via property change or close() method), restore focus:
   ```typescript
   private restoreFocus() {
     if (this.triggerElement && typeof this.triggerElement.focus === 'function') {
       // Use requestAnimationFrame to ensure focus happens after close
       requestAnimationFrame(() => {
         this.triggerElement?.focus();
         this.triggerElement = null;
       });
     }
   }
   ```

4. **Listen to native close event:**
   Add handler for `@close=${this.handleNativeClose}` on dialog element.
   In handleNativeClose, call restoreFocus().

Note: Focus capture happens in show() which consumers call. Direct property setting (open=true) won't capture focus - this is expected per W3C APG pattern.
  </action>
  <verify>
Code review: triggerElement stored before showModal, focus restored on close.
  </verify>
  <done>
Focus returns to the element that triggered the dialog when it closes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement backdrop click and close event with reason</name>
  <files>src/components/dialog/dialog.ts</files>
  <action>
Add backdrop click detection and close event with reason:

1. **Define CloseReason type:**
   ```typescript
   export type CloseReason = 'escape' | 'backdrop' | 'programmatic';
   ```

2. **Update close() method:**
   ```typescript
   close(reason: CloseReason = 'programmatic') {
     this.emitClose(reason);
   }
   ```

3. **Create emitClose helper:**
   ```typescript
   private emitClose(reason: CloseReason) {
     this.open = false;
     this.dispatchEvent(new CustomEvent('close', {
       detail: { reason },
       bubbles: true,
       composed: true  // CRITICAL: must cross Shadow DOM boundary
     }));
   }
   ```

4. **Update handleCancel to use emitClose:**
   ```typescript
   private handleCancel(e: Event) {
     if (!this.dismissible) {
       e.preventDefault();
       return;
     }
     e.preventDefault(); // Prevent default close, we control it
     this.emitClose('escape');
   }
   ```

5. **Add backdrop click handler:**
   Following RESEARCH.md Pattern 3:
   ```typescript
   private handleDialogClick(e: MouseEvent) {
     // Dialog element is the backdrop click target
     // Content has stopPropagation so won't reach here
     if (e.target === this.dialogEl && this.dismissible) {
       this.emitClose('backdrop');
     }
   }
   ```

6. **Update render:**
   - Add `@click=${this.handleDialogClick}` to `<dialog>` element
   - Ensure content wrapper has `@click=${(e: Event) => e.stopPropagation()}`

7. **Export CloseReason type from component file**
  </action>
  <verify>
Code review:
- backdrop click triggers emitClose('backdrop')
- Escape triggers emitClose('escape')
- close() method uses emitClose('programmatic')
- Event has composed: true
  </verify>
  <done>
Dialog emits close event with reason indicating how it was closed. Backdrop clicks close dismissible dialogs.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Dialog stores activeElement before showModal
3. Focus returns to stored element after close
4. Backdrop click closes dialog when dismissible=true
5. Backdrop click does NOT close when dismissible=false
6. Close event includes reason in detail
7. Close event has bubbles: true and composed: true
</verification>

<success_criteria>
- triggerElement captured in show() method
- Focus restored to trigger after dialog closes
- Clicking backdrop area closes dismissible dialogs
- Non-dismissible dialogs block Escape and backdrop close
- Close event emitted with { reason: 'escape' | 'backdrop' | 'programmatic' }
- Event crosses Shadow DOM boundary (composed: true)
</success_criteria>

<output>
After completion, create `.planning/phases/03-dialog-component/03-02-SUMMARY.md`
</output>
