---
phase: 03-dialog-component
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - src/components/dialog/dialog.ts
  - src/components/demo/demo-page.ts
autonomous: false

must_haves:
  truths:
    - "Opening dialog from within dialog works correctly"
    - "Closing nested dialog does not close parent dialog"
    - "Each dialog returns focus to its own trigger"
    - "Demo page shows all dialog features"
  artifacts:
    - path: "src/components/demo/demo-page.ts"
      provides: "Dialog demo section with nested dialog example"
      contains: "ui-dialog"
  key_links:
    - from: "nested dialog close event"
      to: "parent dialog"
      via: "stopPropagation prevents bubble"
      pattern: "stopPropagation"
---

<objective>
Add nested dialog support and create a comprehensive demo page for visual verification of all dialog features.

Purpose: Validate that dialogs can be nested (a common pattern for confirmations from within a modal) and provide visual verification of all requirements.

Output: Working nested dialogs and demo page covering all DLG-* requirements.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dialog-component/03-RESEARCH.md
@.planning/phases/03-dialog-component/03-02-SUMMARY.md
@.planning/phases/03-dialog-component/03-03-SUMMARY.md
@src/components/dialog/dialog.ts
@src/components/demo/demo-page.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add nested dialog support</name>
  <files>src/components/dialog/dialog.ts</files>
  <action>
Ensure nested dialogs work correctly:

1. **Verify native behavior:**
   Native `<dialog>` with `showModal()` automatically supports nesting via the browser's top layer stack. Each dialog pushed to top layer renders above the previous.

2. **Add close event stop propagation option:**
   To prevent parent dialogs from receiving close events from nested dialogs, consumers should use `@close=${(e) => e.stopPropagation()}`.

   Document this in a JSDoc comment on the Dialog class:
   ```typescript
   /**
    * Dialog component using native <dialog> element.
    *
    * @slot title - Dialog title content
    * @slot - Default slot for dialog body
    * @slot footer - Dialog footer (typically action buttons)
    *
    * @fires close - When dialog closes, detail: { reason: 'escape' | 'backdrop' | 'programmatic' }
    *
    * @example Nested dialogs
    * ```html
    * <ui-dialog id="parent">
    *   <ui-dialog id="child" @close=${(e) => e.stopPropagation()}>
    *   </ui-dialog>
    * </ui-dialog>
    * ```
    */
   ```

3. **Verify each dialog tracks its own trigger:**
   The triggerElement is an instance property, so each dialog instance maintains its own focus return target. No changes needed if implemented correctly in Plan 02.

4. **Add optional show-close-button property:**
   Per CONTEXT.md, add optional close button:
   ```typescript
   @property({ type: Boolean, attribute: 'show-close-button' })
   showCloseButton = false;
   ```

   Render close button when enabled:
   ```typescript
   ${this.showCloseButton ? html`
     <button
       class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
       @click=${() => this.close('programmatic')}
       aria-label="Close dialog"
     >
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
       </svg>
     </button>
   ` : nothing}
   ```
  </action>
  <verify>
Code review:
- JSDoc documents nested dialog pattern
- showCloseButton property exists
- Close button renders with proper aria-label
  </verify>
  <done>
Nested dialogs supported via native top layer. Optional close button available.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create dialog demo section</name>
  <files>src/components/demo/demo-page.ts</files>
  <action>
Add comprehensive dialog demo to demo-page.ts:

1. **Add dialog section after button section:**
   Create new section with heading "Dialog Component"

2. **Demo 1: Basic Dialog**
   - Button to open dialog
   - Dialog with title, content, and footer with close button
   ```html
   <ui-button @click=${() => this.showBasicDialog()}>Open Dialog</ui-button>
   <ui-dialog ?open=${this.basicDialogOpen} @close=${this.closeBasicDialog}>
     <h2 slot="title">Dialog Title</h2>
     <p>This is the dialog content.</p>
     <div slot="footer">
       <ui-button @click=${() => this.closeBasicDialog()}>Close</ui-button>
     </div>
   </ui-dialog>
   ```

3. **Demo 2: Size Variants**
   - Buttons for sm, md, lg dialogs
   - Show each size

4. **Demo 3: Non-Dismissible Dialog**
   - Dialog with dismissible=false
   - Note: Escape and backdrop click won't close

5. **Demo 4: Nested Dialogs**
   - Parent dialog with button to open child dialog
   - Demonstrate independent close behavior

6. **Demo 5: With Close Button**
   - Dialog with show-close-button attribute

7. **Add state management:**
   ```typescript
   @state() private basicDialogOpen = false;
   @state() private sizeDialogSize: 'sm' | 'md' | 'lg' = 'md';
   @state() private sizeDialogOpen = false;
   // etc.
   ```

8. **Add methods:**
   ```typescript
   private showBasicDialog() { this.basicDialogOpen = true; }
   private closeBasicDialog() { this.basicDialogOpen = false; }
   // etc.
   ```
  </action>
  <verify>
Run `npm run dev` and navigate to demo page.
Verify all dialog demos are visible and interactive.
  </verify>
  <done>
Demo page shows all dialog features: basic, sizes, non-dismissible, nested, close button.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Dialog component with:
- Open/close via property
- Focus trap via native showModal()
- Escape key closes (when dismissible)
- Return focus to trigger
- Backdrop click closes (when dismissible)
- Non-dismissible mode
- Enter/exit animations
- Reduced motion support
- Body scroll lock
- Nested dialog support
- Optional close button
  </what-built>
  <how-to-verify>
1. Run `npm run dev` and open http://localhost:5173
2. Test basic dialog:
   - Click "Open Dialog" - should animate in
   - Press Escape - should close
   - Verify focus returns to button
3. Test sizes:
   - Open sm, md, lg dialogs - verify width differences
4. Test non-dismissible:
   - Open non-dismissible dialog
   - Press Escape - should NOT close
   - Click backdrop - should NOT close
   - Must click the close button
5. Test nested dialogs:
   - Open parent dialog
   - Open child dialog from within
   - Close child - parent should remain open
6. Test animations:
   - Dialogs should fade+scale in/out
   - Enable "Reduce motion" in OS settings
   - Dialogs should appear/disappear instantly
7. Test scroll lock:
   - With long page content, body should not scroll when dialog open
8. Test close button:
   - Dialog with show-close-button should have X in corner
  </how-to-verify>
  <resume-signal>Type "approved" if all verifications pass, or describe specific issues</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Demo page loads with dialog section
3. All dialog demos function correctly
4. Nested dialogs close independently
5. Focus returns properly for both parent and child dialogs
6. Visual verification checkpoint passes
</verification>

<success_criteria>
- Nested dialogs work via browser top layer
- Demo page demonstrates all DLG-* requirements
- Human verification confirms functionality
- Optional close button renders when enabled
- All animations and interactions work as specified
</success_criteria>

<output>
After completion, create `.planning/phases/03-dialog-component/03-04-SUMMARY.md`
</output>
