---
phase: 100-1m-streaming-infrastructure-for-line-area
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/charts/src/base/base-chart-element.ts
  - packages/charts/src/shared/line-option-builder.ts
autonomous: true
requirements: [STRM-04]

must_haves:
  truths:
    - "buildLineOption() produces series options with sampling:'lttb', large:true, largeThreshold:2000 for every series"
    - "_initChart() is accessible to subclasses so _triggerReset() can reinitialize without a TypeScript private-access error"
  artifacts:
    - path: "packages/charts/src/shared/line-option-builder.ts"
      provides: "Updated buildLineOption with LTTB + large dataset flags per series"
      contains: "sampling: 'lttb'"
    - path: "packages/charts/src/base/base-chart-element.ts"
      provides: "Protected _initChart() so subclasses can trigger reinit"
      contains: "protected async _initChart"
  key_links:
    - from: "packages/charts/src/line/line-chart.ts"
      to: "packages/charts/src/shared/line-option-builder.ts"
      via: "buildLineOption() import"
      pattern: "buildLineOption"
    - from: "packages/charts/src/line/line-chart.ts (future _triggerReset)"
      to: "packages/charts/src/base/base-chart-element.ts"
      via: "this._initChart() call"
      pattern: "_initChart\\(\\)"
---

<objective>
Make BaseChartElement._initChart() protected so subclasses can trigger dispose+reinit, and add LTTB decimation + large dataset rendering flags to buildLineOption() for all Line/Area series.

Purpose: These are foundational changes that Plans 02 and 03 depend on. The base class change unblocks the reset path in LuiLineChart and LuiAreaChart. The option builder change (STRM-04) activates native ECharts LTTB decimation so zooming out on 1M+ point charts renders a smooth, representative curve.

Output: Modified base-chart-element.ts with protected _initChart(), modified line-option-builder.ts with sampling/large/largeThreshold on every series.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/100-1m-streaming-infrastructure-for-line-area/100-RESEARCH.md

<interfaces>
<!-- Key contracts for the executor. Do not re-explore the codebase. -->

From packages/charts/src/base/base-chart-element.ts:
```typescript
// _initChart is currently PRIVATE — must become PROTECTED
private async _initChart(): Promise<void> {
  await this._registerModules();
  const { init, getInstanceByDom } = await import('echarts/core');
  const container = this.shadowRoot?.querySelector<HTMLDivElement>('#chart');
  if (!container) return;
  const existing = getInstanceByDom(container);
  if (existing) existing.dispose();
  const theme = this._themeBridge.buildThemeObject();
  this._chart = init(container, theme, { renderer: 'canvas' });
  // ... ResizeObserver, MutationObserver, _applyData() ...
}
```

From packages/charts/src/shared/line-option-builder.ts:
```typescript
export function buildLineOption(
  series: LineChartSeries[],
  props: LineOptionProps,
  mode: 'line' | 'area'
): Record<string, unknown>

// Current series map — MISSING sampling/large/largeThreshold:
const echartsSeriesArray = series.map((s, i) => ({
  name: s.name,
  type: 'line' as const,
  data: s.data,
  smooth: props.smooth ?? false,
  areaStyle: isArea ? { opacity: props.opacity ?? 0.6 } : undefined,
  stack: isArea && props.stacked ? 'total' : undefined,
  label: isArea && props.labelPosition ? { show: true, position: props.labelPosition } : undefined,
  markLine: i === 0 && props.markLines?.length ? { ... } : undefined,
}));
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make _initChart() protected in BaseChartElement</name>
  <files>packages/charts/src/base/base-chart-element.ts</files>
  <action>
Change the visibility of `_initChart()` from `private` to `protected` in base-chart-element.ts.

Locate the line:
```typescript
private async _initChart(): Promise<void> {
```

Change to:
```typescript
protected async _initChart(): Promise<void> {
```

That is the ONLY change to base-chart-element.ts. Do not modify any other part of the file.

Why protected and not private: LuiLineChart and LuiAreaChart (Plans 02 and 03) need to call `this._initChart()` from their `_triggerReset()` methods when the streaming buffer reaches maxPoints. Private access would cause a TypeScript compile error. The `protected` modifier is consistent with `_detectRenderer()` which is already protected for the same reason (subclass override pattern).

Do NOT add or change any other methods. Do NOT change _detectRenderer, disconnectedCallback, or any private fields.
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components && npx tsc -p packages/charts/tsconfig.json --noEmit 2>&1 | tail -5</automated>
  </verify>
  <done>TypeScript compilation exits 0 with no errors. The `protected async _initChart()` signature exists in base-chart-element.ts.</done>
</task>

<task type="auto">
  <name>Task 2: Add LTTB sampling and large dataset flags to buildLineOption()</name>
  <files>packages/charts/src/shared/line-option-builder.ts</files>
  <action>
Add `sampling: 'lttb' as const`, `large: true`, and `largeThreshold: 2000` to every series produced by the `series.map()` in `buildLineOption()`.

The updated series map should produce objects like:
```typescript
const echartsSeriesArray = series.map((s, i) => ({
  name: s.name,
  type: 'line' as const,
  data: s.data,
  smooth: props.smooth ?? false,
  sampling: 'lttb' as const,      // STRM-04: native LTTB decimation — activates at high point counts
  large: true,                     // STRM-01: large dataset rendering optimization
  largeThreshold: 2000,            // STRM-01: switch to large path above 2000 points
  areaStyle: isArea ? { opacity: props.opacity ?? 0.6 } : undefined,
  stack: isArea && props.stacked ? 'total' : undefined,
  label: isArea && props.labelPosition ? { show: true, position: props.labelPosition } : undefined,
  markLine:
    i === 0 && props.markLines?.length
      ? {
          silent: false,
          data: props.markLines.map((ml) => ({
            yAxis: ml.value,
            name: ml.label ?? '',
            lineStyle: ml.color ? { color: ml.color } : undefined,
          })),
        }
      : undefined,
}));
```

Key points:
- `sampling: 'lttb' as const` — ECharts requires the literal string type. The `as const` is needed to satisfy the ECharts series type (otherwise TypeScript widens it to `string`).
- `large: true` — activates ECharts internal large-series rendering path (WebGL-accelerated pixel painting).
- `largeThreshold: 2000` — below 2000 points, `large` mode is skipped (no overhead on small datasets).
- These three properties apply to ALL line/area series unconditionally — they are no-ops on small datasets.
- Do NOT change any other part of the file. Types, exports, function signature, and option structure remain unchanged.
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components && npx tsc -p packages/charts/tsconfig.json --noEmit 2>&1 | tail -5</automated>
  </verify>
  <done>TypeScript compilation exits 0. The line-option-builder.ts series map includes `sampling: 'lttb' as const`, `large: true`, and `largeThreshold: 2000` for every series entry.</done>
</task>

</tasks>

<verification>
Run full TypeScript check across the charts package:
```
cd /Users/sn0w/Documents/dev/lit-components && npx tsc -p packages/charts/tsconfig.json --noEmit
```
Must exit 0 with no errors.

Grep confirmation:
```
grep -n "protected async _initChart" packages/charts/src/base/base-chart-element.ts
grep -n "sampling" packages/charts/src/shared/line-option-builder.ts
grep -n "largeThreshold" packages/charts/src/shared/line-option-builder.ts
```
All three greps must return matches.
</verification>

<success_criteria>
- `_initChart()` is `protected` in base-chart-element.ts (not `private`)
- `buildLineOption()` series map includes `sampling: 'lttb' as const`, `large: true`, `largeThreshold: 2000`
- TypeScript compilation passes with zero errors
- No other behavior changes — existing chart tests/builds unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/100-1m-streaming-infrastructure-for-line-area/100-01-SUMMARY.md`
</output>
