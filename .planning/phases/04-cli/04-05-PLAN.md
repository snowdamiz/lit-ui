---
phase: 04-cli
plan: 05
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - packages/cli/src/commands/add.ts
  - packages/cli/src/utils/copy-component.ts
  - packages/cli/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Running `lit-ui add button` copies button.ts to user's project"
    - "Add command resolves and prompts for component dependencies"
    - "Add command handles file conflicts (overwrite/skip prompt)"
    - "Add command requires init to be run first (checks for lit-ui.json)"
  artifacts:
    - path: "packages/cli/src/commands/add.ts"
      provides: "Add command implementation"
      exports: ["add"]
    - path: "packages/cli/src/utils/copy-component.ts"
      provides: "Component file copying with conflict handling"
      exports: ["copyComponent", "copyComponentFiles"]
  key_links:
    - from: "packages/cli/src/commands/add.ts"
      to: "packages/cli/src/utils/registry.ts"
      via: "getComponent, resolveDependencies"
      pattern: "getComponent|resolveDependencies"
    - from: "packages/cli/src/commands/add.ts"
      to: "packages/cli/src/utils/config.ts"
      via: "getConfig"
      pattern: "getConfig"
---

<objective>
Implement the `lit-ui add <component>` command that copies component source to user's project.

Purpose: Add is the main command users will use to install individual components.
Output: Working add command with dependency resolution and conflict handling.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-cli/04-RESEARCH.md
@.planning/phases/04-cli/04-CONTEXT.md
@.planning/phases/04-cli/04-02-SUMMARY.md
@.planning/phases/04-cli/04-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create copy-component utility</name>
  <files>packages/cli/src/utils/copy-component.ts</files>
  <action>
Create copy-component.ts with conflict handling:

```typescript
import { copy, pathExists, ensureDir } from 'fs-extra';
import { consola } from 'consola';
import { resolve, dirname } from 'pathe';

type ConflictResolution = 'overwrite' | 'skip' | 'diff';

interface CopyOptions {
  overwrite?: boolean;
  yes?: boolean;
}

export async function copyComponent(
  sourcePath: string,
  targetPath: string,
  options: CopyOptions
): Promise<boolean> {
  // Ensure target directory exists
  await ensureDir(dirname(targetPath));

  const exists = await pathExists(targetPath);

  if (exists && !options.overwrite) {
    if (options.yes) {
      consola.warn(`Skipping ${targetPath} (already exists)`);
      return false;
    }

    const resolution = await consola.prompt(`File exists: ${targetPath}`, {
      type: 'select',
      options: [
        { value: 'overwrite', label: 'Overwrite' },
        { value: 'skip', label: 'Skip' },
      ],
    }) as ConflictResolution;

    if (resolution === 'skip') return false;
  }

  await copy(sourcePath, targetPath, { overwrite: true });
  return true;
}
```

Also add `copyComponentFiles(files: RegistryFile[], config: LitUIConfig, options: CopyOptions)` that:
- Maps registry file paths to source/target paths
- Calls copyComponent for each file
- Returns list of copied files
  </action>
  <verify>TypeScript compiles</verify>
  <done>Copy utility handles conflicts and directory creation</done>
</task>

<task type="auto">
  <name>Task 2: Create add command</name>
  <files>packages/cli/src/commands/add.ts</files>
  <action>
Create add.ts using citty defineCommand:

1. Command definition:
   ```typescript
   export const add = defineCommand({
     meta: { name: 'add', description: 'Add a component to your project' },
     args: {
       component: {
         type: 'positional',
         description: 'Component name to add',
         required: true,
       },
       yes: { type: 'boolean', alias: 'y', description: 'Skip prompts', default: false },
       overwrite: { type: 'boolean', alias: 'o', description: 'Overwrite existing', default: false },
       cwd: { type: 'string', description: 'Working directory', default: '.' },
     },
     async run({ args }) { ... }
   });
   ```

2. Add flow:
   a. Check lit-ui.json exists - error if not ("Run `lit-ui init` first")
   b. Get config for componentsPath
   c. Look up component in registry - error if not found
   d. Resolve dependencies (registryDependencies)
   e. If dependencies, prompt to install all (unless --yes)
   f. For each component:
      - Show spinner "Adding {component}..."
      - Copy component files to componentsPath
      - Show success checkmark
   g. Summary: "Added: button, dialog" with file paths
   h. Next steps if any dependencies needed

3. Component file embedding strategy:
   - For MVP, embed component source as template strings in CLI
   - Or reference from src/ in monorepo (works for local dev)
   - Map registry paths to actual content
  </action>
  <verify>TypeScript compiles</verify>
  <done>Add command defined with full workflow</done>
</task>

<task type="auto">
  <name>Task 3: Wire add command and test</name>
  <files>packages/cli/src/index.ts</files>
  <action>
1. Update src/index.ts:
   ```typescript
   import { add } from './commands/add';

   const main = defineCommand({
     meta: { ... },
     subCommands: { init, add },
   });
   ```

2. Create templates module if needed for component content
   - packages/cli/src/templates/button.ts
   - packages/cli/src/templates/dialog.ts
   - Export component source as strings

3. Build: `npm run build`

4. Test add command:
   - In a test directory with lit-ui.json
   - Run `node dist/index.js add button --yes`
   - Verify button.ts copied to components path
   - Verify no errors

5. Test add with missing init:
   - In empty directory without lit-ui.json
   - Should error with "Run `lit-ui init` first"
  </action>
  <verify>lit-ui add button copies component files</verify>
  <done>Add command works with config and registry</done>
</task>

</tasks>

<verification>
- `lit-ui add button` copies button.ts to configured componentsPath
- `lit-ui add dialog` copies dialog.ts
- Add without init shows helpful error
- `lit-ui add --help` shows command options
</verification>

<success_criteria>
Add command copies component source with proper paths and conflict handling
</success_criteria>

<output>
After completion, create `.planning/phases/04-cli/04-05-SUMMARY.md`
</output>
