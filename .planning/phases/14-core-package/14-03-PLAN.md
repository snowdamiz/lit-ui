---
phase: 14-core-package
plan: 03
type: execute
wave: 2
depends_on: ["14-01", "14-02"]
files_modified:
  - packages/core/src/fouc.css
  - packages/core/package.json
autonomous: true

must_haves:
  truths:
    - "Consumer imports `import { TailwindElement } from '@lit-ui/core'` successfully"
    - "After hydration, component uses shared constructable stylesheets (memory optimization)"
    - "Tree shaking removes unused exports when bundling consumer app"
  artifacts:
    - path: "packages/core/src/fouc.css"
      provides: "FOUC prevention CSS snippet for consumers"
      contains: ":not(:defined)"
    - path: "packages/core/dist/index.js"
      provides: "Built library output"
      min_lines: 50
  key_links:
    - from: "consumer app"
      to: "@lit-ui/core"
      via: "import statement"
      pattern: "import.*@lit-ui/core"
---

<objective>
Verify build and add FOUC prevention guidance

Purpose: Ensure @lit-ui/core builds correctly, exports work as documented, and consumers have FOUC prevention guidance. This plan validates the entire phase implementation.

Output: Verified build, FOUC prevention CSS, updated documentation
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-core-package/14-RESEARCH.md
@.planning/phases/14-core-package/14-01-SUMMARY.md
@.planning/phases/14-core-package/14-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FOUC Prevention CSS</name>
  <files>packages/core/src/fouc.css</files>
  <action>
Create packages/core/src/fouc.css with FOUC prevention snippet that consumers can import:

```css
/**
 * FOUC Prevention for @lit-ui components
 *
 * Include this CSS in your app's global styles to prevent
 * Flash of Unstyled Content before component JS loads.
 *
 * Usage:
 * @import '@lit-ui/core/fouc.css';
 *
 * Or copy these rules to your own CSS.
 */

/* Hide undefined custom elements */
ui-button:not(:defined),
ui-dialog:not(:defined) {
  opacity: 0;
  visibility: hidden;
}

/* Optional: Show skeleton placeholder instead of hiding */
/*
ui-button:not(:defined) {
  display: inline-block;
  min-width: 80px;
  min-height: 36px;
  background: var(--color-muted, #e5e5e5);
  border-radius: var(--radius-md, 0.375rem);
  animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
*/
```

Add fouc.css to package.json exports:
```json
"./fouc.css": "./src/fouc.css"
```
  </action>
  <verify>Run `ls packages/core/src/fouc.css` and verify file exists</verify>
  <done>FOUC prevention CSS exists and is exported from package</done>
</task>

<task type="auto">
  <name>Task 2: Verify Full Build and Exports</name>
  <files>packages/core/dist/*</files>
  <action>
Run comprehensive build verification:

1. Clean and rebuild:
   ```bash
   rm -rf packages/core/dist
   pnpm --filter @lit-ui/core build
   ```

2. Verify all expected outputs exist:
   - dist/index.js (main entry)
   - dist/index.d.ts (types)
   - dist/tokens/index.js (tokens subpath)
   - dist/tokens/index.d.ts (tokens types)
   - dist/utils/index.js (utils subpath)
   - dist/utils/index.d.ts (utils types)

3. Verify exports in dist/index.js:
   - TailwindElement class
   - isServer re-export
   - dispatchCustomEvent
   - hasConstructableStylesheets
   - VERSION constant

4. Verify dist/index.d.ts contains proper TypeScript declarations

5. Check bundle size is reasonable (should be small since lit is external)

If build fails, debug based on error messages. Common issues:
- Missing ?inline imports for CSS
- Vite config not handling multiple entries
- TypeScript errors in new files
  </action>
  <verify>Run `ls packages/core/dist/` and `ls packages/core/dist/tokens/` to confirm all files exist</verify>
  <done>Build succeeds with all expected outputs in dist/</done>
</task>

<task type="auto">
  <name>Task 3: Validate Tree Shaking and Side Effects</name>
  <files>packages/core/package.json</files>
  <action>
Verify tree shaking setup is correct:

1. Confirm package.json has `"sideEffects": false`

2. Check that all module-level code is guarded:
   - Stylesheet creation guarded with `if (!isServer)`
   - Document manipulation guarded with `typeof document !== 'undefined'`

3. Verify lit is properly externalized (not bundled):
   ```bash
   grep -c "LitElement" packages/core/dist/index.js
   ```
   Should show import reference, not the full LitElement code.

4. Run a quick tree-shaking test by checking the built output doesn't include unused code markers

If sideEffects is not set, add it. If guards are missing, add them to prevent tree-shaking breakage.
  </action>
  <verify>Run `grep sideEffects packages/core/package.json` to confirm it's set to false</verify>
  <done>Package is properly configured for tree shaking with no unguarded side effects</done>
</task>

</tasks>

<verification>
Run from repository root:
1. `pnpm --filter @lit-ui/core build` - Build should succeed
2. `ls -la packages/core/dist/` - List all outputs with sizes
3. `head -20 packages/core/dist/index.js` - Check imports look correct
4. `grep "isServer" packages/core/dist/index.js` - Verify isServer is present
5. Full success criteria from roadmap:
   - Consumer can import TailwindElement
   - SSR inline styles work (isServer conditional)
   - Client adoptedStyleSheets work (guarded initialization)
   - tokens available via subpath
   - Tree shaking works (sideEffects: false)
</verification>

<success_criteria>
1. All dist/ files exist as expected
2. TailwindElement, isServer, dispatchCustomEvent exported
3. tokens/index.js and utils/index.js exist
4. fouc.css exists and is in package exports
5. sideEffects: false in package.json
6. lit is external (not bundled)
</success_criteria>

<output>
After completion, create `.planning/phases/14-core-package/14-03-SUMMARY.md`
</output>
