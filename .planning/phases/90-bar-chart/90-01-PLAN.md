---
phase: 90-bar-chart
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/charts/src/shared/bar-option-builder.ts
  - packages/charts/src/bar/bar-registry.ts
autonomous: true
requirements: [BAR-01, BAR-02, BAR-03]

must_haves:
  truths:
    - "Developer can pass data with multiple named series and see grouped bar charts with correct axis orientation"
    - "Developer can set `stacked` prop and see bars stacked using `stack: 'total'` (string, not boolean)"
    - "Developer can set `horizontal` prop and see axis types swap: xAxis becomes value, yAxis becomes category"
    - "Developer can set `show-labels` prop and see value labels on each bar (top for vertical, right for horizontal)"
    - "Developer can set `color-by-data` prop and see each bar receive a distinct palette color via `colorBy: 'data'`"
  artifacts:
    - path: "packages/charts/src/shared/bar-option-builder.ts"
      provides: "Pure buildBarOption() helper and BarChartSeries/BarOptionProps types"
      exports: ["buildBarOption", "BarChartSeries", "BarOptionProps"]
    - path: "packages/charts/src/bar/bar-registry.ts"
      provides: "registerBarModules() — registers BarChart ECharts module exactly once via _barRegistered guard"
      exports: ["registerBarModules"]
  key_links:
    - from: "packages/charts/src/bar/bar-chart.ts"
      to: "packages/charts/src/shared/bar-option-builder.ts"
      via: "import { buildBarOption, BarChartSeries }"
      pattern: "buildBarOption"
    - from: "packages/charts/src/bar/bar-registry.ts"
      to: "packages/charts/src/registry/canvas-core.ts"
      via: "registerCanvasCore() called before use([BarChart])"
      pattern: "registerCanvasCore"
---

<objective>
Create the shared bar option builder (types + pure function) and the per-chart ECharts module registry for bar charts — covering BAR-01, BAR-02, and the streaming infrastructure foundation for BAR-03.

Purpose: Establish the contracts and registry that LuiBarChart (Plan 02) depends on, following the identical Phase 89 pattern of option-builder-first, component-second.
Output: `bar-option-builder.ts` with `buildBarOption` + types; `bar-registry.ts` with `registerBarModules`.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/90-bar-chart/90-RESEARCH.md
@.planning/phases/89-line-chart-area-chart/89-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from Phase 88/89 codebase. -->
<!-- Executor should use these directly — no codebase exploration needed. -->

From packages/charts/src/base/base-chart-element.ts:
```typescript
export abstract class BaseChartElement extends TailwindElement {
  @property({ attribute: false }) option?: EChartsCoreOption;
  @property({ attribute: false }) data?: unknown;
  @property({ type: Boolean }) loading = false;
  @property({ type: Boolean, attribute: 'enable-gl' }) enableGl = false;
  @property({ type: Number }) maxPoints = 1000;

  protected _chart: EChartsType | null = null;
  // Bar charts use 'buffer' default (STRM-04 — do NOT override to 'appendData')
  protected _streamingMode: 'appendData' | 'buffer' = 'buffer';

  protected abstract _registerModules(): Promise<void>;
  getChart(): EChartsType | undefined;
  pushData(point: unknown): void;  // RAF-coalesced; bar uses circular buffer path

  override updated(changed: PropertyValues): void; // base handles 'option' and 'loading'
}
// Buffer mode: _flushPendingData() calls setOption({ series: [{ data: _circularBuffer }] }, { lazyUpdate: true })
// This updates series[0] only. Document: pushData() targets series[0] for multi-series bar charts.
```

From packages/charts/src/registry/canvas-core.ts:
```typescript
export async function registerCanvasCore(): Promise<void>;
// Registers: CanvasRenderer, TitleComponent, TooltipComponent, GridComponent,
// LegendComponent, DataZoomComponent, MarkLineComponent, MarkAreaComponent,
// ToolboxComponent, LabelLayout, UniversalTransition
// Guard: _registered module-level flag — safe to call from multiple chart instances
// NOTE: BarChart is NOT registered here — bar-registry.ts must register it separately
```

From packages/charts/src/line/line-registry.ts (pattern to replicate):
```typescript
let _lineRegistered = false;

export async function registerLineModules(): Promise<void> {
  if (_lineRegistered) return;
  _lineRegistered = true;

  const { registerCanvasCore } = await import('../registry/canvas-core.js');
  await registerCanvasCore();

  const [{ LineChart }, { use }] = await Promise.all([
    import('echarts/charts'),
    import('echarts/core'),
  ]);

  use([LineChart]);
}
```

From packages/charts/src/shared/line-option-builder.ts (structure to replicate for bar):
```typescript
export type LineChartSeries = { name: string; data: (number | [number | string, number] | null)[]; };
export type MarkLineSpec = { value: number; label?: string; color?: string; };
export type LineOptionProps = { smooth?: boolean | number; zoom?: boolean; markLines?: MarkLineSpec[]; stacked?: boolean; opacity?: number; };
export function buildLineOption(series: LineChartSeries[], props: LineOptionProps, mode: 'line' | 'area'): Record<string, unknown>;
```

From packages/charts/src/index.ts (current exports — Plan 02 will add bar exports):
```typescript
export { BaseChartElement } from './base/base-chart-element.js';
export { ThemeBridge } from './base/theme-bridge.js';
export { registerCanvasCore } from './registry/canvas-core.js';
export type { EChartsOption } from './base/base-chart-element.js';
export { LuiLineChart } from './line/line-chart.js';
export { LuiAreaChart } from './area/area-chart.js';
export type { LineChartSeries, MarkLineSpec, LineOptionProps } from './shared/line-option-builder.js';
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bar-option-builder.ts</name>
  <files>packages/charts/src/shared/bar-option-builder.ts</files>
  <action>
Create `packages/charts/src/shared/bar-option-builder.ts` with the following exact content. This is the single source of truth for bar chart ECharts option construction.

```typescript
// packages/charts/src/shared/bar-option-builder.ts

// BAR-01: Data shape — named series with numeric value arrays.
// Category axis labels are derived from array position (ECharts default) or via
// the `categories` field which sets xAxis.data (vertical) or yAxis.data (horizontal).
export type BarChartSeries = {
  name: string;
  data: (number | null)[];
};

export type BarOptionProps = {
  // BAR-01: Stack all series using 'total' group. string, NOT boolean — ECharts requires string group name.
  stacked?: boolean;
  // BAR-01: Swap axis types: xAxis becomes value, yAxis becomes category.
  horizontal?: boolean;
  // BAR-02: Render value labels on each bar. Position adapts: 'top' vertical, 'right' horizontal.
  showLabels?: boolean;
  // BAR-02: Each bar gets a distinct palette color via colorBy: 'data'.
  // Best with single-series bar; multi-series results in per-bar palette cycling (expected behavior).
  colorByData?: boolean;
  // Optional axis category labels. When provided: sets xAxis.data (vertical) or yAxis.data (horizontal).
  // When omitted: ECharts uses integer indices (0, 1, 2...) as category labels.
  categories?: string[];
};

export function buildBarOption(
  series: BarChartSeries[],
  props: BarOptionProps
): Record<string, unknown> {
  const echartsSeriesArray = series.map((s) => ({
    name: s.name,
    type: 'bar' as const,
    data: s.data,
    // BAR-01: stack MUST be string 'total', never boolean.
    // stack: false or stack: undefined disables stacking; stack: true (boolean) does NOT work.
    stack: props.stacked ? 'total' : undefined,
    // BAR-02: Value labels — position depends on orientation to avoid clipping.
    // Pitfall: 'top' on horizontal bars clips labels outside bar bounds; 'right' places them at bar end.
    label: props.showLabels
      ? {
          show: true,
          position: props.horizontal ? ('right' as const) : ('top' as const),
        }
      : undefined,
    // BAR-02: colorBy: 'data' = each bar gets a distinct palette color from ThemeBridge palette.
    // Default 'series' = all bars in a series share one palette color.
    // colorBy is on SeriesOption base (shared.d.ts:7278) — valid on BarSeriesOption.
    colorBy: props.colorByData ? ('data' as const) : ('series' as const),
  }));

  // BAR-01: Horizontal orientation — swap which axis is 'category' vs 'value'.
  // BOTH axes must swap atomically. Swapping only one produces garbled bar output.
  const categoryAxisConfig = props.categories
    ? { type: 'category' as const, data: props.categories }
    : { type: 'category' as const };
  const valueAxis = { type: 'value' as const };

  return {
    legend: { show: series.length > 1 },
    tooltip: {
      trigger: 'axis' as const,
      // axisPointer shadow shows column band on hover — conventional for bar charts.
      axisPointer: { type: 'shadow' as const },
    },
    // Horizontal: yAxis is categories, xAxis is values.
    // Vertical: xAxis is categories (default), yAxis is values.
    xAxis: props.horizontal ? valueAxis : categoryAxisConfig,
    yAxis: props.horizontal ? categoryAxisConfig : valueAxis,
    series: echartsSeriesArray,
  };
}
```

Key correctness notes:
- `stack` MUST be string `'total'`, never boolean — same pitfall as Phase 89 area chart. `stack: props.stacked ? 'total' : undefined` is the correct pattern (omit when false, not `stack: false`).
- Both axes swap atomically in horizontal mode — swapping only xAxis or only yAxis produces garbled output.
- Label position `'right'` for horizontal, `'top'` for vertical — avoids label clipping at bar boundaries.
- `colorBy: 'data'` uses the ThemeBridge-injected `--ui-chart-*` palette automatically; no manual color lookup needed.
- `categories` field is optional — when omitted ECharts uses integer indices as category labels. Consumers needing named labels pass them here, or use the `option` prop passthrough on the component.
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components && npx tsc --noEmit -p packages/charts/tsconfig.json 2>&1 | head -30</automated>
  </verify>
  <done>File exists at `packages/charts/src/shared/bar-option-builder.ts` with all three exports (`BarChartSeries`, `BarOptionProps`, `buildBarOption`). TypeScript compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Create bar-registry.ts</name>
  <files>packages/charts/src/bar/bar-registry.ts</files>
  <action>
Create the `packages/charts/src/bar/` directory and `bar-registry.ts` inside it. This file registers the ECharts `BarChart` module exactly once using the same guard pattern as `line-registry.ts`.

```typescript
/**
 * Bar chart ECharts module registry.
 *
 * Called by LuiBarChart._registerModules() during chart initialization.
 * BarChart is NOT registered in canvas-core.ts — it must be registered here.
 *
 * _barRegistered guard prevents double-registration when multiple LuiBarChart
 * instances are on the same page. registerCanvasCore() has its own guard,
 * so calling it here is safe regardless of page initialization order.
 *
 * Unlike LuiLineChart/LuiAreaChart, bar charts do NOT use a shared registry
 * across variants — there is only one bar chart type.
 */

let _barRegistered = false;

export async function registerBarModules(): Promise<void> {
  if (_barRegistered) return;
  _barRegistered = true;

  // registerCanvasCore() registers CanvasRenderer + shared ECharts components.
  // Its own _registered guard makes double-call safe from any other chart registry.
  const { registerCanvasCore } = await import('../registry/canvas-core.js');
  await registerCanvasCore();

  // BarChart import: tree-shaken subpath import — keeps bundle at ~135KB gzip.
  // Do NOT use `import * as echarts from 'echarts'` (~400KB gzip).
  const [{ BarChart }, { use }] = await Promise.all([
    import('echarts/charts'),
    import('echarts/core'),
  ]);

  use([BarChart]);
}
```

Verification: confirm the file compiles and the `bar/` directory was created:
```bash
ls packages/charts/src/bar/
npx tsc --noEmit -p packages/charts/tsconfig.json 2>&1 | head -20
```
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components && ls packages/charts/src/bar/ && npx tsc --noEmit -p packages/charts/tsconfig.json 2>&1 | head -20</automated>
  </verify>
  <done>
    - `packages/charts/src/bar/` directory exists
    - `packages/charts/src/bar/bar-registry.ts` exists and exports `registerBarModules`
    - `_barRegistered` module-level guard is present
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
Run the full type check to confirm both new files compile cleanly with the rest of the charts package:

```bash
cd /Users/sn0w/Documents/dev/lit-components && npx tsc --noEmit -p packages/charts/tsconfig.json
```

Expected: Zero TypeScript errors. The build output is not yet updated (index.ts export happens in Plan 02).
</verification>

<success_criteria>
- `packages/charts/src/shared/bar-option-builder.ts` exists with `BarChartSeries`, `BarOptionProps`, `buildBarOption` exports
- `buildBarOption` correctly implements: `stack: 'total'` string for stacked, axis type swap for horizontal, label position adapts to orientation, `colorBy: 'data'` for per-bar color
- `packages/charts/src/bar/bar-registry.ts` exists with `registerBarModules` export and `_barRegistered` guard
- `registerBarModules()` calls `registerCanvasCore()` then `use([BarChart])` via tree-shaken subpath imports
- TypeScript compiles cleanly (zero errors) across the charts package
</success_criteria>

<output>
After completion, create `.planning/phases/90-bar-chart/90-01-SUMMARY.md`
</output>
