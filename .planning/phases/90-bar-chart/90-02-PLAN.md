---
phase: 90-bar-chart
plan: 02
type: execute
wave: 2
depends_on: ["90-01"]
files_modified:
  - packages/charts/src/bar/bar-chart.ts
  - packages/charts/src/index.ts
autonomous: true
requirements: [BAR-01, BAR-02, BAR-03]

must_haves:
  truths:
    - "Developer can import LuiBarChart from '@lit-ui/charts' and use <lui-bar-chart> as a custom element"
    - "Developer can set `stacked` prop and see bars stacked correctly; set `horizontal` prop and see axis orientation flip"
    - "Developer can set `show-labels` and see value labels on bars; set `color-by-data` and see per-bar palette colors"
    - "Developer can call `pushData(point)` and see the chart update via circular buffer without full re-initialization"
    - "Developer can import BarChartSeries and BarOptionProps types from '@lit-ui/charts'"
  artifacts:
    - path: "packages/charts/src/bar/bar-chart.ts"
      provides: "LuiBarChart Lit custom element extending BaseChartElement"
      exports: ["LuiBarChart"]
    - path: "packages/charts/src/index.ts"
      provides: "Updated public API — adds LuiBarChart, BarChartSeries, BarOptionProps exports"
      exports: ["LuiBarChart", "BarChartSeries", "BarOptionProps"]
  key_links:
    - from: "packages/charts/src/bar/bar-chart.ts"
      to: "packages/charts/src/shared/bar-option-builder.ts"
      via: "import { buildBarOption, BarChartSeries }"
      pattern: "buildBarOption"
    - from: "packages/charts/src/bar/bar-chart.ts"
      to: "packages/charts/src/bar/bar-registry.ts"
      via: "_registerModules() calls registerBarModules()"
      pattern: "registerBarModules"
    - from: "packages/charts/src/bar/bar-chart.ts"
      to: "packages/charts/src/base/base-chart-element.ts"
      via: "extends BaseChartElement — _streamingMode NOT overridden (uses 'buffer' default)"
      pattern: "extends BaseChartElement"
    - from: "packages/charts/src/index.ts"
      to: "packages/charts/src/bar/bar-chart.ts"
      via: "export { LuiBarChart }"
      pattern: "LuiBarChart"
---

<objective>
Create LuiBarChart and wire it into the @lit-ui/charts public API via index.ts — completing Phase 90.

Purpose: Ship the concrete bar chart component using the option builder and registry from Plan 01, then export everything consumers need from the package public API.
Output: `bar-chart.ts` (LuiBarChart component); updated `index.ts` with LuiBarChart and bar type exports.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/90-bar-chart/90-RESEARCH.md
@.planning/phases/90-bar-chart/90-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts produced by Plan 01. Executor uses these directly. -->

From packages/charts/src/shared/bar-option-builder.ts (created in Plan 01):
```typescript
export type BarChartSeries = {
  name: string;
  data: (number | null)[];
};

export type BarOptionProps = {
  stacked?: boolean;      // maps to stack: 'total' (string) — NOT boolean
  horizontal?: boolean;   // swaps xAxis/yAxis types atomically
  showLabels?: boolean;   // label: { show: true, position: 'top'|'right' }
  colorByData?: boolean;  // colorBy: 'data' vs default 'series'
  categories?: string[];  // optional axis category labels
};

export function buildBarOption(
  series: BarChartSeries[],
  props: BarOptionProps
): Record<string, unknown>;
```

From packages/charts/src/bar/bar-registry.ts (created in Plan 01):
```typescript
export async function registerBarModules(): Promise<void>;
// Registers CanvasRenderer + shared components via registerCanvasCore()
// then registers BarChart ECharts module.
// _barRegistered guard makes repeated calls safe.
```

From packages/charts/src/base/base-chart-element.ts:
```typescript
export abstract class BaseChartElement extends TailwindElement {
  @property({ attribute: false }) option?: EChartsCoreOption;
  @property({ attribute: false }) data?: unknown;
  @property({ type: Boolean }) loading = false;
  @property({ type: Number }) maxPoints = 1000;

  protected _chart: EChartsType | null = null;
  // CRITICAL for BAR-03: DO NOT override _streamingMode.
  // Default 'buffer' provides circular buffer + setOption({ lazyUpdate: true }) automatically.
  // Overriding to 'appendData' would break bar streaming — appendData only works for line series.
  protected _streamingMode: 'appendData' | 'buffer' = 'buffer';

  protected abstract _registerModules(): Promise<void>;
  getChart(): EChartsType | undefined;
  pushData(point: unknown): void;  // RAF-coalesced; 'buffer' mode: updates series[0].data

  override updated(changed: PropertyValues): void; // base handles 'option' and 'loading'
}
```

From packages/charts/src/index.ts (current — Plan 02 appends bar exports):
```typescript
// Phase 88: Infrastructure
export { BaseChartElement } from './base/base-chart-element.js';
export { ThemeBridge } from './base/theme-bridge.js';
export { registerCanvasCore } from './registry/canvas-core.js';
export type { EChartsOption } from './base/base-chart-element.js';

// Phase 89: Line Chart + Area Chart
export { LuiLineChart } from './line/line-chart.js';
export { LuiAreaChart } from './area/area-chart.js';
export type { LineChartSeries, MarkLineSpec, LineOptionProps } from './shared/line-option-builder.js';
```

From packages/charts/src/line/line-chart.ts (pattern to replicate — key differences noted):
```typescript
export class LuiLineChart extends BaseChartElement {
  constructor() {
    super();
    this._streamingMode = 'appendData';  // BAR CHART: do NOT copy this override
  }
  @property({ type: Boolean }) smooth = false;
  @property({ type: Boolean }) zoom = false;
  @property({ attribute: false }) markLines?: MarkLineSpec[];

  protected override async _registerModules(): Promise<void> {
    await registerLineModules();
  }
  override updated(changed: PropertyValues): void {
    super.updated(changed);
    if (!this._chart) return;
    const lineProps = ['data', 'smooth', 'zoom', 'markLines'] as const;
    if (lineProps.some((k) => changed.has(k))) {
      this._applyData();
    }
  }
  private _applyData(): void { ... }
}
if (typeof customElements !== 'undefined' && !customElements.get('lui-line-chart')) {
  customElements.define('lui-line-chart', LuiLineChart);
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LuiBarChart (bar-chart.ts)</name>
  <files>packages/charts/src/bar/bar-chart.ts</files>
  <action>
Create `packages/charts/src/bar/bar-chart.ts`. LuiBarChart follows the same pattern as LuiLineChart with two critical differences: (1) NO `_streamingMode` override in constructor — bar charts use the base `'buffer'` default per STRM-04; (2) Four props instead of three: `stacked`, `horizontal`, `showLabels`, `colorByData`.

```typescript
/**
 * LuiBarChart — Bar chart component extending BaseChartElement.
 *
 * BAR-01: Grouped (default), stacked, and horizontal bar charts
 * BAR-02: Value labels on bars (`show-labels`); per-bar palette color (`color-by-data`)
 * BAR-03: Streaming via inherited pushData() — circular buffer path (base default)
 *
 * STRM-04 compliance: Bar charts use the circular buffer path (_streamingMode = 'buffer').
 * DO NOT override _streamingMode to 'appendData' — appendData only works for line series.
 * The base class _flushPendingData() handles circular buffer automatically.
 *
 * Streaming limitation: pushData() updates series[0].data only (base buffer behavior).
 * For grouped multi-series bar charts, only the first series is updated by pushData().
 * This satisfies BAR-03 ("chart update via circular buffer without full re-initialization").
 */

import { property } from 'lit/decorators.js';
import type { PropertyValues } from 'lit';
import { BaseChartElement } from '../base/base-chart-element.js';
import { registerBarModules } from './bar-registry.js';
import { buildBarOption, type BarChartSeries } from '../shared/bar-option-builder.js';

export class LuiBarChart extends BaseChartElement {
  // NO constructor override — base _streamingMode = 'buffer' is correct for bar charts.
  // STRM-04: "all other chart types use circular buffer + setOption({ lazyUpdate: true })"

  // BAR-01: Stack all series in one group. Passes stack: 'total' (string) to buildBarOption.
  @property({ type: Boolean }) stacked = false;

  // BAR-01: Horizontal orientation. Swaps xAxis/yAxis types atomically in buildBarOption.
  @property({ type: Boolean }) horizontal = false;

  // BAR-02: Value labels on each bar. Position: 'top' (vertical) or 'right' (horizontal).
  @property({ type: Boolean, attribute: 'show-labels' }) showLabels = false;

  // BAR-02: Each bar receives a distinct palette color (colorBy: 'data').
  // Best with single-series bar charts. Multi-series: each bar cycles through palette per series.
  @property({ type: Boolean, attribute: 'color-by-data' }) colorByData = false;

  protected override async _registerModules(): Promise<void> {
    await registerBarModules();
  }

  override updated(changed: PropertyValues): void {
    super.updated(changed); // base handles this.option passthrough and this.loading state
    if (!this._chart) return;
    const barProps = ['data', 'stacked', 'horizontal', 'showLabels', 'colorByData'] as const;
    if (barProps.some((k) => changed.has(k))) {
      this._applyData();
    }
  }

  private _applyData(): void {
    if (!this._chart || !this.data) return;
    const option = buildBarOption(this.data as BarChartSeries[], {
      stacked: this.stacked,
      horizontal: this.horizontal,
      showLabels: this.showLabels,
      colorByData: this.colorByData,
    });
    // notMerge: false — merge with any option prop overrides from the base class.
    // Note: if pushData() streaming is active, _applyData() will momentarily overwrite
    // series[0] data with the static data prop; the next RAF flush will restore streamed data.
    this._chart.setOption(option, { notMerge: false });
  }
}

// Custom element registration — same guard pattern as all other @lit-ui packages.
if (typeof customElements !== 'undefined' && !customElements.get('lui-bar-chart')) {
  customElements.define('lui-bar-chart', LuiBarChart);
}

declare global {
  interface HTMLElementTagNameMap {
    'lui-bar-chart': LuiBarChart;
  }
}
```

Important implementation notes:
- `super.updated(changed)` called first — base handles `this.option` passthrough and `this.loading`
- No `_streamingMode` override anywhere — `'buffer'` is the correct default for bar charts
- `as const` on `barProps` array — required for TypeScript to narrow types when calling `changed.has(k)`
- `data` prop is typed `unknown` in the base class; `as BarChartSeries[]` cast in `_applyData()` is consumer's responsibility
- `categories` can be passed via the `option` prop (BaseChartElement passthrough) if named axis labels are needed
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components && npx tsc --noEmit -p packages/charts/tsconfig.json 2>&1 | head -30</automated>
  </verify>
  <done>
    - `packages/charts/src/bar/bar-chart.ts` exists and exports `LuiBarChart`
    - Registers `lui-bar-chart` custom element with guard
    - No `_streamingMode` override (inherits `'buffer'` from base)
    - `stacked`, `horizontal`, `show-labels`, `color-by-data` props present
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Update index.ts exports and verify full build</name>
  <files>packages/charts/src/index.ts</files>
  <action>
Read `packages/charts/src/index.ts` first, then append the Phase 90 bar chart exports. The current content is:

```typescript
// @lit-ui/charts — High-performance chart components with WebGL rendering,
// real-time streaming, and CSS token theming built with Lit and ECharts

// Phase 88: Infrastructure
export { BaseChartElement } from './base/base-chart-element.js';
export { ThemeBridge } from './base/theme-bridge.js';
export { registerCanvasCore } from './registry/canvas-core.js';
export type { EChartsOption } from './base/base-chart-element.js';

// Phase 89: Line Chart + Area Chart
export { LuiLineChart } from './line/line-chart.js';
export { LuiAreaChart } from './area/area-chart.js';
export type { LineChartSeries, MarkLineSpec, LineOptionProps } from './shared/line-option-builder.js';
```

Replace with the following complete content (Phase 90 section appended):

```typescript
// @lit-ui/charts — High-performance chart components with WebGL rendering,
// real-time streaming, and CSS token theming built with Lit and ECharts

// Phase 88: Infrastructure
export { BaseChartElement } from './base/base-chart-element.js';
export { ThemeBridge } from './base/theme-bridge.js';
export { registerCanvasCore } from './registry/canvas-core.js';
export type { EChartsOption } from './base/base-chart-element.js';

// Phase 89: Line Chart + Area Chart
export { LuiLineChart } from './line/line-chart.js';
export { LuiAreaChart } from './area/area-chart.js';
export type { LineChartSeries, MarkLineSpec, LineOptionProps } from './shared/line-option-builder.js';

// Phase 90: Bar Chart
export { LuiBarChart } from './bar/bar-chart.js';
export type { BarChartSeries, BarOptionProps } from './shared/bar-option-builder.js';
```

After updating index.ts, run a full package build to confirm dist output includes LuiBarChart:

```bash
cd /Users/sn0w/Documents/dev/lit-components && pnpm --filter @lit-ui/charts build
```

Then verify the type declarations include the new exports:

```bash
grep "LuiBarChart\|BarChartSeries\|BarOptionProps" packages/charts/dist/index.d.ts
```
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components && pnpm --filter @lit-ui/charts build 2>&1 | tail -15 && grep -c "LuiBarChart\|BarChartSeries\|BarOptionProps" packages/charts/dist/index.d.ts</automated>
  </verify>
  <done>
    - `packages/charts/src/index.ts` exports `LuiBarChart`, `BarChartSeries`, `BarOptionProps`
    - `pnpm build` for @lit-ui/charts succeeds with zero errors
    - `dist/index.d.ts` contains LuiBarChart, BarChartSeries, BarOptionProps exports (grep count >= 3)
    - `dist/index.js` updated with bar chart component code
  </done>
</task>

</tasks>

<verification>
Final cross-check after both tasks complete:

```bash
# 1. TypeScript clean
cd /Users/sn0w/Documents/dev/lit-components && npx tsc --noEmit -p packages/charts/tsconfig.json

# 2. Build succeeds
pnpm --filter @lit-ui/charts build

# 3. All required Phase 90 exports present in dist
grep "LuiBarChart\|BarChartSeries\|BarOptionProps" packages/charts/dist/index.d.ts
```

All three commands should succeed with zero errors and matching export names.
</verification>

<success_criteria>
- `packages/charts/src/bar/bar-chart.ts` exists with LuiBarChart, no `_streamingMode` override, stacked/horizontal/showLabels/colorByData props
- `packages/charts/src/index.ts` exports LuiBarChart, BarChartSeries, BarOptionProps
- `pnpm build` for @lit-ui/charts succeeds
- `dist/index.d.ts` contains all three new Phase 90 exports
- Zero TypeScript errors across the charts package
- `lui-bar-chart` custom element registered with guard
</success_criteria>

<output>
After completion, create `.planning/phases/90-bar-chart/90-02-SUMMARY.md`
</output>
