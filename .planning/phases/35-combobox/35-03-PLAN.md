---
phase: 35-combobox
plan: 03
type: execute
wave: 2
depends_on: ["35-01"]
files_modified:
  - packages/select/src/select.ts
autonomous: true

must_haves:
  truths:
    - "User can provide custom filter function to override default contains matching"
    - "User in creatable mode sees 'Create xyz' option when no exact match exists"
    - "User clicks create option and onCreate event fires with the typed value"
    - "User can select create option with keyboard and onCreate event fires"
  artifacts:
    - path: "packages/select/src/select.ts"
      provides: "Custom filter and creatable mode"
      contains: "creatable"
  key_links:
    - from: "packages/select/src/select.ts"
      to: "onCreate event"
      via: "handleCreate method"
      pattern: "onCreate"
    - from: "packages/select/src/select.ts"
      to: "customFilter"
      via: "filteredOptions getter"
      pattern: "customFilter"
---

<objective>
Add custom filter function support and creatable mode for adding new options.

Purpose: Allow developers to customize filtering logic and enable users to create new options when no match exists.
Output: customFilter prop for custom filtering, creatable prop with onCreate event, "Create 'xyz'" option with + icon.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/35-combobox/35-CONTEXT.md
@.planning/phases/35-combobox/35-RESEARCH.md
@packages/select/src/select.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add custom filter function prop</name>
  <files>packages/select/src/select.ts</files>
  <action>
Add support for custom filter functions:

1. Add type definition for custom filter:
```typescript
/**
 * Custom filter function signature.
 * Returns true if the option should be included in filtered results.
 */
export type FilterFunction = (option: SelectOption, query: string) => boolean;
```

2. Add property:
```typescript
/**
 * Custom filter function for filtering options.
 * If provided, overrides the default case-insensitive contains matching.
 * @example
 * // Filter by value instead of label
 * customFilter={(opt, q) => opt.value.toLowerCase().includes(q.toLowerCase())}
 */
@property({ attribute: false })
customFilter?: FilterFunction;
```

3. Update `filteredOptions` getter to use customFilter when provided:
   - If customFilter exists: use it to determine inclusion
   - Still compute matchIndices for highlighting (use default contains logic)
   - This allows custom filtering while preserving highlight behavior

4. Example behavior:
   - Default: filters by label with case-insensitive contains
   - With customFilter: uses custom logic but still highlights based on query match in label
  </action>
  <verify>Build passes, custom filter can be set via property</verify>
  <done>customFilter prop allows developers to override default filtering logic</done>
</task>

<task type="auto">
  <name>Task 2: Add creatable mode with create option</name>
  <files>packages/select/src/select.ts</files>
  <action>
Add creatable mode that shows "Create 'xyz'" option when no exact match:

1. Add properties:
```typescript
/**
 * Whether users can create new options by typing values not in the list.
 * When enabled, shows a "Create 'xyz'" option when the filter query
 * doesn't exactly match any existing option.
 * @default false
 */
@property({ type: Boolean })
creatable = false;
```

2. Add state for tracking if create option is focused:
```typescript
@state()
private createOptionActive = false;
```

3. Add `shouldShowCreateOption()` method:
   - Return false if not searchable or not creatable
   - Return false if filterQuery is empty or whitespace only
   - Return false if any option's label OR value matches filterQuery exactly (case-insensitive)
   - Return true otherwise

4. Add `renderCreateOption()` method:
```typescript
private renderCreateOption() {
  if (!this.shouldShowCreateOption()) return nothing;

  const isActive = this.createOptionActive;
  return html`
    <div
      class="option option-create ${isActive ? 'option-active' : ''}"
      role="option"
      aria-selected="false"
      @click=${this.handleCreateClick}
      @mouseenter=${() => this.setCreateOptionActive(true)}
    >
      <svg class="create-icon" viewBox="0 0 16 16" aria-hidden="true">
        <path d="M8 2v12M2 8h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span>Create "${this.filterQuery}"</span>
    </div>
  `;
}
```

5. Add CSS for create option:
```css
.option-create {
  border-top: 1px solid var(--ui-select-dropdown-border);
}

.create-icon {
  width: 1em;
  height: 1em;
  margin-right: 0.5rem;
  flex-shrink: 0;
}
```

6. Update render() to include create option at the bottom of listbox:
   - Render after normal options (or after empty state if no matches)
   - Create option appears even when there are partial matches (but not exact match)

7. Add `setCreateOptionActive(active: boolean)` method:
   - Sets createOptionActive state
   - When true, clear activeIndex (deselect regular options)
  </action>
  <verify>Type unique value in creatable select, see "Create 'xyz'" option at bottom with + icon</verify>
  <done>Creatable select shows "Create 'xyz'" option when no exact match exists, with plus icon</done>
</task>

<task type="auto">
  <name>Task 3: Handle create option selection and keyboard</name>
  <files>packages/select/src/select.ts</files>
  <action>
Wire up create option to fire onCreate event and work with keyboard:

1. Add `handleCreateClick()` method:
```typescript
private handleCreateClick(): void {
  this.fireCreateEvent();
}

private fireCreateEvent(): void {
  const value = this.filterQuery.trim();
  if (!value) return;

  this.dispatchEvent(
    new CustomEvent('create', {
      detail: { value },
      bubbles: true,
      composed: true,
    })
  );

  // Clear filter and close dropdown after create
  this.filterQuery = '';
  this.closeDropdown();
}
```

2. Update keyboard navigation to include create option:
   - When navigating down past last filtered option: move to create option (if visible)
   - When on create option and pressing up: move to last filtered option
   - When on create option and pressing Enter/Space: fire create event
   - Track this with createOptionActive state

3. Modify `focusNextEnabledOption()`:
   - After reaching last option, if create option visible, set createOptionActive = true and activeIndex = -1

4. Modify `focusPreviousEnabledOption()`:
   - If createOptionActive is true, set it to false and focus last filtered option
   - Otherwise normal behavior

5. Modify `handleKeydown()` for create option:
   - When createOptionActive and Enter/Space pressed: call fireCreateEvent()

6. Update ARIA for create option navigation:
   - Give create option an ID for aria-activedescendant
   - Update aria-activedescendant to point to create option when active

7. Clear createOptionActive when:
   - Filter query changes
   - Dropdown closes
   - Mouse enters a regular option
  </action>
  <verify>Navigate to create option with arrow keys, press Enter, onCreate event fires with typed value</verify>
  <done>Create option selectable via click and keyboard, onCreate event fires with typed value, keyboard navigation includes create option</done>
</task>

</tasks>

<verification>
1. Build passes: `cd packages/select && pnpm build`
2. Custom filter function works when provided
3. Creatable select shows "Create 'xyz'" option when no exact match
4. Create option has + icon
5. Clicking create option fires onCreate event with the value
6. Arrow keys can navigate to create option
7. Enter on create option fires onCreate event
8. Create option doesn't appear when exact match exists
</verification>

<success_criteria>
- COMBO-05: Combobox supports custom filter function prop
- COMBO-06: Combobox supports creatable prop (add new option if not found)
- Create option appears at bottom with + icon
- onCreate event fires with typed value
- Keyboard navigation includes create option
- No create option shown for exact matches
</success_criteria>

<output>
After completion, create `.planning/phases/35-combobox/35-03-SUMMARY.md`
</output>
