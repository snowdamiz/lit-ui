---
phase: 35-combobox
plan: 02
type: execute
wave: 2
depends_on: ["35-01"]
files_modified:
  - packages/select/src/select.ts
  - packages/core/src/styles/tailwind.css
  - packages/core/src/tokens/index.ts
autonomous: true

must_haves:
  truths:
    - "User sees matching text highlighted with bold in filtered options"
    - "User sees 'No results found' when filter has no matches"
    - "User can customize the empty state message via prop"
  artifacts:
    - path: "packages/select/src/select.ts"
      provides: "Match highlighting and empty state"
      contains: "renderHighlightedLabel"
    - path: "packages/core/src/styles/tailwind.css"
      provides: "Highlight CSS tokens"
      contains: "--ui-select-highlight"
  key_links:
    - from: "packages/select/src/select.ts"
      to: "filteredOptions"
      via: "matchIndices in filter result"
      pattern: "matchIndices"
---

<objective>
Add match highlighting to filtered options and empty state when no options match.

Purpose: Visual feedback showing which text matched the filter query, plus clear messaging when no options match.
Output: Bold text highlighting ALL occurrences of matches, customizable empty state message.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/35-combobox/35-CONTEXT.md
@.planning/phases/35-combobox/35-RESEARCH.md
@packages/select/src/select.ts
@packages/core/src/styles/tailwind.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CSS tokens for highlight styling</name>
  <files>packages/core/src/styles/tailwind.css, packages/core/src/tokens/index.ts</files>
  <action>
Add CSS tokens for match highlighting in the select component:

1. In `packages/core/src/styles/tailwind.css`, add under the select tokens section (after checkbox tokens):
```css
/* Combobox highlight */
--ui-select-highlight-weight: 600;
--ui-select-highlight-text: inherit;
```

2. In `packages/core/src/tokens/index.ts`, add to the select tokens object (after checkbox section):
```typescript
// Combobox highlight
highlightWeight: 'var(--ui-select-highlight-weight)',
highlightText: 'var(--ui-select-highlight-text)',
```

These tokens allow theming of the highlight appearance while defaulting to bold text with inherited color (per CONTEXT.md decision).
  </action>
  <verify>Build core package: `cd packages/core && pnpm build`</verify>
  <done>CSS tokens for highlight styling exist in tailwind.css and tokens/index.ts</done>
</task>

<task type="auto">
  <name>Task 2: Implement match highlighting in options</name>
  <files>packages/select/src/select.ts</files>
  <action>
Add match highlighting to filtered options:

1. Define FilterMatch interface (at top of file with other interfaces):
```typescript
interface FilterMatch {
  option: SelectOption;
  originalIndex: number;
  matchIndices: [number, number][];
}
```

2. Add `findAllMatches(text: string, query: string): [number, number][]` method:
   - Returns array of [start, end] tuples for ALL occurrences
   - Case-insensitive matching
   - Example: "an" in "Banana" returns [[1, 3], [3, 5]] (both "an" occurrences)

3. Refactor `filteredOptions` getter to return `FilterMatch[]`:
   - When not filtering: return all options with empty matchIndices
   - When filtering: return matched options with their matchIndices
   - Store originalIndex for correct selection mapping

4. Add `renderHighlightedLabel(label: string, matchIndices: [number, number][])` method:
   - If no matches, return plain text
   - Split label into segments: non-match text and match text
   - Wrap matched portions in `<strong class="highlight">...</strong>`
   - Handle overlapping matches by sorting and merging if needed
   - Return html template with mixed content

5. Update `renderOption()` to use `renderHighlightedLabel()`:
   - Get the FilterMatch for the option
   - Pass matchIndices to renderHighlightedLabel
   - Only highlight when in searchable mode and filtering

6. Add CSS for highlight in static styles:
```css
.highlight {
  font-weight: var(--ui-select-highlight-weight, 600);
  color: var(--ui-select-highlight-text, inherit);
}
```

7. Update all code that uses filteredOptions to handle the new FilterMatch structure:
   - Access option via `filterMatch.option`
   - Use `filterMatch.originalIndex` for selection
  </action>
  <verify>Run dev: `cd packages/select && pnpm dev` - Type "an" in searchable select, see both "an" occurrences highlighted in "Banana"</verify>
  <done>Matching text in options is highlighted with bold, all occurrences are highlighted not just first</done>
</task>

<task type="auto">
  <name>Task 3: Add empty state when no options match</name>
  <files>packages/select/src/select.ts</files>
  <action>
Add empty state display and custom message prop:

1. Add property:
```typescript
/**
 * Message displayed when no options match the filter query.
 * @default 'No results found'
 */
@property({ type: String })
noResultsMessage = 'No results found';
```

2. Add `renderEmptyState()` method:
```typescript
private renderEmptyState() {
  return html`
    <div class="empty-state" role="status" aria-live="polite">
      ${this.noResultsMessage}
    </div>
  `;
}
```

3. Add CSS for empty state in static styles:
```css
.empty-state {
  padding: var(--ui-select-option-padding-y, 0.5rem) var(--ui-select-option-padding-x, 0.75rem);
  color: var(--ui-select-placeholder);
  text-align: center;
  font-style: italic;
}
```

4. Update render() listbox content:
   - When searchable and filtering (filterQuery not empty):
     - If filteredOptions.length === 0: render empty state
     - Else: render filtered options with highlighting
   - When not filtering: render all options normally

5. Update ARIA live region to announce when no results:
   - When filtering produces 0 results, announce the empty state message
  </action>
  <verify>Type "xyz" in searchable select, see "No results found" message. Custom message prop works.</verify>
  <done>Empty state displays when no options match, message is customizable via noResultsMessage prop, screen reader announces empty state</done>
</task>

</tasks>

<verification>
1. Build passes: `cd packages/select && pnpm build`
2. Typing "an" highlights both occurrences in "Banana"
3. Typing non-matching text shows "No results found"
4. Custom noResultsMessage prop changes the empty state text
5. Highlight uses CSS tokens (--ui-select-highlight-*)
6. Screen reader announces empty state
</verification>

<success_criteria>
- COMBO-04: Combobox highlights matching text in option labels
- COMBO-03: Combobox shows empty state when no options match
- All match occurrences highlighted (not just first)
- Bold styling for highlights (per CONTEXT.md)
- CSS tokens allow theme customization
- Empty state message customizable via prop
</success_criteria>

<output>
After completion, create `.planning/phases/35-combobox/35-02-SUMMARY.md`
</output>
