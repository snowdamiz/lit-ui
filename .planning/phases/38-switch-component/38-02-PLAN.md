---
phase: 38-switch-component
plan: 02
type: execute
wave: 2
depends_on: ["38-01"]
files_modified:
  - packages/switch/src/switch.ts
  - packages/switch/src/index.ts
  - packages/switch/src/jsx.d.ts
autonomous: true

must_haves:
  truths:
    - "User can click or press Space/Enter to toggle a switch between on and off states"
    - "Switch renders as track + thumb with animated CSS slide transition"
    - "Switch participates in forms via ElementInternals (setFormValue, setValidity, formResetCallback)"
    - "Switch supports required validation and disabled state"
    - "Switch renders label text via label property or default slot"
    - "Switch has size variants (sm/md/lg) using CSS tokens"
    - "Screen readers announce role='switch' with aria-checked state"
    - "Animations respect prefers-reduced-motion"
    - "Switch is SSR-compatible with isServer guards"
    - "Package builds successfully with pnpm build --filter @lit-ui/switch"
  artifacts:
    - path: "packages/switch/src/switch.ts"
      provides: "Switch web component class"
      exports: ["Switch", "SwitchSize"]
      min_lines: 150
    - path: "packages/switch/src/index.ts"
      provides: "Safe element registration + re-exports"
      contains: "customElements.define"
    - path: "packages/switch/src/jsx.d.ts"
      provides: "JSX type declarations for React, Vue, Svelte"
      contains: "lui-switch"
  key_links:
    - from: "packages/switch/src/switch.ts"
      to: "@lit-ui/core"
      via: "TailwindElement import"
      pattern: "import.*TailwindElement.*@lit-ui/core"
    - from: "packages/switch/src/switch.ts"
      to: "packages/core/src/styles/tailwind.css"
      via: "CSS token references (--ui-switch-*)"
      pattern: "var\\(--ui-switch-"
    - from: "packages/switch/src/switch.ts"
      to: "ElementInternals"
      via: "attachInternals + setFormValue"
      pattern: "attachInternals|setFormValue"
    - from: "packages/switch/src/index.ts"
      to: "packages/switch/src/switch.ts"
      via: "export + customElements.define"
      pattern: "customElements.define.*lui-switch.*Switch"
    - from: "packages/switch/src/jsx.d.ts"
      to: "packages/switch/src/switch.ts"
      via: "type import"
      pattern: "import type.*Switch.*switch.js"
---

<objective>
Implement the lui-switch web component with full accessibility, form participation, animation, and framework type support.

Purpose: Deliver the complete Switch component covering all 14 SWCH requirements (toggle, animation, form, validation, disabled, label, sizes, ARIA, keyboard, tokens, dark mode, SSR, reduced motion, form reset).
Output: Working switch.ts component, index.ts registration, jsx.d.ts types — package builds and all requirements met.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-switch-component/38-RESEARCH.md
@.planning/phases/38-switch-component/38-01-SUMMARY.md

Reference implementations (read these for exact patterns):
@packages/input/src/input.ts
@packages/input/src/index.ts
@packages/input/src/jsx.d.ts
@packages/core/src/utils/events.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement the Switch component</name>
  <files>
    packages/switch/src/switch.ts
  </files>
  <action>
Create `packages/switch/src/switch.ts` implementing the full switch component. Follow the exact patterns from `packages/input/src/input.ts` for form participation, validation, SSR, and events. Use the research code examples as the primary reference.

**Exports:** `Switch` class, `SwitchSize` type (`'sm' | 'md' | 'lg'`)

**Properties (all @property with correct types):**
- `checked: boolean = false` (reflect: true) — SWCH-01
- `disabled: boolean = false` (reflect: true) — SWCH-05
- `required: boolean = false` (reflect: true) — SWCH-04
- `name: string = ''` — SWCH-03
- `value: string = 'on'` — SWCH-03
- `label: string = ''` — SWCH-06
- `size: SwitchSize = 'md'` — SWCH-07

**State (@state):**
- `touched: boolean = false`
- `showError: boolean = false`

**Private fields:**
- `internals: ElementInternals | null = null` — form participation
- `switchId: string` — unique ID for label association (pattern: `lui-switch-${Math.random().toString(36).substr(2, 9)}`)
- `defaultChecked: boolean = false` — for formResetCallback

**Constructor:** Call `super()`, then `if (!isServer) { this.internals = this.attachInternals(); }` — SWCH-12

**connectedCallback:** Call `super.connectedCallback()`, store `this.defaultChecked = this.checked`, call `this.updateFormValue()`.

**Static formAssociated = true** — SWCH-03

**Static styles:** Use `[...tailwindBaseStyles, css\`...\`]` pattern. Include ALL CSS:
- `:host { display: inline-block; }` and `:host([disabled]) { pointer-events: none; }`
- `.switch-wrapper` — flexbox row with `gap: var(--ui-switch-label-gap)`, `align-items: center`
- `.switch-track` — inline-flex, position relative, rounded with `var(--ui-switch-radius)`, background `var(--ui-switch-track-bg)`, cursor pointer, border `1px solid var(--ui-switch-track-border)`, transition background-color
- `.switch-track[aria-checked='true']` — background `var(--ui-switch-track-bg-checked)`, border-color `var(--ui-switch-track-bg-checked)`
- `.switch-track[aria-disabled='true']` — opacity 0.5, cursor not-allowed
- `.switch-thumb` — position absolute, left `var(--ui-switch-thumb-offset)`, top 50% transform translateY(-50%), rounded `var(--ui-switch-thumb-radius)`, background `var(--ui-switch-thumb-bg)`, transition transform
- Size-specific classes: `.track-sm`, `.track-md`, `.track-lg` — set width/height from `var(--ui-switch-track-width-{size})` / `var(--ui-switch-track-height-{size})`
- Size-specific thumb: `.track-{size} .switch-thumb` — set width/height from `var(--ui-switch-thumb-size-{size})`
- Checked thumb position per size: `.track-{size}[aria-checked='true'] .switch-thumb` — `transform: translateX(calc(var(--ui-switch-track-width-{size}) - var(--ui-switch-thumb-size-{size}) - var(--ui-switch-thumb-offset) * 2)) translateY(-50%)`
- Focus ring: `.switch-track:focus-visible` — outline none, box-shadow `0 0 0 2px var(--ui-switch-ring)`
- Error state: `.switch-track.has-error` — border-color `var(--ui-switch-border-error)`
- Label: `.switch-label` — font-size per size from `var(--ui-switch-font-size-{size})`
- Error text: `.error-text` — font-size `0.75rem`, color `var(--ui-switch-text-error)`, margin-top `0.25rem`
- Reduced motion: `@media (prefers-reduced-motion: reduce) { .switch-thumb, .switch-track { transition-duration: 0ms; } }` — SWCH-13

**Methods:**

`toggle()` — If disabled, return. Flip `this.checked`. Set `this.touched = true`. Call `this.updateFormValue()`, `this.validate()`. Dispatch `ui-change` event via `dispatchCustomEvent(this, 'ui-change', { checked: this.checked, value: this.checked ? this.value : null })`. — SWCH-01

`handleClick(e: Event)` — Call `this.toggle()`. — SWCH-01

`handleKeyDown(e: KeyboardEvent)` — If `e.key === ' '` or `e.key === 'Enter'`: call `e.preventDefault()` (prevents page scroll on Space), then `this.toggle()`. — SWCH-09

`updateFormValue()` — `this.internals?.setFormValue(this.checked ? this.value : null)` — SWCH-03 (null when unchecked = omit from FormData)

`validate(): boolean` — If no internals, return true. If `this.required && !this.checked`: call `this.internals.setValidity({ valueMissing: true }, 'Please toggle this switch.', this.shadowRoot?.querySelector('.switch-track') as HTMLElement)`, set `this.showError = this.touched`, return false. Otherwise: `this.internals.setValidity({})`, set `this.showError = false`, return true. — SWCH-04

`formResetCallback()` — Reset: `this.checked = this.defaultChecked`, `this.touched = false`, `this.showError = false`, call `this.updateFormValue()`, `this.internals?.setValidity({})`. — SWCH-14

`formDisabledCallback(disabled: boolean)` — Set `this.disabled = disabled`.

**render() method:** — SWCH-02, SWCH-06, SWCH-08
```
<div class="switch-wrapper">
  <!-- Label (from property or slot) -->
  ${this.label
    ? html`<label id="${this.switchId}-label" class="switch-label label-${this.size}">${this.label}</label>`
    : html`<label id="${this.switchId}-label" class="switch-label label-${this.size}"><slot></slot></label>`
  }
  <div
    role="switch"
    aria-checked=${this.checked ? 'true' : 'false'}
    aria-disabled=${this.disabled ? 'true' : nothing}
    aria-required=${this.required ? 'true' : nothing}
    aria-labelledby="${this.switchId}-label"
    tabindex=${this.disabled ? '-1' : '0'}
    class="switch-track track-${this.size} ${this.showError ? 'has-error' : ''}"
    @click=${this.handleClick}
    @keydown=${this.handleKeyDown}
  >
    <span class="switch-thumb"></span>
  </div>
</div>
${this.showError ? html`<div class="error-text" role="alert">Please toggle this switch.</div>` : nothing}
```

**Important implementation details:**
- Import `html, css, nothing, isServer` from `'lit'`
- Import `property, state` from `'lit/decorators.js'`
- Import `TailwindElement, tailwindBaseStyles` from `'@lit-ui/core'`
- Import `dispatchCustomEvent` from `'@lit-ui/core'` (check exact export path — may be `@lit-ui/core/utils/events` or re-exported from `@lit-ui/core`)
- The `updated()` lifecycle — when `checked` property changes, call `this.updateFormValue()` and `this.validate()` to keep form state in sync with attribute changes
- Dark mode: No explicit dark mode CSS needed. The token system references `--color-primary`, `--color-muted`, etc., which automatically change in dark mode via the `.dark` class on the root — SWCH-11
  </action>
  <verify>
Run `grep 'role="switch"' packages/switch/src/switch.ts` — confirms ARIA role.
Run `grep 'aria-checked' packages/switch/src/switch.ts` — confirms checked state announcement.
Run `grep 'formResetCallback' packages/switch/src/switch.ts` — confirms form reset support.
Run `grep 'setFormValue' packages/switch/src/switch.ts` — confirms form participation.
Run `grep 'setValidity' packages/switch/src/switch.ts` — confirms validation.
Run `grep 'prefers-reduced-motion' packages/switch/src/switch.ts` — confirms reduced motion.
Run `grep 'isServer' packages/switch/src/switch.ts` — confirms SSR guard.
Run `grep 'preventDefault' packages/switch/src/switch.ts` — confirms keyboard handling.
Run `grep 'ui-switch-' packages/switch/src/switch.ts` — confirms token usage.
  </verify>
  <done>
Switch component implements all 14 SWCH requirements: toggle (SWCH-01), track+thumb animation (SWCH-02), form participation (SWCH-03), required validation (SWCH-04), disabled (SWCH-05), label (SWCH-06), sizes (SWCH-07), role="switch" (SWCH-08), keyboard (SWCH-09), CSS tokens (SWCH-10), dark mode (SWCH-11), SSR (SWCH-12), reduced motion (SWCH-13), form reset (SWCH-14).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create index.ts, jsx.d.ts, and build verification</name>
  <files>
    packages/switch/src/index.ts
    packages/switch/src/jsx.d.ts
  </files>
  <action>
**index.ts** — Follow EXACT pattern from `packages/input/src/index.ts`:

```typescript
// @lit-ui/switch - Switch/toggle component with SSR support
/// <reference path="./jsx.d.ts" />
import { isServer } from 'lit';

// Export component class and types
export { Switch } from './switch.js';
export type { SwitchSize } from './switch.js';

// Re-export TailwindElement and isServer for convenience
export { TailwindElement, isServer } from '@lit-ui/core';

// Safe custom element registration with collision detection
import { Switch } from './switch.js';

if (typeof customElements !== 'undefined') {
  if (!customElements.get('lui-switch')) {
    customElements.define('lui-switch', Switch);
  } else if (!isServer && import.meta.env?.DEV) {
    console.warn(
      '[lui-switch] Custom element already registered. ' +
        'This may indicate duplicate imports or version conflicts.'
    );
  }
}

// TypeScript global type registration
declare global {
  interface HTMLElementTagNameMap {
    'lui-switch': Switch;
  }
}
```

**jsx.d.ts** — Follow EXACT pattern from `packages/input/src/jsx.d.ts`:

```typescript
/**
 * JSX type declarations for lui-switch custom element.
 * Provides type support for React, Vue, and Svelte.
 */

import type { Switch, SwitchSize } from './switch.js';

// Common attributes for lui-switch
interface LuiSwitchAttributes {
  checked?: boolean;
  disabled?: boolean;
  required?: boolean;
  name?: string;
  value?: string;
  label?: string;
  size?: SwitchSize;
}

// React JSX support
declare global {
  namespace JSX {
    interface IntrinsicElements {
      'lui-switch': React.DetailedHTMLProps<
        React.HTMLAttributes<Switch> & LuiSwitchAttributes,
        Switch
      >;
    }
  }
}

// Vue support
declare module 'vue' {
  export interface GlobalComponents {
    'lui-switch': import('vue').DefineComponent<LuiSwitchAttributes>;
  }
}

// Svelte support
declare namespace svelteHTML {
  interface IntrinsicElements {
    'lui-switch': LuiSwitchAttributes & {
      'on:ui-change'?: (e: CustomEvent) => void;
    };
  }
}

export {};
```

After creating both files, run the build:
```bash
pnpm build --filter @lit-ui/switch
```

Verify the build produces `packages/switch/dist/index.js` and `packages/switch/dist/index.d.ts`.
  </action>
  <verify>
Run `pnpm build --filter @lit-ui/switch` — builds without errors.
Run `ls packages/switch/dist/index.js packages/switch/dist/index.d.ts` — both output files exist.
Run `grep 'lui-switch' packages/switch/src/index.ts` — element name registered.
Run `grep 'lui-switch' packages/switch/src/jsx.d.ts` — JSX types declared.
  </verify>
  <done>
Switch package has safe element registration (index.ts), framework JSX types (jsx.d.ts), and builds successfully producing dist/index.js and dist/index.d.ts.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build --filter @lit-ui/switch` — builds without errors
2. `ls packages/switch/dist/` — contains index.js, index.d.ts, switch.js, switch.d.ts
3. `grep 'role="switch"' packages/switch/src/switch.ts` — ARIA role present
4. `grep 'formAssociated' packages/switch/src/switch.ts` — form association enabled
5. `grep 'prefers-reduced-motion' packages/switch/src/switch.ts` — motion respect present
6. `grep 'isServer' packages/switch/src/switch.ts` — SSR guards present
7. All 14 SWCH requirements addressable from the component source
</verification>

<success_criteria>
- lui-switch component renders track + thumb with CSS transitions
- Toggle works via click, Space, and Enter key
- Form participation via ElementInternals (setFormValue, setValidity, formResetCallback)
- Required validation prevents form submission when unchecked
- Disabled state blocks interaction and shows visual distinction
- Label supported via property and default slot
- sm/md/lg sizes using CSS tokens
- role="switch" with aria-checked for screen readers
- prefers-reduced-motion disables animations
- isServer guards for SSR compatibility
- Package builds producing dist/ output
- JSX types for React, Vue, Svelte
</success_criteria>

<output>
After completion, create `.planning/phases/38-switch-component/38-02-SUMMARY.md`
</output>
