---
phase: 91-pie-donut-chart
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/charts/src/shared/pie-option-builder.ts
  - packages/charts/src/pie/pie-registry.ts
autonomous: true
requirements: [PIE-01, PIE-02]

must_haves:
  truths:
    - "Small slices below minPercent threshold are merged into a single 'Other' entry before data reaches ECharts"
    - "Donut mode is activated by a non-zero inner-radius; center label appears only in donut mode"
    - "PieSlice and PieOptionProps types are exported and usable by LuiPieChart"
    - "pie-registry.ts registers PieChart module with the same guard pattern as bar-registry.ts"
  artifacts:
    - path: "packages/charts/src/shared/pie-option-builder.ts"
      provides: "buildPieOption() function + PieSlice + PieOptionProps types"
      exports: ["buildPieOption", "PieSlice", "PieOptionProps"]
    - path: "packages/charts/src/pie/pie-registry.ts"
      provides: "registerPieModules() async function"
      exports: ["registerPieModules"]
  key_links:
    - from: "packages/charts/src/shared/pie-option-builder.ts"
      to: "_mergeSmallSlices()"
      via: "internal function call inside buildPieOption"
      pattern: "_mergeSmallSlices"
    - from: "packages/charts/src/pie/pie-registry.ts"
      to: "packages/charts/src/registry/canvas-core.ts"
      via: "dynamic import of registerCanvasCore()"
      pattern: "registerCanvasCore"
---

<objective>
Create the pie/donut option builder and ECharts module registry — the foundational layer for LuiPieChart.

Purpose: Establishes all type contracts, small-slice merging logic, and ECharts PieChart module registration that Plan 02 (LuiPieChart component) builds against.
Output: pie-option-builder.ts (buildPieOption + types), pie-registry.ts (registerPieModules)
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/91-pie-donut-chart/91-RESEARCH.md

<interfaces>
<!-- Key types and contracts from Phase 90 that this plan mirrors. -->
<!-- Use these as pattern reference — pie follows the same structure as bar. -->

From packages/charts/src/shared/bar-option-builder.ts (Phase 90 pattern):
```typescript
// pie-option-builder.ts follows same pattern:
// - Export types (PieSlice, PieOptionProps)
// - Export buildPieOption(slices, props) -> Record<string, unknown>
// - Pure TypeScript — no ECharts imports in the option builder
```

From packages/charts/src/bar/bar-registry.ts (Phase 90 pattern):
```typescript
let _barRegistered = false;

export async function registerBarModules(): Promise<void> {
  if (_barRegistered) return;
  _barRegistered = true;

  const { registerCanvasCore } = await import('../registry/canvas-core.js');
  await registerCanvasCore();

  const [{ BarChart }, { use }] = await Promise.all([
    import('echarts/charts'),
    import('echarts/core'),
  ]);

  use([BarChart]);
}
// pie-registry.ts: replace BarChart -> PieChart, _barRegistered -> _pieRegistered
```

From packages/charts/src/index.ts (Phase 90 exports — append after these):
```typescript
// Phase 90: Bar Chart
export { LuiBarChart } from './bar/bar-chart.js';
export type { BarChartSeries, BarOptionProps } from './shared/bar-option-builder.js';
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pie-option-builder.ts with buildPieOption and types</name>
  <files>packages/charts/src/shared/pie-option-builder.ts</files>
  <action>
Create `packages/charts/src/shared/pie-option-builder.ts` with the following exact implementation:

**Types to export:**
```typescript
export type PieSlice = {
  name: string;
  value: number;
};

export type PieOptionProps = {
  // PIE-01: Merge slices below this percentage into "Other". 0 = no merging (default).
  minPercent?: number;
  // PIE-02: Inner radius for donut mode. 0 or '' = filled pie. Examples: '40%', '60%'.
  innerRadius?: string | number;
  // PIE-02: Text displayed in the donut center hole. Only shown when innerRadius is non-zero.
  centerLabel?: string;
};
```

**`buildPieOption(slices: PieSlice[], props: PieOptionProps): Record<string, unknown>`:**
1. Call internal `_mergeSmallSlices(slices, props.minPercent ?? 0)` to pre-process data (PIE-01). ECharts `minAngle` does NOT merge slices — always use the pre-processing approach.
2. Compute `isDonut`: `innerRadius !== 0 && innerRadius !== '0%' && innerRadius !== '0' && innerRadius !== ''`. Handle all four falsy equivalents — `'0'` is truthy in JS but should be treated as pie mode.
3. Build the series object:
   - `type: 'pie'`
   - `data: mergedSlices`
   - `radius: isDonut ? [innerRadius, '70%'] : '70%'`
   - `tooltip: { trigger: 'item' }`
4. Build the base option:
   - `legend: { show: true, type: 'scroll' }` — handles crowded legend with many slices
   - `tooltip: { trigger: 'item' }`
   - `series: [series]`
5. Inject center label ONLY when `isDonut && props.centerLabel`:
   - `option['title'] = { text: props.centerLabel, left: 'center', top: 'center', textStyle: { fontSize: 16, fontWeight: 'bold' } }`
   - DO NOT inject `title` when `centerLabel` is empty or when not in donut mode — empty title key causes layout interference.

**`_mergeSmallSlices(slices: PieSlice[], minPercent: number): PieSlice[]` (not exported):**
1. If `minPercent <= 0` or `slices.length === 0`, return `slices` unchanged.
2. Compute `total = slices.reduce((sum, s) => sum + s.value, 0)`. If total is 0, return `slices` unchanged.
3. Iterate: slices where `(value / total) * 100 < minPercent` accumulate into `otherValue`; the rest push to `kept[]`.
4. If `otherValue > 0`, push `{ name: 'Other', value: otherValue }` to `kept[]`.
5. Return `kept`.

No ECharts imports in this file — it is pure TypeScript data processing.
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components && npx tsc -p packages/charts/tsconfig.json --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>pie-option-builder.ts compiles with zero TypeScript errors. PieSlice, PieOptionProps, and buildPieOption are exported. _mergeSmallSlices is internal (not exported). TypeScript strict mode passes.</done>
</task>

<task type="auto">
  <name>Task 2: Create pie-registry.ts with registerPieModules</name>
  <files>packages/charts/src/pie/pie-registry.ts</files>
  <action>
Create `packages/charts/src/pie/pie-registry.ts`. Follow the exact guard pattern from bar-registry.ts — same structure, swap `BarChart` for `PieChart`:

```typescript
let _pieRegistered = false;

export async function registerPieModules(): Promise<void> {
  if (_pieRegistered) return;
  _pieRegistered = true;

  const { registerCanvasCore } = await import('../registry/canvas-core.js');
  await registerCanvasCore();

  const [{ PieChart }, { use }] = await Promise.all([
    import('echarts/charts'),
    import('echarts/core'),
  ]);

  use([PieChart]);
}
```

Key points:
- `_pieRegistered` guard prevents double-registration (ECharts `use()` is idempotent but guard avoids redundant imports).
- `registerCanvasCore()` first — it registers TitleComponent (needed for center labels), GridComponent, TooltipComponent, LegendComponent.
- `PieChart` is the only pie-specific module; donut is a pie with inner radius, not a separate ECharts module.
- No `BarChart`, `LineChart`, or any other series module here — tree-shaking boundary.
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components && npx tsc -p packages/charts/tsconfig.json --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>pie-registry.ts compiles with zero TypeScript errors. registerPieModules is exported. File is in packages/charts/src/pie/ directory. Full build remains clean.</done>
</task>

</tasks>

<verification>
Run full TypeScript compile to confirm both new files are error-free and do not break existing chart infrastructure:
```
cd /Users/sn0w/Documents/dev/lit-components && npx tsc -p packages/charts/tsconfig.json --noEmit
```

Expected: zero errors. Both `pie-option-builder.ts` and `pie-registry.ts` must compile cleanly alongside existing Phase 88-90 files.
</verification>

<success_criteria>
- packages/charts/src/shared/pie-option-builder.ts exists and exports PieSlice, PieOptionProps, buildPieOption
- packages/charts/src/pie/pie-registry.ts exists and exports registerPieModules
- buildPieOption returns correct option structure: legend, tooltip, series with radius array for donut, title only when isDonut + centerLabel
- _mergeSmallSlices correctly sums slices below threshold into 'Other' entry
- isDonut guard handles all four falsy cases: 0, '0', '0%', ''
- TypeScript compile passes with zero errors across all packages/charts source files
</success_criteria>

<output>
After completion, create `.planning/phases/91-pie-donut-chart/91-01-SUMMARY.md`
</output>
