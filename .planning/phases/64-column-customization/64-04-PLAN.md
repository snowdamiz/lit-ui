---
phase: 64-column-customization
plan: 04
type: execute
wave: 3
depends_on: ["64-01", "64-02", "64-03"]
files_modified:
  - packages/data-table/src/column-preferences.ts
  - packages/data-table/src/data-table.ts
  - packages/data-table/src/types.ts
  - packages/data-table/src/index.ts
autonomous: true

must_haves:
  truths:
    - "User returns to site and sees previous column preferences restored"
    - "Column widths, order, and visibility all persist"
    - "Optional callback receives preference changes for server-side persistence"
  artifacts:
    - path: "packages/data-table/src/column-preferences.ts"
      provides: "localStorage save/load utilities with versioning"
      contains: "savePreferences"
    - path: "packages/data-table/src/data-table.ts"
      provides: "Persistence integration with debouncing"
      contains: "persistenceKey"
    - path: "packages/data-table/src/types.ts"
      provides: "ColumnPreferences interface"
      contains: "ColumnPreferences"
  key_links:
    - from: "data-table.ts connectedCallback"
      to: "loadPreferences"
      via: "persistence key lookup"
      pattern: "loadPreferences"
    - from: "data-table.ts onColumnSizingChange"
      to: "dispatchPreferenceChange"
      via: "debounced save"
      pattern: "dispatchPreferenceChange"
---

<objective>
Implement localStorage persistence and optional callback for column preferences.

Purpose: Users expect their column customizations (widths, order, visibility) to persist across sessions. localStorage provides immediate persistence, while the optional callback enables server-side storage for cross-device sync.

Output: Column preferences persist to localStorage, optional callback fires for server-side persistence.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/64-column-customization/64-RESEARCH.md
@.planning/phases/64-column-customization/64-01-SUMMARY.md
@.planning/phases/64-column-customization/64-02-SUMMARY.md
@.planning/phases/64-column-customization/64-03-SUMMARY.md
@packages/data-table/src/data-table.ts
@packages/data-table/src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create column preferences persistence utilities</name>
  <files>packages/data-table/src/column-preferences.ts, packages/data-table/src/types.ts, packages/data-table/src/index.ts</files>
  <action>
1. In types.ts, add ColumnPreferences interface:
   ```typescript
   /**
    * Column preferences for persistence.
    * Stores column sizing, order, and visibility state.
    */
   export interface ColumnPreferences {
     /** Column widths keyed by column ID */
     columnSizing: ColumnSizingState;
     /** Column display order (array of column IDs) */
     columnOrder: ColumnOrderState;
     /** Column visibility keyed by column ID (false = hidden) */
     columnVisibility: VisibilityState;
   }

   /**
    * Event detail for column preferences change.
    * Emitted when any column customization changes.
    */
   export interface ColumnPreferencesChangeEvent extends ColumnPreferences {
     /** Table persistence key for identification */
     tableId: string;
   }
   ```

2. Create packages/data-table/src/column-preferences.ts:
   ```typescript
   import type { ColumnPreferences } from './types.js';

   const STORAGE_KEY_PREFIX = 'lui-data-table-prefs';
   const PREFS_VERSION = 1;

   interface StoredPreferences extends ColumnPreferences {
     version: number;
   }

   /**
    * Save column preferences to localStorage.
    * Fails silently if storage is unavailable or full.
    *
    * @param tableId - Unique identifier for the table
    * @param prefs - Column preferences to save
    */
   export function savePreferences(tableId: string, prefs: ColumnPreferences): void {
     if (!tableId) return;

     try {
       const key = `${STORAGE_KEY_PREFIX}-${tableId}`;
       const stored: StoredPreferences = {
         ...prefs,
         version: PREFS_VERSION,
       };
       localStorage.setItem(key, JSON.stringify(stored));
     } catch (e) {
       // QuotaExceededError or SecurityError - fail silently
       console.warn('Failed to save table preferences:', e);
     }
   }

   /**
    * Load column preferences from localStorage.
    * Returns null if no preferences exist or version mismatch.
    *
    * @param tableId - Unique identifier for the table
    * @returns Stored preferences or null
    */
   export function loadPreferences(tableId: string): ColumnPreferences | null {
     if (!tableId) return null;

     try {
       const key = `${STORAGE_KEY_PREFIX}-${tableId}`;
       const stored = localStorage.getItem(key);
       if (!stored) return null;

       const prefs: StoredPreferences = JSON.parse(stored);

       // Version check for future migrations
       if (prefs.version !== PREFS_VERSION) {
         // Clear outdated preferences
         localStorage.removeItem(key);
         return null;
       }

       return {
         columnSizing: prefs.columnSizing ?? {},
         columnOrder: prefs.columnOrder ?? [],
         columnVisibility: prefs.columnVisibility ?? {},
       };
     } catch {
       // Parse error or SecurityError - return null
       return null;
     }
   }

   /**
    * Clear column preferences from localStorage.
    *
    * @param tableId - Unique identifier for the table
    */
   export function clearPreferences(tableId: string): void {
     if (!tableId) return;

     try {
       const key = `${STORAGE_KEY_PREFIX}-${tableId}`;
       localStorage.removeItem(key);
     } catch {
       // Ignore storage errors
     }
   }
   ```

3. Update packages/data-table/src/index.ts:
   - Add exports: export { savePreferences, loadPreferences, clearPreferences } from './column-preferences.js';
   - Add type export: export type { ColumnPreferences, ColumnPreferencesChangeEvent } from './types.js';
  </action>
  <verify>
```bash
cd packages/data-table && pnpm build
```
  </verify>
  <done>
- ColumnPreferences interface defined in types.ts
- column-preferences.ts provides save/load/clear utilities
- Version migration support via PREFS_VERSION
- All exports added to index.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate persistence into DataTable component</name>
  <files>packages/data-table/src/data-table.ts</files>
  <action>
1. Import persistence utilities:
   ```typescript
   import { savePreferences, loadPreferences } from './column-preferences.js';
   import type { ColumnPreferences, ColumnPreferencesChangeEvent } from './types.js';
   ```

2. Add persistence properties:
   ```typescript
   /**
    * Unique key for localStorage persistence.
    * When set, column preferences are automatically saved and restored.
    * Use a unique key per table instance (e.g., 'users-table', 'orders-table').
    */
   @property({ type: String, attribute: 'persistence-key' })
   persistenceKey = '';

   /**
    * Callback for server-side preference persistence (COL-08).
    * Called with preference changes after debounce, in addition to localStorage.
    */
   @property({ attribute: false })
   onColumnPreferencesChange?: (prefs: ColumnPreferencesChangeEvent) => void;
   ```

3. Add debounce timer:
   ```typescript
   private _preferenceSaveTimer?: ReturnType<typeof setTimeout>;
   private static readonly PREFERENCE_SAVE_DEBOUNCE = 300; // ms
   ```

4. Create dispatchPreferenceChange method:
   ```typescript
   /**
    * Dispatch column preference change with debouncing.
    * Saves to localStorage and calls optional callback.
    */
   private dispatchPreferenceChange(): void {
     clearTimeout(this._preferenceSaveTimer);
     this._preferenceSaveTimer = setTimeout(() => {
       const prefs: ColumnPreferences = {
         columnSizing: this.columnSizing,
         columnOrder: this.columnOrder,
         columnVisibility: this.columnVisibility,
       };

       // Save to localStorage if persistence key provided
       if (this.persistenceKey) {
         savePreferences(this.persistenceKey, prefs);
       }

       // Call optional callback for server-side persistence (COL-08)
       const event: ColumnPreferencesChangeEvent = {
         ...prefs,
         tableId: this.persistenceKey,
       };
       this.onColumnPreferencesChange?.(event);

       // Also dispatch event for declarative usage
       this.dispatchEvent(new CustomEvent('ui-column-preferences-change', {
         detail: event,
         bubbles: true,
         composed: true,
       }));
     }, DataTable.PREFERENCE_SAVE_DEBOUNCE);
   }
   ```

5. Update all column state change callbacks to call dispatchPreferenceChange():
   - onColumnSizingChange: add this.dispatchPreferenceChange();
   - onColumnVisibilityChange: add this.dispatchPreferenceChange();
   - onColumnOrderChange: add this.dispatchPreferenceChange();

6. Load preferences in connectedCallback:
   ```typescript
   override connectedCallback(): void {
     super.connectedCallback();

     // Load persisted preferences if key provided
     if (this.persistenceKey) {
       const stored = loadPreferences(this.persistenceKey);
       if (stored) {
         // Only apply if not already set (allows prop override)
         if (Object.keys(this.columnSizing).length === 0) {
           this.columnSizing = stored.columnSizing;
         }
         if (this.columnOrder.length === 0) {
           this.columnOrder = stored.columnOrder;
         }
         if (Object.keys(this.columnVisibility).length === 0) {
           this.columnVisibility = stored.columnVisibility;
         }
       }
     }
   }
   ```

7. Clean up timer in disconnectedCallback:
   ```typescript
   override disconnectedCallback(): void {
     super.disconnectedCallback();
     clearTimeout(this._preferenceSaveTimer);
   }
   ```

NOTE: Preferences loaded in connectedCallback only apply if current state is empty. This allows developers to override with explicit props. Debounce prevents excessive localStorage writes during resize drag.
  </action>
  <verify>
Manual testing:
1. Set persistence-key="test-table"
2. Resize a column
3. Refresh page
4. Column should retain resized width

```bash
cd packages/data-table && pnpm build
```
  </verify>
  <done>
- persistence-key attribute enables localStorage persistence
- Preferences loaded on connectedCallback
- Preferences saved with debouncing on state changes
- onColumnPreferencesChange callback fires for server-side persistence
- ui-column-preferences-change event available for declarative usage
  </done>
</task>

<task type="auto">
  <name>Task 3: Add reset preferences method and documentation</name>
  <files>packages/data-table/src/data-table.ts</files>
  <action>
1. Add public method to reset preferences:
   ```typescript
   /**
    * Reset column preferences to defaults.
    * Clears localStorage and resets sizing, order, and visibility.
    */
   public resetColumnPreferences(): void {
     // Clear localStorage
     if (this.persistenceKey) {
       clearPreferences(this.persistenceKey);
     }

     // Reset state to defaults
     this.columnSizing = {};
     this.columnOrder = [];
     this.columnVisibility = {};

     // Dispatch event for tracking
     this.dispatchEvent(new CustomEvent('ui-column-preferences-reset', {
       detail: { tableId: this.persistenceKey },
       bubbles: true,
       composed: true,
     }));
   }
   ```

2. Import clearPreferences:
   ```typescript
   import { savePreferences, loadPreferences, clearPreferences } from './column-preferences.js';
   ```

3. Update JSDoc for the component with persistence documentation:
   ```typescript
   /**
    * lui-data-table - A high-performance data table with virtual scrolling
    *
    * Features:
    * - Renders columns and rows from column definitions
    * - TanStack Table for headless state management
    * - Virtual scrolling for 100K+ rows
    * - Column resize, reorder, and visibility customization
    * - localStorage persistence with optional server-side callback
    *
    * @example
    * ```html
    * <lui-data-table
    *   .columns=${columns}
    *   .data=${data}
    *   persistence-key="users-table"
    *   enable-column-resizing
    *   enable-column-reorder
    *   show-column-picker
    *   sticky-first-column
    * ></lui-data-table>
    * ```
    *
    * @fires ui-column-preferences-change - When column sizing/order/visibility changes
    * @fires ui-column-preferences-reset - When preferences are reset via resetColumnPreferences()
    */
   ```

4. Ensure all new properties have complete JSDoc documentation.
  </action>
  <verify>
```bash
cd packages/data-table && pnpm build
pnpm typecheck
```

Manual testing:
1. Customize columns
2. Call table.resetColumnPreferences()
3. Preferences should reset to defaults
4. Refresh page - should stay at defaults
  </verify>
  <done>
- resetColumnPreferences() method clears storage and resets state
- Component JSDoc updated with persistence features
- All events documented
- TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Build succeeds: `cd packages/data-table && pnpm build`
2. Type check passes: `pnpm typecheck`
3. Set persistence-key, customize columns, refresh - preferences restored
4. onColumnPreferencesChange callback fires on changes
5. ui-column-preferences-change event fires for declarative usage
6. resetColumnPreferences() clears storage and resets state
7. Version migration clears old preferences (update PREFS_VERSION to test)
</verification>

<success_criteria>
- COL-07: Column preferences (width, order, visibility) persist to localStorage
- COL-08: Optional callback receives preference changes for server-side persistence
- Debounced saves prevent excessive localStorage writes
- Version support enables future migrations
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/64-column-customization/64-04-SUMMARY.md`
</output>
