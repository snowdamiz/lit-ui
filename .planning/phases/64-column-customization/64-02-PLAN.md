---
phase: 64-column-customization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/data-table/src/data-table.ts
  - packages/data-table/src/types.ts
  - packages/data-table/src/column-picker.ts
autonomous: true

must_haves:
  truths:
    - "User can open column picker dropdown"
    - "User can toggle visibility of individual columns"
    - "Hidden columns are removed from the table view"
  artifacts:
    - path: "packages/data-table/src/column-picker.ts"
      provides: "Column picker component with lui-popover"
      contains: "renderColumnPicker"
    - path: "packages/data-table/src/data-table.ts"
      provides: "Column visibility state integration"
      contains: "columnVisibility"
    - path: "packages/data-table/src/types.ts"
      provides: "VisibilityState re-export"
      contains: "VisibilityState"
  key_links:
    - from: "column-picker.ts"
      to: "table.getAllLeafColumns()"
      via: "TanStack column visibility API"
      pattern: "getAllLeafColumns"
    - from: "column-picker.ts"
      to: "column.toggleVisibility()"
      via: "checkbox click handler"
      pattern: "toggleVisibility"
---

<objective>
Implement column visibility with a picker dropdown for showing/hiding columns.

Purpose: Users need to customize which columns are visible to focus on relevant data. The column picker provides a UI for toggling column visibility without losing column configuration.

Output: Column picker component using lui-popover, integrated with TanStack Table's visibility state.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/64-column-customization/64-RESEARCH.md
@packages/data-table/src/data-table.ts
@packages/data-table/src/types.ts
@packages/popover/src/popover.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add column visibility state to DataTable</name>
  <files>packages/data-table/src/data-table.ts, packages/data-table/src/types.ts</files>
  <action>
1. In types.ts:
   - Verify VisibilityState is re-exported from @tanstack/lit-table (already in imports, ensure export)

2. In data-table.ts:
   - Add @property columnVisibility: VisibilityState = {} (Record<string, boolean>)
   - Add @property showColumnPicker = false (boolean to show/hide picker button)

3. Update tableController.table() options:
   - Add state: { columnVisibility: this.columnVisibility } (merge with existing state)
   - Add onColumnVisibilityChange callback:
     ```typescript
     onColumnVisibilityChange: (updater) => {
       const newVisibility = typeof updater === 'function'
         ? updater(this.columnVisibility)
         : updater;
       this.columnVisibility = newVisibility;
       this.dispatchEvent(new CustomEvent('ui-column-visibility-change', {
         detail: { columnVisibility: newVisibility },
         bubbles: true,
         composed: true,
       }));
     }
     ```

4. Ensure getGridTemplateColumns() uses table.getVisibleLeafColumns():
   - The TanStack table already filters columns by visibility when getVisibleLeafColumns() is called
   - Update if currently using raw this.columns instead of table columns

NOTE: The visibility state is a Record<columnId, boolean> where true means visible (or omit key for visible). TanStack handles filtering automatically.
  </action>
  <verify>
```bash
cd packages/data-table && pnpm build
```
  </verify>
  <done>
- columnVisibility property accepts external visibility state
- TanStack table options include visibility configuration
- ui-column-visibility-change event fires on visibility changes
  </done>
</task>

<task type="auto">
  <name>Task 2: Create column picker component</name>
  <files>packages/data-table/src/column-picker.ts, packages/data-table/src/index.ts</files>
  <action>
1. Create packages/data-table/src/column-picker.ts:
   ```typescript
   import { html, css, type TemplateResult } from 'lit';
   import type { Table, RowData, Column } from '@tanstack/lit-table';
   import '@lit-ui/popover';
   import '@lit-ui/checkbox';

   /**
    * Render column picker dropdown for toggling column visibility.
    * Uses lui-popover for positioning and lui-checkbox for toggles.
    */
   export function renderColumnPicker<TData extends RowData>(
     table: Table<TData>
   ): TemplateResult {
     const columns = table.getAllLeafColumns().filter(col => col.getCanHide());

     if (columns.length === 0) {
       return html``;
     }

     return html`
       <lui-popover placement="bottom-end" class="column-picker-popover">
         <button
           slot="trigger"
           type="button"
           class="column-picker-trigger"
           aria-label="Toggle columns"
         >
           <svg
             viewBox="0 0 24 24"
             width="20"
             height="20"
             fill="none"
             stroke="currentColor"
             stroke-width="2"
             aria-hidden="true"
           >
             <path d="M12 3v18M3 12h18M9 3h6M3 9v6M21 9v6M9 21h6" />
           </svg>
           <span>Columns</span>
         </button>
         <div slot="content" class="column-picker-content">
           <div class="column-picker-header">Show/Hide Columns</div>
           <div class="column-picker-list">
             ${columns.map(col => renderColumnPickerItem(col))}
           </div>
         </div>
       </lui-popover>
     `;
   }

   function renderColumnPickerItem<TData extends RowData>(
     column: Column<TData, unknown>
   ): TemplateResult {
     const label = typeof column.columnDef.header === 'string'
       ? column.columnDef.header
       : column.id;

     return html`
       <label class="column-picker-item">
         <lui-checkbox
           .checked=${column.getIsVisible()}
           @ui-change=${() => column.toggleVisibility()}
         ></lui-checkbox>
         <span class="column-picker-label">${label}</span>
       </label>
     `;
   }

   export const columnPickerStyles = css`
     .column-picker-trigger {
       display: inline-flex;
       align-items: center;
       gap: 6px;
       padding: 6px 12px;
       font-size: 14px;
       font-weight: 500;
       color: var(--ui-data-table-text-color);
       background: var(--ui-data-table-row-bg);
       border: 1px solid var(--ui-data-table-border-color);
       border-radius: var(--ui-radius, 6px);
       cursor: pointer;
       transition: background-color 0.15s, border-color 0.15s;
     }

     .column-picker-trigger:hover {
       background: var(--ui-data-table-row-hover-bg);
       border-color: var(--color-primary, #3b82f6);
     }

     .column-picker-trigger:focus-visible {
       outline: 2px solid var(--color-primary, #3b82f6);
       outline-offset: 2px;
     }

     .column-picker-content {
       min-width: 200px;
       max-height: 300px;
       overflow-y: auto;
     }

     .column-picker-header {
       padding: 8px 12px;
       font-size: 12px;
       font-weight: 600;
       text-transform: uppercase;
       letter-spacing: 0.05em;
       color: var(--ui-data-table-header-text);
       border-bottom: 1px solid var(--ui-data-table-border-color);
     }

     .column-picker-list {
       padding: 4px 0;
     }

     .column-picker-item {
       display: flex;
       align-items: center;
       gap: 8px;
       padding: 8px 12px;
       cursor: pointer;
       transition: background-color 0.15s;
     }

     .column-picker-item:hover {
       background: var(--ui-data-table-row-hover-bg);
     }

     .column-picker-label {
       font-size: 14px;
       color: var(--ui-data-table-text-color);
     }
   `;
   ```

2. Update packages/data-table/src/index.ts:
   - Add export: export { renderColumnPicker, columnPickerStyles } from './column-picker.js';

NOTE: Using a function rather than a component allows flexible placement. The DataTable can render it in a toolbar slot. Styles are exported separately so DataTable can include them.
  </action>
  <verify>
```bash
cd packages/data-table && pnpm build
```
  </verify>
  <done>
- column-picker.ts created with renderColumnPicker function
- columnPickerStyles exported for CSS inclusion
- Exports added to index.ts
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate column picker into DataTable toolbar</name>
  <files>packages/data-table/src/data-table.ts</files>
  <action>
1. Import column picker:
   ```typescript
   import { renderColumnPicker, columnPickerStyles } from './column-picker.js';
   ```

2. Add columnPickerStyles to static styles array (merge with existing css)

3. Create renderToolbar() method that includes column picker:
   ```typescript
   private renderToolbar(table: Table<TData>): TemplateResult {
     const hasToolbarContent = this.showColumnPicker;
     if (!hasToolbarContent) return html``;

     return html`
       <div class="data-table-toolbar">
         <slot name="toolbar-start"></slot>
         <div class="toolbar-spacer"></div>
         <slot name="toolbar-end">
           ${this.showColumnPicker ? renderColumnPicker(table) : nothing}
         </slot>
       </div>
     `;
   }
   ```

4. Add toolbar CSS:
   ```css
   .data-table-toolbar {
     display: flex;
     align-items: center;
     gap: 8px;
     padding: 8px 12px;
     border-bottom: 1px solid var(--ui-data-table-border-color);
     background: var(--ui-data-table-header-bg);
   }

   .toolbar-spacer {
     flex: 1;
   }
   ```

5. Call renderToolbar() in main render(), before renderHeader():
   - Insert: ${this.renderToolbar(table)}
   - Place inside data-table-container, before header

6. Update getGridTemplateColumns() to use table.getVisibleLeafColumns():
   - Instead of iterating this.columns directly
   - Get columns from table.getVisibleLeafColumns() which filters by visibility

7. Update renderSkeletonRows() and other places that iterate columns:
   - Use visible columns from table when available
   - For skeleton (no table), fall back to this.columns filtered by columnVisibility

NOTE: The toolbar provides extensibility via slots. Users can add their own controls to toolbar-start or toolbar-end slots, with column picker as default in toolbar-end.
  </action>
  <verify>
Manual testing:
1. Set showColumnPicker=true on data table
2. Click "Columns" button
3. Uncheck a column
4. Column should hide from table

```bash
cd packages/data-table && pnpm build
```
  </verify>
  <done>
- Column picker renders in toolbar when showColumnPicker=true
- Toggling checkbox hides/shows column in table
- Hidden columns are excluded from grid layout
- Toolbar provides slots for extensibility
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Build succeeds: `cd packages/data-table && pnpm build`
2. Type check passes: `pnpm typecheck`
3. Column picker button appears when showColumnPicker=true
4. Clicking picker opens dropdown with all hideable columns
5. Toggling checkbox immediately hides/shows column
6. Grid layout adjusts correctly (no empty column spaces)
7. Visibility state can be controlled externally via columnVisibility prop
</verification>

<success_criteria>
- COL-05: Column picker dropdown allows show/hide of individual columns
- Column visibility state integrates with TanStack Table
- ui-column-visibility-change event fires for state tracking
- TypeScript compiles without errors
- lui-popover and lui-checkbox properly imported and used
</success_criteria>

<output>
After completion, create `.planning/phases/64-column-customization/64-02-SUMMARY.md`
</output>
