---
phase: 23-visual-configurator-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/docs/package.json
  - apps/docs/src/utils/color-utils.ts
  - apps/docs/src/contexts/ConfiguratorContext.tsx
autonomous: true

must_haves:
  truths:
    - "Color conversion utilities correctly convert between HSV, OKLCH, and hex"
    - "ConfiguratorContext provides theme state and actions to child components"
    - "Light/dark mode derivation works bidirectionally with override tracking"
  artifacts:
    - path: "apps/docs/src/utils/color-utils.ts"
      provides: "HSV/OKLCH/hex conversion functions"
      exports: ["hsvToOklch", "oklchToHsv", "oklchToHex", "hexToOklch"]
    - path: "apps/docs/src/contexts/ConfiguratorContext.tsx"
      provides: "Theme state management with derivation"
      exports: ["ConfiguratorProvider", "useConfigurator"]
  key_links:
    - from: "apps/docs/src/contexts/ConfiguratorContext.tsx"
      to: "packages/cli/src/theme/color-scale.ts"
      via: "deriveDarkMode function import"
      pattern: "deriveDarkMode"
    - from: "apps/docs/src/contexts/ConfiguratorContext.tsx"
      to: "packages/cli/src/theme/index.ts"
      via: "generateThemeCSS and encodeThemeConfig imports"
      pattern: "(generateThemeCSS|encodeThemeConfig)"
---

<objective>
Create the foundational utilities and state management for the visual theme configurator.

Purpose: Establish the color conversion bridge between picker UI (HSV) and internal storage (OKLCH), plus the React Context that manages all theme state with light/dark derivation and override tracking.

Output: Color utility functions, ConfiguratorContext with provider and hook, and installed @uiw/react-color packages.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-visual-configurator-core/23-CONTEXT.md
@.planning/phases/23-visual-configurator-core/23-RESEARCH.md
@packages/cli/src/theme/index.ts
@packages/cli/src/theme/color-scale.ts
@packages/cli/src/theme/defaults.ts
@packages/cli/src/theme/schema.ts
@apps/docs/src/contexts/FrameworkContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install color picker dependencies and create color utilities</name>
  <files>
    apps/docs/package.json
    apps/docs/src/utils/color-utils.ts
  </files>
  <action>
1. Install @uiw/react-color packages in apps/docs:
   ```bash
   cd apps/docs && pnpm add @uiw/react-color-saturation @uiw/react-color-hue @uiw/react-color-editable-input @uiw/react-color-swatch colorjs.io
   ```

2. Create `apps/docs/src/utils/color-utils.ts` with conversion functions:

   - `hsvToOklch(hsv: { h: number; s: number; v: number }): string`
     - Create HSV color using colorjs.io: `new Color('hsv', [h, s/100, v/100])`
     - Convert to OKLCH: `color.to('oklch')`
     - Format as string: `oklch(L C H)` with L/C to 2 decimals, H to integer
     - Handle NaN hue (for grays) by defaulting to 0

   - `oklchToHsv(oklchString: string): { h: number; s: number; v: number }`
     - Parse OKLCH string with `new Color(oklchString)`
     - Convert to HSV: `color.to('hsv')`
     - Return h as-is (0-360), s and v multiplied by 100 (0-100 range for picker)
     - Handle NaN values with defaults

   - `oklchToHex(oklchString: string): string`
     - Parse OKLCH, convert to sRGB, format as hex
     - Use `color.to('srgb').toString({ format: 'hex' })`
     - Ensure gamut mapping with `color.toGamut('srgb')` if out of gamut

   - `hexToOklch(hex: string): string`
     - Parse hex with `new Color(hex)`
     - Convert to OKLCH and format consistently
     - Handle various hex formats (3-char, 6-char, with/without #)

   - `isValidHex(hex: string): boolean`
     - Try parsing with colorjs.io, return true if valid, false if throws

Import colorjs.io as: `import Color from 'colorjs.io'`
  </action>
  <verify>
    - `pnpm install` succeeds from monorepo root
    - File exists: `apps/docs/src/utils/color-utils.ts`
    - TypeScript compiles: `cd apps/docs && pnpm exec tsc --noEmit`
  </verify>
  <done>
    - Color conversion utilities exist with all 5 functions
    - TypeScript types are correct (no compilation errors)
    - Dependencies installed in apps/docs/package.json
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ConfiguratorContext with theme state management</name>
  <files>
    apps/docs/src/contexts/ConfiguratorContext.tsx
  </files>
  <action>
Create `apps/docs/src/contexts/ConfiguratorContext.tsx` implementing the state management pattern from RESEARCH.md:

1. Define interfaces:
   ```typescript
   type ColorKey = 'primary' | 'secondary' | 'destructive' | 'background' | 'foreground' | 'muted';

   interface ConfiguratorState {
     activeMode: 'light' | 'dark';
     lightColors: Record<ColorKey, string>;  // OKLCH format
     darkColors: Record<ColorKey, string>;   // OKLCH format
     darkOverrides: Set<ColorKey>;           // Which dark colors are manually set
     lightOverrides: Set<ColorKey>;          // Which light colors are manually set (when editing dark first)
     radius: 'sm' | 'md' | 'lg';
   }

   interface ConfiguratorContextValue extends ConfiguratorState {
     setActiveMode: (mode: 'light' | 'dark') => void;
     setLightColor: (key: ColorKey, oklch: string) => void;
     setDarkColor: (key: ColorKey, oklch: string) => void;
     resetDarkColor: (key: ColorKey) => void;
     resetLightColor: (key: ColorKey) => void;
     setRadius: (radius: 'sm' | 'md' | 'lg') => void;
     getThemeConfig: () => ThemeConfig;
     getGeneratedCSS: () => string;
   }
   ```

2. Import from @lit-ui/cli:
   - `import { defaultTheme, generateThemeCSS, encodeThemeConfig, type ThemeConfig } from '@lit-ui/cli/theme'`
   - Note: This import path works because @lit-ui/cli exports theme module

3. Import deriveDarkMode for color derivation:
   - Since deriveDarkMode is not exported from the public API, implement a local version using colorjs.io that matches the logic from color-scale.ts:
     - Invert lightness: `darkL = 1 - lightL`
     - Reduce chroma: `darkC = lightC * 0.9`
     - Preserve hue
   - Also implement deriveLightMode (inverse): `lightL = 1 - darkL`, `lightC = darkC / 0.9`

4. Initialize state from defaultTheme:
   - lightColors from defaultTheme.colors
   - darkColors derived from lightColors using deriveDarkMode
   - Both override sets start empty
   - activeMode starts as 'light'
   - radius from defaultTheme.radius

5. Implement actions:
   - `setLightColor`: Update light color, if dark color NOT overridden, re-derive it
   - `setDarkColor`: Update dark color, ADD key to darkOverrides
   - `resetDarkColor`: REMOVE key from darkOverrides, re-derive from light
   - Similar logic for light overrides (when user edits dark mode first)
   - `getThemeConfig`: Build ThemeConfig object from current state
   - `getGeneratedCSS`: Call generateThemeCSS with current config

6. Create provider and hook:
   - `ConfiguratorProvider` wrapping children with context
   - `useConfigurator` hook with error if used outside provider
  </action>
  <verify>
    - File exists: `apps/docs/src/contexts/ConfiguratorContext.tsx`
    - TypeScript compiles: `cd apps/docs && pnpm exec tsc --noEmit`
    - Exports ConfiguratorProvider and useConfigurator
  </verify>
  <done>
    - ConfiguratorContext provides full theme state management
    - Light/dark derivation works bidirectionally
    - Override tracking allows manual customization
    - getThemeConfig and getGeneratedCSS produce valid output
  </done>
</task>

</tasks>

<verification>
1. Dependencies installed: Check apps/docs/package.json has @uiw/react-color-* packages
2. Color utils work: TypeScript compilation passes with no errors
3. Context exports: ConfiguratorProvider and useConfigurator are exported
4. CLI integration: Import from @lit-ui/cli/theme works (no runtime errors)
</verification>

<success_criteria>
- [ ] @uiw/react-color packages installed in apps/docs
- [ ] colorjs.io installed in apps/docs (for browser-side color conversion)
- [ ] color-utils.ts exports hsvToOklch, oklchToHsv, oklchToHex, hexToOklch, isValidHex
- [ ] ConfiguratorContext.tsx exports ConfiguratorProvider and useConfigurator
- [ ] TypeScript compiles without errors
- [ ] State management includes light/dark derivation with override tracking
</success_criteria>

<output>
After completion, create `.planning/phases/23-visual-configurator-core/23-01-SUMMARY.md`
</output>
