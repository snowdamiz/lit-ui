---
phase: 43-calendar-display-advanced
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/calendar/src/gesture-handler.ts
  - packages/calendar/src/animation-controller.ts
autonomous: true

must_haves:
  truths:
    - "GestureHandler detects horizontal swipe gestures using Pointer Events API and calls onSwipe callback with 'left' or 'right'"
    - "AnimationController provides slide transitions that automatically fall back to fade when prefers-reduced-motion is enabled"
    - "GestureHandler sets touch-action: pan-y on the target element to allow vertical scroll while capturing horizontal swipe"
    - "AnimationController cancels in-progress animations before starting new ones to prevent visual glitches"
  artifacts:
    - path: "packages/calendar/src/gesture-handler.ts"
      provides: "Pointer Events swipe detection"
      contains: "class GestureHandler"
      exports: ["GestureHandler"]
    - path: "packages/calendar/src/animation-controller.ts"
      provides: "Slide/fade animation with reduced-motion support"
      contains: "class AnimationController"
      exports: ["AnimationController"]
  key_links:
    - from: "packages/calendar/src/gesture-handler.ts"
      to: "Pointer Events API"
      via: "pointerdown/pointermove/pointerup/pointercancel listeners"
      pattern: "addEventListener.*pointer"
    - from: "packages/calendar/src/animation-controller.ts"
      to: "Web Animations API"
      via: "Element.animate() for slide/fade"
      pattern: "this\\.target\\.animate"
---

<objective>
Create standalone GestureHandler and AnimationController modules for swipe detection and month transition animations.

Purpose: These are reusable utility classes that encapsulate complex browser API interactions (Pointer Events, Web Animations API, prefers-reduced-motion). Keeping them separate from the Calendar component maintains clean architecture and enables testing in isolation.
Output: Two new TypeScript modules ready for integration in Plan 05.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-calendar-display-advanced/43-RESEARCH.md

Reference patterns from:
@packages/calendar/src/keyboard-nav.ts (standalone utility class pattern)
@packages/calendar/src/calendar.ts (consumer context)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GestureHandler for Pointer Events swipe detection</name>
  <files>packages/calendar/src/gesture-handler.ts</files>
  <action>
    Create `packages/calendar/src/gesture-handler.ts` with:

    Export class `GestureHandler` with these features:

    **Constructor:** `constructor(element: HTMLElement, onSwipe: (direction: 'left' | 'right') => void, threshold = 50, ratio = 1.5)`
    - `element`: The DOM element to attach pointer event listeners to
    - `onSwipe`: Callback invoked when a valid swipe is detected
    - `threshold`: Minimum horizontal distance (px) to qualify as swipe (default 50)
    - `ratio`: Minimum horizontal-to-vertical ratio to distinguish from vertical scroll (default 1.5)

    **Private state:**
    - `startX: number = 0` — X coordinate at pointer down
    - `startY: number = 0` — Y coordinate at pointer down
    - `pointerId: number | null = null` — Active pointer ID for multi-touch filtering

    **Public methods:**
    - `attach(): void` — Sets `element.style.touchAction = 'pan-y'` (critical: allows vertical scroll, captures horizontal). Adds pointerdown, pointerup, pointercancel event listeners. All handlers must be arrow functions (bound to instance) so they can be removed.
    - `detach(): void` — Removes all pointer event listeners. Resets touchAction to empty string.
    - `destroy(): void` — Alias for detach() for semantic clarity.

    **Private handler methods (arrow functions for binding):**
    - `onPointerDown = (e: PointerEvent)` — Store startX, startY, pointerId from event. Only track if pointerId is null (ignore multi-touch).
    - `onPointerUp = (e: PointerEvent)` — If e.pointerId matches stored pointerId: compute dx = e.clientX - startX, dy = e.clientY - startY. If Math.abs(dx) > threshold AND Math.abs(dx) > Math.abs(dy) * ratio, call onSwipe(dx > 0 ? 'right' : 'left'). Reset pointerId to null.
    - `onPointerCancel = (e: PointerEvent)` — If e.pointerId matches, reset pointerId to null (swipe canceled by browser).

    Do NOT add pointermove listener — swipe is evaluated only on pointerup. This keeps it simple and avoids performance overhead from continuous tracking.
  </action>
  <verify>
    - `grep "class GestureHandler" packages/calendar/src/gesture-handler.ts` confirms class exists
    - `grep "touch-action" packages/calendar/src/gesture-handler.ts` confirms pan-y setting
    - `grep "pointerdown\|pointerup\|pointercancel" packages/calendar/src/gesture-handler.ts` confirms all three handlers
    - `grep "export" packages/calendar/src/gesture-handler.ts` confirms export
  </verify>
  <done>GestureHandler class detects swipes via Pointer Events with configurable threshold and ratio, sets touch-action: pan-y</done>
</task>

<task type="auto">
  <name>Task 2: Create AnimationController for slide/fade transitions</name>
  <files>packages/calendar/src/animation-controller.ts</files>
  <action>
    Create `packages/calendar/src/animation-controller.ts` with:

    Export class `AnimationController` with these features:

    **Constructor:** `constructor(target: HTMLElement, duration = 200)`
    - `target`: The DOM element to animate (the .month-grid wrapper div)
    - `duration`: Animation duration in milliseconds (default 200)

    **Private state:**
    - `currentAnimation: Animation | null = null` — Reference to in-progress animation for cancellation
    - `prefersReducedMotion: boolean` — Current reduced-motion preference
    - `mediaQuery: MediaQueryList` — Reference to the matchMedia query
    - `isAnimating: boolean = false` — Guard flag for rapid navigation

    **Constructor body:**
    - Create mediaQuery via `window.matchMedia('(prefers-reduced-motion: reduce)')`
    - Set prefersReducedMotion from mediaQuery.matches
    - Add change listener to update prefersReducedMotion on preference change

    **Public methods:**
    - `async transition(direction: 'left' | 'right'): Promise<void>` — If isAnimating is true, return immediately (skip animation on rapid nav, content updates instantly). Cancel any currentAnimation. Set isAnimating = true. If prefersReducedMotion, call fade(). Otherwise call slide(direction). Set isAnimating = false when done.
    - `getIsAnimating(): boolean` — Returns isAnimating state.
    - `destroy(): void` — Cancel currentAnimation if exists. Remove mediaQuery change listener. Reset state.

    **Private methods:**
    - `async slide(direction: 'left' | 'right'): Promise<void>` — Determine offset: direction === 'left' ? '-100%' : '100%'. Use Element.animate() with keyframes `[{ transform: translateX(offset), opacity: 0 }, { transform: 'translateX(0)', opacity: 1 }]` and options `{ duration: this.duration, easing: 'ease-out', fill: 'forwards' }`. Store as currentAnimation. Await animation.finished. Set currentAnimation = null.
    - `async fade(): Promise<void>` — Use Element.animate() with keyframes `[{ opacity: 0 }, { opacity: 1 }]` and options `{ duration: 150, easing: 'ease-in-out', fill: 'forwards' }`. Store as currentAnimation. Await animation.finished. Set currentAnimation = null.

    Wrap animation.finished await in try/catch — if animation is canceled (via cancel()), the promise rejects. Catch and silently ignore AbortError / DOMException.
  </action>
  <verify>
    - `grep "class AnimationController" packages/calendar/src/animation-controller.ts` confirms class exists
    - `grep "prefers-reduced-motion" packages/calendar/src/animation-controller.ts` confirms reduced-motion detection
    - `grep "animate" packages/calendar/src/animation-controller.ts` confirms Web Animations API usage
    - `grep "export" packages/calendar/src/animation-controller.ts` confirms export
    - `pnpm --filter @lit-ui/calendar build` succeeds
  </verify>
  <done>AnimationController provides slide/fade transitions with reduced-motion support, animation cancellation, and rapid-navigation guard</done>
</task>

</tasks>

<verification>
- `pnpm --filter @lit-ui/calendar build` completes without TypeScript errors
- gesture-handler.ts exports GestureHandler class with attach(), detach(), destroy()
- animation-controller.ts exports AnimationController class with transition(), destroy()
- Both modules are standalone with no imports from calendar.ts
</verification>

<success_criteria>
1. GestureHandler detects left/right swipes with configurable threshold
2. GestureHandler sets touch-action: pan-y for proper mobile behavior
3. AnimationController provides slide and fade transitions
4. AnimationController respects prefers-reduced-motion (fade instead of slide)
5. AnimationController cancels in-progress animations safely
6. Package builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/43-calendar-display-advanced/43-02-SUMMARY.md`
</output>
