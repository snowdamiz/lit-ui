---
phase: 43-calendar-display-advanced
plan: 05
type: execute
wave: 3
depends_on: ["43-02", "43-03", "43-04"]
files_modified:
  - packages/calendar/src/calendar.ts
autonomous: true

must_haves:
  truths:
    - "Month transitions animate with slide effect (200ms)"
    - "Animations use fade instead of slide when prefers-reduced-motion is set"
    - "Rapid navigation skips animation and updates instantly"
    - "Touch swipe left/right navigates months on touch devices"
    - "Week number column shows ISO 8601 week numbers when show-week-numbers is set"
    - "Clicking a week number emits ui-week-select event with all 7 dates"
    - "Custom .renderDay callback controls day cell content"
  artifacts:
    - path: "packages/calendar/src/calendar.ts"
      provides: "Animation integration, swipe support, week numbers, custom rendering"
      contains: "AnimationController|GestureHandler|show-week-numbers|renderDay"
  key_links:
    - from: "packages/calendar/src/calendar.ts"
      to: "packages/calendar/src/animation-controller.ts"
      via: "import and instantiation"
      pattern: "new AnimationController"
    - from: "packages/calendar/src/calendar.ts"
      to: "packages/calendar/src/gesture-handler.ts"
      via: "import and instantiation"
      pattern: "new GestureHandler"
    - from: "packages/calendar/src/calendar.ts"
      to: "packages/calendar/src/date-utils.ts"
      via: "import getMonthWeeks"
      pattern: "getMonthWeeks|getISOWeekNumber"
---

<objective>
Integrate animations, touch swipe, week numbers, and custom day cell rendering into Calendar.

Purpose: Combines the utility modules from plans 02 and 03 with the Calendar component. This delivers CAL-24 (animation), CAL-25 (reduced-motion), CAL-26 (week numbers), CAL-27 (week selection), CAL-28 (touch swipe), and CAL-23 (custom cell rendering).
Output: Calendar component with animations, swipe navigation, optional week numbers, and .renderDay callback.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/calendar/src/calendar.ts
@packages/calendar/src/animation-controller.ts
@packages/calendar/src/gesture-handler.ts
@packages/calendar/src/date-utils.ts
@.planning/phases/43-calendar-display-advanced/43-RESEARCH.md
@.planning/phases/43-calendar-display-advanced/43-02-SUMMARY.md
@.planning/phases/43-calendar-display-advanced/43-03-SUMMARY.md
@.planning/phases/43-calendar-display-advanced/43-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate animations and swipe into Calendar</name>
  <files>packages/calendar/src/calendar.ts</files>
  <action>
Add animation and gesture support:

1. Import AnimationController and GestureHandler at top of file
2. Add private fields:
   - `private animationController: AnimationController | null = null;`
   - `private gestureHandler: GestureHandler | null = null;`

3. Initialize in connectedCallback (after super.connectedCallback):
   - Create AnimationController with callback that returns `this.shadowRoot?.querySelector('.month-grid')`
   - Create GestureHandler on the grid container element with swipe callback:
     - Swipe left -> handleNextMonth()
     - Swipe right -> handlePreviousMonth()

4. Clean up in disconnectedCallback:
   - Call `this.animationController?.destroy()`
   - Call `this.gestureHandler?.destroy()`

5. Update handlePreviousMonth and handleNextMonth to use AnimationController:
   - Wrap month update in `this.animationController.animateTransition('prev', () => { ... })`
   - The updateFn does the actual state change (currentMonth, selectedMonth, selectedYear, announceMonthChange, emitMonthChange)
   - If no animationController (SSR), do direct update

6. Add animation CSS to static styles:
   ```css
   .month-grid {
     transition: transform 200ms ease-out, opacity 200ms ease-out;
   }
   .month-grid.slide-out-left { transform: translateX(-100%); opacity: 0; }
   .month-grid.slide-out-right { transform: translateX(100%); opacity: 0; }
   .month-grid.slide-in-left { transform: translateX(-100%); opacity: 0; }
   .month-grid.slide-in-right { transform: translateX(100%); opacity: 0; }
   .month-grid.fade-out { opacity: 0; }
   @media (prefers-reduced-motion: reduce) {
     .month-grid {
       transition: opacity 150ms ease-out;
       transform: none !important;
     }
   }
   ```

7. Add `touch-action: pan-y` CSS to the grid container to allow vertical scrolling but capture horizontal swipe

8. Wrap the grid content in a `div.month-grid` container for animation targeting (the animation controller targets this element)

9. In firstUpdated, initialize gestureHandler on the rendered grid element (needs DOM to exist)
  </action>
  <verify>
`npx tsc --noEmit -p packages/calendar/tsconfig.json` compiles.
  </verify>
  <done>
Month transitions animate with slide (or fade for reduced-motion). Touch swipe left/right navigates months. Rapid navigation skips animation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add week numbers and custom day cell rendering</name>
  <files>packages/calendar/src/calendar.ts</files>
  <action>
Add week number column and renderDay callback:

1. Import `getMonthWeeks`, `getISOWeekNumber`, `WeekInfo` from date-utils

2. Add properties:
   - `@property({ type: Boolean, attribute: 'show-week-numbers' }) showWeekNumbers = false;`
   - `@property({ attribute: false }) renderDay?: (state: DayCellState) => unknown;`

3. Add `DayCellState` interface export:
   ```typescript
   export interface DayCellState {
     date: Date;
     isoDate: string;
     isToday: boolean;
     isSelected: boolean;
     isDisabled: boolean;
     isInRange: boolean;
     isWeekend: boolean;
   }
   ```

4. Update renderMonthView to optionally include week number column:
   - When `showWeekNumbers` is true, wrap the grid in a container with CSS Grid `grid-template-columns: auto 1fr`
   - Left column: week number buttons for each row
   - Right column: existing 7-column grid
   - Week number column header shows "W" (abbreviated "Week")
   - Each week number is a `<button>` with `aria-label="Select week N"`
   - Click handler: `handleWeekSelect(weekInfo)` dispatches `ui-week-select` custom event:
     ```typescript
     detail: {
       week: weekNumber,
       dates: isoDateStrings[], // all 7 dates
       start: isoStartDate,
       end: isoEndDate,
     }
     ```

5. Add week number CSS:
   ```css
   .calendar-with-weeks { display: grid; grid-template-columns: auto 1fr; }
   .week-numbers { display: flex; flex-direction: column; }
   .week-number {
     /* Button styling matching calendar cells */
     border: none;
     background: transparent;
     cursor: pointer;
     /* Same height as grid cells for alignment */
   }
   .week-number:hover { background-color: var(--color-gray-100); }
   ```

6. Update renderDayCell to use .renderDay callback:
   - Build DayCellState object from existing state
   - If `this.renderDay` exists, use its return value for cell content
   - Otherwise use default `date.getDate()` rendering
   - Keep all existing aria-* attributes and event handlers on the wrapper div regardless

7. Size variants for week numbers: scale week number button size to match sm/md/lg
  </action>
  <verify>
`npx tsc --noEmit -p packages/calendar/tsconfig.json` compiles.
`pnpm --filter @lit-ui/calendar build` succeeds.
  </verify>
  <done>
Week number column shows ISO 8601 week numbers when show-week-numbers is set. Click emits ui-week-select. Custom .renderDay callback controls day cell content while preserving accessibility attributes.
  </done>
</task>

</tasks>

<verification>
- TypeScript compiles: `npx tsc --noEmit -p packages/calendar/tsconfig.json`
- Build passes: `pnpm --filter @lit-ui/calendar build`
- AnimationController integrated with month navigation
- GestureHandler connected to grid for swipe detection
- Week number column renders when show-week-numbers is set
- ui-week-select event dispatched on week number click
- .renderDay callback invoked for each day cell
- DayCellState interface exported
- CSS animations include reduced-motion media query
</verification>

<success_criteria>
Calendar supports animated month transitions, touch swipe navigation, optional week numbers with selection, and custom day cell rendering via callback property.
</success_criteria>

<output>
After completion, create `.planning/phases/43-calendar-display-advanced/43-05-SUMMARY.md`
</output>
