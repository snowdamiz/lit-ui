---
phase: 43-calendar-display-advanced
plan: 05
type: execute
wave: 3
depends_on: ["43-02", "43-03"]
files_modified:
  - packages/calendar/src/calendar.ts
autonomous: true

must_haves:
  truths:
    - "Month transitions animate with slide effect (or fade when prefers-reduced-motion is enabled)"
    - "User can swipe left/right on the calendar grid to navigate months on touch devices"
    - "ISO week numbers display in a column when show-week-numbers attribute is set"
    - "Clicking a week number fires a ui-week-select event with the week's dates"
    - "renderDay callback property allows custom day cell rendering while preserving ARIA attributes"
  artifacts:
    - path: "packages/calendar/src/calendar.ts"
      provides: "Calendar with animations, swipe, week numbers, and custom day rendering"
      contains: "GestureHandler"
      exports: ["Calendar", "DateConstraints", "DayCellState"]
  key_links:
    - from: "packages/calendar/src/calendar.ts"
      to: "packages/calendar/src/gesture-handler.ts"
      via: "import GestureHandler"
      pattern: "import.*GestureHandler.*gesture-handler"
    - from: "packages/calendar/src/calendar.ts"
      to: "packages/calendar/src/animation-controller.ts"
      via: "import AnimationController"
      pattern: "import.*AnimationController.*animation-controller"
    - from: "packages/calendar/src/calendar.ts"
      to: "packages/calendar/src/date-utils.ts"
      via: "import getISOWeekNumber, getMonthWeeks"
      pattern: "import.*getISOWeekNumber.*date-utils"
---

<objective>
Integrate GestureHandler, AnimationController, week numbers, and custom day rendering into the Calendar component.

Purpose: This plan wires together the standalone utility modules (Plan 02) and week number functions (Plan 03) into the calendar component, completing the core interactive features: animated month transitions, touch swipe navigation, week number display with selection, and a renderDay callback for custom cell content.
Output: Calendar component with full animation, gesture, week number, and custom rendering support.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-calendar-display-advanced/43-RESEARCH.md
@.planning/phases/43-calendar-display-advanced/43-02-SUMMARY.md
@.planning/phases/43-calendar-display-advanced/43-03-SUMMARY.md

Reference patterns from:
@packages/calendar/src/calendar.ts (current state after Plan 04)
@packages/calendar/src/gesture-handler.ts (from Plan 02)
@packages/calendar/src/animation-controller.ts (from Plan 02)
@packages/calendar/src/date-utils.ts (with week utils from Plan 03)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate AnimationController and GestureHandler into Calendar</name>
  <files>packages/calendar/src/calendar.ts</files>
  <action>
    1. Add imports at top of calendar.ts:
       - `import { GestureHandler } from './gesture-handler.js';`
       - `import { AnimationController } from './animation-controller.js';`

    2. Add private instance properties:
       - `private gestureHandler: GestureHandler | null = null;`
       - `private animationController: AnimationController | null = null;`

    3. Add a @query for the animation target:
       - `@query('.month-grid') private monthGrid!: HTMLElement;`
       - NOTE: Wrap the calendar-grid div in a new `.month-grid` wrapper div in renderMonthView(). This wrapper is the animation target — it isolates the animation from header and other elements.

    4. Update `firstUpdated()` to initialize gesture and animation:
       ```typescript
       // After existing keyboard nav setup...
       // Initialize gesture handler on month-grid wrapper
       this.updateComplete.then(() => {
         const grid = this.renderRoot.querySelector('.month-grid') as HTMLElement;
         if (grid) {
           this.gestureHandler = new GestureHandler(grid, (direction) => {
             if (direction === 'left') this.navigateNextMonth();
             else this.navigatePrevMonth();
           });
           this.gestureHandler.attach();
           this.animationController = new AnimationController(grid);
         }
       });
       ```

    5. Update `navigatePrevMonth()` and `navigateNextMonth()` to trigger animations:
       - Before changing currentMonth, call `this.animationController?.transition(direction)` where direction is 'right' for prev (content slides in from left) and 'left' for next (content slides in from right).
       - Actually, the animation should happen AFTER the DOM updates with new content. Better approach: Change currentMonth first (triggers re-render), then in updated() when currentMonth changes, trigger animation. The animation makes the new content appear to slide in.
       - Implementation: Add a `private lastNavigationDirection: 'left' | 'right' | null = null` property. Set it to 'right' in navigatePrevMonth, 'left' in navigateNextMonth. In updated(), when currentMonth changes and lastNavigationDirection is set, trigger `this.animationController?.transition(lastNavigationDirection)` and reset direction to null.

    6. Add cleanup in a `disconnectedCallback()` override:
       ```typescript
       override disconnectedCallback(): void {
         super.disconnectedCallback();
         this.gestureHandler?.detach();
         this.animationController?.destroy();
       }
       ```

    7. Wrap the calendar grid content in renderMonthView() with a `.month-grid` div:
       ```html
       <div class="month-grid">
         <div class="calendar-weekdays" role="row">...</div>
         <div class="calendar-grid" role="grid" ...>...</div>
       </div>
       ```
       Add CSS: `.month-grid { overflow: hidden; }` to clip animation overflow.
  </action>
  <verify>
    - `grep "GestureHandler" packages/calendar/src/calendar.ts` shows import and usage
    - `grep "AnimationController" packages/calendar/src/calendar.ts` shows import and usage
    - `grep "month-grid" packages/calendar/src/calendar.ts` shows wrapper div
    - `grep "disconnectedCallback" packages/calendar/src/calendar.ts` shows cleanup
  </verify>
  <done>Calendar initializes GestureHandler and AnimationController in firstUpdated, triggers animations on month navigation, cleans up on disconnect</done>
</task>

<task type="auto">
  <name>Task 2: Add week numbers column and renderDay callback</name>
  <files>packages/calendar/src/calendar.ts</files>
  <action>
    1. Add import for week utilities:
       `import { ..., getISOWeekNumber, getMonthWeeks } from './date-utils.js';`
       Add WeekInfo type import if needed.

    2. Define and export the DayCellState interface (at module level, before the class):
       ```typescript
       export interface DayCellState {
         date: Date;
         isToday: boolean;
         isSelected: boolean;
         isDisabled: boolean;
         isOutsideMonth: boolean;
         isInRange: boolean;
         weekNumber: number;
         formattedDate: string;
       }
       ```
       Note: isInRange is the inverse of isDisabled (per prior decision).

    3. Add new properties to Calendar class:
       - `@property({ type: Boolean, attribute: 'show-week-numbers' }) showWeekNumbers = false;`
       - `@property({ attribute: false }) renderDay: ((state: DayCellState) => unknown) | null = null;`
         — A callback that receives DayCellState and returns a Lit template result for custom day cell content. When null, default rendering is used.

    4. Update the calendar grid CSS for week numbers:
       - Add a CSS class `.calendar-weekdays-with-weeks` that uses `grid-template-columns: auto repeat(7, 1fr);` (8 columns: week number + 7 days)
       - Add `.calendar-grid-with-weeks` with same 8-column grid
       - Add CSS for week number cells:
         ```css
         .week-number {
           display: flex;
           align-items: center;
           justify-content: center;
           font-size: 0.75rem;
           color: var(--ui-calendar-weekday-color, #6b7280);
           cursor: pointer;
           padding: 0.25rem;
           border: none;
           background: none;
           border-radius: var(--ui-calendar-radius, 0.375rem);
           width: 2rem;
         }
         .week-number:hover {
           background-color: var(--ui-calendar-hover-bg, #f3f4f6);
         }
         .week-number:focus-visible {
           outline: 2px solid var(--ui-calendar-focus-ring, var(--color-ring, #3b82f6));
           outline-offset: 2px;
         }
         ```

    5. Update renderMonthView() to support week numbers:
       - If showWeekNumbers is true:
         a. Use `calendar-weekdays-with-weeks` class (add empty header cell before weekday names)
         b. Use `calendar-grid-with-weeks` class
         c. Group the days array into rows of 7
         d. For each row, prepend a week number button:
            ```html
            <button class="week-number"
                    tabindex="-1"
                    aria-label="Week ${getISOWeekNumber(row[3])}, select entire week"
                    @click="${() => this.handleWeekSelect(row)}">
              ${getISOWeekNumber(row[3])}
            </button>
            ```
            Use row[3] (Thursday) for ISO week determination.
       - If showWeekNumbers is false: keep existing flat grid rendering

    6. Add `private handleWeekSelect(weekDays: Date[]): void`:
       - Filter weekDays to only include current-month days that are not disabled
       - Dispatch custom event 'week-select' with detail: `{ weekNumber, dates: filteredDays, isoStrings: filteredDays.map(d => format(d, 'yyyy-MM-dd')) }`
       - Announce via liveAnnouncement: "Selected week ${weekNumber}"

    7. Update day cell rendering to support renderDay callback:
       - Before rendering each day button, compute `DayCellState` object
       - If this.renderDay is not null, render:
         ```html
         <div class="date-button-wrapper ${classes}"
              tabindex="${tabindex}"
              role="gridcell"
              aria-label="${label}"
              aria-selected="${selected}"
              aria-disabled="${isDisabled}"
              aria-current="${today ? 'date' : nothing}"
              @click="${() => this.handleDateSelect(day)}">
           ${this.renderDay(dayCellState)}
         </div>
         ```
         The wrapper div retains ALL ARIA attributes and keyboard behavior. The renderDay callback only controls visual content inside.
       - If this.renderDay is null, render the existing button markup (default).

    8. Update setupCells() to query the correct elements when week numbers are shown — week number buttons should NOT be part of the keyboard navigation cells. Only query '.date-button' or '.date-button-wrapper' elements (not '.week-number').

    9. IMPORTANT: When showWeekNumbers is true, the keyboard navigation manager should still use 7 columns (week number buttons are outside the navigable grid).
  </action>
  <verify>
    - `grep "show-week-numbers" packages/calendar/src/calendar.ts` shows the property
    - `grep "DayCellState" packages/calendar/src/calendar.ts` shows the interface
    - `grep "renderDay" packages/calendar/src/calendar.ts` shows the callback property
    - `grep "week-select" packages/calendar/src/calendar.ts` shows the event dispatch
    - `grep "week-number" packages/calendar/src/calendar.ts` shows week number button CSS and rendering
    - `pnpm --filter @lit-ui/calendar build` succeeds
  </verify>
  <done>Calendar supports show-week-numbers with clickable week selection, renderDay callback for custom cell content, and proper grid layout with 8 columns when week numbers shown</done>
</task>

</tasks>

<verification>
- `pnpm --filter @lit-ui/calendar build` completes without errors
- Calendar integrates GestureHandler for swipe navigation
- Calendar integrates AnimationController for slide/fade transitions
- show-week-numbers attribute displays ISO week column with clickable buttons
- week-select event fires with week dates when week number clicked
- renderDay callback property allows custom cell rendering
- DayCellState interface is exported
- Keyboard navigation works correctly with and without week numbers
</verification>

<success_criteria>
1. Month transitions animate with slide (or fade for reduced-motion)
2. Swipe left/right navigates months on touch devices
3. show-week-numbers shows ISO week column
4. Clicking week number fires week-select event
5. renderDay callback renders custom content inside ARIA-equipped wrapper
6. Package builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/43-calendar-display-advanced/43-05-SUMMARY.md`
</output>
