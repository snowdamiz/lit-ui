---
phase: 43-calendar-display-advanced
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/calendar/src/date-utils.ts
autonomous: true

must_haves:
  truths:
    - "getISOWeekNumber() returns correct ISO 8601 week numbers including year boundary edge cases"
    - "getISOWeekDates() returns an array of 7 dates (Monday to Sunday) for any given date's ISO week"
    - "getMonthWeeks() returns all unique weeks for a given month with week numbers and date ranges"
  artifacts:
    - path: "packages/calendar/src/date-utils.ts"
      provides: "ISO week number utilities added to existing date utility module"
      contains: "getISOWeekNumber"
      exports: ["getISOWeekNumber", "getISOWeekDates", "getMonthWeeks"]
  key_links:
    - from: "packages/calendar/src/date-utils.ts"
      to: "date-fns"
      via: "import getISOWeek, startOfISOWeek, endOfISOWeek, eachDayOfInterval"
      pattern: "import.*getISOWeek.*from.*date-fns"
---

<objective>
Add ISO 8601 week number utility functions to date-utils.ts for week number display and week selection features.

Purpose: The calendar needs to display ISO week numbers in a column and support selecting entire weeks by clicking the week number. These utilities wrap date-fns ISO week functions to handle edge cases at year boundaries.
Output: Three new exported functions in the existing date-utils.ts module.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-calendar-display-advanced/43-RESEARCH.md

Reference patterns from:
@packages/calendar/src/date-utils.ts (existing date utilities — add to this file)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ISO week number utilities to date-utils.ts</name>
  <files>packages/calendar/src/date-utils.ts</files>
  <action>
    Add these imports from date-fns to the existing import statement at the top of date-utils.ts:
    - `getISOWeek` — Returns ISO 8601 week number (1-53)
    - `startOfISOWeek` — Returns Monday of the ISO week
    - `endOfISOWeek` — Returns Sunday of the ISO week

    Also add `getISOWeek` to the re-export block.

    Add three new exported functions after the existing `intlFirstDayToDateFns` function:

    1. `export function getISOWeekNumber(date: Date): number`
       - Returns `getISOWeek(date)`
       - Simple wrapper for consistency with the module's API surface
       - JSDoc: "Get ISO 8601 week number for a date. Week 1 is the week containing the first Thursday of the year."

    2. `export function getISOWeekDates(date: Date): Date[]`
       - Returns `eachDayOfInterval({ start: startOfISOWeek(date), end: endOfISOWeek(date) })`
       - Always returns 7 dates (Monday to Sunday) regardless of locale first-day-of-week setting
       - JSDoc: "Get all 7 dates in an ISO week (Monday to Sunday) for the given date."

    3. `export function getMonthWeeks(month: Date, weekStartsOn: 0|1|2|3|4|5|6): WeekInfo[]`
       - Define interface `WeekInfo { weekNumber: number; startDate: Date; endDate: Date; days: Date[] }`
       - Export the WeekInfo interface
       - Implementation:
         a. Get all calendar days via `getCalendarDays(month, weekStartsOn)` (reuse existing function)
         b. Group days into rows of 7 (each row is one week as displayed in the calendar)
         c. For each row, compute weekNumber via `getISOWeekNumber(row[0])` — BUT use the Thursday of the row for ISO week determination (ISO 8601 defines week by its Thursday). Find the Thursday: it's the day where getDay() === 4. If no Thursday in row (shouldn't happen in 7-day row), fall back to row[0].
         d. Use a Map keyed by `startOfISOWeek(thursday).getTime()` to deduplicate weeks that span month boundaries
         e. For each unique week, create WeekInfo with weekNumber, startDate (first day of display row), endDate (last day of display row), days (the 7 calendar days in that row)
         f. Return array sorted by startDate
       - JSDoc: "Get all weeks displayed in a calendar month grid with ISO week numbers. Each WeekInfo contains the week number and the 7 displayed days for that calendar row."

    IMPORTANT: The `getMonthWeeks` function works with the calendar's display grid, not pure ISO weeks. The `days` array matches what the calendar renders (respecting weekStartsOn), while `weekNumber` follows ISO 8601. This means if the calendar starts on Sunday, the week number corresponds to the ISO week of the row's Thursday.
  </action>
  <verify>
    - `grep "getISOWeekNumber" packages/calendar/src/date-utils.ts` shows the function
    - `grep "getISOWeekDates" packages/calendar/src/date-utils.ts` shows the function
    - `grep "getMonthWeeks" packages/calendar/src/date-utils.ts` shows the function
    - `grep "WeekInfo" packages/calendar/src/date-utils.ts` shows the interface
    - `grep "getISOWeek" packages/calendar/src/date-utils.ts` shows the import from date-fns
    - `pnpm --filter @lit-ui/calendar build` succeeds
  </verify>
  <done>Three ISO week utility functions exported from date-utils.ts, WeekInfo interface exported, package builds cleanly</done>
</task>

</tasks>

<verification>
- `pnpm --filter @lit-ui/calendar build` completes without TypeScript errors
- date-utils.ts exports getISOWeekNumber, getISOWeekDates, getMonthWeeks, WeekInfo
- Existing exports (getCalendarDays, getMonthYearLabel, etc.) are unchanged
- getMonthWeeks reuses getCalendarDays internally (no duplication)
</verification>

<success_criteria>
1. getISOWeekNumber returns ISO 8601 week numbers via date-fns
2. getISOWeekDates returns 7 dates (Monday-Sunday) for any date's ISO week
3. getMonthWeeks returns all weeks in a month grid with week numbers
4. WeekInfo interface is exported for type consumers
5. Package builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/43-calendar-display-advanced/43-03-SUMMARY.md`
</output>
