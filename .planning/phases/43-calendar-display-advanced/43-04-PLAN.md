---
phase: 43-calendar-display-advanced
plan: 04
type: execute
wave: 2
depends_on: ["43-01"]
files_modified:
  - packages/calendar/src/calendar.ts
autonomous: true

must_haves:
  truths:
    - "Clicking the month/year heading drills into year view showing 12 years in a 4x3 grid"
    - "Clicking the decade heading in year view drills into decade view showing 12 decades in a 4x3 grid"
    - "Clicking a year in year view navigates to that year's month view"
    - "Clicking a decade in decade view navigates to that decade's year view"
    - "Escape key navigates back one view level (decade -> year -> month)"
    - "Arrow keys navigate the 4x3 grid in year and decade views via KeyboardNavigationManager with 4 columns"
  artifacts:
    - path: "packages/calendar/src/calendar.ts"
      provides: "Calendar with month, year, and decade views"
      contains: "currentView"
      exports: ["Calendar", "DateConstraints"]
  key_links:
    - from: "packages/calendar/src/calendar.ts"
      to: "packages/calendar/src/keyboard-nav.ts"
      via: "setColumns(4) for year/decade views, setColumns(7) for month view"
      pattern: "setColumns"
---

<objective>
Add decade and century (decade-of-decades) views to the Calendar component with view switching via heading clicks and Escape key navigation.

Purpose: Users selecting birth dates or historical dates need to navigate to distant years quickly. The decade view shows a 4x3 grid of 12 years, and the century view shows a 4x3 grid of 12 decades, enabling fast drill-down to any year.
Output: Calendar component with three view modes (month, year, decade) and keyboard-accessible view switching.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-calendar-display-advanced/43-RESEARCH.md
@.planning/phases/43-calendar-display-advanced/43-01-SUMMARY.md

Reference patterns from:
@packages/calendar/src/calendar.ts (existing component to modify)
@packages/calendar/src/keyboard-nav.ts (KeyboardNavigationManager with setColumns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CalendarView type and view switching state</name>
  <files>packages/calendar/src/calendar.ts</files>
  <action>
    Add a type and state to the Calendar class for view management:

    1. Define type at module level (after imports, before class):
       `type CalendarView = 'month' | 'year' | 'decade';`

    2. Add new @state() property to Calendar class:
       `@state() private currentView: CalendarView = 'month';`

    3. Add view navigation methods:

       - `private drillUp(): void` — Switch to parent view:
         - If month -> set currentView to 'year'
         - If year -> set currentView to 'decade'
         - If decade -> do nothing (top level)

       - `private drillDown(view: CalendarView): void` — Switch to child view:
         - Set currentView to the specified view
         - After updateComplete + rAF, call setupViewCells() to initialize keyboard nav for new view

       - `private handleViewHeadingClick(): void` — Call drillUp()

       - `private handleViewHeadingKeydown(e: KeyboardEvent): void` — If Enter or Space, prevent default, call drillUp()

    4. Add `private setupViewCells(): void` method:
       - If currentView is 'month': call this.navigationManager!.setColumns(7) then existing setupCells()
       - If currentView is 'year': call this.navigationManager!.setColumns(4), query '.year-cell' buttons, call setCells() and setFocusedIndex(0)
       - If currentView is 'decade': call this.navigationManager!.setColumns(4), query '.decade-cell' buttons, call setCells() and setFocusedIndex(0)

    5. Update the existing `handleKeydown` method to add Escape key handling:
       - If e.key === 'Escape': If currentView is 'decade', drillDown('year'). If currentView is 'year', drillDown('month'). Prevent default.
       - The existing arrow key / Home / End / PageUp / PageDown handling should only apply in month view. For year and decade views, the arrow key handling via KeyboardNavigationManager with 4 columns is sufficient (same moveFocus logic).
       - Add Enter/Space handling for year and decade views: In year view, clicking/pressing Enter on a year cell calls selectYear(year). In decade view, pressing Enter calls selectDecade(decade).
  </action>
  <verify>
    - `grep "CalendarView" packages/calendar/src/calendar.ts` shows the type
    - `grep "currentView" packages/calendar/src/calendar.ts` shows the state property
    - `grep "drillUp\|drillDown" packages/calendar/src/calendar.ts` shows navigation methods
    - `grep "Escape" packages/calendar/src/calendar.ts` shows Escape key handling
  </verify>
  <done>Calendar has CalendarView state with drill-up/drill-down methods and Escape key navigation between views</done>
</task>

<task type="auto">
  <name>Task 2: Implement year view (decade grid) and decade view (century grid) renders</name>
  <files>packages/calendar/src/calendar.ts</files>
  <action>
    1. Update the main `render()` method to dispatch to view-specific render methods:
       ```
       protected override render() {
         switch (this.currentView) {
           case 'year': return this.renderYearView();
           case 'decade': return this.renderDecadeView();
           default: return this.renderMonthView();
         }
       }
       ```
       Move ALL existing render() content into a new `private renderMonthView()` method. The renderMonthView should be identical to the old render() except:
       - The header h2 / month-year-selectors section gets a clickable heading that calls drillUp() (see below)

    2. Update the month view header: Replace the existing `<div class="month-year-selectors">` with a heading button that drills up:
       - Wrap the month/year label in a clickable element: `<button class="view-heading" role="button" @click="${this.handleViewHeadingClick}" @keydown="${this.handleViewHeadingKeydown}" aria-label="Switch to year view">${monthLabel}</button>`
       - Keep the prev/next navigation buttons as-is on either side
       - REMOVE the month-select and year-select dropdowns from the header (they're replaced by the drill-up navigation). Actually, KEEP them but hide them when in month view — they still serve as accessible month/year jump. Better approach: Replace the heading area entirely. Use the heading button for view drilling, keep dropdowns as a fallback. Simplest approach: Use the heading button AND keep the dropdowns. The heading button appears between prev/next buttons. Dropdowns remain below or are removed.
       - DECISION: Replace the month/year select dropdowns with a single clickable heading button. The decade and century views provide the same year-jump functionality more intuitively. Remove `handleMonthSelect`, `handleYearSelect`, `getYearRange`, `selectedMonth`, `selectedYear` state properties since they're replaced by the drill-up views.

    3. Create `private renderYearView()` method:
       - Compute decadeStart = Math.floor(getYear(this.currentMonth) / 10) * 10
       - Generate 12 years: decadeStart - 1 through decadeStart + 10 (1 before + 10 in decade + 1 after)
       - Header: prev button (decade - 10), heading button "${decadeStart}-${decadeStart+9}" with @click to drillUp(), next button (decade + 10)
       - Grid: 4x3 grid of year buttons. Each button:
         - class="year-cell" + "outside" if year < decadeStart or year > decadeStart+9
         - class="current" if year === getYear(this.currentMonth)
         - @click calls selectYear(year)
         - aria-label="${year}"
         - tabindex managed by KeyboardNavigationManager
       - After render, setupViewCells() initializes keyboard nav with 4 columns

    4. Create `private renderDecadeView()` method:
       - Compute centuryStart = Math.floor(getYear(this.currentMonth) / 100) * 100
       - Generate 12 decades: centuryStart - 10 through centuryStart + 100 (stepping by 10)
       - Header: prev button (century - 100), heading "${centuryStart}-${centuryStart+99}" (non-clickable, top level), next button (century + 100)
       - Grid: 4x3 grid of decade buttons. Each button:
         - class="decade-cell" + "outside" if decade < centuryStart or decade >= centuryStart+100
         - @click calls selectDecade(decade)
         - aria-label="${decade} to ${decade + 9}"
         - tabindex managed by KeyboardNavigationManager

    5. Add selection handlers:
       - `private selectYear(year: number): void` — Set currentMonth to January 1st of selected year. Set currentView to 'month'. After updateComplete + rAF, setupViewCells().
       - `private selectDecade(decade: number): void` — Set currentMonth to January 1st of decade start year. Set currentView to 'year'. After updateComplete + rAF, setupViewCells().
       - Navigation in year/decade views: prev/next buttons should shift by 10 years (year view) or 100 years (decade view)

    6. Add CSS for year and decade grid views:
       ```css
       .year-grid, .decade-grid {
         display: grid;
         grid-template-columns: repeat(4, 1fr);
         gap: 0.25rem;
         padding: 0.5rem;
       }
       .year-cell, .decade-cell {
         display: flex;
         align-items: center;
         justify-content: center;
         padding: 0.75rem 0.5rem;
         border-radius: var(--ui-calendar-radius, 0.375rem);
         border: 2px solid transparent;
         background: none;
         cursor: pointer;
         font-size: 0.875rem;
         color: inherit;
       }
       .year-cell:hover, .decade-cell:hover {
         background-color: var(--ui-calendar-hover-bg, #f3f4f6);
       }
       .year-cell:focus-visible, .decade-cell:focus-visible {
         outline: 2px solid var(--ui-calendar-focus-ring, var(--color-ring, #3b82f6));
         outline-offset: 2px;
       }
       .year-cell.outside, .decade-cell.outside {
         opacity: var(--ui-calendar-outside-opacity, 0.4);
       }
       .year-cell.current {
         border-color: var(--ui-calendar-today-border, var(--color-primary, #3b82f6));
         font-weight: 600;
       }
       .view-heading {
         font-size: 0.875rem;
         font-weight: 600;
         background: none;
         border: none;
         cursor: pointer;
         padding: 0.25rem 0.5rem;
         border-radius: var(--ui-calendar-radius, 0.375rem);
         color: inherit;
       }
       .view-heading:hover {
         background-color: var(--ui-calendar-hover-bg, #f3f4f6);
       }
       .view-heading:focus-visible {
         outline: 2px solid var(--ui-calendar-focus-ring, var(--color-ring, #3b82f6));
         outline-offset: 2px;
       }
       ```
       Add dark mode variants for year-cell, decade-cell, view-heading hover states.

    7. Update the `updated()` lifecycle method: When currentView changes, after next rAF, call setupViewCells().
  </action>
  <verify>
    - `grep "renderYearView\|renderDecadeView\|renderMonthView" packages/calendar/src/calendar.ts` shows all three render methods
    - `grep "selectYear\|selectDecade" packages/calendar/src/calendar.ts` shows selection handlers
    - `grep "year-grid\|decade-grid" packages/calendar/src/calendar.ts` shows CSS for grid views
    - `grep "view-heading" packages/calendar/src/calendar.ts` shows clickable heading
    - `pnpm --filter @lit-ui/calendar build` succeeds
  </verify>
  <done>Calendar renders month, year (4x3), and decade (4x3) views with keyboard navigation, view drilling via heading clicks, and Escape key to go back</done>
</task>

</tasks>

<verification>
- `pnpm --filter @lit-ui/calendar build` completes without errors
- Calendar has three view modes: month (7-col grid), year (4x3 grid of years), decade (4x3 grid of decades)
- Heading click drills up (month -> year -> decade)
- Escape key navigates back (decade -> year -> month)
- Year/decade cells are keyboard accessible via KeyboardNavigationManager with 4 columns
- All views have consistent header layout (prev button, heading, next button)
</verification>

<success_criteria>
1. Month view renders as before with clickable heading for drill-up
2. Year view shows 12 years (decade-1 through decade+10) in 4x3 grid
3. Decade view shows 12 decades in 4x3 grid
4. Arrow keys navigate all three grid types correctly
5. Escape navigates back one view level
6. Selecting a year returns to month view for that year
7. Package builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/43-calendar-display-advanced/43-04-SUMMARY.md`
</output>
