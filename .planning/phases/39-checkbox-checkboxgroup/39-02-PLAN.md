---
phase: 39-checkbox-checkboxgroup
plan: 02
type: execute
wave: 2
depends_on: ["39-01"]
files_modified:
  - packages/checkbox/src/checkbox.ts
  - packages/checkbox/src/index.ts
  - packages/checkbox/src/jsx.d.ts
autonomous: true

must_haves:
  truths:
    - "User can click or press Space to toggle a checkbox between checked and unchecked"
    - "Checkbox displays animated SVG checkmark draw-in transition when checked"
    - "Checkbox supports indeterminate state with dash icon and aria-checked='mixed'"
    - "Indeterminate clears on user interaction (toggle always results in checked or unchecked)"
    - "Checkbox participates in forms via ElementInternals (setFormValue, setValidity, formResetCallback)"
    - "Checkbox supports required validation with touched-based error display"
    - "Checkbox renders label text via label property or default slot"
    - "Checkbox has size variants (sm/md/lg) using CSS tokens"
    - "Screen readers announce role='checkbox' with aria-checked state (true/false/mixed)"
    - "Animations respect prefers-reduced-motion"
    - "Checkbox is SSR-compatible with isServer guards"
    - "Package builds successfully producing dist/ output"
  artifacts:
    - path: "packages/checkbox/src/checkbox.ts"
      provides: "Checkbox web component class"
      exports: ["Checkbox", "CheckboxSize"]
      min_lines: 150
    - path: "packages/checkbox/src/index.ts"
      provides: "Safe element registration + re-exports for both lui-checkbox and lui-checkbox-group"
      contains: "customElements.define"
    - path: "packages/checkbox/src/jsx.d.ts"
      provides: "JSX type declarations for React, Vue, Svelte"
      contains: "lui-checkbox"
  key_links:
    - from: "packages/checkbox/src/checkbox.ts"
      to: "@lit-ui/core"
      via: "TailwindElement import"
      pattern: "import.*TailwindElement.*@lit-ui/core"
    - from: "packages/checkbox/src/checkbox.ts"
      to: "packages/core/src/styles/tailwind.css"
      via: "CSS token references (--ui-checkbox-*)"
      pattern: "var\\(--ui-checkbox-"
    - from: "packages/checkbox/src/checkbox.ts"
      to: "ElementInternals"
      via: "attachInternals + setFormValue"
      pattern: "attachInternals|setFormValue"
    - from: "packages/checkbox/src/index.ts"
      to: "packages/checkbox/src/checkbox.ts"
      via: "export + customElements.define"
      pattern: "customElements.define.*lui-checkbox.*Checkbox"
---

<objective>
Implement the lui-checkbox web component with animated SVG checkmark, indeterminate tri-state, form participation, and framework type support. Also create index.ts (registering both lui-checkbox and lui-checkbox-group placeholders) and jsx.d.ts.

Purpose: Deliver the Checkbox component covering CHKB-01 through CHKB-14 requirements. The CheckboxGroup class will be added in plan 39-03, but index.ts is set up to register both elements.
Output: Working checkbox.ts component, index.ts registration, jsx.d.ts types — package builds with the checkbox component.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-checkbox-checkboxgroup/39-RESEARCH.md
@.planning/phases/39-checkbox-checkboxgroup/39-01-SUMMARY.md

Reference implementations (read these for exact patterns):
@packages/switch/src/switch.ts
@packages/switch/src/index.ts
@packages/switch/src/jsx.d.ts
@packages/core/src/utils/events.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement the Checkbox component</name>
  <files>
    packages/checkbox/src/checkbox.ts
  </files>
  <action>
Create `packages/checkbox/src/checkbox.ts` implementing the full checkbox component. Follow the exact patterns from `packages/switch/src/switch.ts` for form participation, validation, SSR, and events. Use the 39-RESEARCH.md code examples as the primary reference.

**Exports:** `Checkbox` class, `CheckboxSize` type (`'sm' | 'md' | 'lg'`)

**Properties (all @property with correct types):**
- `checked: boolean = false` (reflect: true) — CHKB-01
- `disabled: boolean = false` (reflect: true) — CHKB-05
- `required: boolean = false` (reflect: true) — CHKB-04
- `indeterminate: boolean = false` (NOT reflected — JS-only property per native convention) — CHKB-02
- `name: string = ''` — CHKB-03
- `value: string = 'on'` — CHKB-03 (native checkbox default value)
- `label: string = ''` — CHKB-06
- `size: CheckboxSize = 'md'` — CHKB-07

**State (@state):**
- `touched: boolean = false`
- `showError: boolean = false`

**Private fields:**
- `internals: ElementInternals | null = null`
- `checkboxId: string` — unique ID (pattern: `lui-cb-${Math.random().toString(36).substr(2, 9)}`)
- `defaultChecked: boolean = false` — for formResetCallback

**Constructor:** `super()`, then `if (!isServer) { this.internals = this.attachInternals(); }` — CHKB-11

**connectedCallback:** `super.connectedCallback()`, store `this.defaultChecked = this.checked`, call `this.updateFormValue()`.

**Static formAssociated = true** — CHKB-03

**updated(changedProperties: PropertyValues):** When `checked` or `indeterminate` changes, call `this.updateFormValue()` and `this.validate()`. Use `PropertyValues` type (NOT Map) to avoid api-extractor DTS rollup crash.

**Static styles:** Use `[...tailwindBaseStyles, css\`...\`]` pattern. Include ALL CSS from 39-RESEARCH.md "CSS Styles for Checkbox" section:
- `:host { display: inline-block; }` and `:host([disabled]) { pointer-events: none; }`
- `.checkbox-wrapper` — flexbox row, `gap: var(--ui-checkbox-label-gap)`, `align-items: center` (clickable: add click handler on wrapper)
- `.checkbox-box` — inline-flex, align-items/justify-content center, border `var(--ui-checkbox-border-width) solid var(--ui-checkbox-border)`, border-radius `var(--ui-checkbox-radius)`, background `var(--ui-checkbox-bg)`, cursor pointer, transition background-color + border-color, flex-shrink 0, color `var(--ui-checkbox-check-color)`
- `.checkbox-box[aria-checked='true']` and `.checkbox-box[aria-checked='mixed']` — background `var(--ui-checkbox-bg-checked)`, border-color `var(--ui-checkbox-border-checked)`
- `.checkbox-icon` — width/height 75%
- **Checkmark draw-in animation:** `.check-path` — stroke-dasharray: 14, stroke-dashoffset: 14, transition stroke-dashoffset
- `.checkbox-box[aria-checked='true'] .check-path` — stroke-dashoffset: 0
- **Indeterminate dash:** `.dash-path` — opacity: 0, transition opacity
- `.checkbox-box[aria-checked='mixed'] .dash-path` — opacity: 1
- `.checkbox-box[aria-checked='mixed'] .check-path` — stroke-dashoffset: 14 (hide checkmark when indeterminate)
- Size classes: `.box-sm`, `.box-md`, `.box-lg` — width/height from `var(--ui-checkbox-size-{size})`
- Focus ring: `.checkbox-box:focus-visible` — outline none, box-shadow `0 0 0 2px var(--ui-checkbox-ring)`
- Disabled: `.checkbox-box[aria-disabled='true']` — opacity 0.5, cursor not-allowed
- Label: `.checkbox-label` + `.label-sm/md/lg` — font-size from tokens, cursor pointer
- Error text: `.error-text` — font-size 0.75rem, color `var(--ui-checkbox-text-error)`, margin-top 0.25rem
- Has-error: `.checkbox-box.has-error` — border-color `var(--ui-checkbox-border-error)`
- **Reduced motion:** `@media (prefers-reduced-motion: reduce) { .check-path, .dash-path, .checkbox-box { transition-duration: 0ms; } }` — CHKB-13

**Methods:**

`toggle()` — If disabled, return. Set `this.indeterminate = false` (always clear indeterminate on user interaction — CHKB-02). Flip `this.checked`. Set `this.touched = true`. Call `this.updateFormValue()`, `this.validate()`. Dispatch `ui-change` event via `dispatchCustomEvent(this, 'ui-change', { checked: this.checked, value: this.checked ? this.value : null })`. — CHKB-01

`handleClick(e: Event)` — Call `this.toggle()`. — CHKB-01

`handleKeyDown(e: KeyboardEvent)` — If `e.key === ' '` (Space ONLY — NOT Enter, per W3C APG checkbox spec): call `e.preventDefault()` (prevents page scroll — Pitfall 4), then `this.toggle()`. — CHKB-12

`updateFormValue()` — `this.internals?.setFormValue(this.checked ? this.value : null)`. Indeterminate does NOT affect form value (Pitfall 1). — CHKB-03

`validate(): boolean` — If no internals, return true. If `this.required && !this.checked`: call `this.internals.setValidity({ valueMissing: true }, 'Please check this box.', this.shadowRoot?.querySelector('.checkbox-box') as HTMLElement)`, set `this.showError = this.touched`, return false. Otherwise: `this.internals.setValidity({})`, set `this.showError = false`, return true. — CHKB-04

`formResetCallback()` — Reset: `this.checked = this.defaultChecked`, `this.indeterminate = false`, `this.touched = false`, `this.showError = false`, call `this.updateFormValue()`, `this.internals?.setValidity({})`. — CHKB-14

`formDisabledCallback(disabled: boolean)` — Set `this.disabled = disabled`.

**render() method:** — CHKB-02, CHKB-06, CHKB-08
```
<div class="checkbox-wrapper" @click=${this.handleClick}>
  <div
    role="checkbox"
    aria-checked=${this.indeterminate ? 'mixed' : this.checked ? 'true' : 'false'}
    aria-disabled=${this.disabled ? 'true' : nothing}
    aria-required=${this.required ? 'true' : nothing}
    aria-labelledby="${this.checkboxId}-label"
    tabindex=${this.disabled ? '-1' : '0'}
    class="checkbox-box box-${this.size} ${this.showError ? 'has-error' : ''}"
    @keydown=${this.handleKeyDown}
  >
    <svg class="checkbox-icon" viewBox="0 0 12 12" fill="none" aria-hidden="true">
      <path class="check-path" d="M2 6L5 9L10 3"
        stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round" />
      <path class="dash-path" d="M3 6H9"
        stroke="currentColor" stroke-width="2"
        stroke-linecap="round" />
    </svg>
  </div>
  ${this.label
    ? html`<label id="${this.checkboxId}-label" class="checkbox-label label-${this.size}">${this.label}</label>`
    : html`<label id="${this.checkboxId}-label" class="checkbox-label label-${this.size}"><slot></slot></label>`}
</div>
${this.showError
  ? html`<div class="error-text" role="alert">Please check this box.</div>`
  : nothing}
```

**IMPORTANT: Click handler is on the wrapper (not the checkbox-box) so clicking the label also toggles.** Remove any separate click handler from the checkbox-box div to avoid double-toggling. The keydown handler stays on the checkbox-box (which has tabindex).

**Import details:**
- `html, css, nothing, isServer` from `'lit'`
- `type PropertyValues` from `'lit'`
- `property, state` from `'lit/decorators.js'`
- `TailwindElement, tailwindBaseStyles` from `'@lit-ui/core'`
- `dispatchCustomEvent` from `'@lit-ui/core'` (check exact export path from switch.ts)
  </action>
  <verify>
Run `grep 'role="checkbox"' packages/checkbox/src/checkbox.ts` — confirms ARIA role.
Run `grep 'aria-checked' packages/checkbox/src/checkbox.ts` — confirms checked state (including mixed).
Run `grep 'mixed' packages/checkbox/src/checkbox.ts` — confirms indeterminate support.
Run `grep 'formResetCallback' packages/checkbox/src/checkbox.ts` — confirms form reset.
Run `grep 'setFormValue' packages/checkbox/src/checkbox.ts` — confirms form participation.
Run `grep 'setValidity' packages/checkbox/src/checkbox.ts` — confirms validation.
Run `grep 'prefers-reduced-motion' packages/checkbox/src/checkbox.ts` — confirms reduced motion.
Run `grep 'isServer' packages/checkbox/src/checkbox.ts` — confirms SSR guard.
Run `grep 'preventDefault' packages/checkbox/src/checkbox.ts` — confirms keyboard handling.
Run `grep 'stroke-dasharray' packages/checkbox/src/checkbox.ts` — confirms SVG animation.
Run `grep 'stroke-dashoffset' packages/checkbox/src/checkbox.ts` — confirms draw-in technique.
Run `grep "e.key === ' '" packages/checkbox/src/checkbox.ts` — confirms Space-only keyboard (NOT Enter).
  </verify>
  <done>
Checkbox component implements all 14 CHKB requirements: toggle (CHKB-01), indeterminate tri-state (CHKB-02), form participation (CHKB-03), required validation (CHKB-04), disabled (CHKB-05), label (CHKB-06), sizes (CHKB-07), animated SVG checkmark (CHKB-08), CSS tokens (CHKB-09), dark mode (CHKB-10), SSR (CHKB-11), Space-only keyboard (CHKB-12), reduced motion (CHKB-13), form reset (CHKB-14).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create index.ts, jsx.d.ts, and build verification</name>
  <files>
    packages/checkbox/src/index.ts
    packages/checkbox/src/jsx.d.ts
  </files>
  <action>
**index.ts** — Follow the multi-element registration pattern from 39-RESEARCH.md (similar to packages/select/src/index.ts). Register both lui-checkbox and lui-checkbox-group. Since checkbox-group.ts does not exist yet, use a conditional import pattern — register lui-checkbox now and include a placeholder comment for lui-checkbox-group that plan 39-03 will fill in.

Actually, simpler approach: Create index.ts that ONLY registers lui-checkbox for now. Plan 39-03 will update index.ts to also register lui-checkbox-group after creating checkbox-group.ts.

```typescript
// @lit-ui/checkbox - Checkbox component with SSR support
/// <reference path="./jsx.d.ts" />
import { isServer } from 'lit';

// Export component class and types
export { Checkbox } from './checkbox.js';
export type { CheckboxSize } from './checkbox.js';

// Re-export TailwindElement and isServer for convenience
export { TailwindElement, isServer } from '@lit-ui/core';

// Safe custom element registration with collision detection
import { Checkbox } from './checkbox.js';

if (typeof customElements !== 'undefined') {
  if (!customElements.get('lui-checkbox')) {
    customElements.define('lui-checkbox', Checkbox);
  } else if (!isServer && import.meta.env?.DEV) {
    console.warn(
      '[lui-checkbox] Custom element already registered. ' +
        'This may indicate duplicate imports or version conflicts.'
    );
  }
}

// TypeScript global type registration
declare global {
  interface HTMLElementTagNameMap {
    'lui-checkbox': Checkbox;
  }
}
```

**jsx.d.ts** — Follow EXACT pattern from `packages/switch/src/jsx.d.ts`. Include types for BOTH lui-checkbox and lui-checkbox-group (the group types will be forward-looking; plan 39-03 will update if needed):

```typescript
/**
 * JSX type declarations for lui-checkbox and lui-checkbox-group custom elements.
 * Provides type support for React, Vue, and Svelte.
 */

import type { Checkbox, CheckboxSize } from './checkbox.js';

// Common attributes for lui-checkbox
interface LuiCheckboxAttributes {
  checked?: boolean;
  disabled?: boolean;
  required?: boolean;
  indeterminate?: boolean;
  name?: string;
  value?: string;
  label?: string;
  size?: CheckboxSize;
}

// Common attributes for lui-checkbox-group
interface LuiCheckboxGroupAttributes {
  label?: string;
  disabled?: boolean;
  required?: boolean;
  error?: string;
  'select-all'?: boolean;
}

// React JSX support
declare global {
  namespace JSX {
    interface IntrinsicElements {
      'lui-checkbox': React.DetailedHTMLProps<
        React.HTMLAttributes<Checkbox> & LuiCheckboxAttributes,
        Checkbox
      >;
      'lui-checkbox-group': React.DetailedHTMLProps<
        React.HTMLAttributes<HTMLElement> & LuiCheckboxGroupAttributes,
        HTMLElement
      >;
    }
  }
}

// Vue support
declare module 'vue' {
  export interface GlobalComponents {
    'lui-checkbox': import('vue').DefineComponent<LuiCheckboxAttributes>;
    'lui-checkbox-group': import('vue').DefineComponent<LuiCheckboxGroupAttributes>;
  }
}

// Svelte support
declare namespace svelteHTML {
  interface IntrinsicElements {
    'lui-checkbox': LuiCheckboxAttributes & {
      'on:ui-change'?: (e: CustomEvent) => void;
    };
    'lui-checkbox-group': LuiCheckboxGroupAttributes & {
      'on:ui-change'?: (e: CustomEvent) => void;
    };
  }
}

export {};
```

After creating both files, run the build:
```bash
pnpm build --filter @lit-ui/checkbox
```

Verify the build produces `packages/checkbox/dist/index.js` and `packages/checkbox/dist/index.d.ts`.
  </action>
  <verify>
Run `pnpm build --filter @lit-ui/checkbox` — builds without errors.
Run `ls packages/checkbox/dist/index.js packages/checkbox/dist/index.d.ts` — both output files exist.
Run `grep 'lui-checkbox' packages/checkbox/src/index.ts` — element name registered.
Run `grep 'lui-checkbox' packages/checkbox/src/jsx.d.ts` — JSX types declared.
Run `grep 'lui-checkbox-group' packages/checkbox/src/jsx.d.ts` — group JSX types declared.
  </verify>
  <done>
Checkbox package has safe element registration (index.ts), framework JSX types for both elements (jsx.d.ts), and builds successfully producing dist/index.js and dist/index.d.ts.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build --filter @lit-ui/checkbox` — builds without errors
2. `ls packages/checkbox/dist/` — contains index.js, index.d.ts, checkbox.js, checkbox.d.ts
3. `grep 'role="checkbox"' packages/checkbox/src/checkbox.ts` — ARIA role present
4. `grep 'formAssociated' packages/checkbox/src/checkbox.ts` — form association enabled
5. `grep 'stroke-dasharray' packages/checkbox/src/checkbox.ts` — SVG animation present
6. `grep 'mixed' packages/checkbox/src/checkbox.ts` — indeterminate support present
7. `grep 'prefers-reduced-motion' packages/checkbox/src/checkbox.ts` — motion respect present
8. `grep 'isServer' packages/checkbox/src/checkbox.ts` — SSR guards present
9. All 14 CHKB requirements addressable from the component source
</verification>

<success_criteria>
- lui-checkbox component renders checkbox box with SVG checkmark draw-in animation
- Toggle works via click and Space key (NOT Enter — per W3C APG checkbox spec)
- Indeterminate state shows dash icon with aria-checked="mixed", clears on user interaction
- Form participation via ElementInternals (setFormValue, setValidity, formResetCallback)
- Required validation prevents form submission when unchecked
- Disabled state blocks interaction and shows visual distinction
- Label supported via property and default slot; clicking label toggles checkbox
- sm/md/lg sizes using CSS tokens
- role="checkbox" with aria-checked (true/false/mixed) for screen readers
- prefers-reduced-motion disables animations
- isServer guards for SSR compatibility
- Package builds producing dist/ output
- JSX types for React, Vue, Svelte (both checkbox and checkbox-group)
</success_criteria>

<output>
After completion, create `.planning/phases/39-checkbox-checkboxgroup/39-02-SUMMARY.md`
</output>
