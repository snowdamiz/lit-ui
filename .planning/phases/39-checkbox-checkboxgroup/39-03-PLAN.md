---
phase: 39-checkbox-checkboxgroup
plan: 03
type: execute
wave: 3
depends_on: ["39-02"]
files_modified:
  - packages/checkbox/src/checkbox-group.ts
  - packages/checkbox/src/index.ts
autonomous: true

must_haves:
  truths:
    - "CheckboxGroup renders with role='group' and aria-labelledby"
    - "CheckboxGroup displays label text"
    - "CheckboxGroup propagates disabled state to all child lui-checkbox elements"
    - "CheckboxGroup disabled propagation re-syncs when disabled property changes after initial render"
    - "CheckboxGroup select-all checkbox reflects indeterminate when some children are checked"
    - "Clicking select-all when indeterminate/unchecked checks all enabled children; clicking when all checked unchecks all"
    - "Select-all batch update uses flag to prevent race conditions during event handling"
    - "CheckboxGroup displays error message when group-level validation fails (required with none checked)"
    - "Each child checkbox still submits independently to forms (group is NOT form-associated)"
    - "index.ts registers both lui-checkbox and lui-checkbox-group custom elements"
    - "Package builds successfully with both components"
  artifacts:
    - path: "packages/checkbox/src/checkbox-group.ts"
      provides: "CheckboxGroup web component class"
      exports: ["CheckboxGroup"]
      min_lines: 100
    - path: "packages/checkbox/src/index.ts"
      provides: "Safe element registration for BOTH lui-checkbox and lui-checkbox-group"
      contains: "lui-checkbox-group"
  key_links:
    - from: "packages/checkbox/src/checkbox-group.ts"
      to: "@lit-ui/core"
      via: "TailwindElement import"
      pattern: "import.*TailwindElement.*@lit-ui/core"
    - from: "packages/checkbox/src/checkbox-group.ts"
      to: "packages/checkbox/src/checkbox.ts"
      via: "Checkbox type import for child discovery"
      pattern: "import.*Checkbox.*checkbox"
    - from: "packages/checkbox/src/checkbox-group.ts"
      to: "slotchange"
      via: "Child discovery via slot change event"
      pattern: "@slotchange"
    - from: "packages/checkbox/src/index.ts"
      to: "packages/checkbox/src/checkbox-group.ts"
      via: "export + customElements.define"
      pattern: "customElements.define.*lui-checkbox-group.*CheckboxGroup"
---

<objective>
Implement the lui-checkbox-group web component with group accessibility, disabled propagation, select-all coordination, and validation UI. Update index.ts to register both elements.

Purpose: Deliver the CheckboxGroup container covering CGRP-01 through CGRP-05 requirements. The group is NOT form-associated — it provides layout, accessibility, disabled propagation, select-all, and validation UI only.
Output: Working checkbox-group.ts component, updated index.ts with both registrations — package builds with both components.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-checkbox-checkboxgroup/39-RESEARCH.md
@.planning/phases/39-checkbox-checkboxgroup/39-02-SUMMARY.md

Reference implementations (read these for exact patterns):
@packages/checkbox/src/checkbox.ts
@packages/checkbox/src/index.ts
@packages/select/src/select.ts (slotchange pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement the CheckboxGroup component</name>
  <files>
    packages/checkbox/src/checkbox-group.ts
  </files>
  <action>
Create `packages/checkbox/src/checkbox-group.ts` implementing the checkbox group container. This is NOT form-associated. It provides role="group", disabled propagation, select-all coordination, and validation UI. Use 39-RESEARCH.md Patterns 4 and 5 as primary reference. Use `packages/select/src/select.ts` for the slotchange child discovery pattern.

**Exports:** `CheckboxGroup` class

**Properties (all @property with correct types):**
- `label: string = ''` — CGRP-02
- `disabled: boolean = false` (reflect: true) — CGRP-03
- `required: boolean = false` — CGRP-05 (group-level: at least one must be checked)
- `error: string = ''` — CGRP-05 (custom error message)
- `selectAll: boolean = false` (attribute: 'select-all') — CGRP-04

**State (@state):**
- `showError: boolean = false`

**Private fields:**
- `groupId: string` — unique ID (pattern: `lui-cbg-${Math.random().toString(36).substr(2, 9)}`)
- `checkboxes: Checkbox[] = []` — discovered child checkboxes (NOT including select-all)
- `_batchUpdating: boolean = false` — flag to prevent select-all race condition (Pitfall 6)
- `selectAllEl: Checkbox | null = null` — reference to internal select-all checkbox (if selectAll property is true)

**NO static formAssociated.** This class does NOT participate in forms. Children submit independently.

**Static styles:** Use `[...tailwindBaseStyles, css\`...\`]` pattern:
- `:host { display: block; }`
- `.group-wrapper` — display flex, flex-direction column
- `.group-label` — font-weight 500, margin-bottom 0.375rem, font-size 0.875rem, color appropriate token
- `.group-items` — display flex, flex-direction column, gap `var(--ui-checkbox-group-gap)`
- `.select-all-wrapper` — padding-bottom `var(--ui-checkbox-group-gap)`, border-bottom 1px solid `var(--ui-checkbox-border)`, margin-bottom `var(--ui-checkbox-group-gap)`
- `.error-text` — font-size 0.75rem, color `var(--ui-checkbox-text-error)`, margin-top 0.25rem
- `:host([disabled])` — opacity 0.5

**updated(changedProperties: PropertyValues):** (Use PropertyValues type — Pitfall 7)
- If `disabled` changed: call `this.syncDisabledState()` — Pitfall 5
- If `selectAll` changed: request update to re-render select-all checkbox

**Methods:**

`handleSlotChange(e: Event)` — Get assigned elements from slot, filter for `LUI-CHECKBOX` tagName. Store as `this.checkboxes`. Call `this.syncDisabledState()`. Set up event listeners for child changes. — Pattern from Select component.

The child discovery must:
1. Get all assigned elements: `const slot = e.target as HTMLSlotElement; const assigned = slot.assignedElements({ flatten: true });`
2. Filter for checkboxes: `this.checkboxes = assigned.filter(el => el.tagName === 'LUI-CHECKBOX') as Checkbox[];`
3. Call `this.syncDisabledState()`
4. Update select-all state if applicable

`syncDisabledState()` — If `this.disabled`, set `disabled = true` on all child checkboxes. — CGRP-03, Pitfall 5

`handleChildChange(e: Event)` — Listener for `ui-change` events bubbling from children. If `this._batchUpdating`, return early (Pitfall 6). If `this.selectAll`, update the select-all checkbox state. Call `this.validateGroup()`. — CGRP-04

`updateSelectAllState()` — Count checked vs total enabled children. If 0 checked: selectAllEl.checked = false, selectAllEl.indeterminate = false. If all checked: selectAllEl.checked = true, selectAllEl.indeterminate = false. Else: selectAllEl.checked = false, selectAllEl.indeterminate = true. — Pattern 5

`handleSelectAllToggle()` — Determine `shouldCheck` (if NOT all enabled are checked, check all; otherwise uncheck all). Set `this._batchUpdating = true`. Set `checked` on each non-disabled child. Set `this._batchUpdating = false`. Call `this.updateSelectAllState()`. Call `this.validateGroup()`. Dispatch `ui-change` event on the group with aggregate state. — CGRP-04, Pitfall 6

`validateGroup()` — If `this.required` and no children are checked: set `this.showError = true`. Otherwise `this.showError = false`. — CGRP-05

**render() method:** — CGRP-01, CGRP-02, CGRP-04, CGRP-05
```
<div
  class="group-wrapper"
  role="group"
  aria-labelledby="${this.groupId}-label"
  @ui-change=${this.handleChildChange}
>
  ${this.label ? html`<span id="${this.groupId}-label" class="group-label">${this.label}</span>` : nothing}
  ${this.selectAll ? html`
    <div class="select-all-wrapper">
      <lui-checkbox
        label="Select all"
        @ui-change=${this.handleSelectAllToggle}
        .disabled=${this.disabled}
      ></lui-checkbox>
    </div>
  ` : nothing}
  <div class="group-items">
    <slot @slotchange=${this.handleSlotChange}></slot>
  </div>
  ${this.showError
    ? html`<div class="error-text" role="alert">${this.error || 'Please select at least one option.'}</div>`
    : nothing}
</div>
```

**IMPORTANT for select-all checkbox reference:** After rendering, get the select-all checkbox reference in `updated()` when `selectAll` is true: `this.selectAllEl = this.shadowRoot?.querySelector('.select-all-wrapper lui-checkbox') as Checkbox | null;`. Then call `this.updateSelectAllState()` to sync initial state.

**IMPORTANT for event handling:** The `@ui-change` on the group wrapper catches ALL ui-change events from child checkboxes (composed: true events bubble through Shadow DOM). The select-all checkbox's `@ui-change` handler is separate (`handleSelectAllToggle`) and should call `e.stopPropagation()` to prevent it from also triggering `handleChildChange`.

**Import details:**
- `html, css, nothing` from `'lit'`
- `type PropertyValues` from `'lit'`
- `property, state` from `'lit/decorators.js'`
- `TailwindElement, tailwindBaseStyles` from `'@lit-ui/core'`
- `dispatchCustomEvent` from `'@lit-ui/core'`
- `type { Checkbox }` from `'./checkbox.js'` (type-only for child reference typing)
  </action>
  <verify>
Run `grep 'role="group"' packages/checkbox/src/checkbox-group.ts` — confirms group role.
Run `grep 'aria-labelledby' packages/checkbox/src/checkbox-group.ts` — confirms label association.
Run `grep 'slotchange' packages/checkbox/src/checkbox-group.ts` — confirms child discovery.
Run `grep '_batchUpdating' packages/checkbox/src/checkbox-group.ts` — confirms race condition guard.
Run `grep 'indeterminate' packages/checkbox/src/checkbox-group.ts` — confirms select-all mixed state.
Run `grep 'formAssociated' packages/checkbox/src/checkbox-group.ts` — should NOT be found (group is not form-associated).
Run `grep 'validateGroup' packages/checkbox/src/checkbox-group.ts` — confirms group validation.
Run `grep 'syncDisabledState' packages/checkbox/src/checkbox-group.ts` — confirms disabled propagation.
  </verify>
  <done>
CheckboxGroup component implements all 5 CGRP requirements: role="group" with aria-labelledby (CGRP-01), label display (CGRP-02), disabled propagation (CGRP-03), select-all with indeterminate coordination (CGRP-04), group validation error message (CGRP-05).
  </done>
</task>

<task type="auto">
  <name>Task 2: Update index.ts to register both elements and rebuild</name>
  <files>
    packages/checkbox/src/index.ts
  </files>
  <action>
Update `packages/checkbox/src/index.ts` to export and register BOTH lui-checkbox and lui-checkbox-group. Follow the multi-element registration pattern from 39-RESEARCH.md (similar to packages/select/src/index.ts).

Replace the entire file with:

```typescript
// @lit-ui/checkbox - Checkbox and CheckboxGroup components with SSR support
/// <reference path="./jsx.d.ts" />
import { isServer } from 'lit';

// Export component classes and types
export { Checkbox } from './checkbox.js';
export { CheckboxGroup } from './checkbox-group.js';
export type { CheckboxSize } from './checkbox.js';

// Re-export TailwindElement and isServer for convenience
export { TailwindElement, isServer } from '@lit-ui/core';

// Safe custom element registration with collision detection
import { Checkbox } from './checkbox.js';
import { CheckboxGroup } from './checkbox-group.js';

if (typeof customElements !== 'undefined') {
  if (!customElements.get('lui-checkbox')) {
    customElements.define('lui-checkbox', Checkbox);
  } else if (!isServer && import.meta.env?.DEV) {
    console.warn(
      '[lui-checkbox] Custom element already registered. ' +
        'This may indicate duplicate imports or version conflicts.'
    );
  }

  if (!customElements.get('lui-checkbox-group')) {
    customElements.define('lui-checkbox-group', CheckboxGroup);
  } else if (!isServer && import.meta.env?.DEV) {
    console.warn(
      '[lui-checkbox-group] Custom element already registered. ' +
        'This may indicate duplicate imports or version conflicts.'
    );
  }
}

// TypeScript global type registration
declare global {
  interface HTMLElementTagNameMap {
    'lui-checkbox': Checkbox;
    'lui-checkbox-group': CheckboxGroup;
  }
}
```

After updating, rebuild:
```bash
pnpm build --filter @lit-ui/checkbox
```

Verify the build produces output files for both components.
  </action>
  <verify>
Run `pnpm build --filter @lit-ui/checkbox` — builds without errors.
Run `ls packages/checkbox/dist/` — contains index.js, index.d.ts, checkbox.js, checkbox.d.ts, checkbox-group.js, checkbox-group.d.ts.
Run `grep 'lui-checkbox-group' packages/checkbox/src/index.ts` — group element registered.
Run `grep 'CheckboxGroup' packages/checkbox/src/index.ts` — group class exported.
  </verify>
  <done>
Package exports and registers both lui-checkbox and lui-checkbox-group, builds successfully with all source files producing dist/ output.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build --filter @lit-ui/checkbox` — builds without errors
2. `ls packages/checkbox/dist/` — contains both checkbox and checkbox-group output files
3. `grep 'role="group"' packages/checkbox/src/checkbox-group.ts` — group ARIA role
4. `grep '_batchUpdating' packages/checkbox/src/checkbox-group.ts` — race condition protection
5. `grep 'formAssociated' packages/checkbox/src/checkbox-group.ts` — should NOT exist
6. `grep 'lui-checkbox-group' packages/checkbox/src/index.ts` — both elements registered
7. All 5 CGRP requirements addressable from the group source
</verification>

<success_criteria>
- lui-checkbox-group renders with role="group" and aria-labelledby
- Group displays label text
- Group disabled state propagates to all child checkboxes (initial and dynamic)
- Select-all checkbox reflects indeterminate when some children checked, checked when all, unchecked when none
- Batch update flag prevents select-all race conditions
- Group validation shows error message when required and none checked
- Group is NOT form-associated (individual checkboxes submit independently)
- index.ts registers both lui-checkbox and lui-checkbox-group
- Package builds with both components
</success_criteria>

<output>
After completion, create `.planning/phases/39-checkbox-checkboxgroup/39-03-SUMMARY.md`
</output>
