---
phase: 99-incremental-moving-average-state-machine
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/charts/src/shared/candlestick-option-builder.ts
  - packages/charts/src/base/base-chart-element.ts
autonomous: true
requirements: [MA-02, MA-04]

must_haves:
  truths:
    - "MAConfig.color is now optional — an MAConfig without a color property is a valid TypeScript type with no compile error"
    - "buildCandlestickOption accepts maValueArrays and resolvedMAColors in CandlestickOptionProps and uses them instead of calling _computeSMA/_computeEMA when provided"
    - "An MAConfig with showType: true and type: 'ema' produces a series named 'MA20 (EMA)' in the ECharts option object"
    - "An MAConfig with showType: false (or omitted) produces a series named 'MA20' (no suffix)"
    - "readChartToken(name) is a protected method on BaseChartElement that delegates to _themeBridge.readToken(name)"
  artifacts:
    - path: "packages/charts/src/shared/candlestick-option-builder.ts"
      provides: "Updated MAConfig type, maValueArrays/resolvedMAColors in CandlestickOptionProps, _maLegendName() function"
      exports: ["MAConfig", "CandlestickOptionProps", "buildCandlestickOption", "CandlestickBarPoint", "OhlcBar"]
    - path: "packages/charts/src/base/base-chart-element.ts"
      provides: "readChartToken() protected method"
      contains: "protected readChartToken"
  key_links:
    - from: "packages/charts/src/candlestick/candlestick-chart.ts"
      to: "packages/charts/src/shared/candlestick-option-builder.ts"
      via: "imports MAConfig, CandlestickOptionProps"
      pattern: "import.*MAConfig"
    - from: "packages/charts/src/candlestick/candlestick-chart.ts"
      to: "packages/charts/src/base/base-chart-element.ts"
      via: "inherits readChartToken()"
      pattern: "readChartToken"
---

<objective>
Update MAConfig type and candlestick-option-builder.ts to support optional colors, pre-computed MA value arrays, resolved color arrays, and showType legend labels. Add a protected readChartToken() helper to BaseChartElement so LuiCandlestickChart can resolve CSS tokens without accessing the private _themeBridge field directly.

Purpose: MA-02 requires the component to assign default colors from CSS tokens — this requires either making _themeBridge protected (invasive) or adding a protected accessor (preferred). MA-04 requires legend names like "MA20 (EMA)" when showType: true. Both changes to the option builder type contract must be backward-compatible — existing MAConfig with color still works; existing buildCandlestickOption calls without maValueArrays still work (fallback to O(n) _computeSMA/_computeEMA).

Output: Updated candlestick-option-builder.ts with expanded types and logic; updated base-chart-element.ts with readChartToken().
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/99-incremental-moving-average-state-machine/99-RESEARCH.md

<interfaces>
<!-- Exact current state of the files being modified. Executor uses these directly. -->

From packages/charts/src/shared/candlestick-option-builder.ts (CURRENT — to be modified):
```typescript
export type MAConfig = {
  period: number;
  color: string;        // CHANGE: make optional (color?: string)
  type?: 'sma' | 'ema';
  // ADD: showType?: boolean   (MA-04)
};

export type CandlestickOptionProps = {
  bullColor?: string;
  bearColor?: string;
  showVolume?: boolean;
  movingAverages?: MAConfig[];
  // ADD: maValueArrays?: (number | null)[][]  (pre-computed, avoids O(n) recompute)
  // ADD: resolvedMAColors?: string[]           (pre-resolved token colors)
};

// Private helpers (keep, used as fallback when maValueArrays not provided):
function _computeSMA(closes: number[], period: number): (number | null)[]
function _computeEMA(closes: number[], period: number): (number | null)[]
```

From packages/charts/src/base/base-chart-element.ts (CURRENT — to be modified):
```typescript
private _themeBridge = new ThemeBridge(this);  // line ~125
```
ThemeBridge.readToken(name: string): string  — resolves CSS token with fallback

Token defaults confirmed in packages/charts/src/base/theme-bridge.ts:
- '--ui-chart-color-2': '#8b5cf6'
- '--ui-chart-color-3': '#10b981'
- '--ui-chart-color-4': '#f59e0b'
- '--ui-chart-color-5': '#ef4444'
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update MAConfig type and option builder for optional color, showType, and pre-computed arrays</name>
  <files>packages/charts/src/shared/candlestick-option-builder.ts</files>
  <action>
    Make three targeted changes to this file:

    1. **MAConfig type** — change `color: string` to `color?: string` and add `showType?: boolean`:
    ```typescript
    export type MAConfig = {
      period: number;
      color?: string;       // MA-02: optional — component assigns default if omitted
      type?: 'sma' | 'ema';
      showType?: boolean;   // MA-04: appends "(EMA)" or "(SMA)" to legend label when true
    };
    ```

    2. **CandlestickOptionProps** — add two new optional fields:
    ```typescript
    export type CandlestickOptionProps = {
      bullColor?: string;
      bearColor?: string;
      showVolume?: boolean;
      movingAverages?: MAConfig[];
      /** Pre-computed MA value arrays (one per MAConfig entry). When provided, skips O(n) _computeSMA/_computeEMA. */
      maValueArrays?: (number | null)[][];
      /** Pre-resolved MA colors (one per MAConfig entry). When provided, skips token resolution in builder. */
      resolvedMAColors?: string[];
    };
    ```

    3. **Add `_maLegendName()` private function** immediately before the `maSeries` computation inside `buildCandlestickOption` (or as a module-level private function):
    ```typescript
    function _maLegendName(ma: MAConfig): string {
      const base = `MA${ma.period}`;
      if (!ma.showType) return base;
      const typeSuffix = (ma.type ?? 'sma').toUpperCase();
      return `${base} (${typeSuffix})`;
    }
    ```

    4. **Update `maSeries` construction** inside `buildCandlestickOption` to:
    - Use `_maLegendName(ma)` instead of `` `MA${ma.period}` `` for the series `name`
    - Use `maValueArrays?.[i]` when provided, falling back to `_computeEMA`/`_computeSMA` otherwise
    - Use `resolvedMAColors?.[i] ?? ma.color ?? '#888888'` for lineStyle.color

    Replace the existing `maSeries` block:
    ```typescript
    const maSeries = movingAverages.map((ma, i) => {
      const computed =
        (props.maValueArrays && props.maValueArrays[i]) ??
        ((ma.type ?? 'sma') === 'ema'
          ? _computeEMA(closes, ma.period)
          : _computeSMA(closes, ma.period));

      const color = (props.resolvedMAColors && props.resolvedMAColors[i]) ?? ma.color ?? '#888888';
      const name = _maLegendName(ma);

      return {
        name,
        type: 'line',
        xAxisIndex: 0,
        yAxisIndex: 0,
        data: computed,
        smooth: true,
        lineStyle: { color, width: 1.5, opacity: 0.85 },
        symbol: 'none',
        tooltip: { show: true },
      };
    });
    ```

    5. **Update legendData** to use `_maLegendName(m)` instead of `` `MA${m.period}` ``:
    ```typescript
    const legendData = ['Candlestick', ...movingAverages.map((m) => _maLegendName(m))];
    ```

    Keep `_computeSMA` and `_computeEMA` as private module-level functions — they remain as fallbacks for non-streaming use. Do NOT export them.

    The `props.` prefix is needed when accessing `maValueArrays` and `resolvedMAColors` inside `buildCandlestickOption` since they come from the `props` parameter. Destructure them at the top:
    ```typescript
    const { maValueArrays, resolvedMAColors } = props;
    ```
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components && pnpm --filter @lit-ui/charts run build 2>&1 | tail -20</automated>
  </verify>
  <done>
    - MAConfig type: color is optional, showType is present
    - CandlestickOptionProps: maValueArrays and resolvedMAColors fields exist
    - _maLegendName() function exists and handles showType correctly
    - maSeries uses pre-computed arrays when provided, falls back to _computeSMA/_computeEMA
    - Build passes with zero TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add protected readChartToken() to BaseChartElement</name>
  <files>packages/charts/src/base/base-chart-element.ts</files>
  <action>
    Add a single protected method to BaseChartElement that exposes CSS token reading without exposing the private _themeBridge instance. This follows the research recommendation (Option B) — keep ThemeBridge private, expose only the read accessor.

    Locate the `protected _webglUnavailable = false;` line (around line 139) or the cluster of protected fields. Add the method in the protected section, after the protected fields and before the first abstract method:

    ```typescript
    /**
     * MA-02: Protected CSS token reader — delegates to _themeBridge.readToken().
     * Exposes token resolution to subclasses (e.g., LuiCandlestickChart for MA default colors)
     * without making _themeBridge itself accessible. ThemeBridge instance stays private.
     */
    protected readChartToken(name: string): string {
      return this._themeBridge.readToken(name);
    }
    ```

    Place it AFTER the protected fields block and BEFORE `protected abstract _registerModules()`. Do not change any other code in this file.
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components && pnpm --filter @lit-ui/charts run build 2>&1 | tail -10</automated>
  </verify>
  <done>
    - readChartToken(name: string): string method exists on BaseChartElement
    - Method is protected (not private, not public)
    - Delegates to this._themeBridge.readToken(name)
    - No other changes to base-chart-element.ts
    - Build passes with zero TypeScript errors
  </done>
</task>

</tasks>

<verification>
Run full charts package build:
```bash
cd /Users/sn0w/Documents/dev/lit-components && pnpm --filter @lit-ui/charts run build
```

Confirm:
1. Zero TypeScript errors
2. MAConfig in compiled .d.ts has `color?: string` (optional) and `showType?: boolean`
3. CandlestickOptionProps in compiled .d.ts has `maValueArrays` and `resolvedMAColors` fields
4. BaseChartElement compiled .d.ts has `protected readChartToken(name: string): string`
</verification>

<success_criteria>
- MAConfig.color is optional (string | undefined) — existing configs with color still compile
- MAConfig.showType exists as optional boolean
- buildCandlestickOption uses resolvedMAColors[i] when provided (skips ma.color)
- buildCandlestickOption uses maValueArrays[i] when provided (skips O(n) compute)
- Legend names respect showType — "MA20 (EMA)" when showType: true, "MA20" otherwise
- readChartToken() is protected on BaseChartElement, delegates to _themeBridge.readToken()
- pnpm --filter @lit-ui/charts run build exits 0
</success_criteria>

<output>
After completion, create .planning/phases/99-incremental-moving-average-state-machine/99-02-SUMMARY.md
</output>
