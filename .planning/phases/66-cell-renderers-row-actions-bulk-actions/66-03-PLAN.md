---
phase: 66-cell-renderers-row-actions-bulk-actions
plan: 03
type: execute
wave: 3
depends_on: ["66-02"]
files_modified:
  - packages/data-table/src/data-table.ts
  - packages/data-table/src/bulk-actions.ts
  - packages/data-table/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Floating bulk actions toolbar appears when rows are selected and bulkActions are configured"
    - "Toolbar shows count of selected items (BULK-02)"
    - "Developer configures action buttons via bulkActions property (BULK-03)"
    - "Destructive bulk action with requiresConfirmation shows lui-dialog before executing (BULK-04)"
    - "Bulk actions dispatch ui-bulk-action event with selected row data (BULK-05)"
    - "Bulk toolbar replaces selection banner when bulkActions are configured"
    - "Clear selection button in toolbar deselects all rows"
    - "Dialog close event does not propagate to data table"
  artifacts:
    - path: "packages/data-table/src/bulk-actions.ts"
      provides: "Bulk actions toolbar template + confirmation dialog template + CSS styles"
      exports: ["renderBulkActionsToolbar", "renderConfirmationDialog", "bulkActionsStyles"]
    - path: "packages/data-table/src/data-table.ts"
      provides: "Bulk actions integration — properties, rendering, event handling"
      contains: "bulkActions"
    - path: "packages/data-table/src/index.ts"
      provides: "Bulk actions exports"
      contains: "bulk-actions"
  key_links:
    - from: "packages/data-table/src/data-table.ts"
      to: "packages/data-table/src/bulk-actions.ts"
      via: "import renderBulkActionsToolbar, bulkActionsStyles"
      pattern: "import.*renderBulkActionsToolbar.*bulk-actions"
    - from: "packages/data-table/src/data-table.ts"
      to: "ui-bulk-action event dispatch"
      via: "CustomEvent dispatch in dispatchBulkAction"
      pattern: "ui-bulk-action"
    - from: "packages/data-table/src/data-table.ts"
      to: "lui-dialog for confirmation"
      via: "Rendered in data-table shadow DOM"
      pattern: "lui-dialog"
---

<objective>
Add bulk actions support to the DataTable component — a floating toolbar with configurable actions that appears when rows are selected, with confirmation dialog for destructive actions.

Purpose: Fulfills BULK-01 through BULK-05. Completes Phase 66 by giving developers bulk operation capabilities on selected rows.

Output:
- `bulk-actions.ts` — standalone templates for bulk toolbar and confirmation dialog
- DataTable gains `bulkActions` property, `_pendingBulkAction` state, and `ui-bulk-action` event
- Bulk toolbar replaces selection banner when configured
- Confirmation dialog rendered in shadow DOM for destructive actions
- All bulk action exports added to index.ts
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md

@packages/data-table/src/data-table.ts
@packages/data-table/src/types.ts
@packages/data-table/src/index.ts

@.planning/phases/66-cell-renderers-row-actions-bulk-actions/66-02-SUMMARY.md
@.planning/phases/66-cell-renderers-row-actions-bulk-actions/66-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bulk-actions.ts module</name>
  <files>
    packages/data-table/src/bulk-actions.ts
  </files>
  <action>
Create `bulk-actions.ts` following the pattern from inline-editing.ts (standalone render functions + CSS styles).

**Imports:** `html, css, nothing, type TemplateResult` from 'lit', `type BulkAction` from './types.js'.

**renderBulkActionsToolbar function:**

```typescript
export function renderBulkActionsToolbar(
  selectedCount: number,
  bulkActions: BulkAction[],
  onAction: (action: BulkAction) => void,
  onClear: () => void,
  selectAllText?: string,
  onSelectAll?: () => void
): TemplateResult
```

Returns a toolbar div with:
- `class="bulk-actions-toolbar"`, `role="toolbar"`, `aria-label="Bulk actions"`
- Selected count: `<span class="bulk-actions-count">${selectedCount} selected</span>`
- Optional "Select all X items" link: if `selectAllText` and `onSelectAll` are provided, render a button similar to the existing selection banner link
- Action buttons from `bulkActions` array: `<button class="bulk-action-btn ${action.variant === 'destructive' ? 'destructive' : ''}">` with the action label and optional icon. Each button `@click` calls `onAction(action)`.
- Clear selection button: `<button class="bulk-action-clear" @click=${onClear}>Clear selection</button>` at the end

**renderConfirmationDialog function:**

```typescript
export function renderConfirmationDialog(
  action: BulkAction | null,
  selectedCount: number,
  onConfirm: () => void,
  onCancel: () => void
): TemplateResult
```

If `action` is null, return `nothing`.

Otherwise, render:
```html
<lui-dialog open size="sm" @close=${(e: Event) => { e.stopPropagation(); onCancel(); }}>
  <span slot="title">${action.confirmTitle ?? 'Confirm Action'}</span>
  <p>${resolveMessage(action.confirmMessage, selectedCount)}</p>
  <div slot="footer">
    <lui-button variant="outline" @click=${onCancel}>Cancel</lui-button>
    <lui-button variant="destructive" @click=${onConfirm}>
      ${action.confirmLabel ?? 'Confirm'}
    </lui-button>
  </div>
</lui-dialog>
```

Where `resolveMessage` is a helper:
```typescript
function resolveMessage(msg: string | ((count: number) => string) | undefined, count: number): string {
  if (typeof msg === 'function') return msg(count);
  return msg ?? `Are you sure? This will affect ${count} item${count !== 1 ? 's' : ''}.`;
}
```

**bulkActionsStyles:** Export a `css` tagged template:

- `.bulk-actions-toolbar`: `display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: var(--color-primary, #3b82f6); color: white; font-size: 14px; border-radius: 0;` — positioned between header and body (not sticky, just inline in the flow). This makes it visible and prominent.
- `.bulk-actions-count`: `font-weight: 600; margin-right: 8px;`
- `.bulk-action-btn`: `display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; background: transparent; color: white; cursor: pointer; font-size: 13px; font-weight: 500; transition: background 0.15s;`
- `.bulk-action-btn:hover`: `background: rgba(255,255,255,0.15);`
- `.bulk-action-btn.destructive`: `border-color: rgba(255,255,255,0.5);`
- `.bulk-action-btn.destructive:hover`: `background: rgba(255,255,255,0.2);`
- `.bulk-action-clear`: `margin-left: auto; padding: 4px 12px; border: none; background: transparent; color: rgba(255,255,255,0.8); cursor: pointer; font-size: 13px; text-decoration: underline;`
- `.bulk-action-clear:hover`: `color: white;`
- `.bulk-actions-select-all`: `padding: 4px 12px; border: none; background: transparent; color: rgba(255,255,255,0.9); cursor: pointer; font-size: 13px; text-decoration: underline;`
- Focus-visible styles for all buttons (white outline)
- Dark mode: toolbar may use a slightly different shade, or keep primary color (test both; primary color already works in dark mode since it's an accent)
  </action>
  <verify>
Run `npx tsc --noEmit --project packages/data-table/tsconfig.json` — should compile with no errors.
Verify bulk-actions.ts exports: renderBulkActionsToolbar, renderConfirmationDialog, bulkActionsStyles.
  </verify>
  <done>
bulk-actions.ts contains toolbar rendering with selected count, action buttons, clear selection, select-all link, and confirmation dialog with lui-dialog. All exported with CSS styles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate bulk actions into DataTable and update exports</name>
  <files>
    packages/data-table/src/data-table.ts
    packages/data-table/src/index.ts
  </files>
  <action>
**2a. Modify data-table.ts:**

**Add imports:**
- Import `renderBulkActionsToolbar, renderConfirmationDialog, bulkActionsStyles` from `'./bulk-actions.js'`
- Import `type BulkAction, type BulkActionEvent` from `'./types.js'` (add to existing import)

**Add properties** (after the row actions section):

```typescript
// ==========================================================================
// Bulk Actions (BULK-*)
// ==========================================================================

/**
 * Array of bulk actions for the toolbar.
 * When configured and rows are selected, a floating toolbar appears
 * above the table body with action buttons.
 */
@property({ type: Array })
bulkActions: BulkAction[] = [];

/**
 * Tracks a pending bulk action that requires confirmation dialog.
 * Non-null triggers the confirmation dialog to render.
 */
@state()
private _pendingBulkAction: BulkAction | null = null;
```

**Modify renderSelectionBanner:**

Update the existing `renderSelectionBanner` method to render the bulk actions toolbar INSTEAD of the simple banner when `bulkActions` is configured:

```typescript
private renderSelectionBanner(table: Table<TData>): TemplateResult {
  if (!this.enableSelection) return html``;

  const selectedCount = Object.keys(this.rowSelection).length;

  // Render bulk actions toolbar when configured and rows are selected
  if (this.bulkActions.length > 0 && selectedCount > 0) {
    const isAllPageSelected = table.getIsAllPageRowsSelected();
    const totalCount = this.totalRowCount ?? this.data.length;
    const showSelectAll = isAllPageSelected && selectedCount < totalCount;

    return renderBulkActionsToolbar(
      selectedCount,
      this.bulkActions,
      (action) => this.handleBulkAction(action),
      () => this.clearSelection(table),
      showSelectAll ? `Select all ${totalCount.toLocaleString()} items` : undefined,
      showSelectAll ? () => this.handleSelectAll(table, totalCount) : undefined
    );
  }

  // Fallback: existing selection banner (no bulk actions configured)
  const isAllPageSelected = table.getIsAllPageRowsSelected();
  const totalCount = this.totalRowCount ?? this.data.length;

  if (!isAllPageSelected || selectedCount >= totalCount) {
    return html``;
  }

  return html`
    <div class="selection-banner" role="status" aria-live="polite">
      <span class="selection-banner-text">
        ${selectedCount} items on this page selected.
      </span>
      <button
        type="button"
        class="selection-banner-link"
        @click=${() => this.handleSelectAll(table, totalCount)}
      >
        Select all ${totalCount.toLocaleString()} items
      </button>
    </div>
  `;
}
```

**Add clearSelection helper:**

```typescript
/**
 * Clear all row selection state.
 */
private clearSelection(table: Table<TData>): void {
  table.resetRowSelection();
}
```

**Add handleBulkAction method:**

```typescript
/**
 * Handle bulk action click.
 * If action requires confirmation, show dialog.
 * Otherwise dispatch event immediately.
 */
private handleBulkAction(action: BulkAction): void {
  if (action.requiresConfirmation) {
    this._pendingBulkAction = action;
    return;
  }
  this.dispatchBulkAction(action);
}
```

**Add dispatchBulkAction method:**

```typescript
/**
 * Dispatch ui-bulk-action event with selected row data.
 */
private dispatchBulkAction(action: BulkAction): void {
  const table = this._tableInstance;
  if (!table) return;

  const selectedRows = table
    .getSelectedRowModel()
    .rows.map((r) => r.original);

  const event = new CustomEvent<BulkActionEvent<TData>>('ui-bulk-action', {
    detail: {
      actionId: action.id,
      selectedRows,
      rowSelection: { ...this.rowSelection },
      selectedCount: selectedRows.length,
    },
    bubbles: true,
    composed: true,
  });
  this.dispatchEvent(event);
}
```

**Add confirmation dialog rendering in render():**

In the main `render()` method, after `${this.renderBody(table)}` and before the sr-only announcement div, add:

```typescript
${renderConfirmationDialog(
  this._pendingBulkAction,
  Object.keys(this.rowSelection).length,
  () => {
    this.dispatchBulkAction(this._pendingBulkAction!);
    this._pendingBulkAction = null;
  },
  () => {
    this._pendingBulkAction = null;
  }
)}
```

**Add bulkActionsStyles to static styles:**

Add `bulkActionsStyles` to the `static override styles` array (alongside the cellRendererStyles and rowActionsStyles that Plan 02 already added).

**2b. Update index.ts exports:**

Add after the row actions exports:

```typescript
// Bulk actions (toolbar + dialog templates)
export { renderBulkActionsToolbar, renderConfirmationDialog, bulkActionsStyles } from './bulk-actions.js';
```
  </action>
  <verify>
Run `npx tsc --noEmit --project packages/data-table/tsconfig.json` — should compile with no errors.
Verify DataTable has `bulkActions` property and `_pendingBulkAction` state.
Verify `renderSelectionBanner` renders bulk toolbar when bulkActions configured + rows selected.
Verify confirmation dialog renders when `_pendingBulkAction` is non-null.
Verify `ui-bulk-action` event dispatches with selectedRows, actionId, selectedCount.
Verify all bulk action exports present in index.ts.
  </verify>
  <done>
Bulk actions toolbar appears when rows are selected and bulkActions property is configured. Destructive actions trigger a confirmation dialog via lui-dialog. All events dispatch with complete selected row data. Bulk toolbar replaces selection banner. Clear selection button works. All exports in index.ts.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit --project packages/data-table/tsconfig.json` passes
2. DataTable with `bulkActions=[{ id: 'delete', label: 'Delete', variant: 'destructive', requiresConfirmation: true }]` shows toolbar when rows selected
3. Toolbar shows "3 selected" count, action buttons, and "Clear selection" link
4. Clicking destructive action opens lui-dialog confirmation
5. Confirming dispatches `ui-bulk-action` with selectedRows array
6. Canceling dialog dismisses without event
7. Dialog close event does not propagate (stopPropagation on @close)
8. When no bulkActions configured, existing selection banner behavior unchanged (backward compatible)
9. "Select all X items" link works in bulk toolbar when all page rows selected
10. All exports resolve from `@lit-ui/data-table`
</verification>

<success_criteria>
Bulk actions toolbar renders correctly with selected count and action buttons. Confirmation dialog prevents accidental destructive actions. Events carry complete selected row data. Selection banner gracefully degrades when bulkActions not configured. All module exports compile and resolve.
</success_criteria>

<output>
After completion, create `.planning/phases/66-cell-renderers-row-actions-bulk-actions/66-03-SUMMARY.md`
</output>
