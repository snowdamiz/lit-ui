---
phase: 22-cli-theme-integration
plan: 04
type: execute
wave: 3
depends_on: ["22-02", "22-03"]
files_modified:
  - packages/cli/tests/theme/cli-integration.test.ts
autonomous: true

must_haves:
  truths:
    - "CLI theme integration tests verify complete workflow"
    - "Tests cover init --theme, theme command, and error cases"
    - "All tests pass with pnpm test"
  artifacts:
    - path: "packages/cli/tests/theme/cli-integration.test.ts"
      provides: "CLI theme command integration tests"
      min_lines: 100
  key_links:
    - from: "packages/cli/tests/theme/cli-integration.test.ts"
      to: "packages/cli/src/utils/apply-theme.ts"
      via: "import applyTheme"
      pattern: "applyTheme"
    - from: "packages/cli/tests/theme/cli-integration.test.ts"
      to: "packages/cli/src/utils/detect-css-entry.ts"
      via: "import detectCssEntry"
      pattern: "detectCssEntry"
---

<objective>
Create integration tests verifying the complete CLI theme workflow from encoding to CSS generation to file output.

Purpose: Ensure the theme CLI integration works correctly before shipping, catching regressions and edge cases.

Output: Comprehensive test suite covering detectCssEntry, injectThemeImport, applyTheme, and error handling.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-cli-theme-integration/22-CONTEXT.md
@.planning/phases/22-cli-theme-integration/22-01-SUMMARY.md
@.planning/phases/22-cli-theme-integration/22-02-SUMMARY.md
@.planning/phases/22-cli-theme-integration/22-03-SUMMARY.md
@packages/cli/tests/theme/integration.test.ts
@packages/cli/src/utils/detect-css-entry.ts
@packages/cli/src/utils/inject-import.ts
@packages/cli/src/utils/apply-theme.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CLI theme integration tests</name>
  <files>packages/cli/tests/theme/cli-integration.test.ts</files>
  <action>
Create `cli-integration.test.ts` with comprehensive tests for the CLI theme utilities.

Use the established test patterns from `integration.test.ts` (vitest, describe/it blocks).

Test structure:

```typescript
import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { resolve, join } from 'pathe';
import fsExtra from 'fs-extra';
import { detectCssEntry } from '../../src/utils/detect-css-entry';
import { injectThemeImport } from '../../src/utils/inject-import';
import { encodeThemeConfig, defaultTheme } from '../../src/theme/index';

const { ensureDir, writeFile, readFile, remove, pathExists } = fsExtra;

// Test fixtures directory
const FIXTURES_DIR = resolve(__dirname, '../fixtures/cli-theme');

describe('CLI Theme Integration', () => {
  beforeEach(async () => {
    // Create fresh fixtures directory
    await ensureDir(FIXTURES_DIR);
  });

  afterEach(async () => {
    // Clean up fixtures
    await remove(FIXTURES_DIR);
  });

  describe('detectCssEntry', () => {
    it('detects Next.js App Router globals.css', async () => {
      // Create src/app/globals.css with Tailwind import
      const cssPath = join(FIXTURES_DIR, 'src/app/globals.css');
      await ensureDir(join(FIXTURES_DIR, 'src/app'));
      await writeFile(cssPath, '@import "tailwindcss";\n');

      const result = await detectCssEntry(FIXTURES_DIR);
      expect(result).toBe('src/app/globals.css');
    });

    it('detects Vite src/index.css', async () => {
      const cssPath = join(FIXTURES_DIR, 'src/index.css');
      await ensureDir(join(FIXTURES_DIR, 'src'));
      await writeFile(cssPath, "@import 'tailwindcss';\n");

      const result = await detectCssEntry(FIXTURES_DIR);
      expect(result).toBe('src/index.css');
    });

    it('returns null when no CSS entry found', async () => {
      const result = await detectCssEntry(FIXTURES_DIR);
      expect(result).toBeNull();
    });

    it('ignores CSS files without Tailwind import', async () => {
      const cssPath = join(FIXTURES_DIR, 'src/index.css');
      await ensureDir(join(FIXTURES_DIR, 'src'));
      await writeFile(cssPath, 'body { margin: 0; }\n');

      const result = await detectCssEntry(FIXTURES_DIR);
      expect(result).toBeNull();
    });

    it('detects @tailwind base syntax', async () => {
      const cssPath = join(FIXTURES_DIR, 'src/index.css');
      await ensureDir(join(FIXTURES_DIR, 'src'));
      await writeFile(cssPath, '@tailwind base;\n@tailwind components;\n');

      const result = await detectCssEntry(FIXTURES_DIR);
      expect(result).toBe('src/index.css');
    });
  });

  describe('injectThemeImport', () => {
    it('injects import into detected CSS file', async () => {
      // Create CSS entry and theme file
      const cssPath = join(FIXTURES_DIR, 'src/index.css');
      await ensureDir(join(FIXTURES_DIR, 'src'));
      await writeFile(cssPath, '@import "tailwindcss";\n\nbody { margin: 0; }');
      await writeFile(join(FIXTURES_DIR, 'lit-ui-theme.css'), ':root { }');

      await injectThemeImport(FIXTURES_DIR);

      const content = await readFile(cssPath, 'utf-8');
      expect(content).toContain('lit-ui-theme.css');
      expect(content).toContain('@import "tailwindcss"');
    });

    it('calculates correct relative path from nested CSS', async () => {
      // CSS file in nested directory
      const cssPath = join(FIXTURES_DIR, 'src/styles/main.css');
      await ensureDir(join(FIXTURES_DIR, 'src/styles'));
      await writeFile(cssPath, '@import "tailwindcss";');
      await writeFile(join(FIXTURES_DIR, 'lit-ui-theme.css'), ':root { }');

      await injectThemeImport(FIXTURES_DIR);

      const content = await readFile(cssPath, 'utf-8');
      // Should have ../../lit-ui-theme.css (go up from src/styles to root)
      expect(content).toContain('../../lit-ui-theme.css');
    });

    it('is idempotent - does not duplicate import', async () => {
      const cssPath = join(FIXTURES_DIR, 'src/index.css');
      await ensureDir(join(FIXTURES_DIR, 'src'));
      await writeFile(cssPath, "@import 'tailwindcss';\n@import '../lit-ui-theme.css';");

      await injectThemeImport(FIXTURES_DIR);
      await injectThemeImport(FIXTURES_DIR);

      const content = await readFile(cssPath, 'utf-8');
      const matches = content.match(/lit-ui-theme\.css/g);
      expect(matches).toHaveLength(1);
    });

    it('inserts after existing @import lines', async () => {
      const cssPath = join(FIXTURES_DIR, 'src/index.css');
      await ensureDir(join(FIXTURES_DIR, 'src'));
      await writeFile(cssPath, "@import 'tailwindcss';\n@import 'custom.css';\n\n:root { }");

      await injectThemeImport(FIXTURES_DIR);

      const content = await readFile(cssPath, 'utf-8');
      const lines = content.split('\n');
      const tailwindIndex = lines.findIndex(l => l.includes('tailwindcss'));
      const themeIndex = lines.findIndex(l => l.includes('lit-ui-theme'));
      const rootIndex = lines.findIndex(l => l.includes(':root'));

      expect(themeIndex).toBeGreaterThan(tailwindIndex);
      expect(themeIndex).toBeLessThan(rootIndex);
    });
  });

  describe('Theme file generation', () => {
    it('writes theme CSS file to project root', async () => {
      // This test verifies the file writing aspect
      // We test applyTheme behavior indirectly through file existence
      const themePath = join(FIXTURES_DIR, 'lit-ui-theme.css');

      // Manually write what applyTheme would write
      const { generateThemeCSS } = await import('../../src/theme/index');
      const css = generateThemeCSS(defaultTheme);
      await writeFile(themePath, css);

      expect(await pathExists(themePath)).toBe(true);
      const content = await readFile(themePath, 'utf-8');
      expect(content).toContain('--lui-');
      expect(content).toContain(':root');
    });
  });

  describe('Encoding round-trip', () => {
    it('encoded theme produces valid CSS', async () => {
      const { decodeThemeConfig, generateThemeCSS } = await import('../../src/theme/index');
      const encoded = encodeThemeConfig(defaultTheme);
      const decoded = decodeThemeConfig(encoded);
      const css = generateThemeCSS(decoded);

      expect(css).toContain(':root');
      expect(css).toContain('.dark');
      expect(css).toContain('--lui-primary');
    });
  });
});
```

Adjust paths and imports as needed based on the actual test file structure. Follow existing test patterns from `integration.test.ts`.
  </action>
  <verify>Run tests: `cd packages/cli && pnpm test`</verify>
  <done>All CLI theme integration tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Verify complete test suite passes</name>
  <files>packages/cli/tests/theme/cli-integration.test.ts</files>
  <action>
Run the complete test suite to verify:
1. All new CLI theme tests pass
2. All existing theme tests (103 from Phase 21) still pass
3. No regressions introduced

Execute: `cd packages/cli && pnpm test`

If any tests fail, diagnose and fix the issues. Common issues:
- Path resolution differences (use resolve from pathe)
- Async timing issues (ensure proper await)
- File cleanup between tests (use beforeEach/afterEach)

The test suite should report all tests passing with no errors.
  </action>
  <verify>Run tests: `cd packages/cli && pnpm test` shows all tests passing</verify>
  <done>Complete test suite passes including new CLI theme tests and existing 103 theme tests</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `cd packages/cli && pnpm test` passes all tests
2. Test coverage includes detectCssEntry, injectThemeImport, and encoding round-trip
3. No regressions in existing theme tests
4. Build succeeds: `cd packages/cli && pnpm build`
</verification>

<success_criteria>
- CLI theme integration test file exists with 10+ test cases
- All tests pass including existing 103 theme tests
- Tests cover CSS entry detection, import injection, and encoding round-trip
- Test fixtures are properly cleaned up after each test
</success_criteria>

<output>
After completion, create `.planning/phases/22-cli-theme-integration/22-04-SUMMARY.md`
</output>
