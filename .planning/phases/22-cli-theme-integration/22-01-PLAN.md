---
phase: 22-cli-theme-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/cli/src/utils/detect-css-entry.ts
  - packages/cli/src/utils/inject-import.ts
  - packages/cli/src/utils/apply-theme.ts
autonomous: true

must_haves:
  truths:
    - "CSS entry file detection finds Tailwind entry files in common locations"
    - "Import injection adds theme import without duplicating"
    - "Theme application writes CSS file and injects import"
  artifacts:
    - path: "packages/cli/src/utils/detect-css-entry.ts"
      provides: "CSS entry file detection utility"
      exports: ["detectCssEntry"]
    - path: "packages/cli/src/utils/inject-import.ts"
      provides: "CSS import injection utility"
      exports: ["injectThemeImport"]
    - path: "packages/cli/src/utils/apply-theme.ts"
      provides: "Shared theme application logic"
      exports: ["applyTheme"]
  key_links:
    - from: "packages/cli/src/utils/apply-theme.ts"
      to: "packages/cli/src/theme/index.ts"
      via: "import decodeThemeConfig, generateThemeCSS"
      pattern: "import.*from.*theme"
    - from: "packages/cli/src/utils/apply-theme.ts"
      to: "packages/cli/src/utils/inject-import.ts"
      via: "import injectThemeImport"
      pattern: "injectThemeImport"
---

<objective>
Create shared utilities for theme CSS entry detection, import injection, and theme application.

Purpose: These utilities are used by both `lit-ui init --theme` and `lit-ui theme` commands, avoiding code duplication and ensuring consistent behavior.

Output: Three utility modules that handle the theme application pipeline from decoding to CSS file generation to import injection.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-cli-theme-integration/22-CONTEXT.md
@.planning/phases/22-cli-theme-integration/22-RESEARCH.md
@packages/cli/src/theme/index.ts
@packages/cli/src/utils/logger.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSS entry file detection utility</name>
  <files>packages/cli/src/utils/detect-css-entry.ts</files>
  <action>
Create `detect-css-entry.ts` with `detectCssEntry(cwd: string): Promise<string | null>` function.

Requirements:
1. Check CSS file candidates in order of likelihood:
   - `src/app/globals.css` (Next.js App Router)
   - `app/globals.css` (Next.js without src)
   - `src/index.css` (Vite default)
   - `src/styles/index.css`
   - `src/main.css`
   - `src/styles/main.css`
   - `src/styles/globals.css`
   - `styles/globals.css`
   - `src/styles/tailwind.css`
   - `src/tailwind.css`

2. For each candidate:
   - Check if file exists using fs-extra pathExists
   - Read content and verify it looks like Tailwind entry (contains `@import "tailwindcss"` or `@import 'tailwindcss'` or `@tailwind base`)
   - Return relative path on first match

3. Return null if no suitable file found

Use pathe for path operations (already used in CLI). Use fs-extra for file operations (already used in CLI).
  </action>
  <verify>TypeScript compiles without errors: `cd packages/cli && pnpm tsc --noEmit`</verify>
  <done>detectCssEntry function exists and checks all candidate locations with Tailwind content verification</done>
</task>

<task type="auto">
  <name>Task 2: Create CSS import injection utility</name>
  <files>packages/cli/src/utils/inject-import.ts</files>
  <action>
Create `inject-import.ts` with `injectThemeImport(cwd: string): Promise<void>` function.

Requirements:
1. Import and call `detectCssEntry(cwd)` to find CSS entry file
2. If no CSS entry found:
   - Call `warn()` with "Could not detect main CSS file."
   - Call `info()` with manual instructions: "Manually add to your CSS: @import 'lit-ui-theme.css';"
   - Return (don't error)

3. If CSS entry found:
   - Read file content
   - Check idempotency: if content already includes `lit-ui-theme.css`, call `info()` and return early
   - Calculate relative path from CSS entry file location to `lit-ui-theme.css` in project root using `pathe.relative(dirname(cssPath), themePath)`
   - Build import statement: `@import '${relativePath}';`
   - Find insertion point after any `@charset` or existing `@import` lines but before other content
   - Insert the import line
   - Write updated content back to file
   - Call `success()` with "Added theme import to {cssEntry}"

Use logger utilities from `../utils/logger` for success, warn, info, file formatting.
  </action>
  <verify>TypeScript compiles without errors: `cd packages/cli && pnpm tsc --noEmit`</verify>
  <done>injectThemeImport function handles detection, idempotency, relative path calculation, and proper import placement</done>
</task>

<task type="auto">
  <name>Task 3: Create shared theme application utility</name>
  <files>packages/cli/src/utils/apply-theme.ts</files>
  <action>
Create `apply-theme.ts` with `applyTheme(cwd: string, encoded: string, options: { yes?: boolean }): Promise<void>` function.

Requirements:
1. Define constants:
   - `THEME_FILE = 'lit-ui-theme.css'`
   - `CONFIGURATOR_URL = 'https://lit-ui.dev/themes'`

2. Check for existing theme file:
   - If exists and NOT options.yes and process.stdout.isTTY:
     - Prompt with consola.prompt: "Theme exists. Replace?" (type: confirm, initial: false)
     - If user declines, call `info('Theme unchanged.')` and return
   - If exists and (options.yes OR !isTTY):
     - With options.yes: proceed silently to replace
     - Without options.yes and non-TTY: call `info('Theme exists. Use interactive mode to replace.')` and return

3. Decode and validate theme:
   - Import `decodeThemeConfig` from `../theme/index.js`
   - Wrap in try/catch
   - On error: call `error('Invalid theme. Generate a new one from the configurator.')`, call `info(CONFIGURATOR_URL)`, call `process.exit(1)`

4. Generate CSS:
   - Import `generateThemeCSS` from `../theme/index.js`
   - Call `generateThemeCSS(config)` to get CSS string

5. Write theme file:
   - Write CSS to `resolve(cwd, THEME_FILE)` using fs-extra writeFile
   - Call `success('Theme applied.')`

6. Inject import:
   - Call `injectThemeImport(cwd)` from `./inject-import.js`
   - (This function handles its own warnings if detection fails)

Import consola for prompts, fs-extra for file operations, pathe for paths.
  </action>
  <verify>TypeScript compiles without errors: `cd packages/cli && pnpm tsc --noEmit`</verify>
  <done>applyTheme function handles existing file prompts, theme decoding with friendly errors, CSS generation, and import injection</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. All three utility files exist in packages/cli/src/utils/
2. TypeScript compilation succeeds: `cd packages/cli && pnpm tsc --noEmit`
3. No circular dependencies between utilities
</verification>

<success_criteria>
- detectCssEntry finds CSS files in standard project locations
- injectThemeImport adds imports idempotently with correct relative paths
- applyTheme provides complete theme application flow with user-friendly prompts and errors
- All utilities properly import from theme module and use established logger patterns
</success_criteria>

<output>
After completion, create `.planning/phases/22-cli-theme-integration/22-01-SUMMARY.md`
</output>
