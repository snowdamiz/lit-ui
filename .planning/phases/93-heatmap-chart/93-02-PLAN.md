---
phase: 93-heatmap-chart
plan: 02
type: execute
wave: 2
depends_on:
  - 93-01
files_modified:
  - packages/charts/src/heatmap/heatmap-chart.ts
  - packages/charts/src/index.ts
autonomous: true
requirements:
  - HEAT-01
  - HEAT-02

must_haves:
  truths:
    - "Developer can pass xCategories, yCategories, and data to lui-heatmap-chart and see a color-coded cell matrix with the VisualMap legend"
    - "Developer can set color-range='#minColor,#maxColor' attribute and see the VisualMap color scale update"
    - "Developer can call pushData([xIdx, yIdx, value]) and see only that specific cell update — other cells are preserved"
    - "Multiple pushData() calls in the same animation frame are coalesced into one setOption call"
    - "LuiHeatmapChart, HeatmapCell, and HeatmapOptionProps are importable from @lit-ui/charts"
  artifacts:
    - path: "packages/charts/src/heatmap/heatmap-chart.ts"
      provides: "LuiHeatmapChart Lit custom element (lui-heatmap-chart)"
      exports: ["LuiHeatmapChart"]
    - path: "packages/charts/src/index.ts"
      provides: "Phase 93 public API exports"
      contains: "LuiHeatmapChart"
  key_links:
    - from: "packages/charts/src/heatmap/heatmap-chart.ts"
      to: "packages/charts/src/heatmap/heatmap-registry.ts"
      via: "_registerModules() calling registerHeatmapModules()"
      pattern: "registerHeatmapModules"
    - from: "packages/charts/src/heatmap/heatmap-chart.ts"
      to: "packages/charts/src/shared/heatmap-option-builder.ts"
      via: "_applyData() calling buildHeatmapOption()"
      pattern: "buildHeatmapOption"
    - from: "LuiHeatmapChart.pushData()"
      to: "this._cellData"
      via: "_pendingCells Map + RAF coalescing in _flushCellUpdates()"
      pattern: "_pendingCells\\.set.*_cellRafId"
    - from: "packages/charts/src/index.ts"
      to: "packages/charts/src/heatmap/heatmap-chart.ts"
      via: "Phase 93 export section"
      pattern: "LuiHeatmapChart.*heatmap-chart"
---

<objective>
Create LuiHeatmapChart Lit custom element with cell-update streaming semantics and add Phase 93 public API exports to index.ts.

Purpose: The component wires together Plan 01's foundations (heatmap-registry + heatmap-option-builder) with BaseChartElement lifecycle. The pushData() override provides correct cell-update semantics — updating a specific [xIdx, yIdx] cell without overwriting the rest of the matrix.
Output: heatmap-chart.ts (LuiHeatmapChart) + index.ts updated with Phase 93 exports.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/93-heatmap-chart/93-RESEARCH.md
@.planning/phases/93-heatmap-chart/93-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->
<!-- Executor should use these directly — no codebase exploration needed. -->

From packages/charts/src/base/base-chart-element.ts:
```typescript
export abstract class BaseChartElement extends TailwindElement {
  @property({ type: Boolean }) loading = false;
  @property({ type: Boolean, attribute: 'enable-gl' }) enableGl = false;
  @property({ type: Number }) maxPoints = 1000;
  @property({ attribute: false }) data: unknown = null;
  @property() option: EChartsCoreOption | null = null;
  protected _chart: EChartsType | null = null;
  protected _streamingMode: 'appendData' | 'buffer' = 'buffer';
  protected _webglUnavailable: boolean;   // readable by subclasses
  // pushData() is public + overridable — heatmap MUST override this
  pushData(point: unknown): void;
  // _flushPendingData() is private — CANNOT be overridden; do not call
  protected abstract _registerModules(): Promise<void>;
  override disconnectedCallback(): void;  // calls super; base cancels its own _rafId
  override updated(changed: PropertyValues): void;
}
```

From packages/charts/src/heatmap/heatmap-option-builder.ts (created in Plan 01):
```typescript
export type HeatmapCell = [number, number, number]; // [xIdx, yIdx, value]
export type HeatmapOptionProps = {
  xCategories: string[];
  yCategories: string[];
  colorRange?: [string, string];
  min?: number;
  max?: number;
};
export function buildHeatmapOption(data: HeatmapCell[], props: HeatmapOptionProps): Record<string, unknown>;
```

From packages/charts/src/heatmap/heatmap-registry.ts (created in Plan 01):
```typescript
export async function registerHeatmapModules(): Promise<void>;
```

From packages/charts/src/pie/pie-chart.ts (mirror this structure):
```typescript
export class LuiPieChart extends BaseChartElement {
  @property({ type: Number, attribute: 'min-percent' }) minPercent = 0;
  @property({ attribute: 'inner-radius' }) innerRadius: string | number = 0;
  @property({ attribute: 'center-label' }) centerLabel = '';
  protected override async _registerModules(): Promise<void> { await registerPieModules(); }
  override updated(changed: PropertyValues): void {
    super.updated(changed);
    if (!this._chart) return;
    const pieProps = ['data', 'minPercent', 'innerRadius', 'centerLabel'] as const;
    if (pieProps.some((k) => changed.has(k))) { this._applyData(); }
  }
  private _applyData(): void { ... }
}
if (typeof customElements !== 'undefined' && !customElements.get('lui-pie-chart')) {
  customElements.define('lui-pie-chart', LuiPieChart);
}
declare global { interface HTMLElementTagNameMap { 'lui-pie-chart': LuiPieChart; } }
```

From packages/charts/src/index.ts (append after line 25 — Phase 92 exports):
```typescript
// Phase 92: Scatter + Bubble Chart
export { LuiScatterChart } from './scatter/scatter-chart.js';
export type { ScatterPoint, ScatterOptionProps } from './shared/scatter-option-builder.js';
// ADD Phase 93 exports below this line
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create heatmap-chart.ts (LuiHeatmapChart with pushData cell-update override)</name>
  <files>packages/charts/src/heatmap/heatmap-chart.ts</files>
  <action>
Create `packages/charts/src/heatmap/heatmap-chart.ts` implementing LuiHeatmapChart:

**Class structure:**
```typescript
import { property } from 'lit/decorators.js';
import type { PropertyValues } from 'lit';
import { BaseChartElement } from '../base/base-chart-element.js';
import { registerHeatmapModules } from './heatmap-registry.js';
import { buildHeatmapOption, type HeatmapCell } from '../shared/heatmap-option-builder.js';

export class LuiHeatmapChart extends BaseChartElement {
  // HEAT-01: Category arrays — attribute: false (arrays cannot be safely serialized as HTML attributes;
  // project convention per REQUIREMENTS.md Out of Scope: "data='[...]' attribute serialization").
  // Developers MUST set these via JavaScript property assignment.
  @property({ attribute: false }) xCategories: string[] = [];
  @property({ attribute: false }) yCategories: string[] = [];

  // HEAT-01: Color range — arrives as raw string from HTML (e.g., '#313695,#d73027').
  // No type converter — mirrors innerRadius pattern from LuiPieChart (Phase 91 decision).
  // Parsed in _applyData() via _parseColorRange().
  @property({ attribute: 'color-range' }) colorRange: string | null = null;

  // Component-level authoritative cell matrix — kept in sync with this.data.
  // pushData() updates cells in-place via _pendingCells Map.
  private _cellData: HeatmapCell[] = [];
  // Pending cell updates: key = "xIdx,yIdx", value = new numeric value.
  // Last write within same RAF frame wins — deduplicates rapid updates to the same cell.
  private _pendingCells = new Map<string, number>();
  // Component's own RAF handle — must be cancelled in disconnectedCallback() (Pitfall 3).
  // The BASE CLASS cancels its own _rafId but has no knowledge of _cellRafId.
  private _cellRafId?: number;
  ...
}
```

**_registerModules():**
```typescript
protected override async _registerModules(): Promise<void> {
  await registerHeatmapModules();
}
```

**updated():**
Watch `['data', 'xCategories', 'yCategories', 'colorRange']`. Call `super.updated(changed)` first. If any watched key changed and `this._chart` exists, call `_applyData()`.

**_applyData():**
```typescript
private _applyData(): void {
  if (!this._chart) return;
  // Sync _cellData from this.data so pushData() cell lookups start from current state.
  this._cellData = this.data ? [...(this.data as HeatmapCell[])] : [];
  const parsed = _parseColorRange(this.colorRange);
  const option = buildHeatmapOption(this._cellData, {
    xCategories: this.xCategories,
    yCategories: this.yCategories,
    colorRange: parsed,
  });
  // notMerge: false — merge with any option prop overrides from the base class.
  // NEVER use notMerge: true — it wipes the VisualMap component on each data update.
  this._chart.setOption(option, { notMerge: false });
}
```

**pushData() override (HEAT-02 — cell-update semantics):**
```typescript
override pushData(point: unknown): void {
  // Override base implementation — heatmap uses cell-update semantics, not rolling buffer.
  // NEVER call super.pushData() — it would add point to _circularBuffer and call
  // setOption({ series: [{ data: circularBuffer }] }) on RAF flush, overwriting _cellData
  // with only the streaming points. See RESEARCH.md Pitfall 2.
  const [xi, yi, val] = point as HeatmapCell;
  // Last write for a given [xi,yi] key in same RAF frame wins.
  this._pendingCells.set(`${xi},${yi}`, val);
  if (this._cellRafId === undefined) {
    this._cellRafId = requestAnimationFrame(() => {
      this._flushCellUpdates();
      this._cellRafId = undefined;
    });
  }
}
```

**_flushCellUpdates() (private):**
```typescript
private _flushCellUpdates(): void {
  if (!this._chart || this._pendingCells.size === 0) return;
  for (const [key, val] of this._pendingCells) {
    const [xi, yi] = key.split(',').map(Number);
    const idx = this._cellData.findIndex((c) => c[0] === xi && c[1] === yi);
    if (idx >= 0) {
      this._cellData[idx] = [xi, yi, val]; // update existing cell in-place
    } else {
      this._cellData.push([xi, yi, val]); // add new cell
    }
  }
  this._pendingCells.clear();
  // Flush full _cellData — not just pending cells — so ECharts has the complete matrix.
  this._chart.setOption(
    { series: [{ data: this._cellData }] },
    { lazyUpdate: true } as object
  );
}
```

**disconnectedCallback() override:**
```typescript
override disconnectedCallback(): void {
  // Cancel component's own RAF before base class disposes the chart.
  // Base class cancels its own _rafId but has no knowledge of _cellRafId.
  // Failing to cancel causes post-disposal setOption errors (RESEARCH.md Pitfall 3).
  if (this._cellRafId !== undefined) {
    cancelAnimationFrame(this._cellRafId);
    this._cellRafId = undefined;
  }
  super.disconnectedCallback();
}
```

**_parseColorRange() module-level helper (NOT exported):**
```typescript
function _parseColorRange(raw: string | null): [string, string] | undefined {
  if (!raw) return undefined;
  const parts = raw.split(',').map((s) => s.trim());
  if (parts.length >= 2) return [parts[0], parts[1]];
  return undefined;
}
```

**Custom element registration (end of file):**
```typescript
if (typeof customElements !== 'undefined' && !customElements.get('lui-heatmap-chart')) {
  customElements.define('lui-heatmap-chart', LuiHeatmapChart);
}

declare global {
  interface HTMLElementTagNameMap {
    'lui-heatmap-chart': LuiHeatmapChart;
  }
}
```

**Critical invariants:**
- NO `_streamingMode` override — base `'buffer'` default is fine; but `pushData()` is overridden entirely, so the base streaming path is bypassed for heatmap
- `disconnectedCallback()` MUST cancel `_cellRafId` BEFORE calling `super.disconnectedCallback()` (which disposes the chart)
- `_applyData()` MUST resync `_cellData` from `this.data` on each call to keep the authoritative matrix fresh for subsequent `pushData()` calls
- `setOption({ notMerge: false })` in `_applyData()` — NOT `notMerge: true` which wipes VisualMap
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components && pnpm --filter @lit-ui/charts exec tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>heatmap-chart.ts exists, LuiHeatmapChart extends BaseChartElement, customElements.define('lui-heatmap-chart') present, TypeScript compiles with zero errors</done>
</task>

<task type="auto">
  <name>Task 2: Add Phase 93 exports to index.ts and verify full build</name>
  <files>packages/charts/src/index.ts</files>
  <action>
Append Phase 93 exports to `packages/charts/src/index.ts` after the existing Phase 92 exports section.

The current end of index.ts (Phase 92 section):
```typescript
// Phase 92: Scatter + Bubble Chart
export { LuiScatterChart } from './scatter/scatter-chart.js';
export type { ScatterPoint, ScatterOptionProps } from './shared/scatter-option-builder.js';
```

Append after it:
```typescript
// Phase 93: Heatmap Chart
export { LuiHeatmapChart } from './heatmap/heatmap-chart.js';
export type { HeatmapCell, HeatmapOptionProps } from './shared/heatmap-option-builder.js';
```

Then verify the full build passes:
```bash
pnpm --filter @lit-ui/charts run build
```

Check dist/index.d.ts to confirm all three Phase 93 declarations are present:
- `LuiHeatmapChart` class declaration
- `HeatmapCell` type declaration
- `HeatmapOptionProps` type declaration
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components && pnpm --filter @lit-ui/charts run build 2>&1 | tail -10</automated>
  </verify>
  <done>index.ts exports LuiHeatmapChart + HeatmapCell + HeatmapOptionProps, full build passes with zero errors, dist/index.d.ts contains all three Phase 93 declarations</done>
</task>

</tasks>

<verification>
After both tasks:
1. `pnpm --filter @lit-ui/charts run build` — zero errors, dist/ updated
2. `grep -n "LuiHeatmapChart\|HeatmapCell\|HeatmapOptionProps" packages/charts/dist/index.d.ts` — all three found
3. `grep "pushData\|_cellRafId\|_pendingCells\|_cellData" packages/charts/src/heatmap/heatmap-chart.ts` — all streaming fields present
4. `grep "cancelAnimationFrame\|disconnectedCallback" packages/charts/src/heatmap/heatmap-chart.ts` — RAF cleanup in disconnectedCallback confirmed
5. `grep "notMerge: false" packages/charts/src/heatmap/heatmap-chart.ts` — correct merge mode in _applyData()
</verification>

<success_criteria>
- LuiHeatmapChart registers as lui-heatmap-chart custom element
- xCategories, yCategories declared with attribute: false (JS property only)
- colorRange declared with attribute: 'color-range' (string | null, no type converter)
- pushData() overrides base — does NOT call super.pushData(), uses _pendingCells + _cellRafId RAF coalescing
- disconnectedCallback() cancels _cellRafId before super.disconnectedCallback()
- _applyData() syncs _cellData from this.data and uses notMerge: false
- Full build passes: pnpm --filter @lit-ui/charts run build
- dist/index.d.ts contains LuiHeatmapChart, HeatmapCell, HeatmapOptionProps
</success_criteria>

<output>
After completion, create `.planning/phases/93-heatmap-chart/93-02-SUMMARY.md`
</output>
