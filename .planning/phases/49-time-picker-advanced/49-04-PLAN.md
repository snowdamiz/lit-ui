---
phase: 49-time-picker-advanced
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/time-picker/src/time-scroll-wheel.ts
autonomous: true

must_haves:
  truths:
    - "User can scroll through hour and minute columns to select time (iOS-style wheel)"
    - "Scroll snapping centers the selected value in a highlighted row"
    - "Non-visible items above and below the highlight fade out with opacity gradient"
    - "Component detects scrollend to read final selected value (with debounce fallback)"
    - "AM/PM column appears when hour12 mode is active"
  artifacts:
    - path: "packages/time-picker/src/time-scroll-wheel.ts"
      provides: "iOS-style scroll wheel time picker component"
      contains: "TimeScrollWheel"
  key_links:
    - from: "packages/time-picker/src/time-scroll-wheel.ts"
      to: "CSS scroll-snap"
      via: "scroll-snap-type: y mandatory on wheel containers"
      pattern: "scroll-snap-type"
---

<objective>
Create an iOS-style scroll wheel time picker using CSS scroll-snap for mobile-friendly time selection.

Purpose: Fulfills TP-21 (mobile scrolling wheels). Internal component composed by TimePicker when `interface-mode="wheel"` (wired in Plan 06).
Output: New time-scroll-wheel.ts component with hour, minute, and optional AM/PM scroll columns.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/49-time-picker-advanced/49-RESEARCH.md
@packages/time-picker/src/time-utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TimeScrollWheel component with CSS scroll-snap columns</name>
  <files>packages/time-picker/src/time-scroll-wheel.ts</files>
  <action>
Create `lui-time-scroll-wheel` internal component with three scroll columns (hour, minute, optional AM/PM).

1. Import from Lit and @lit-ui/core. Import `TimeValue, to12Hour, to24Hour` from `./time-utils.js`.

2. Define `TimeScrollWheel` extending `TailwindElement`:

   **Constants at module level:**
   ```typescript
   const ITEM_HEIGHT = 40; // px per wheel item
   const VISIBLE_ITEMS = 5; // number of visible items in each column
   const SCROLL_DEBOUNCE = 200; // ms fallback for scrollend
   ```

   **Properties:**
   - `@property({ attribute: false }) value: TimeValue | null = null;`
   - `@property({ type: Boolean }) hour12 = false;`
   - `@property({ type: Number }) step = 1;` -- minute step
   - `@property({ type: Boolean, reflect: true }) disabled = false;`

   **Internal state:**
   - `@state() private _selectedHour = 0;`
   - `@state() private _selectedMinute = 0;`
   - `@state() private _selectedPeriod: 'AM' | 'PM' = 'AM';`
   - Private `_scrollTimers: Map<string, number>` for debounce fallback.

   **Lifecycle:**
   - `updated()`: When `value` changes, sync `_selectedHour`, `_selectedMinute`, `_selectedPeriod` from value, and scroll each column to the selected position using `scrollTop = index * ITEM_HEIGHT`.

   **Private method `_getHourItems(): Array<{ value: number; label: string }>`:**
   - If hour12: 1-12, labels "1"-"12"
   - If !hour12: 0-23, labels "00"-"23" (zero-padded)

   **Private method `_getMinuteItems(): Array<{ value: number; label: string }>`:**
   - For i = 0; i < 60; i += step: `{ value: i, label: String(i).padStart(2, '0') }`

   **Private method `_handleScrollEnd(column: 'hour' | 'minute' | 'period', e: Event)`:**
   - Get scroll container from event target.
   - Calculate selected index: `Math.round(scrollTop / ITEM_HEIGHT)`.
   - Clamp to valid range.
   - Update `_selectedHour`, `_selectedMinute`, or `_selectedPeriod`.
   - Call `_emitChange()`.

   **Private method `_handleScroll(column: string, e: Event)`:**
   - Feature-detect `scrollend`: `if ('onscrollend' in window) return;` (scrollend handler will fire)
   - Otherwise debounce: clear existing timer for column, set new 200ms timeout calling `_handleScrollEnd`.

   **Private method `_emitChange()`:**
   - Build TimeValue from selected values. If hour12, convert via to24Hour.
   - Dispatch `ui-scroll-wheel-change` with `{ value: TimeValue }`.

   **Private method `_renderColumn(items, column, selectedValue)`:**
   ```html
   <div class="wheel-column">
     <div
       class="wheel-container"
       @scrollend=${(e: Event) => this._handleScrollEnd(column, e)}
       @scroll=${(e: Event) => this._handleScroll(column, e)}
     >
       ${this._renderPadding()}
       ${items.map((item, i) => html`
         <div
           class="wheel-item ${item.value === selectedValue ? 'selected' : ''}"
           data-value=${item.value}
         >${item.label}</div>
       `)}
       ${this._renderPadding()}
     </div>
   </div>
   ```

   **Private method `_renderPadding()`:**
   - Render 2 empty div.wheel-item elements (padding above/below so first/last items can center).

   **Render:**
   ```html
   <div class="scroll-wheel-wrapper" role="group" aria-label="Select time">
     <div class="wheel-highlight" aria-hidden="true"></div>
     ${this._renderColumn(this._getHourItems(), 'hour', this._selectedHour)}
     <span class="wheel-separator" aria-hidden="true">:</span>
     ${this._renderColumn(this._getMinuteItems(), 'minute', this._selectedMinute)}
     ${this.hour12 ? this._renderColumn(
       [{ value: 0, label: 'AM' }, { value: 1, label: 'PM' }],
       'period',
       this._selectedPeriod === 'AM' ? 0 : 1
     ) : nothing}
   </div>
   ```

   **CSS styles:**
   ```css
   :host { display: block; }

   .scroll-wheel-wrapper {
     display: flex;
     align-items: center;
     justify-content: center;
     position: relative;
     gap: 0.25rem;
   }

   .wheel-column {
     position: relative;
     width: 60px;
   }

   .wheel-container {
     height: calc(${VISIBLE_ITEMS} * ${ITEM_HEIGHT}px); /* 200px */
     overflow-y: auto;
     scroll-snap-type: y mandatory;
     -ms-overflow-style: none;
     scrollbar-width: none;
   }

   .wheel-container::-webkit-scrollbar { display: none; }

   .wheel-item {
     height: ${ITEM_HEIGHT}px;
     scroll-snap-align: center;
     display: flex;
     align-items: center;
     justify-content: center;
     font-size: 1rem;
     font-variant-numeric: tabular-nums;
     color: var(--ui-time-picker-text, #374151);
     opacity: 0.4;
     transition: opacity 0.15s ease;
   }

   .wheel-item.selected {
     opacity: 1;
     font-weight: 600;
     color: var(--ui-time-picker-primary, var(--ui-primary, #3b82f6));
   }

   .wheel-highlight {
     position: absolute;
     left: 0;
     right: 0;
     top: 50%;
     transform: translateY(-50%);
     height: ${ITEM_HEIGHT}px;
     border-top: 1px solid var(--ui-time-picker-border, #d1d5db);
     border-bottom: 1px solid var(--ui-time-picker-border, #d1d5db);
     background: var(--ui-time-picker-highlight-bg, rgba(59, 130, 246, 0.05));
     pointer-events: none;
     z-index: 1;
   }

   .wheel-separator {
     font-size: 1.25rem;
     font-weight: 600;
     color: var(--ui-time-picker-separator, #9ca3af);
     user-select: none;
   }
   ```

   Dark mode:
   ```css
   :host-context(.dark) .wheel-item {
     color: var(--ui-time-picker-text, #d1d5db);
   }
   :host-context(.dark) .wheel-highlight {
     border-color: var(--ui-time-picker-border, #4b5563);
     background: rgba(59, 130, 246, 0.1);
   }
   :host-context(.dark) .wheel-separator {
     color: var(--ui-time-picker-separator, #6b7280);
   }
   ```

3. Safe custom element registration at bottom.

**Key decisions:**
- CSS scroll-snap handles all physics (no JS momentum/spring).
- scrollend event with debounce fallback for older browsers.
- Padding items above/below allow first/last items to center in highlight.
- Never force scroll position via JS scrollTo during active user scroll (only on value prop change).
  </action>
  <verify>
Build: `cd packages/time-picker && npx tsc --noEmit`. No type errors.
Verify file has scroll-snap CSS, scrollend handling, and hour/minute/period columns.
  </verify>
  <done>TimeScrollWheel renders iOS-style scroll columns with CSS scroll-snap for hours, minutes, and optional AM/PM, with scrollend detection and debounce fallback.</done>
</task>

</tasks>

<verification>
1. `cd packages/time-picker && npx tsc --noEmit` passes
2. `grep -n 'scroll-snap\|scrollend\|ITEM_HEIGHT\|wheel-container' packages/time-picker/src/time-scroll-wheel.ts` confirms scroll-snap implementation
3. Component dispatches `ui-scroll-wheel-change` event with TimeValue
</verification>

<success_criteria>
- Three scroll columns (hour, minute, AM/PM) with CSS scroll-snap centering
- Highlight row indicator shows the centered/selected value
- scrollend event detection with 200ms debounce fallback
- Step property controls minute interval
- Dark mode via :host-context(.dark)
</success_criteria>

<output>
After completion, create `.planning/phases/49-time-picker-advanced/49-04-SUMMARY.md`
</output>
