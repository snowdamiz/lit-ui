---
phase: 49-time-picker-advanced
plan: 06
type: execute
wave: 2
depends_on: ["49-01", "49-02", "49-03", "49-04", "49-05"]
files_modified:
  - packages/time-picker/src/time-picker.ts
  - packages/time-picker/src/index.ts
  - packages/time-picker/src/jsx.d.ts
autonomous: true

must_haves:
  truths:
    - "TimePicker passes businessHours and step props down to ClockFace and TimeDropdown"
    - "TimePicker renders TimezoneDisplay when additionalTimezones is set"
    - "TimePicker renders TimeScrollWheel when interface-mode is 'wheel'"
    - "TimePicker renders TimeVoiceInput when voice prop is enabled"
    - "TimePicker renders TimeRangeSlider when interface-mode is 'range'"
    - "New components are imported and registered in index.ts"
    - "JSX types include new properties (businessHours, additionalTimezones, voice)"
    - "Package exports include new component classes and types"
    - "SSR safe: isServer guards on all new runtime features"
  artifacts:
    - path: "packages/time-picker/src/time-picker.ts"
      provides: "Updated TimePicker with all Phase 49 sub-component composition"
      contains: "businessHours"
    - path: "packages/time-picker/src/index.ts"
      provides: "Updated exports including all new components"
      contains: "timezone-display"
    - path: "packages/time-picker/src/jsx.d.ts"
      provides: "JSX types with new attributes"
      contains: "additionalTimezones"
  key_links:
    - from: "packages/time-picker/src/time-picker.ts"
      to: "packages/time-picker/src/clock-face.ts"
      via: ".step and .businessHours property binding in template"
      pattern: ".step=\\$\\{this.step\\}"
    - from: "packages/time-picker/src/time-picker.ts"
      to: "packages/time-picker/src/timezone-display.ts"
      via: "lui-timezone-display in popup template"
      pattern: "lui-timezone-display"
    - from: "packages/time-picker/src/index.ts"
      to: "all new components"
      via: "side-effect imports for custom element registration"
      pattern: "./time-range-slider.js"
---

<objective>
Wire all Phase 49 sub-components into the main TimePicker, update package exports, custom element registration, and JSX types.

Purpose: Integrates TP-16 through TP-23 features into the parent TimePicker component. Updates public API (exports, JSX types) for consumers.
Output: Updated time-picker.ts with new props and sub-component composition, updated index.ts and jsx.d.ts.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/49-time-picker-advanced/49-RESEARCH.md
@packages/time-picker/src/time-picker.ts
@packages/time-picker/src/index.ts
@packages/time-picker/src/jsx.d.ts

# Prior plan summaries for integration context
@.planning/phases/49-time-picker-advanced/49-01-SUMMARY.md
@.planning/phases/49-time-picker-advanced/49-02-SUMMARY.md
@.planning/phases/49-time-picker-advanced/49-03-SUMMARY.md
@.planning/phases/49-time-picker-advanced/49-04-SUMMARY.md
@.planning/phases/49-time-picker-advanced/49-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add new properties and sub-component composition to TimePicker</name>
  <files>packages/time-picker/src/time-picker.ts</files>
  <action>
Add new properties and wire sub-components into the TimePicker main component.

**1. New properties (add after existing properties):**

```typescript
/**
 * Business hours range for visual highlighting.
 * - `false` (default): no highlighting
 * - `{ start: number; end: number }`: highlight hours in range (24h format)
 */
@property({ attribute: false })
businessHours: { start: number; end: number } | false = false;

/**
 * Additional IANA timezone identifiers for multi-timezone display.
 * When set, a timezone comparison row appears in the popup.
 * Example: ['America/Los_Angeles', 'Europe/London']
 */
@property({ attribute: false })
additionalTimezones: string[] = [];

/**
 * Enable voice input button (progressive enhancement).
 * Button hidden when Web Speech API is unavailable.
 */
@property({ type: Boolean })
voice = false;
```

**2. Update `interfaceMode` type union to include 'wheel' and 'range':**
Change:
```typescript
@property({ type: String, attribute: 'interface-mode' })
interfaceMode: 'clock' | 'dropdown' | 'both' = 'both';
```
To:
```typescript
@property({ type: String, attribute: 'interface-mode' })
interfaceMode: 'clock' | 'dropdown' | 'both' | 'wheel' | 'range' = 'both';
```

**3. Add event handler for scroll wheel changes:**
```typescript
private handleScrollWheelChange(e: Event): void {
  const detail = (e as CustomEvent).detail;
  if (!detail?.value) return;
  this.internalValue = detail.value as TimeValue;
  this.syncValueFromInternal();
}
```

**4. Add event handler for voice input:**
```typescript
private handleVoiceSelect(e: Event): void {
  const detail = (e as CustomEvent).detail;
  if (!detail?.value) return;
  this.internalValue = detail.value as TimeValue;
  this.syncValueFromInternal();
  this.closePopup();
}
```

**5. Add event handler for range slider:**
```typescript
private handleRangeChange(e: Event): void {
  const detail = (e as CustomEvent).detail;
  if (!detail) return;
  // Range slider emits start/end, use startTime as the primary value
  if (detail.startTime) {
    this.internalValue = detail.startTime as TimeValue;
    this.syncValueFromInternal();
  }
}
```

**6. Update `renderActiveInterface()` to handle wheel and range modes:**
Add cases:
```typescript
const showWheel = this.interfaceMode === 'wheel';
const showRange = this.interfaceMode === 'range';

if (showWheel) {
  return html`
    <lui-time-scroll-wheel
      .value=${this.internalValue}
      .hour12=${this.effectiveHour12}
      .step=${this.step}
      ?disabled=${this.disabled}
      @ui-scroll-wheel-change=${this.handleScrollWheelChange}
    ></lui-time-scroll-wheel>
  `;
}

if (showRange) {
  return html`
    <lui-time-range-slider
      .startMinutes=${this.internalValue ? this.internalValue.hour * 60 + this.internalValue.minute : 540}
      .endMinutes=${1020}
      .step=${this.step}
      .hour12=${this.effectiveHour12}
      .locale=${this.locale}
      ?disabled=${this.disabled}
      @ui-time-range-change=${this.handleRangeChange}
    ></lui-time-range-slider>
  `;
}
```

**7. Pass businessHours and step to ClockFace and TimeDropdown:**
In the existing clock face template:
```html
<lui-clock-face
  .mode=${this.clockMode}
  .hour=${this.internalValue?.hour ?? 0}
  .minute=${this.internalValue?.minute ?? 0}
  .hour12=${this.effectiveHour12}
  .step=${this.step}
  .businessHours=${this.businessHours}
  ?disabled=${this.disabled}
  @clock-select=${this.handleClockSelect}
></lui-clock-face>
```

In the existing dropdown template:
```html
<lui-time-dropdown
  .value=${this.internalValue}
  .step=${this.step}
  .hour12=${this.effectiveHour12}
  .locale=${this.locale}
  .minTime=${this.minTime}
  .maxTime=${this.maxTime}
  .businessHours=${this.businessHours}
  ?disabled=${this.disabled}
  @ui-time-dropdown-select=${this.handleDropdownSelect}
></lui-time-dropdown>
```

**8. Render timezone display in popup (after presets):**
In the render method, after `${this.renderPresets()}`:
```typescript
${this.additionalTimezones.length > 0
  ? html`
      <lui-timezone-display
        .value=${this.internalValue}
        .locale=${this.locale}
        .hour12=${this.effectiveHour12}
        .primaryTimezone=${this.timezone}
        .additionalTimezones=${this.additionalTimezones}
      ></lui-timezone-display>
    `
  : nothing}
```

**9. Render voice input button in the input-display area:**
After the toggle button, add:
```typescript
${this.voice
  ? html`
      <lui-time-voice-input
        .locale=${this.locale}
        ?disabled=${this.disabled || this.readonly}
        @ui-voice-time-select=${this.handleVoiceSelect}
      ></lui-time-voice-input>
    `
  : nothing}
```

**10. Update interface tabs to include wheel option when interfaceMode is 'both':**
No change needed -- 'wheel' and 'range' are standalone modes, not tabs. The existing tab rendering for 'both' stays as-is.
  </action>
  <verify>
Build: `cd packages/time-picker && npx tsc --noEmit`. No type errors.
Verify time-picker.ts has all new properties and sub-component compositions.
  </verify>
  <done>TimePicker composes all Phase 49 sub-components with property binding and event handling.</done>
</task>

<task type="auto">
  <name>Task 2: Update index.ts exports and jsx.d.ts types</name>
  <files>packages/time-picker/src/index.ts, packages/time-picker/src/jsx.d.ts</files>
  <action>
**1. Update index.ts:**

Add side-effect imports for new internal components (after existing imports):
```typescript
import './timezone-display.js';
import './time-range-slider.js';
import './time-scroll-wheel.js';
import './time-voice-input.js';
```

Add named exports for new component classes (for advanced consumers who want standalone usage):
```typescript
export { TimezoneDisplay } from './timezone-display.js';
export { TimeRangeSlider } from './time-range-slider.js';
export { TimeScrollWheel } from './time-scroll-wheel.js';
export { TimeVoiceInput } from './time-voice-input.js';
```

**2. Update jsx.d.ts:**

Add new attributes to `LuiTimePickerAttributes`:
```typescript
voice?: boolean;
'interface-mode'?: 'clock' | 'dropdown' | 'both' | 'wheel' | 'range';
```

Note: `businessHours`, `additionalTimezones`, and `presets` are JS-only (`attribute: false`), so they are NOT in the JSX attributes interface. This follows the Phase 48-06 decision.

Add event types:
```typescript
interface LuiTimePickerEvents {
  onchange?: (event: CustomEvent<{ value: string; timeValue: import('./time-utils.js').TimeValue | null }>) => void;
  'on:change'?: (event: CustomEvent<{ value: string; timeValue: import('./time-utils.js').TimeValue | null }>) => void;
}
```

**3. SSR verification:**
Ensure all new side-effect imports are safe. Each new component uses `typeof customElements !== 'undefined'` guard for registration. No module-level DOM access. This follows the established pattern from Phase 48-06.
  </action>
  <verify>
Build: `cd packages/time-picker && npx tsc --noEmit`. No type errors.
Verify index.ts has all new imports and exports.
Verify jsx.d.ts has voice and updated interface-mode attributes.
  </verify>
  <done>Package exports include all new components. JSX types include voice and updated interface-mode. Side-effect imports register all new custom elements. SSR-safe.</done>
</task>

</tasks>

<verification>
1. `cd packages/time-picker && npx tsc --noEmit` passes with no errors
2. `grep -n 'businessHours\|additionalTimezones\|voice\|wheel\|range' packages/time-picker/src/time-picker.ts` shows all new properties and modes
3. `grep -n 'timezone-display\|time-range-slider\|time-scroll-wheel\|time-voice-input' packages/time-picker/src/index.ts` shows all new imports
4. `grep -n 'voice\|wheel\|range' packages/time-picker/src/jsx.d.ts` shows updated JSX types
</verification>

<success_criteria>
- TimePicker passes step and businessHours to ClockFace and TimeDropdown
- TimePicker renders TimezoneDisplay when additionalTimezones is set
- TimePicker renders TimeScrollWheel when interface-mode="wheel"
- TimePicker renders TimeRangeSlider when interface-mode="range"
- TimePicker renders TimeVoiceInput microphone button when voice=true
- All new components registered via side-effect imports in index.ts
- Named exports available for advanced consumers
- JSX types updated with new attributes
- Full build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/49-time-picker-advanced/49-06-SUMMARY.md`
</output>
