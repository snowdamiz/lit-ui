---
phase: 67-export-expandable-rows
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/data-table/src/export-csv.ts
  - packages/data-table/src/types.ts
  - packages/data-table/src/data-table.ts
  - packages/data-table/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Calling exportCsv() downloads a CSV file with current filtered/visible data"
    - "Calling exportCsv({ selectedOnly: true }) exports only selected rows"
    - "Hidden columns are excluded from CSV export"
    - "When onExport callback is set, exportCsv() delegates to it with table state params"
    - "Utility columns (_selection, _actions, _expand) are excluded from CSV export"
  artifacts:
    - path: "packages/data-table/src/export-csv.ts"
      provides: "exportToCsv utility, escapeCsvField, triggerDownload, ExportCsvOptions, ServerExportParams"
      min_lines: 60
    - path: "packages/data-table/src/types.ts"
      provides: "ExportCsvOptions, ServerExportParams type interfaces"
      contains: "ServerExportParams"
    - path: "packages/data-table/src/data-table.ts"
      provides: "exportCsv() public method, onExport callback property"
      contains: "exportCsv"
    - path: "packages/data-table/src/index.ts"
      provides: "Re-exports for exportToCsv and export types"
      contains: "export-csv"
  key_links:
    - from: "packages/data-table/src/data-table.ts"
      to: "packages/data-table/src/export-csv.ts"
      via: "importToCsv called from exportCsv() method"
      pattern: "exportToCsv"
    - from: "packages/data-table/src/export-csv.ts"
      to: "@tanstack/lit-table Table instance"
      via: "table.getFilteredRowModel, table.getSelectedRowModel, table.getVisibleLeafColumns"
      pattern: "table\\.get(Filtered|Selected)RowModel"
---

<objective>
Add CSV export capability to the DataTable component as a public method and standalone utility.

Purpose: Users need to export table data for offline analysis, reporting, or data transfer. The export respects current filters, column visibility, and selection state. A server-side callback escape hatch handles large datasets where client-side export isn't practical.

Output: `export-csv.ts` utility module, type additions in `types.ts`, `exportCsv()` public method on DataTable, package exports.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/67-export-expandable-rows/67-RESEARCH.md
@packages/data-table/src/types.ts
@packages/data-table/src/data-table.ts
@packages/data-table/src/index.ts
@packages/data-table/src/selection-column.ts
@packages/data-table/src/bulk-actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create export-csv.ts utility module and add export types to types.ts</name>
  <files>
    packages/data-table/src/export-csv.ts
    packages/data-table/src/types.ts
  </files>
  <action>
**In `types.ts`**, add the following interfaces at the end of the file (before any closing comments), in a new section headed `// Export Types (EXP-*)`:

1. `ExportCsvOptions` interface:
   - `filename?: string` (default: 'export.csv')
   - `selectedOnly?: boolean` (export only selected rows, EXP-02)
   - `includeBom?: boolean` (UTF-8 BOM for Excel, default true)
   - `headers?: Record<string, string>` (custom column header labels, override accessor-derived headers)

2. `ServerExportParams` interface:
   - `columnFilters: ColumnFiltersState`
   - `globalFilter: string`
   - `sorting: SortingState`
   - `visibleColumnIds: string[]` (EXP-03)
   - `selectedRowIds: string[]`

**Create `export-csv.ts`** as a standalone utility module following the pattern of `bulk-actions.ts` and `row-actions.ts`:

1. Import `Table`, `RowData` from `@tanstack/lit-table`, import `ExportCsvOptions` from `./types.js`.

2. `escapeCsvField(field: string): string` - RFC 4180 compliant escaping:
   - If field contains comma, double-quote, newline, or carriage return: wrap in double-quotes, escape internal quotes by doubling them
   - Otherwise return as-is

3. `triggerDownload(blob: Blob, filename: string): void` - Browser download:
   - `URL.createObjectURL(blob)` to create URL
   - Create anchor element with `href` and `download` attributes
   - `a.style.display = 'none'`, append to body, click, then cleanup with `setTimeout(() => { removeChild; revokeObjectURL }, 100)`

4. `exportToCsv<TData extends RowData>(table: Table<TData>, options: ExportCsvOptions = {}): void` - Main export function:
   - Destructure options with defaults: `filename = 'export.csv'`, `selectedOnly = false`, `includeBom = true`
   - Get rows: `selectedOnly ? table.getSelectedRowModel().rows : table.getFilteredRowModel().rows`
   - **IMPORTANT for EXP-02 fallback:** If `selectedOnly` is true and selected rows count is 0, fall back to `table.getFilteredRowModel().rows` (documented behavior from research pitfall 7)
   - Get visible columns, filtering out utility columns: `table.getVisibleLeafColumns().filter(col => !col.id.startsWith('_'))` (this excludes `_selection`, `_actions`, `_expand`)
   - Build header row: For each column, use `options.headers?.[col.id]` if available, else if `col.columnDef.header` is a string use it, else fall back to `col.id`. Escape each via `escapeCsvField`.
   - Build data rows: For each row, for each column, get `row.getValue(col.id)`, convert null/undefined to empty string, else `String(value)`, escape via `escapeCsvField`. Join with comma.
   - Assemble: `[headerRow, ...dataRows].join('\r\n')`
   - Create Blob: `new Blob([(includeBom ? '\uFEFF' : '') + csv], { type: 'text/csv;charset=utf-8' })`
   - Call `triggerDownload(blob, filename)`

5. Export all functions and ensure clean JSDoc documentation on the public function.
  </action>
  <verify>
Run `npx tsc --noEmit -p packages/data-table/tsconfig.json` - TypeScript compiles without errors.
Verify `export-csv.ts` exists with `exportToCsv`, `escapeCsvField` functions.
Verify `types.ts` contains `ExportCsvOptions` and `ServerExportParams` interfaces.
  </verify>
  <done>
export-csv.ts contains RFC 4180 compliant CSV export utility. types.ts contains ExportCsvOptions and ServerExportParams interfaces. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add exportCsv() public method and onExport callback to DataTable</name>
  <files>
    packages/data-table/src/data-table.ts
    packages/data-table/src/index.ts
  </files>
  <action>
**In `data-table.ts`:**

1. Add import: `import { exportToCsv } from './export-csv.js';` and import `ExportCsvOptions, ServerExportParams` from `./types.js` (add to existing type import).

2. Add a new property section after the bulk actions section (around line 225), headed `// Export (EXP-*)`:
   - `@property({ attribute: false }) onExport?: (params: ServerExportParams) => void | Promise<void>;` - Server-side export callback (EXP-04). When set, `exportCsv()` delegates to this callback instead of client-side CSV generation.

3. Add the public `exportCsv()` method. Place it near the other public methods (after `resetColumnPreferences` or similar). This method:
   ```typescript
   public async exportCsv(options?: ExportCsvOptions): Promise<void> {
     const table = this._tableInstance;
     if (!table) return;

     if (this.onExport) {
       // Server-side export (EXP-04)
       const visibleColumnIds = table.getVisibleLeafColumns()
         .filter(c => !c.id.startsWith('_'))
         .map(c => c.id);
       const selectedRowIds = Object.keys(this.rowSelection);

       await this.onExport({
         columnFilters: this.columnFilters,
         globalFilter: this.globalFilter,
         sorting: this.sorting,
         visibleColumnIds,
         selectedRowIds,
       });
     } else {
       // Client-side export (EXP-01, EXP-02, EXP-03)
       exportToCsv(table, options);
     }
   }
   ```

**In `index.ts`:**

4. Add export for the CSV utility and types:
   ```typescript
   // CSV export utility
   export { exportToCsv } from './export-csv.js';
   ```
   The types (ExportCsvOptions, ServerExportParams) are already exported via `export * from './types.js'`.

5. Verify the re-export line for types.ts already exports `ExportCsvOptions` and `ServerExportParams` via the `export * from './types.js'` line. No additional change needed for types.
  </action>
  <verify>
Run `npx tsc --noEmit -p packages/data-table/tsconfig.json` - TypeScript compiles without errors.
Grep for `exportCsv` in `data-table.ts` to confirm the public method exists.
Grep for `export-csv` in `index.ts` to confirm the re-export.
Grep for `onExport` in `data-table.ts` to confirm the callback property.
  </verify>
  <done>
DataTable has `exportCsv()` public method and `onExport` callback property. When `onExport` is set, it delegates with full table state (EXP-04). When not set, it calls `exportToCsv` for client-side CSV download (EXP-01, EXP-02, EXP-03). Package entry point re-exports `exportToCsv`. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit -p packages/data-table/tsconfig.json` passes
2. `export-csv.ts` exports `exportToCsv` function
3. `types.ts` exports `ExportCsvOptions` and `ServerExportParams`
4. `data-table.ts` has `exportCsv()` public method and `onExport` property
5. `index.ts` re-exports `exportToCsv`
6. Utility columns (`_selection`, `_actions`, `_expand`) filtered from export
7. RFC 4180 escaping handles commas, quotes, newlines
8. UTF-8 BOM prepended by default for Excel compatibility
</verification>

<success_criteria>
- EXP-01: exportToCsv reads from getFilteredRowModel().rows for all visible/filtered data
- EXP-02: selectedOnly option reads from getSelectedRowModel().rows (with empty-selection fallback)
- EXP-03: getVisibleLeafColumns() + filter out _* columns respects column visibility
- EXP-04: onExport callback receives ServerExportParams with filters, sorting, visible columns, selected rows
- Clean TypeScript compilation, no new warnings
</success_criteria>

<output>
After completion, create `.planning/phases/67-export-expandable-rows/67-01-SUMMARY.md`
</output>
