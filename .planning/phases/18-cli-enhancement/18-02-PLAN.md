---
phase: 18-cli-enhancement
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - packages/cli/src/utils/install-component.ts
  - packages/cli/src/commands/add.ts
autonomous: true

must_haves:
  truths:
    - "Add command in npm mode runs package manager install"
    - "Add command in copy-source mode copies files (existing behavior)"
    - "User can override mode with --npm or --copy flags"
    - "Auto-detect package manager and use correct install command"
  artifacts:
    - path: "packages/cli/src/utils/install-component.ts"
      provides: "npm mode component installation"
      exports: ["installComponent", "componentToPackage"]
    - path: "packages/cli/src/commands/add.ts"
      provides: "Mode-branching add command"
      contains: "mode === 'npm'"
  key_links:
    - from: "packages/cli/src/commands/add.ts"
      to: "packages/cli/src/utils/install-component.ts"
      via: "installComponent call"
      pattern: "installComponent"
    - from: "packages/cli/src/utils/install-component.ts"
      to: "execa"
      via: "package manager execution"
      pattern: "execa.*npm|pnpm|yarn|bun"
---

<objective>
Update add command to support both npm and copy-source modes with per-command flag overrides.

Purpose: Allow users to install components via npm packages OR copy source files, based on project mode or explicit flags.

Output: Mode-aware add command with install-component utility for npm mode.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-cli-enhancement/18-CONTEXT.md
@.planning/phases/18-cli-enhancement/18-RESEARCH.md
@.planning/phases/18-cli-enhancement/18-01-SUMMARY.md
@packages/cli/src/commands/add.ts
@packages/cli/src/utils/config.ts
@packages/cli/src/utils/detect-package-manager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create install-component utility for npm mode</name>
  <files>packages/cli/src/utils/install-component.ts</files>
  <action>
Create new utility file for npm mode component installation:

1. Create packages/cli/src/utils/install-component.ts with:

```typescript
import { execa } from 'execa';
import { consola } from 'consola';
import pc from 'picocolors';
import { detectPackageManager, type PackageManager } from './detect-package-manager';

/**
 * Map component names to npm package names
 */
export const componentToPackage: Record<string, string> = {
  button: '@lit-ui/button',
  dialog: '@lit-ui/dialog',
};

/**
 * Get install arguments for each package manager
 */
function getInstallArgs(pm: PackageManager, packageName: string): string[] {
  switch (pm) {
    case 'npm':
      return ['install', packageName];
    case 'yarn':
      return ['add', packageName];
    case 'pnpm':
      return ['add', packageName];
    case 'bun':
      return ['add', packageName];
  }
}

/**
 * Install a component via npm package manager
 */
export async function installComponent(
  componentName: string,
  cwd: string
): Promise<boolean> {
  const packageName = componentToPackage[componentName];

  if (!packageName) {
    consola.error(`Unknown component: ${pc.cyan(componentName)}`);
    consola.info('Available components: ' + Object.keys(componentToPackage).join(', '));
    return false;
  }

  const pm = await detectPackageManager(cwd);
  const args = getInstallArgs(pm, packageName);

  consola.start(`Installing ${pc.cyan(packageName)} via ${pm}...`);

  try {
    // First ensure @lit-ui/core is installed (peer dependency)
    const coreArgs = getInstallArgs(pm, '@lit-ui/core');
    await execa(pm, coreArgs, { cwd, stdio: 'pipe' });

    // Then install the component
    await execa(pm, args, { cwd, stdio: 'pipe' });

    consola.success(`Installed ${pc.cyan(packageName)}`);

    // Print usage instructions
    console.log('');
    console.log(pc.dim('Import:'));
    console.log(`  import '@lit-ui/${componentName}';`);
    console.log('');
    console.log(pc.dim('Usage:'));
    console.log(`  <lui-${componentName}>...</lui-${componentName}>`);

    return true;
  } catch (error) {
    consola.error(`Failed to install ${packageName}`);
    if (error instanceof Error) {
      consola.error(error.message);
    }
    return false;
  }
}

/**
 * Check if a component is available in npm mode
 */
export function isNpmComponent(componentName: string): boolean {
  return componentName in componentToPackage;
}
```

Note: Use 'lui-' prefix for tag names to match @lit-ui component naming convention.
  </action>
  <verify>TypeScript compiles: `pnpm --filter @lit-ui/cli build`</verify>
  <done>install-component.ts exports installComponent and componentToPackage mapping</done>
</task>

<task type="auto">
  <name>Task 2: Update add command with mode branching and flags</name>
  <files>packages/cli/src/commands/add.ts</files>
  <action>
Update add command to branch on mode with flag overrides:

1. Add --npm and --copy flags to args:
   ```typescript
   npm: {
     type: 'boolean',
     description: 'Install from npm (override config mode)',
     default: false,
   },
   copy: {
     type: 'boolean',
     description: 'Copy source files (override config mode)',
     default: false,
   },
   ```

2. Import new utilities:
   ```typescript
   import { getOrCreateConfig } from '../utils/config';
   import { installComponent, isNpmComponent } from '../utils/install-component';
   ```

3. Replace getConfig with getOrCreateConfig (auto-creates config if missing):
   ```typescript
   const config = await getOrCreateConfig(cwd);
   // Remove the "No lit-ui.json found" error - config auto-creates now
   ```

4. Determine effective mode from flags and config:
   ```typescript
   // Flag overrides config
   const mode = args.npm ? 'npm' : args.copy ? 'copy-source' : config.mode;
   ```

5. Branch on mode before the existing copy logic:
   ```typescript
   if (mode === 'npm') {
     // npm mode: install packages
     if (!isNpmComponent(componentName)) {
       consola.error(`Component ${pc.cyan(componentName)} not available as npm package.`);
       consola.info('Available npm components: button, dialog');
       process.exit(1);
     }

     const success = await installComponent(componentName, cwd);
     if (!success) {
       process.exit(1);
     }
     return; // Exit early, skip copy logic
   }

   // copy-source mode: existing behavior continues below
   ```

6. Keep all existing copy-source logic intact for backward compatibility.

7. Update final "Next steps" message to use correct import path for npm mode (but since we return early, this is handled in installComponent).
  </action>
  <verify>
1. Build succeeds: `pnpm --filter @lit-ui/cli build`
2. Test add command shows correct behavior based on mode
  </verify>
  <done>Add command branches on mode, supports --npm and --copy flags, auto-creates config</done>
</task>

</tasks>

<verification>
1. Build succeeds: `pnpm --filter @lit-ui/cli build`
2. `lit-ui add button` with npm mode config runs package install
3. `lit-ui add button` with copy-source mode copies files (existing behavior)
4. `lit-ui add button --npm` overrides config to use npm mode
5. `lit-ui add button --copy` overrides config to use copy-source mode
6. Auto-detect package manager (npm/pnpm/yarn/bun) for install command
</verification>

<success_criteria>
- installComponent utility runs correct package manager with proper install syntax
- Add command reads mode from config, allows flag override
- npm mode shows import snippet and usage after install
- copy-source mode maintains backward compatibility
- Config auto-creates if missing (no "run init first" error)
</success_criteria>

<output>
After completion, create `.planning/phases/18-cli-enhancement/18-02-SUMMARY.md`
</output>
