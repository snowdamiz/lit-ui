---
phase: 62-sorting-selection
plan: 02
type: execute
wave: 2
depends_on: ["62-01"]
files_modified:
  - packages/data-table/src/data-table.ts
  - packages/data-table/src/types.ts
  - packages/data-table/src/selection-column.ts
  - packages/data-table/src/index.ts
autonomous: true

must_haves:
  truths:
    - "User can enable row selection checkbox column via property"
    - "User can check individual row checkboxes to select rows"
    - "User can click header checkbox to select/deselect all rows on current page"
    - "User's selection persists when navigating pages"
  artifacts:
    - path: "packages/data-table/src/selection-column.ts"
      provides: "Selection column factory function"
      exports: ["createSelectionColumn"]
    - path: "packages/data-table/src/data-table.ts"
      provides: "RowSelectionState integration"
      contains: "rowSelection"
    - path: "packages/data-table/src/types.ts"
      provides: "SelectionChangeEvent type"
      contains: "SelectionChangeEvent"
  key_links:
    - from: "packages/data-table/src/data-table.ts"
      to: "packages/data-table/src/selection-column.ts"
      via: "createSelectionColumn import and usage"
      pattern: "createSelectionColumn"
    - from: "packages/data-table/src/selection-column.ts"
      to: "lui-checkbox component"
      via: "html template literal"
      pattern: "lui-checkbox"
---

<objective>
Add row selection capabilities to lui-data-table with checkbox column and header select-all.

Purpose: Users need to select rows for bulk operations (delete, export, etc.). Selection state must persist across page navigation.

Output:
- Optional selection checkbox column
- Header checkbox for page select-all (with indeterminate state)
- Row selection state integration with TanStack Table
- Selection change events for parent components
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/62-sorting-&-selection/62-RESEARCH.md
@.planning/phases/62-sorting-&-selection/62-01-SUMMARY.md
@packages/data-table/src/data-table.ts
@packages/data-table/src/types.ts
@packages/checkbox/src/checkbox.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add selection state and event types</name>
  <files>
    packages/data-table/src/types.ts
    packages/data-table/src/data-table.ts
  </files>
  <action>
1. In types.ts, add SelectionChangeEvent interface:
```typescript
/**
 * Event detail for selection change events.
 */
export interface SelectionChangeEvent<TData extends RowData = RowData> {
  /** Row selection state (row IDs mapped to boolean) */
  rowSelection: RowSelectionState;
  /** Array of currently selected row objects */
  selectedRows: TData[];
  /** Number of selected rows */
  selectedCount: number;
  /** Reason for the change */
  reason?: 'user' | 'select-all' | 'clear' | 'filter-changed';
}
```

2. In data-table.ts, add selection properties:
```typescript
/**
 * Enable row selection with checkbox column.
 * When true, adds a checkbox column as the first column.
 */
@property({ type: Boolean, attribute: 'enable-selection' })
enableSelection = false;

/**
 * Current row selection state.
 * Maps row IDs to selection status.
 */
@property({ type: Object })
rowSelection: RowSelectionState = {};

/**
 * Property key to use as row ID for selection tracking.
 * Defaults to 'id'. Must be a unique identifier for each row.
 */
@property({ attribute: 'row-id-key' })
rowIdKey = 'id';
```

3. Add selection state to tableController.table() options:
```typescript
const table = this.tableController.table({
  columns: this.getEffectiveColumns(),
  data: this.data,
  state: {
    sorting: this.sorting,
    rowSelection: this.rowSelection,
  },
  onSortingChange: ...,
  onRowSelectionChange: (updater) => {
    const newSelection = typeof updater === 'function'
      ? updater(this.rowSelection)
      : updater;
    this.rowSelection = newSelection;
    this.dispatchSelectionChange(table, newSelection, 'user');
  },
  getRowId: (row) => String(row[this.rowIdKey as keyof TData]),
  enableRowSelection: this.enableSelection,
  getCoreRowModel: getCoreRowModel(),
  getSortedRowModel: this.manualSorting ? undefined : getSortedRowModel(),
  manualSorting: this.manualSorting,
});
```

4. Add helper method to dispatch selection events:
```typescript
private dispatchSelectionChange(
  table: Table<TData>,
  rowSelection: RowSelectionState,
  reason: SelectionChangeEvent<TData>['reason']
): void {
  const selectedRows = table.getSelectedRowModel().rows.map(r => r.original);
  const event = new CustomEvent('ui-selection-change', {
    detail: {
      rowSelection,
      selectedRows,
      selectedCount: selectedRows.length,
      reason,
    } satisfies SelectionChangeEvent<TData>,
    bubbles: true,
    composed: true,
  });
  this.dispatchEvent(event);
}
```

Note: Import RowSelectionState from @tanstack/lit-table if not already re-exported.
  </action>
  <verify>
Build: `cd packages/data-table && pnpm build`
Verify no TypeScript errors for selection state types.
  </verify>
  <done>
DataTable has enableSelection, rowSelection, and rowIdKey properties.
Selection state integrated with TanStack Table.
ui-selection-change event emitted on selection changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create selection column factory with checkboxes</name>
  <files>
    packages/data-table/src/selection-column.ts
    packages/data-table/src/index.ts
  </files>
  <action>
1. Create selection-column.ts with factory function:
```typescript
/**
 * Selection column factory for lui-data-table.
 * Creates a checkbox column for row selection with header select-all.
 */

import { html, nothing } from 'lit';
import type { ColumnDef, RowData } from './types.js';
import type { Table, Row } from '@tanstack/lit-table';

/**
 * Creates a selection column with checkboxes for row selection.
 *
 * @template TData - Row data type
 * @returns Column definition for selection checkbox column
 *
 * @example
 * ```typescript
 * const columns = [
 *   createSelectionColumn<User>(),
 *   { accessorKey: 'name', header: 'Name' },
 * ];
 * ```
 */
export function createSelectionColumn<TData extends RowData>(): ColumnDef<TData, unknown> {
  return {
    id: '_selection',
    header: ({ table }: { table: Table<TData> }) => {
      const isAllPageSelected = table.getIsAllPageRowsSelected();
      const isSomePageSelected = table.getIsSomePageRowsSelected();

      return html`
        <lui-checkbox
          size="sm"
          .checked=${isAllPageSelected}
          .indeterminate=${!isAllPageSelected && isSomePageSelected}
          @ui-change=${() => table.toggleAllPageRowsSelected()}
          aria-label="Select all rows on this page"
        ></lui-checkbox>
      `;
    },
    cell: ({ row }: { row: Row<TData> }) => {
      const isSelected = row.getIsSelected();
      const canSelect = row.getCanSelect();

      return html`
        <lui-checkbox
          size="sm"
          .checked=${isSelected}
          .disabled=${!canSelect}
          @ui-change=${() => row.toggleSelected()}
          aria-label="Select row"
        ></lui-checkbox>
      `;
    },
    size: 48,
    minSize: 48,
    maxSize: 48,
    enableSorting: false,
    enableColumnFilter: false,
    enableResizing: false,
  };
}
```

2. Update index.ts to export the factory:
```typescript
// Selection column factory
export { createSelectionColumn } from './selection-column.js';
```

3. In data-table.ts, add method to prepend selection column when enabled:
```typescript
/**
 * Get effective columns including selection column if enabled.
 */
private getEffectiveColumns(): ColumnDef<TData, unknown>[] {
  if (!this.enableSelection) {
    return this.columns;
  }

  // Import at top: import { createSelectionColumn } from './selection-column.js';
  return [createSelectionColumn<TData>(), ...this.columns];
}
```

4. Update render() to use getEffectiveColumns() for columns passed to tableController.

Important: The lui-checkbox component expects:
- `.checked` property for checked state
- `.indeterminate` property for indeterminate state
- `@ui-change` event for change handling
- `size="sm"` for compact size in table cells
  </action>
  <verify>
1. Build: `cd packages/data-table && pnpm build`
2. Visual check:
   - Enable selection on data table: `<lui-data-table enable-selection .data=${data} .columns=${columns}>`
   - Checkbox column appears as first column
   - Individual row checkboxes work
   - Header checkbox selects all on page
   - Header shows indeterminate when some selected
  </verify>
  <done>
- createSelectionColumn factory exported from package
- Selection column with 48px fixed width
- Header checkbox with indeterminate state for partial selection
- Row checkboxes toggle individual selection
- Disabled state respected on non-selectable rows
  </done>
</task>

<task type="auto">
  <name>Task 3: Add selection column styling and keyboard support</name>
  <files>
    packages/data-table/src/data-table.ts
  </files>
  <action>
1. Add CSS for selection column in static styles:
```css
/* Selection column styles */
.data-table-cell:first-child,
.data-table-header-cell:first-child {
  /* Ensure checkbox cells have proper alignment */
}

/* Checkbox in table should be centered */
lui-checkbox {
  --ui-checkbox-size: 16px;
}

/* Selection row highlight */
.data-table-row.selected {
  background: var(--ui-data-table-selected-bg, rgba(59, 130, 246, 0.1));
}

:host-context(.dark) .data-table-row.selected {
  --ui-data-table-selected-bg: rgba(59, 130, 246, 0.2);
}
```

2. Update renderRow to add 'selected' class when row is selected:
```typescript
private renderRow(row: Row<TData>, rowIndex: number): TemplateResult {
  const isSelected = row.getIsSelected();

  return html`
    <div
      role="row"
      aria-rowindex="${rowIndex + 2}"
      aria-selected="${isSelected}"
      class="data-table-row ${isSelected ? 'selected' : ''}"
      data-row-id="${row.id}"
    >
      ${row.getVisibleCells().map((cell, colIndex) =>
        this.renderCell(cell, rowIndex, colIndex)
      )}
    </div>
  `;
}
```

3. Update renderVirtualizedBody similarly to add selected class and aria-selected.

4. Ensure checkbox receives keyboard focus when navigating to selection column cell.
   The lui-checkbox should already be focusable. Grid navigation should allow Enter/Space
   to toggle checkbox when cell is focused (lui-checkbox handles this internally).
  </action>
  <verify>
1. Build: `cd packages/data-table && pnpm build`
2. Visual check:
   - Selected rows have subtle highlight color
   - Keyboard navigation to checkbox column works
   - Enter/Space on checkbox cell toggles selection
   - Screen reader announces aria-selected state
  </verify>
  <done>
- Selected rows have visual highlight
- aria-selected attribute on selected rows
- Checkbox keyboard accessible via grid navigation
- Selection persists across page changes (handled by TanStack + rowIdKey)
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Selection column appears when enabled:**
   - Set enable-selection attribute
   - Checkbox column is first column
   - 48px fixed width, no sorting/filtering

2. **Individual row selection:**
   - Click row checkbox -> row selected, highlight visible
   - Click again -> deselected
   - ui-selection-change event fires with updated selection

3. **Header select-all:**
   - No rows selected -> header unchecked
   - Some rows selected -> header indeterminate
   - All page rows selected -> header checked
   - Click header -> toggles all page rows

4. **Selection persistence:**
   - Select rows on page 1
   - Navigate to page 2 (when pagination added in Phase 63)
   - Navigate back to page 1
   - Selection still present

5. **Accessibility:**
   - aria-selected on selected rows
   - Checkboxes have aria-label
   - Keyboard navigation works
</verification>

<success_criteria>
1. SEL-01: Row selection checkbox column is optionally enabled (via enable-selection attribute)
2. SEL-02: Header checkbox selects/deselects all rows on current page (with indeterminate state)
3. SEL-05: Selection state is maintained across pagination (via row IDs, not indices)
</success_criteria>

<output>
After completion, create `.planning/phases/62-sorting-&-selection/62-02-SUMMARY.md`
</output>
