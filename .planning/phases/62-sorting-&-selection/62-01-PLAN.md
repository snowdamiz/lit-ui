---
phase: 62-sorting-selection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/data-table/src/data-table.ts
  - packages/data-table/src/types.ts
autonomous: true

must_haves:
  truths:
    - "User can click column header to sort ascending, click again for descending"
    - "User sees arrow indicator showing current sort direction"
    - "User can Shift+click additional columns for multi-column sort with priority numbers"
    - "Server-side sorting emits sort state via event when manual mode enabled"
  artifacts:
    - path: "packages/data-table/src/data-table.ts"
      provides: "Sorting integration with TanStack getSortedRowModel"
      contains: "getSortedRowModel"
    - path: "packages/data-table/src/types.ts"
      provides: "SortChangeEvent type definition"
      contains: "SortChangeEvent"
  key_links:
    - from: "packages/data-table/src/data-table.ts"
      to: "TanStack Table sorting"
      via: "column.getToggleSortingHandler()"
      pattern: "getToggleSortingHandler"
    - from: "packages/data-table/src/data-table.ts"
      to: "aria-sort attribute"
      via: "column.getIsSorted()"
      pattern: "aria-sort"
---

<objective>
Add sorting capabilities to lui-data-table using TanStack Table's built-in sorting APIs.

Purpose: Users need to sort table data by clicking column headers, with visual indicators and multi-sort support via Shift+click.

Output:
- Sortable column headers with click handlers
- Sort direction indicators (arrows) with multi-sort priority numbers
- aria-sort attributes for accessibility
- Server-side sorting support via manual mode
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/62-sorting-&-selection/62-RESEARCH.md
@packages/data-table/src/data-table.ts
@packages/data-table/src/types.ts
@packages/data-table/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sorting state and TanStack integration</name>
  <files>
    packages/data-table/src/data-table.ts
    packages/data-table/src/types.ts
  </files>
  <action>
Update the DataTable component to integrate TanStack Table sorting:

1. In types.ts, add SortChangeEvent interface:
```typescript
export interface SortChangeEvent {
  /** Current sorting state array */
  sorting: SortingState;
  /** Helper format for REST APIs */
  sortParams: Array<{ column: string; direction: 'asc' | 'desc' }>;
}
```

2. In data-table.ts:
   - Import getSortedRowModel from @tanstack/lit-table
   - Add properties:
     - `sorting: SortingState = []` (reactive array property)
     - `manualSorting = false` (boolean attribute 'manual-sorting')
   - Update tableController.table() call to include:
     - `state: { sorting: this.sorting }`
     - `onSortingChange` callback that updates this.sorting and emits 'ui-sort-change' event
     - `getSortedRowModel: this.manualSorting ? undefined : getSortedRowModel()`
     - `manualSorting: this.manualSorting`

3. Create dispatchCustomEvent helper if not exists:
```typescript
private dispatchSortChange(sorting: SortingState): void {
  const event = new CustomEvent('ui-sort-change', {
    detail: {
      sorting,
      sortParams: sorting.map(s => ({
        column: s.id,
        direction: s.desc ? 'desc' : 'asc',
      })),
    },
    bubbles: true,
    composed: true,
  });
  this.dispatchEvent(event);
}
```

Note: TanStack's getToggleSortingHandler() automatically handles Shift+click for multi-sort.
  </action>
  <verify>
Run TypeScript compilation: `cd packages/data-table && pnpm build`
Verify no type errors related to sorting state or event types.
  </verify>
  <done>
DataTable has sorting property, manualSorting property, and emits ui-sort-change events.
TanStack getSortedRowModel integrated for client-side sorting.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add sortable header cells with click handlers and indicators</name>
  <files>
    packages/data-table/src/data-table.ts
  </files>
  <action>
Update renderHeaderCell method to support sorting:

1. Add renderSortIndicator method:
```typescript
private renderSortIndicator(
  direction: false | 'asc' | 'desc',
  sortIndex: number
): TemplateResult {
  const showPriority = sortIndex > 0; // Show for secondary+ sorts

  return html`
    <span class="sort-indicator" aria-hidden="true">
      ${direction === 'asc' ? html`
        <svg viewBox="0 0 12 12" class="sort-icon">
          <path d="M6 3L10 9H2L6 3Z" fill="currentColor"/>
        </svg>
      ` : direction === 'desc' ? html`
        <svg viewBox="0 0 12 12" class="sort-icon">
          <path d="M6 9L2 3H10L6 9Z" fill="currentColor"/>
        </svg>
      ` : html`
        <svg viewBox="0 0 12 12" class="sort-icon unsorted">
          <path d="M6 2L9 5H3L6 2ZM6 10L3 7H9L6 10Z" fill="currentColor" opacity="0.3"/>
        </svg>
      `}
      ${showPriority ? html`<span class="sort-priority">${sortIndex + 1}</span>` : nothing}
    </span>
  `;
}
```

2. Update renderHeaderCell to:
   - Get canSort from header.column.getCanSort()
   - Get sortDirection from header.column.getIsSorted() (returns false | 'asc' | 'desc')
   - Get sortIndex from header.column.getSortIndex() (-1 if not sorted, 0+ for priority)
   - Add aria-sort attribute (only on primary sorted column, sortIndex === 0):
     - 'ascending' if direction === 'asc' && sortIndex === 0
     - 'descending' if direction === 'desc' && sortIndex === 0
     - Remove attribute otherwise (use nothing directive)
   - Add @click handler: canSort ? header.column.getToggleSortingHandler() : nothing
   - Add 'sortable' class when canSort is true
   - Add cursor:pointer visual styling for sortable headers
   - Render sort indicator after header content

3. Add CSS for sortable headers (in static styles):
```css
.data-table-header-cell.sortable {
  cursor: pointer;
  user-select: none;
}

.data-table-header-cell.sortable:hover {
  background: var(--ui-data-table-header-hover-bg, rgba(0, 0, 0, 0.05));
}

.data-table-header-cell.sortable:focus-visible {
  outline: 2px solid var(--color-primary, #3b82f6);
  outline-offset: -2px;
  border-radius: 2px;
}

:host-context(.dark) .data-table-header-cell.sortable:hover {
  --ui-data-table-header-hover-bg: rgba(255, 255, 255, 0.05);
}

.sort-indicator {
  display: inline-flex;
  align-items: center;
  gap: 2px;
  margin-left: 4px;
}

.sort-icon {
  width: 12px;
  height: 12px;
}

.sort-icon.unsorted {
  opacity: 0.3;
}

.sort-priority {
  font-size: 10px;
  font-weight: 600;
  min-width: 14px;
  height: 14px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: var(--color-primary, #3b82f6);
  color: var(--color-primary-foreground, #ffffff);
  border-radius: 50%;
}
```

Important: Only set aria-sort on the PRIMARY sorted column (sortIndex === 0) to avoid confusing screen readers.
  </action>
  <verify>
1. Build: `cd packages/data-table && pnpm build`
2. Visual check in docs dev server:
   - Run `pnpm dev` in apps/docs
   - Navigate to data table demo
   - Click column header to sort - should see arrow change direction
   - Shift+click second column - should see priority numbers (1, 2)
  </verify>
  <done>
- Column headers are clickable for sorting with visual feedback
- Sort direction arrows display correctly (up for asc, down for desc)
- Multi-sort shows numbered priority indicators
- aria-sort attribute set on primary sorted column only
- Sortable headers have hover/focus styles
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Client-side sorting works:**
   - Click column header -> sorts ascending
   - Click again -> sorts descending
   - Click third time -> removes sort (if enableSortingRemoval is true, default)

2. **Multi-sort works:**
   - Click column A -> arrow shows, no priority number
   - Shift+click column B -> both have arrows, B shows "2" badge
   - Shift+click column C -> A shows "1", B shows "2", C shows "3"

3. **Server-side mode works:**
   - Set manual-sorting attribute
   - Listen for ui-sort-change event
   - Event detail includes sorting array and sortParams helper

4. **Accessibility:**
   - Primary sorted column has aria-sort="ascending" or "descending"
   - Secondary sorted columns do NOT have aria-sort (to avoid confusion)
   - Sortable headers are keyboard accessible via Enter/Space
</verification>

<success_criteria>
1. SORT-01: User can click column header to sort by that column (asc/desc toggle)
2. SORT-02: Sort indicator (arrow) shows current sort direction
3. SORT-03: User can Shift+click additional columns for multi-column sort
4. SORT-04: Multi-column sort shows priority numbers on sorted columns
5. SORT-05: Server-side sorting passes sort state to data callback when manual mode enabled
</success_criteria>

<output>
After completion, create `.planning/phases/62-sorting-&-selection/62-01-SUMMARY.md`
</output>
