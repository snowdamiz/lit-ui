---
phase: 33-select-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/select/src/option.ts
  - packages/select/src/select.ts
  - packages/select/src/index.ts
  - packages/select/src/jsx.d.ts
autonomous: true

must_haves:
  truths:
    - "Developer uses slotted lui-option elements and Select renders them correctly"
    - "Developer can add icons via start/end slots in lui-option"
    - "Developer can add descriptions via description slot in lui-option"
    - "Existing options property still works (backwards compatibility)"
    - "Keyboard navigation works with slotted options"
    - "Type-ahead search works with slotted options"
  artifacts:
    - path: "packages/select/src/option.ts"
      provides: "Enhanced Option component with named slots"
      contains: "slot name=\"start\""
    - path: "packages/select/src/select.ts"
      provides: "Select with slot support"
      contains: "@slotchange"
    - path: "packages/select/src/index.ts"
      provides: "lui-option registration"
      contains: "lui-option"
  key_links:
    - from: "packages/select/src/select.ts"
      to: "packages/select/src/option.ts"
      via: "slotchange event and Option type import"
      pattern: "handleSlotChange.*assignedElements"
---

<objective>
Enable slot-based custom content in Select options by enhancing lui-option with named slots and updating Select to render slotted children alongside or instead of the options property.

Purpose: SELECT-14 requires icons and descriptions in options. This requires transitioning from property-only to slot-based rendering while maintaining backwards compatibility.

Output: Enhanced lui-option component registered as custom element with start, end, and description slots. Select component detects and renders slotted options with working keyboard navigation.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-select-enhancements/33-RESEARCH.md
@packages/select/src/option.ts
@packages/select/src/select.ts
@packages/select/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance lui-option with named slots for custom content</name>
  <files>packages/select/src/option.ts</files>
  <action>
Enhance the Option component to support custom content via named slots:

1. Add `getLabel()` method that returns `this.label || this.textContent?.trim() || this.value`

2. Update render() to include slot structure:
   - `<span class="slot-start"><slot name="start"></slot></span>` before label
   - `<span class="option-content">` wrapping:
     - `<span class="option-label">${this.label || html\`<slot></slot>\`}</span>`
     - `<slot name="description"></slot>` below label
   - `<span class="slot-end"><slot name="end"></slot></span>` after content

3. Add CSS for slot containers:
   ```css
   .slot-start, .slot-end {
     display: flex;
     align-items: center;
     flex-shrink: 0;
   }

   .option-content {
     flex: 1;
     min-width: 0;
     display: flex;
     flex-direction: column;
   }

   .option-label {
     overflow: hidden;
     text-overflow: ellipsis;
     white-space: nowrap;
   }

   ::slotted([slot="start"]), ::slotted([slot="end"]) {
     width: 1.25em;
     height: 1.25em;
   }

   ::slotted([slot="description"]) {
     font-size: 0.75rem;
     color: var(--ui-select-option-text-disabled);
     overflow: hidden;
     text-overflow: ellipsis;
     white-space: nowrap;
   }
   ```

4. Update .option flex layout: `display: flex; align-items: center; gap: 0.5rem;`

5. Keep existing properties (value, label, disabled, selected) and getId() method unchanged.
  </action>
  <verify>
Build succeeds: `cd /Users/sn0w/Documents/dev/lit-components && pnpm build --filter @lit-ui/select`

TypeScript compiles without errors.
  </verify>
  <done>
lui-option component has start, end, and description slots rendering correctly. Check icon placement renders in slot-start, label in option-content, description below label.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Select to support slotted lui-option children</name>
  <files>packages/select/src/select.ts</files>
  <action>
Modify Select to detect and render slotted lui-option elements while maintaining options property support:

1. Import Option type at top of file:
   ```typescript
   import { Option } from './option.js';
   ```

2. Add state for tracking slotted options:
   ```typescript
   @state()
   private slottedOptions: Option[] = [];
   ```

3. Add slot change handler method:
   ```typescript
   private handleSlotChange(e: Event): void {
     const slot = e.target as HTMLSlotElement;
     this.slottedOptions = slot
       .assignedElements({ flatten: true })
       .filter((el): el is Option => el.tagName === 'LUI-OPTION');

     // Sync selected state to slotted options
     this.syncSlottedOptionStates();
     this.requestUpdate();
   }

   private syncSlottedOptionStates(): void {
     this.slottedOptions.forEach(opt => {
       opt.selected = opt.value === this.value;
     });
   }
   ```

4. Create unified option getter for keyboard navigation:
   ```typescript
   private getAllOptions(): Array<{ value: string; label: string; disabled: boolean; element?: Option }> {
     // If options property has items, use those (backwards compatible)
     if (this.options.length > 0) {
       return this.options.map(o => ({
         value: o.value,
         label: o.label,
         disabled: o.disabled || false,
       }));
     }

     // Otherwise use slotted options
     return this.slottedOptions.map(opt => ({
       value: opt.value,
       label: opt.getLabel(),
       disabled: opt.disabled,
       element: opt,
     }));
   }
   ```

5. Update all methods that use `this.options` to use `this.getAllOptions()`:
   - `openDropdown()`: `const allOpts = this.getAllOptions(); const selectedIdx = allOpts.findIndex(...)`
   - `findFirstEnabledIndex()`: use getAllOptions()
   - `focusFirstEnabledOption()`, `focusLastEnabledOption()`: use getAllOptions()
   - `focusNextEnabledOption()`, `focusPreviousEnabledOption()`: use getAllOptions()
   - `findTypeaheadMatch()`: use getAllOptions() for search
   - `selectOption()`: get from getAllOptions(), sync to slotted element if present
   - `getSelectedLabel()`: use getAllOptions()
   - `getActiveOptionLabel()`, `getEnabledOptionsCount()`: use getAllOptions()

6. Update selectOption to handle slotted options:
   ```typescript
   private selectOption(index: number): void {
     const allOptions = this.getAllOptions();
     const option = allOptions[index];
     if (!option || option.disabled) return;

     this.value = option.value;

     // Sync selected state to slotted options
     if (this.slottedOptions.length > 0) {
       this.syncSlottedOptionStates();
     }

     // Update form value
     this.internals?.setFormValue(this.value);
     // ... rest unchanged
   }
   ```

7. Update render() to conditionally render based on options source:
   - If `this.options.length > 0`: render inline options (current behavior)
   - Otherwise: render `<slot @slotchange=${this.handleSlotChange}></slot>`

8. Update active index handling for slotted options:
   - When slotted, set `data-active="true"` attribute on active option element
   - Add CSS: `::slotted([data-active="true"]) { background-color: var(--ui-select-option-bg-active); }`
  </action>
  <verify>
Build succeeds: `pnpm build --filter @lit-ui/select`

Manual test in demo app shows:
1. Options via property still works
2. Slotted lui-option elements render and are selectable
3. Keyboard navigation works with slotted options
4. Type-ahead works with slotted options
  </verify>
  <done>
Select renders slotted lui-option children with full keyboard navigation. Options property still works unchanged for backwards compatibility.
  </done>
</task>

<task type="auto">
  <name>Task 3: Register lui-option and update TypeScript types</name>
  <files>packages/select/src/index.ts, packages/select/src/jsx.d.ts</files>
  <action>
Register lui-option custom element and update TypeScript declarations:

1. Update index.ts:
   - Export Option class: `export { Option } from './option.js';`
   - Add registration for lui-option:
   ```typescript
   import { Option } from './option.js';

   // After lui-select registration block:
   if (typeof customElements !== 'undefined') {
     if (!customElements.get('lui-option')) {
       customElements.define('lui-option', Option);
     } else if (!isServer && import.meta.env?.DEV) {
       console.warn('[lui-option] Custom element already registered.');
     }
   }
   ```
   - Add to global HTMLElementTagNameMap:
   ```typescript
   declare global {
     interface HTMLElementTagNameMap {
       'lui-select': Select;
       'lui-option': Option;
     }
   }
   ```

2. Update jsx.d.ts to add lui-option JSX type:
   ```typescript
   interface LuiOptionAttributes {
     value?: string;
     label?: string;
     disabled?: boolean;
     selected?: boolean;
     children?: any;
   }
   ```
   Add to JSX.IntrinsicElements: `'lui-option': LuiOptionAttributes;`
  </action>
  <verify>
Build succeeds: `pnpm build --filter @lit-ui/select`

TypeScript recognizes:
- `<lui-option>` element type
- Option class exported from package
  </verify>
  <done>
lui-option is registered as custom element. TypeScript types include lui-option in HTMLElementTagNameMap and JSX.IntrinsicElements.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build: `pnpm build --filter @lit-ui/select` passes
2. Type check: `pnpm exec tsc --noEmit -p packages/select` passes
3. Custom elements registered: lui-select and lui-option both defined
4. Slotted usage works:
   ```html
   <lui-select>
     <lui-option value="email">
       <svg slot="start">...</svg>
       Email
       <span slot="description">Via email notification</span>
     </lui-option>
   </lui-select>
   ```
5. Property usage still works: `<lui-select .options=${[{value: 'a', label: 'A'}]}>`
6. Keyboard navigation works with slotted options
7. Type-ahead search finds slotted options by label/textContent
</verification>

<success_criteria>
- lui-option registered and renderable with slots
- Select accepts both options property AND slotted children
- Keyboard navigation and type-ahead work with slotted options
- Custom content (icons, descriptions) render in correct positions
- Full backwards compatibility with options property API
</success_criteria>

<output>
After completion, create `.planning/phases/33-select-enhancements/33-01-SUMMARY.md`
</output>
