---
phase: 33-select-enhancements
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/select/src/option-group.ts
  - packages/select/src/select.ts
  - packages/select/src/index.ts
  - packages/select/src/jsx.d.ts
autonomous: true

must_haves:
  truths:
    - "Developer wraps options in lui-option-group with label prop and group header displays"
    - "Screen reader announces group label when navigating into group"
    - "Keyboard navigation skips group labels (only stops on options)"
    - "Multiple groups display with visual separation"
  artifacts:
    - path: "packages/select/src/option-group.ts"
      provides: "OptionGroup component"
      contains: "role=\"group\""
    - path: "packages/select/src/index.ts"
      provides: "lui-option-group registration"
      contains: "lui-option-group"
  key_links:
    - from: "packages/select/src/option-group.ts"
      to: "W3C APG grouped listbox pattern"
      via: "aria-labelledby on group element"
      pattern: "aria-labelledby"
---

<objective>
Create lui-option-group component for organizing options under labeled headers with proper ARIA grouping per W3C APG listbox grouped options pattern.

Purpose: SELECT-13 and A11Y-05 require option groups with headers that screen readers announce correctly. Groups use role="group" with aria-labelledby referencing the group label.

Output: New lui-option-group component that wraps lui-option children with proper ARIA structure. Visual separation between groups.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-select-enhancements/33-RESEARCH.md
@packages/select/src/select.ts
@packages/select/src/option.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lui-option-group component</name>
  <files>packages/select/src/option-group.ts</files>
  <action>
Create the OptionGroup component following W3C APG grouped listbox pattern:

```typescript
/**
 * lui-option-group - Groups related options under a labeled header
 *
 * Follows W3C APG listbox with grouped options pattern.
 * Uses role="group" with aria-labelledby for accessibility.
 * Group labels are presentational and not focusable via keyboard.
 *
 * @example
 * <lui-select>
 *   <lui-option-group label="Fruits">
 *     <lui-option value="apple">Apple</lui-option>
 *     <lui-option value="banana">Banana</lui-option>
 *   </lui-option-group>
 * </lui-select>
 */
import { html, css, nothing } from 'lit';
import { property } from 'lit/decorators.js';
import { TailwindElement, tailwindBaseStyles } from '@lit-ui/core';

/**
 * Groups options under a labeled header with proper ARIA structure.
 */
export class OptionGroup extends TailwindElement {
  /**
   * Label text displayed as the group header.
   * Screen readers will announce this when entering the group.
   * @default ''
   */
  @property({ type: String })
  label = '';

  /**
   * Unique ID for aria-labelledby reference.
   */
  private groupId = `lui-option-group-${Math.random().toString(36).substr(2, 9)}`;

  static override styles = [
    ...tailwindBaseStyles,
    css`
      :host {
        display: block;
      }

      /* Visual separator between groups (not on first group) */
      :host(:not(:first-child)) {
        border-top: 1px solid var(--ui-select-dropdown-border);
        margin-top: 0.25rem;
        padding-top: 0.25rem;
      }

      /* Group label styling - uppercase, smaller, muted */
      .group-label {
        padding: 0.375rem var(--ui-select-option-padding-x, 0.75rem);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--ui-select-option-text-disabled);
        user-select: none;
        pointer-events: none;
      }

      /* Container for options */
      .group-content {
        display: block;
      }
    `,
  ];

  override render() {
    return html`
      <div role="group" aria-labelledby=${this.label ? this.groupId : nothing}>
        ${this.label
          ? html`
              <div
                id=${this.groupId}
                class="group-label"
                role="presentation"
                aria-hidden="true"
              >
                ${this.label}
              </div>
            `
          : nothing}
        <div class="group-content">
          <slot></slot>
        </div>
      </div>
    `;
  }
}
```

Key implementation notes:
- `role="group"` with `aria-labelledby` per W3C APG
- Group label has `role="presentation"` and `aria-hidden="true"` (screen readers read via aria-labelledby)
- Group label has `pointer-events: none` - not interactive
- Visual separator via `:host(:not(:first-child))` border
- Slot for lui-option children
  </action>
  <verify>
File created at packages/select/src/option-group.ts

Build succeeds: `pnpm build --filter @lit-ui/select`
  </verify>
  <done>
OptionGroup component created with role="group", aria-labelledby, presentation label, and visual separator styling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register lui-option-group and update TypeScript types</name>
  <files>packages/select/src/index.ts, packages/select/src/jsx.d.ts</files>
  <action>
Register lui-option-group and add TypeScript declarations:

1. Update index.ts:
   - Add export: `export { OptionGroup } from './option-group.js';`
   - Add registration (after lui-option registration):
   ```typescript
   import { OptionGroup } from './option-group.js';

   if (typeof customElements !== 'undefined') {
     if (!customElements.get('lui-option-group')) {
       customElements.define('lui-option-group', OptionGroup);
     } else if (!isServer && import.meta.env?.DEV) {
       console.warn('[lui-option-group] Custom element already registered.');
     }
   }
   ```
   - Add to global HTMLElementTagNameMap:
   ```typescript
   'lui-option-group': OptionGroup;
   ```

2. Update jsx.d.ts:
   - Add interface:
   ```typescript
   interface LuiOptionGroupAttributes {
     label?: string;
     children?: any;
   }
   ```
   - Add to JSX.IntrinsicElements:
   ```typescript
   'lui-option-group': LuiOptionGroupAttributes;
   ```
  </action>
  <verify>
Build succeeds: `pnpm build --filter @lit-ui/select`

TypeScript recognizes lui-option-group element type.
  </verify>
  <done>
lui-option-group registered as custom element with proper TypeScript types.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Select slotted option detection to include groups</name>
  <files>packages/select/src/select.ts</files>
  <action>
Update Select to detect options inside lui-option-group elements:

1. Import OptionGroup:
   ```typescript
   import { OptionGroup } from './option-group.js';
   ```

2. Update handleSlotChange to find options inside groups:
   ```typescript
   private handleSlotChange(e: Event): void {
     const slot = e.target as HTMLSlotElement;
     const assigned = slot.assignedElements({ flatten: true });

     // Collect options - both direct children and inside groups
     const options: Option[] = [];

     for (const el of assigned) {
       if (el.tagName === 'LUI-OPTION') {
         options.push(el as Option);
       } else if (el.tagName === 'LUI-OPTION-GROUP') {
         // Find options inside the group
         const groupOptions = el.querySelectorAll('lui-option');
         groupOptions.forEach(opt => options.push(opt as Option));
       }
     }

     this.slottedOptions = options;
     this.syncSlottedOptionStates();
     this.requestUpdate();
   }
   ```

3. The keyboard navigation already works because:
   - We navigate through `slottedOptions` array which only contains lui-option elements
   - Group labels are not in this array, so they're skipped automatically
   - aria-activedescendant points to option IDs, not group labels

4. Add mutation observer to detect dynamically added options inside groups:
   ```typescript
   private mutationObserver: MutationObserver | null = null;

   override connectedCallback(): void {
     super.connectedCallback();
     if (!isServer) {
       document.addEventListener('click', this.handleDocumentClick);
       // ... existing code ...

       // Observe for dynamic option changes inside groups
       this.mutationObserver = new MutationObserver(() => {
         this.updateComplete.then(() => {
           // Re-query slotted options when children change
           const slot = this.shadowRoot?.querySelector('slot:not([name])') as HTMLSlotElement;
           if (slot) {
             this.handleSlotChange({ target: slot } as Event);
           }
         });
       });
       this.mutationObserver.observe(this, { childList: true, subtree: true });
     }
   }

   override disconnectedCallback(): void {
     super.disconnectedCallback();
     if (!isServer) {
       document.removeEventListener('click', this.handleDocumentClick);
       // ... existing cleanup ...
       this.mutationObserver?.disconnect();
       this.mutationObserver = null;
     }
   }
   ```

Note: Keep this simple - the mutation observer is a safety net for dynamic content. The main detection path is via slotchange.
  </action>
  <verify>
Build succeeds: `pnpm build --filter @lit-ui/select`

Test that grouped options work:
```html
<lui-select>
  <lui-option-group label="Fruits">
    <lui-option value="apple">Apple</lui-option>
  </lui-option-group>
  <lui-option-group label="Vegetables">
    <lui-option value="carrot">Carrot</lui-option>
  </lui-option-group>
</lui-select>
```

Keyboard navigation skips group headers, moves between options only.
  </verify>
  <done>
Select detects options inside lui-option-group elements. Keyboard navigation works correctly, skipping group headers.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build: `pnpm build --filter @lit-ui/select` passes
2. lui-option-group registered as custom element
3. Groups display with label headers and visual separators
4. ARIA structure correct:
   - Group has role="group" with aria-labelledby
   - Label has aria-hidden="true" and role="presentation"
5. Keyboard navigation skips group labels, only stops on options
6. Screen reader (VoiceOver) announces group name when navigating into group
</verification>

<success_criteria>
- lui-option-group component exists with proper ARIA structure
- Visual grouping with headers and separators
- Keyboard navigation skips group labels
- Screen readers announce group labels via aria-labelledby
- Options inside groups are selectable
</success_criteria>

<output>
After completion, create `.planning/phases/33-select-enhancements/33-02-SUMMARY.md`
</output>
