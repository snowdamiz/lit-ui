---
phase: 33-select-enhancements
plan: 03
type: execute
wave: 2
depends_on: ["33-01", "33-02"]
files_modified:
  - packages/select/src/select.ts
autonomous: true

must_haves:
  truths:
    - "User clicks X button on clearable select and selection resets to empty state"
    - "User can Tab to clear button and activate with Enter or Space"
    - "Screen reader announces clear button as 'Clear selection' button"
    - "Clear button only appears when value is selected"
    - "Clicking clear button does not open dropdown"
  artifacts:
    - path: "packages/select/src/select.ts"
      provides: "Clearable select functionality"
      contains: "clearable"
  key_links:
    - from: "packages/select/src/select.ts"
      to: "Input component clear pattern"
      via: "Same clear button UX pattern"
      pattern: "handleClear.*stopPropagation"
---

<objective>
Add clearable prop to Select component with an X button that resets selection to empty/placeholder state, following the existing Input component's clear button pattern.

Purpose: SELECT-15 requires users to clear their selection without needing to find a "None" option. Clear button must be keyboard accessible and not trigger the dropdown.

Output: Select has `clearable` boolean prop. When true and a value is selected, X button appears that clears selection on click/Enter/Space without opening dropdown.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-select-enhancements/33-RESEARCH.md
@.planning/phases/33-select-enhancements/33-01-SUMMARY.md
@.planning/phases/33-select-enhancements/33-02-SUMMARY.md
@packages/select/src/select.ts
@packages/input/src/input.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add clearable prop and clear button to Select</name>
  <files>packages/select/src/select.ts</files>
  <action>
Implement clearable functionality following the Input component pattern:

1. Add clearable property:
   ```typescript
   /**
    * Whether to show a clear button when a value is selected.
    * @default false
    */
   @property({ type: Boolean })
   clearable = false;
   ```

2. Add X circle icon as a private property (same as Input uses):
   ```typescript
   private xCircleIcon = html`
     <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
     <line x1="15" y1="9" x2="9" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
     <line x1="9" y1="9" x2="15" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
   `;
   ```

3. Add handleClear method:
   ```typescript
   /**
    * Handle clear button click - reset value without opening dropdown.
    */
   private handleClear(e: Event): void {
     e.stopPropagation(); // Don't open dropdown
     e.preventDefault();

     this.value = '';

     // Reset selected state on slotted options
     if (this.slottedOptions.length > 0) {
       this.slottedOptions.forEach(opt => {
         opt.selected = false;
       });
     }

     // Update form value
     this.internals?.setFormValue('');

     // Validate after clearing
     if (this.touched) {
       const isValid = this.validate();
       this.showError = !isValid;
     }

     // Dispatch change and clear events
     this.dispatchEvent(new CustomEvent('clear', {
       bubbles: true,
       composed: true,
     }));
     this.dispatchEvent(new CustomEvent('change', {
       detail: { value: '' },
       bubbles: true,
       composed: true,
     }));

     // Focus trigger after clearing
     this.triggerEl?.focus();
   }
   ```

4. Add renderClearButton method:
   ```typescript
   /**
    * Render the clear button if clearable and value is set.
    */
   private renderClearButton() {
     if (!this.clearable || !this.value || this.disabled) return nothing;

     return html`
       <button
         type="button"
         class="clear-button"
         aria-label="Clear selection"
         tabindex="-1"
         @click=${this.handleClear}
         @mousedown=${(e: MouseEvent) => e.preventDefault()}
       >
         <svg viewBox="0 0 24 24" aria-hidden="true" class="clear-icon">
           ${this.xCircleIcon}
         </svg>
       </button>
     `;
   }
   ```

   Note: `tabindex="-1"` keeps clear button out of tab order (trigger handles all keyboard interaction). `mousedown preventDefault` prevents focus shift.

5. Add CSS for clear button (in static styles):
   ```css
   /* Clear button styling */
   .clear-button {
     display: flex;
     align-items: center;
     justify-content: center;
     padding: 0.125rem;
     border: none;
     background: transparent;
     color: var(--ui-select-placeholder);
     cursor: pointer;
     border-radius: var(--radius-sm, 0.25rem);
     transition: color 150ms, background-color 150ms;
     flex-shrink: 0;
   }

   .clear-button:hover {
     color: var(--ui-select-text);
     background-color: var(--color-muted, rgba(0, 0, 0, 0.05));
   }

   .clear-button:focus-visible {
     outline: 2px solid var(--ui-select-ring);
     outline-offset: 1px;
   }

   .clear-icon {
     width: 1em;
     height: 1em;
   }

   /* Trigger actions container */
   .trigger-actions {
     display: flex;
     align-items: center;
     gap: 0.25rem;
     flex-shrink: 0;
   }
   ```

6. Update trigger render to include clear button:
   ```typescript
   // In render(), update the trigger structure:
   <div class=${this.getTriggerClasses()} ...>
     ${selectedLabel
       ? html`<span class="selected-value">${selectedLabel}</span>`
       : html`<span class="placeholder">${this.placeholder}</span>`}

     <div class="trigger-actions">
       ${this.renderClearButton()}
       <svg class="chevron ${this.open ? 'chevron-open' : ''}" ...>
         <!-- existing chevron -->
       </svg>
     </div>
   </div>
   ```
  </action>
  <verify>
Build succeeds: `pnpm build --filter @lit-ui/select`

Manual verification:
1. `<lui-select clearable .options=${options}></lui-select>` shows X when value selected
2. Clicking X clears value, shows placeholder, dispatches events
3. Clicking X does NOT open dropdown
4. X button hidden when no value or when disabled
5. Keyboard: Tab to select, type to select value, X appears visually
  </verify>
  <done>
Clearable select implemented with X button that:
- Appears only when clearable=true and value is set
- Clears value on click without opening dropdown
- Dispatches 'clear' and 'change' events
- Focuses trigger after clearing
- Styled consistently with Input component
  </done>
</task>

<task type="auto">
  <name>Task 2: Add keyboard handling for clear button accessibility</name>
  <files>packages/select/src/select.ts</files>
  <action>
Enhance keyboard handling to support clearing via keyboard when focused on trigger:

1. Add Delete/Backspace handling in handleKeydown (closed state):
   ```typescript
   // In handleKeydown, closed state switch:
   case 'Delete':
   case 'Backspace':
     if (this.clearable && this.value) {
       e.preventDefault();
       this.handleClear(e);
     }
     break;
   ```

   This allows users to press Delete or Backspace while focused on the trigger to clear the selection (only if clearable is enabled).

2. Verify ARIA is correct:
   - Clear button has `aria-label="Clear selection"`
   - Button is `type="button"` (not submit)
   - Button has `tabindex="-1"` (not in tab order - trigger handles it)

3. Test flow:
   - Tab to select
   - Press Space/Enter to open, arrow to option, Enter to select
   - Press Delete or Backspace to clear
   - Value clears, placeholder shows

Note: We keep clear button out of tab order (`tabindex="-1"`) because the trigger element handles all keyboard interaction. This follows the pattern where combobox/select trigger is the single focusable element. Delete/Backspace provide the keyboard clear mechanism.
  </action>
  <verify>
Build succeeds: `pnpm build --filter @lit-ui/select`

Keyboard test:
1. Tab to clearable select with value
2. Press Backspace or Delete
3. Value clears, placeholder shows
4. 'clear' and 'change' events fire
  </verify>
  <done>
Clearable select fully keyboard accessible via Delete/Backspace keys. Clear button has proper ARIA label for screen readers.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build: `pnpm build --filter @lit-ui/select` passes
2. Clearable prop works:
   - `<lui-select clearable>` shows X when value set
   - X hidden when no value or disabled
3. Clear functionality:
   - Click X clears value, shows placeholder
   - Dropdown does NOT open when clicking X
   - Delete/Backspace clear when focused on trigger
4. Events:
   - 'clear' event dispatched
   - 'change' event dispatched with empty value
5. Form integration:
   - Form value updated to empty string
   - Validation runs after clear
6. Accessibility:
   - Screen reader announces "Clear selection" button
   - Keyboard users can clear via Delete/Backspace
</verification>

<success_criteria>
- clearable prop enables clear button
- Clear button appears only when value is set
- Click/Enter/Space on button clears selection
- Delete/Backspace on trigger clears selection
- Clicking clear does NOT open dropdown
- Events dispatched correctly
- Screen reader announces clear button
</success_criteria>

<output>
After completion, create `.planning/phases/33-select-enhancements/33-03-SUMMARY.md`
</output>
