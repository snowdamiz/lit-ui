---
phase: 34-multi-select
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/select/src/select.ts
  - packages/select/src/option.ts
autonomous: true

must_haves:
  truths:
    - "User can select multiple options and all selections are tracked"
    - "Dropdown stays open after selecting an option in multi-select mode"
    - "Form submission sends multiple values via FormData.getAll()"
    - "Options show checkbox indicators in multi-select mode"
  artifacts:
    - path: "packages/select/src/select.ts"
      provides: "Multi-select mode with multiple prop"
      contains: "multiple"
    - path: "packages/select/src/option.ts"
      provides: "Checkbox indicator rendering"
      contains: "checkbox"
  key_links:
    - from: "packages/select/src/select.ts"
      to: "ElementInternals.setFormValue"
      via: "FormData.append for each value"
      pattern: "formData\\.append"
---

<objective>
Implement core multi-select functionality with mode switching, selection tracking, and form participation.

Purpose: Enable users to select multiple values from a dropdown with proper form submission, establishing the foundation for tag display and overflow handling in subsequent plans.

Output: Working multi-select mode that tracks multiple selections, submits via FormData.append(), and shows checkbox indicators on options.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-multi-select/34-CONTEXT.md
@.planning/phases/34-multi-select/34-RESEARCH.md
@packages/select/src/select.ts
@packages/select/src/option.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add multiple prop and selection tracking to Select</name>
  <files>packages/select/src/select.ts</files>
  <action>
Add multi-select mode to the Select component:

1. Add `multiple` boolean prop (default false, reflects to attribute)
2. Add `selectedValues: Set<string>` state for tracking multi-selections
3. Add `maxSelections` optional number prop for limiting selections

4. Update value getter/setter to return string[] in multi-select mode:
   ```typescript
   get value(): string | string[] {
     if (this.multiple) {
       return Array.from(this.selectedValues);
     }
     return this._value;
   }

   set value(val: string | string[]) {
     if (this.multiple && Array.isArray(val)) {
       this.selectedValues = new Set(val);
     } else if (!this.multiple && typeof val === 'string') {
       this._value = val;
     }
     this.updateFormValue();
   }
   ```

5. Add private `_value` to hold single-select value (rename from current `value` property storage)

6. Create `toggleSelection(index: number)` method:
   - Get option value from effectiveOptions
   - If value in selectedValues, remove it; otherwise add it
   - Respect maxSelections limit if set
   - Call updateFormValue() and requestUpdate()

7. Modify `selectOption(index)` for mode-aware behavior:
   - If multiple: call toggleSelection, do NOT close dropdown
   - If single: existing behavior (set value, close dropdown)

8. Update keyboard handling in open state:
   - Space: toggles selection in multi-select mode (don't close)
   - Enter: closes dropdown in multi-select mode (W3C APG pattern)
   - Keep existing single-select behavior

9. Create `updateFormValue()` method for form participation:
   ```typescript
   private updateFormValue(): void {
     if (!this.internals) return;

     if (this.multiple) {
       const formData = new FormData();
       for (const val of this.selectedValues) {
         formData.append(this.name, val);
       }
       this.internals.setFormValue(formData);
     } else {
       this.internals.setFormValue(this._value);
     }
   }
   ```

10. Update `formResetCallback()` to clear selectedValues in multi-select mode

11. Add aria-multiselectable="true" to listbox when multiple prop is set

12. Update syncSlottedOptionStates to handle multi-select:
    - Set opt.selected = selectedValues.has(opt.value)
  </action>
  <verify>Build passes: `cd packages/select && pnpm build`</verify>
  <done>Select has multiple prop that tracks selections in Set, supports array value, closes only on Enter in multi-mode, and submits via FormData.append</done>
</task>

<task type="auto">
  <name>Task 2: Add checkbox indicator to Option component</name>
  <files>packages/select/src/option.ts</files>
  <action>
Extend Option component to show checkbox indicator in multi-select mode:

1. Add `multiselect` boolean prop to Option (reflects attribute):
   ```typescript
   @property({ type: Boolean, reflect: true })
   multiselect = false;
   ```

2. Create checkbox indicator rendering method:
   ```typescript
   private renderSelectionIndicator() {
     if (this.multiselect) {
       return html`
         <span class="checkbox-indicator ${this.selected ? 'checked' : ''}">
           ${this.selected ? html`
             <svg viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
               <path d="M3 8l4 4 6-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
             </svg>
           ` : nothing}
         </span>
       `;
     }
     // Single-select checkmark (existing pattern)
     return html`
       <svg class="check-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" aria-hidden="true">
         <path d="M3 8l4 4 6-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
       </svg>
     `;
   }
   ```

3. Update render method to use renderSelectionIndicator() instead of hardcoded check-icon

4. Add CSS for checkbox indicator:
   ```css
   .checkbox-indicator {
     width: 1em;
     height: 1em;
     flex-shrink: 0;
     border: 2px solid var(--ui-select-checkbox-border, var(--color-border));
     border-radius: var(--radius-sm, 0.25rem);
     display: flex;
     align-items: center;
     justify-content: center;
     margin-right: 0.5rem;
   }

   .checkbox-indicator.checked {
     background-color: var(--ui-select-checkbox-bg-checked, var(--color-primary));
     border-color: var(--ui-select-checkbox-bg-checked, var(--color-primary));
   }

   .checkbox-indicator svg {
     width: 0.75em;
     height: 0.75em;
     color: var(--ui-select-checkbox-check, white);
   }
   ```

5. Update Select component to set multiselect attribute on slotted options:
   In select.ts syncSlottedOptionStates():
   ```typescript
   for (const opt of this.slottedOptions) {
     opt.multiselect = this.multiple;
     opt.selected = this.multiple
       ? this.selectedValues.has(opt.value)
       : opt.value === this._value;
   }
   ```

6. Update property-based option rendering in Select to show checkbox for multi-select:
   In renderOption method, conditionally render checkbox or checkmark based on this.multiple
  </action>
  <verify>Build passes: `cd packages/select && pnpm build`</verify>
  <done>Options show checkbox indicator when parent select has multiple prop, checkmark shown when selected</done>
</task>

</tasks>

<verification>
1. Build succeeds: `pnpm build` in packages/select
2. TypeScript: No type errors for union type value property
3. Multi-select toggles: Space toggles without closing dropdown
4. Form submission: FormData has multiple entries via getAll()
5. Checkbox display: Options show checkbox (not checkmark) in multi-mode
</verification>

<success_criteria>
- Select with multiple prop tracks multiple selections in Set
- Value property returns string[] in multi-select mode
- Dropdown stays open when selecting options (closes on Enter/Escape)
- FormData.append() used for each selected value
- Options display checkbox indicators in multi-select mode
- ARIA multiselectable="true" set on listbox
- Keyboard: Space toggles, Enter closes in multi-select
</success_criteria>

<output>
After completion, create `.planning/phases/34-multi-select/34-01-SUMMARY.md`
</output>
