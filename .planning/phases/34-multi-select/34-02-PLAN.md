---
phase: 34-multi-select
plan: 02
type: execute
wave: 2
depends_on: ["34-01"]
files_modified:
  - packages/select/src/select.ts
  - packages/core/src/styles/tailwind.css
  - packages/core/src/tokens/index.ts
autonomous: true

must_haves:
  truths:
    - "Selected items display as pill-shaped tags in trigger area"
    - "User clicks X on tag and that selection is removed"
    - "Tags show truncated text with ellipsis for long labels"
    - "Tags replace placeholder when selections exist"
  artifacts:
    - path: "packages/select/src/select.ts"
      provides: "Tag rendering and removal"
      contains: "tag"
    - path: "packages/core/src/styles/tailwind.css"
      provides: "Tag CSS tokens"
      contains: "--ui-select-tag"
  key_links:
    - from: "packages/select/src/select.ts tag-remove click"
      to: "toggleSelection method"
      via: "Click handler removes selection"
      pattern: "handleTagRemove"
---

<objective>
Implement tag/chip display for multi-select with remove functionality.

Purpose: Show selected items as removable tags in the trigger area, matching Gmail-style chips with pill shape and filled background.

Output: Multi-select displays selected items as tags with X button for removal, proper CSS tokens for theming.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-multi-select/34-CONTEXT.md
@.planning/phases/34-multi-select/34-RESEARCH.md
@.planning/phases/34-multi-select/34-01-SUMMARY.md
@packages/select/src/select.ts
@packages/core/src/styles/tailwind.css
@packages/core/src/tokens/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CSS tokens for tag styling to core package</name>
  <files>packages/core/src/styles/tailwind.css, packages/core/src/tokens/index.ts</files>
  <action>
Add CSS tokens for multi-select tag styling:

1. In packages/core/src/styles/tailwind.css, add after existing select tokens (~line 463):
   ```css
   /* Multi-select tag tokens */
   --ui-select-tag-bg: var(--color-secondary, var(--ui-color-secondary));
   --ui-select-tag-text: var(--color-secondary-foreground, var(--ui-color-secondary-foreground));
   --ui-select-tag-gap: 0.25rem;
   --ui-select-tag-padding-x: 0.5rem;
   --ui-select-tag-padding-y: 0.125rem;

   /* Checkbox indicator tokens */
   --ui-select-checkbox-border: var(--color-border, var(--ui-color-border));
   --ui-select-checkbox-bg-checked: var(--color-primary, var(--ui-color-primary));
   --ui-select-checkbox-check: white;
   ```

2. In packages/core/src/tokens/index.ts, add to selectTokens object:
   ```typescript
   // Tag tokens (multi-select)
   tagBg: 'var(--ui-select-tag-bg)',
   tagText: 'var(--ui-select-tag-text)',
   tagGap: 'var(--ui-select-tag-gap)',
   tagPaddingX: 'var(--ui-select-tag-padding-x)',
   tagPaddingY: 'var(--ui-select-tag-padding-y)',

   // Checkbox tokens (multi-select)
   checkboxBorder: 'var(--ui-select-checkbox-border)',
   checkboxBgChecked: 'var(--ui-select-checkbox-bg-checked)',
   checkboxCheck: 'var(--ui-select-checkbox-check)',
   ```

3. Rebuild core: `cd packages/core && pnpm build`
  </action>
  <verify>`cd packages/core && pnpm build` succeeds</verify>
  <done>CSS tokens for tag and checkbox styling exist in core package</done>
</task>

<task type="auto">
  <name>Task 2: Implement tag rendering and removal in Select</name>
  <files>packages/select/src/select.ts</files>
  <action>
Add tag display in trigger area for multi-select:

1. Add CSS for tags in static styles:
   ```css
   /* Tag container for multi-select */
   .tag-container {
     display: flex;
     flex-wrap: wrap;
     gap: var(--ui-select-tag-gap, 0.25rem);
     align-items: center;
     min-height: 1.5em;
     flex: 1;
     min-width: 0;
   }

   /* Individual tag/chip styling - Gmail-style pill */
   .tag {
     display: inline-flex;
     align-items: center;
     gap: 0.25rem;
     padding: var(--ui-select-tag-padding-y, 0.125rem) var(--ui-select-tag-padding-x, 0.5rem);
     background-color: var(--ui-select-tag-bg);
     color: var(--ui-select-tag-text);
     border-radius: var(--radius-full, 9999px);
     font-size: 0.875em;
     max-width: 100%;
     overflow: hidden;
   }

   .tag-label {
     overflow: hidden;
     text-overflow: ellipsis;
     white-space: nowrap;
   }

   .tag-remove {
     display: flex;
     align-items: center;
     justify-content: center;
     padding: 0;
     border: none;
     background: transparent;
     color: currentColor;
     cursor: pointer;
     opacity: 0.7;
     flex-shrink: 0;
     border-radius: var(--radius-full, 9999px);
     width: 1em;
     height: 1em;
   }

   .tag-remove:hover {
     opacity: 1;
     background-color: rgba(0, 0, 0, 0.1);
   }

   .tag-remove svg {
     width: 0.75em;
     height: 0.75em;
   }
   ```

2. Create handleTagRemove method:
   ```typescript
   private handleTagRemove(e: Event, value: string): void {
     e.stopPropagation(); // Don't open/close dropdown
     e.preventDefault();

     this.selectedValues.delete(value);
     this.updateFormValue();
     this.requestUpdate();

     // Sync slotted option states
     this.syncSlottedOptionStates();

     // Dispatch change event
     this.dispatchEvent(new CustomEvent('change', {
       detail: { value: Array.from(this.selectedValues) },
       bubbles: true,
       composed: true,
     }));

     // Focus trigger after removal
     this.triggerEl?.focus();
   }
   ```

3. Create renderTags method:
   ```typescript
   private renderTags() {
     if (!this.multiple || this.selectedValues.size === 0) {
       return nothing;
     }

     const selectedOptions = this.effectiveOptions.filter(o =>
       this.selectedValues.has(o.value)
     );

     return html`
       <div class="tag-container">
         ${selectedOptions.map(opt => html`
           <span class="tag" title="${opt.label}">
             <span class="tag-label">${opt.label}</span>
             <button
               type="button"
               class="tag-remove"
               aria-label="Remove ${opt.label}"
               tabindex="-1"
               @click=${(e: Event) => this.handleTagRemove(e, opt.value)}
               @mousedown=${(e: MouseEvent) => e.preventDefault()}
             >
               <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" aria-hidden="true">
                 <path d="M4 4l8 8M12 4l-8 8" stroke-width="2" stroke-linecap="round"/>
               </svg>
             </button>
           </span>
         `)}
       </div>
     `;
   }
   ```

4. Update render() to conditionally show tags or value/placeholder:
   In the trigger div, replace the value/placeholder span with:
   ```typescript
   ${this.multiple && this.selectedValues.size > 0
     ? this.renderTags()
     : selectedLabel
       ? html`<span class="selected-value">${selectedLabel}</span>`
       : html`<span class="placeholder">${this.placeholder}</span>`
   }
   ```

5. Update getSelectedLabel to work with multi-select:
   ```typescript
   private getSelectedLabel(): string {
     if (this.multiple) {
       // For multi-select, tags handle display
       return '';
     }
     const opts = this.effectiveOptions;
     const selected = opts.find((o) => o.value === this._value);
     return selected?.label || selected?.value || '';
   }
   ```
  </action>
  <verify>`cd packages/select && pnpm build` succeeds</verify>
  <done>Multi-select shows tags for selected items with X button that removes selection</done>
</task>

</tasks>

<verification>
1. Core build: `pnpm build` in packages/core
2. Select build: `pnpm build` in packages/select
3. Tags display: Tags appear for each selected option
4. Tag removal: Clicking X removes that tag from selection
5. Tag styling: Pills with rounded ends, truncated text
6. Focus management: Focus returns to trigger after removal
</verification>

<success_criteria>
- CSS tokens --ui-select-tag-* and --ui-select-checkbox-* exist
- Selected items display as pill-shaped tags in trigger area
- Each tag has X button that removes that selection
- Tags show ellipsis for long labels, title for full text on hover
- Tag removal dispatches change event with updated value array
- Focus returns to trigger after tag removal
</success_criteria>

<output>
After completion, create `.planning/phases/34-multi-select/34-02-SUMMARY.md`
</output>
