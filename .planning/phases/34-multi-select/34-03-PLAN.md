---
phase: 34-multi-select
plan: 03
type: execute
wave: 3
depends_on: ["34-02"]
files_modified:
  - packages/select/src/select.ts
autonomous: true

must_haves:
  truths:
    - "User with many selections sees +N more instead of squished tags"
    - "User clicks select all and all enabled options become selected"
    - "User clicks clear all and all selections are removed"
    - "Overflow indicator shows count of hidden selections"
  artifacts:
    - path: "packages/select/src/select.ts"
      provides: "Tag overflow with ResizeObserver and select all actions"
      contains: "ResizeObserver"
  key_links:
    - from: "ResizeObserver callback"
      to: "visibleTagCount state"
      via: "calculateVisibleTags method"
      pattern: "ResizeObserver"
---

<objective>
Implement tag overflow display and select all / deselect all actions.

Purpose: Handle many selections gracefully with +N more indicator and provide bulk selection actions for user convenience.

Output: Multi-select shows dynamic tag count based on container width with +N more counter, and optional select all / clear all actions.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-multi-select/34-CONTEXT.md
@.planning/phases/34-multi-select/34-RESEARCH.md
@.planning/phases/34-multi-select/34-01-SUMMARY.md
@.planning/phases/34-multi-select/34-02-SUMMARY.md
@packages/select/src/select.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement tag overflow with ResizeObserver</name>
  <files>packages/select/src/select.ts</files>
  <action>
Add dynamic tag overflow calculation using ResizeObserver:

1. Add state for tracking visible tags:
   ```typescript
   @state()
   private visibleTagCount: number = Infinity;
   ```

2. Add ResizeObserver instance:
   ```typescript
   private resizeObserver: ResizeObserver | null = null;
   ```

3. Update connectedCallback to setup ResizeObserver (after existing logic):
   ```typescript
   // Add ResizeObserver for tag overflow (only in multi-select mode)
   if (!isServer) {
     this.resizeObserver = new ResizeObserver((entries) => {
       for (const entry of entries) {
         this.calculateVisibleTags(entry.contentRect.width);
       }
     });
   }
   ```

4. Update disconnectedCallback to cleanup:
   ```typescript
   this.resizeObserver?.disconnect();
   this.resizeObserver = null;
   ```

5. Start observing tag container after render (in updated() lifecycle):
   ```typescript
   override updated(changedProperties: Map<string, unknown>): void {
     super.updated(changedProperties);

     // Start observing tag container for overflow
     if (this.multiple && this.selectedValues.size > 0) {
       const tagContainer = this.shadowRoot?.querySelector('.tag-container');
       if (tagContainer && this.resizeObserver) {
         this.resizeObserver.observe(tagContainer);
       }
     }
   }
   ```

6. Implement calculateVisibleTags method:
   ```typescript
   private calculateVisibleTags(containerWidth: number): void {
     if (!this.multiple || this.selectedValues.size === 0) {
       this.visibleTagCount = Infinity;
       return;
     }

     const tags = this.shadowRoot?.querySelectorAll('.tag:not(.tag-overflow)');
     if (!tags || tags.length === 0) {
       this.visibleTagCount = Infinity;
       return;
     }

     const moreButtonWidth = 60; // Reserve space for "+N more"
     const gap = 4; // Gap between tags
     let totalWidth = 0;
     let count = 0;

     for (const tag of tags) {
       const tagWidth = tag.getBoundingClientRect().width + gap;
       if (totalWidth + tagWidth + moreButtonWidth > containerWidth && count > 0) {
         break;
       }
       totalWidth += tagWidth;
       count++;
     }

     // Use requestAnimationFrame to avoid layout thrashing
     requestAnimationFrame(() => {
       if (count !== this.visibleTagCount && count > 0) {
         this.visibleTagCount = count;
       }
     });
   }
   ```

7. Update renderTags to respect visibleTagCount and show overflow:
   ```typescript
   private renderTags() {
     if (!this.multiple || this.selectedValues.size === 0) {
       return nothing;
     }

     const selectedOptions = this.effectiveOptions.filter(o =>
       this.selectedValues.has(o.value)
     );

     const visibleOptions = this.visibleTagCount < selectedOptions.length
       ? selectedOptions.slice(0, this.visibleTagCount)
       : selectedOptions;

     const hiddenCount = selectedOptions.length - visibleOptions.length;

     return html`
       <div class="tag-container">
         ${visibleOptions.map(opt => html`
           <span class="tag" title="${opt.label}">
             <span class="tag-label">${opt.label}</span>
             <button
               type="button"
               class="tag-remove"
               aria-label="Remove ${opt.label}"
               tabindex="-1"
               @click=${(e: Event) => this.handleTagRemove(e, opt.value)}
               @mousedown=${(e: MouseEvent) => e.preventDefault()}
             >
               <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" aria-hidden="true">
                 <path d="M4 4l8 8M12 4l-8 8" stroke-width="2" stroke-linecap="round"/>
               </svg>
             </button>
           </span>
         `)}
         ${hiddenCount > 0 ? html`
           <span class="tag tag-overflow" title="${this.getHiddenSelectionsList(selectedOptions.slice(this.visibleTagCount))}">
             +${hiddenCount} more
           </span>
         ` : nothing}
       </div>
     `;
   }

   private getHiddenSelectionsList(hiddenOptions: SelectOption[]): string {
     return hiddenOptions.map(o => o.label).join(', ');
   }
   ```

8. Add CSS for overflow tag:
   ```css
   .tag-overflow {
     background-color: var(--ui-select-option-bg-hover, var(--color-accent));
     cursor: default;
     flex-shrink: 0;
   }
   ```

9. Reset visibleTagCount when selections change:
   In toggleSelection and handleTagRemove, set this.visibleTagCount = Infinity before requestUpdate
  </action>
  <verify>`cd packages/select && pnpm build` succeeds</verify>
  <done>Tag overflow shows +N more when selections exceed container width, tooltip shows hidden labels</done>
</task>

<task type="auto">
  <name>Task 2: Add select all / deselect all actions</name>
  <files>packages/select/src/select.ts</files>
  <action>
Add showSelectAll prop and bulk selection actions:

1. Add showSelectAll prop:
   ```typescript
   @property({ type: Boolean })
   showSelectAll = false;
   ```

2. Implement selectAll and deselectAll methods:
   ```typescript
   private selectAll(): void {
     const enabledOptions = this.effectiveOptions.filter(o => !o.disabled);

     // Respect maxSelections limit
     if (this.maxSelections && this.maxSelections > 0) {
       const toSelect = enabledOptions.slice(0, this.maxSelections);
       this.selectedValues = new Set(toSelect.map(o => o.value));
     } else {
       this.selectedValues = new Set(enabledOptions.map(o => o.value));
     }

     this.visibleTagCount = Infinity;
     this.updateFormValue();
     this.syncSlottedOptionStates();
     this.requestUpdate();

     this.dispatchEvent(new CustomEvent('change', {
       detail: { value: Array.from(this.selectedValues) },
       bubbles: true,
       composed: true,
     }));
   }

   private deselectAll(): void {
     this.selectedValues.clear();
     this.visibleTagCount = Infinity;
     this.updateFormValue();
     this.syncSlottedOptionStates();
     this.requestUpdate();

     this.dispatchEvent(new CustomEvent('change', {
       detail: { value: [] },
       bubbles: true,
       composed: true,
     }));
   }
   ```

3. Create renderSelectAllActions method:
   ```typescript
   private renderSelectAllActions() {
     if (!this.multiple || !this.showSelectAll) return nothing;

     const enabledCount = this.effectiveOptions.filter(o => !o.disabled).length;
     const allSelected = this.selectedValues.size === enabledCount ||
       (this.maxSelections && this.selectedValues.size >= this.maxSelections);

     return html`
       <div class="select-all-actions">
         <button
           type="button"
           class="select-all-btn"
           @click=${allSelected ? this.deselectAll : this.selectAll}
           @mousedown=${(e: MouseEvent) => e.preventDefault()}
         >
           ${allSelected ? 'Clear all' : 'Select all'}
         </button>
       </div>
     `;
   }
   ```

4. Add CSS for select all actions:
   ```css
   .select-all-actions {
     padding: 0.5rem 0.75rem;
     border-bottom: 1px solid var(--ui-select-dropdown-border);
   }

   .select-all-btn {
     font-size: 0.875em;
     color: var(--color-primary, var(--ui-color-primary));
     background: transparent;
     border: none;
     cursor: pointer;
     padding: 0;
   }

   .select-all-btn:hover {
     text-decoration: underline;
   }
   ```

5. Render select all actions at top of listbox (before options):
   Update the listbox render section to include:
   ```typescript
   <div id=${listboxId} class="listbox" role="listbox" ... >
     ${this.renderSelectAllActions()}
     ${this.options.length > 0
       ? this.options.map((option, index) => this.renderOption(option, index))
       : html`<slot @slotchange=${this.handleSlotChange}></slot>`
     }
   </div>
   ```

6. Update validation to handle multi-select required:
   In validate() method:
   ```typescript
   private validate(): boolean {
     if (!this.internals) return true;

     if (this.required) {
       const hasValue = this.multiple
         ? this.selectedValues.size > 0
         : Boolean(this._value);

       if (!hasValue) {
         this.internals.setValidity(
           { valueMissing: true },
           this.multiple ? 'Please select at least one option' : 'Please select an option',
           this.triggerEl
         );
         return false;
       }
     }

     this.internals.setValidity({});
     return true;
   }
   ```
  </action>
  <verify>`cd packages/select && pnpm build` succeeds</verify>
  <done>showSelectAll prop displays select/clear all button, respects maxSelections, bulk operations work</done>
</task>

</tasks>

<verification>
1. Build: `pnpm build` in packages/select
2. Overflow: Many selections show +N more counter
3. Tooltip: Hovering +N more shows hidden selection labels
4. Select all: Clicking selects all enabled options
5. Clear all: Clicking deselects all options
6. maxSelections: Select all respects limit
7. Validation: Required works with multi-select
</verification>

<success_criteria>
- Tag overflow shows +N more when tags exceed container width
- +N more has tooltip showing hidden selection labels
- showSelectAll prop displays "Select all" / "Clear all" button
- Select all selects only enabled options
- Select all respects maxSelections limit
- Clear all removes all selections
- Validation works: required checks for at least one selection
- No layout thrashing from ResizeObserver
</success_criteria>

<output>
After completion, create `.planning/phases/34-multi-select/34-03-SUMMARY.md`
</output>
