---
phase: 16-ssr-package
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/ssr/package.json
  - packages/ssr/tsconfig.json
  - packages/ssr/vite.config.ts
  - packages/ssr/src/index.ts
  - packages/ssr/src/types.ts
autonomous: true

must_haves:
  truths:
    - "Developer can import render, html from @lit-ui/ssr"
    - "Developer can import renderToString helper for simple rendering"
    - "Developer can import isServer for conditional logic"
    - "Package installs with pnpm install at workspace root"
  artifacts:
    - path: "packages/ssr/package.json"
      provides: "Package configuration with SSR peer dependencies"
      contains: "@lit-labs/ssr"
    - path: "packages/ssr/src/index.ts"
      provides: "SSR render utilities and re-exports"
      exports: ["render", "html", "renderToString", "isServer"]
    - path: "packages/ssr/src/types.ts"
      provides: "Re-exported TypeScript types"
      exports: ["RenderInfo", "RenderResult"]
    - path: "packages/ssr/vite.config.ts"
      provides: "Build configuration with external Lit dependencies"
      contains: "external"
  key_links:
    - from: "packages/ssr/src/index.ts"
      to: "@lit-labs/ssr"
      via: "re-export"
      pattern: "from '@lit-labs/ssr'"
    - from: "packages/ssr/vite.config.ts"
      to: "rollupOptions"
      via: "external dependencies"
      pattern: "@lit-labs"
---

<objective>
Create the @lit-ui/ssr package with server-side render utilities that wrap @lit-labs/ssr

Purpose: Provide a simplified, consistent API for SSR that matches @lit-ui package conventions while re-exporting the official Lit SSR functionality.

Output: Working @lit-ui/ssr package with render utilities, renderToString helper, and isServer export.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-ssr-package/16-RESEARCH.md
@.planning/phases/16-ssr-package/16-CONTEXT.md

# Reference existing package patterns
@packages/core/package.json
@packages/core/vite.config.ts
@packages/core/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SSR Package Structure</name>
  <files>
    packages/ssr/package.json
    packages/ssr/tsconfig.json
    packages/ssr/vite.config.ts
  </files>
  <action>
Create the @lit-ui/ssr package following existing package conventions:

**package.json:**
- name: "@lit-ui/ssr"
- version: "0.0.1"
- type: "module"
- exports: "." for main, "./hydration" for hydration entry
- peerDependencies: lit ^3.0.0, @lit-labs/ssr ^4.0.0, @lit-labs/ssr-client ^1.1.0
- devDependencies: workspace config packages, plus the peer deps for local dev
- sideEffects: false
- scripts: dev, build (matching other packages)

**tsconfig.json:**
- extends @lit-ui/typescript-config/library.json
- include: ["src"]

**vite.config.ts:**
- Use dts plugin for type generation (no rollupTypes - per 15-02 decision)
- Build lib with entry points: index (main), hydration
- External: lit, @lit/*, @lit-labs/*, @lit-ui/* (CRITICAL - Lit SSR breaks when bundled)
- formats: ['es'] only

Key pattern from RESEARCH.md: Lit SSR uses conditional exports (node vs browser) that break when bundled. Mark all Lit packages external.
  </action>
  <verify>
    - ls packages/ssr/package.json packages/ssr/tsconfig.json packages/ssr/vite.config.ts
    - grep "peerDependencies" packages/ssr/package.json
    - grep "external" packages/ssr/vite.config.ts
  </verify>
  <done>
    Package structure exists with correct peer dependencies and external config
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SSR Render Utilities</name>
  <files>
    packages/ssr/src/index.ts
    packages/ssr/src/types.ts
    packages/ssr/src/vite-env.d.ts
  </files>
  <action>
Create the main SSR exports following patterns from RESEARCH.md:

**src/types.ts:**
- Re-export RenderInfo and RenderResult types from @lit-labs/ssr

**src/index.ts:**
- Re-export render, html from @lit-labs/ssr
- Re-export collectResult, collectResultSync from @lit-labs/ssr/lib/render-result.js
- Re-export RenderResultReadable from @lit-labs/ssr/lib/render-result-readable.js
- Re-export isServer from lit
- Re-export types from ./types.js

Add convenience helper:
```typescript
/**
 * Render a Lit template to an HTML string.
 * This is a convenience wrapper around render() + collectResult().
 */
export async function renderToString(
  template: TemplateResult,
  options?: Partial<RenderInfo>
): Promise<string> {
  const result = render(template, options);
  return collectResult(result);
}
```

**src/vite-env.d.ts:**
- /// <reference types="vite/client" />
(Required for import.meta.env types if used, matching 15-01 pattern)

Export VERSION constant for consistency with other packages.
  </action>
  <verify>
    - grep "export.*render" packages/ssr/src/index.ts
    - grep "export.*isServer" packages/ssr/src/index.ts
    - grep "renderToString" packages/ssr/src/index.ts
  </verify>
  <done>
    Main SSR utilities exported: render, html, renderToString, isServer, collectResult, RenderResultReadable
  </done>
</task>

<task type="auto">
  <name>Task 3: Install Dependencies and Verify Build</name>
  <files>None (verification only)</files>
  <action>
Install workspace dependencies and verify build:

1. Run pnpm install at workspace root to install new package deps
2. Run pnpm --filter @lit-ui/ssr build
3. Verify dist/ contains index.js and index.d.ts
4. Verify types export correctly (no any, proper RenderInfo typing)

If build fails:
- Check if @lit-labs/ssr types need separate handling
- Ensure vite-plugin-dts is configured correctly
- Verify external patterns match actual import paths
  </action>
  <verify>
    - pnpm install (at workspace root)
    - pnpm --filter @lit-ui/ssr build
    - ls packages/ssr/dist/index.js packages/ssr/dist/index.d.ts
    - grep "RenderInfo" packages/ssr/dist/index.d.ts
  </verify>
  <done>
    Package builds successfully, types are generated, exports are typed
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `pnpm --filter @lit-ui/ssr build` exits 0
2. `packages/ssr/dist/index.js` exists with render, html, isServer exports
3. `packages/ssr/dist/index.d.ts` exists with proper types
4. `grep "@lit-labs/ssr" packages/ssr/package.json` shows peer dependency
</verification>

<success_criteria>
- @lit-ui/ssr package builds without errors
- render, html, renderToString, isServer, collectResult exported from main entry
- Types (RenderInfo, RenderResult) exported correctly
- Lit SSR packages marked as external (not bundled)
</success_criteria>

<output>
After completion, create `.planning/phases/16-ssr-package/16-01-SUMMARY.md`
</output>
