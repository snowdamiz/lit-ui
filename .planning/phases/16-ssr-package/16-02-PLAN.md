---
phase: 16-ssr-package
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - packages/ssr/src/hydration.ts
autonomous: true

must_haves:
  truths:
    - "Developer can import hydration support via @lit-ui/ssr/hydration"
    - "Hydration module re-exports hydrate function for advanced use"
    - "Build produces hydration.js and hydration.d.ts in dist/"
    - "Full package functionality verified end-to-end"
  artifacts:
    - path: "packages/ssr/src/hydration.ts"
      provides: "Client-side hydration support entry point"
      contains: "lit-element-hydrate-support"
    - path: "packages/ssr/dist/hydration.js"
      provides: "Built hydration entry point"
    - path: "packages/ssr/dist/hydration.d.ts"
      provides: "Hydration types"
  key_links:
    - from: "packages/ssr/src/hydration.ts"
      to: "@lit-labs/ssr-client"
      via: "import for side effects"
      pattern: "lit-element-hydrate-support"
    - from: "packages/ssr/package.json"
      to: "dist/hydration.js"
      via: "exports map"
      pattern: "./hydration"
---

<objective>
Add hydration support entry point and complete @lit-ui/ssr package verification

Purpose: Provide a clear import path for client-side hydration that handles the critical module load order requirement (hydration support must load before any Lit components).

Output: Complete, verified @lit-ui/ssr package with both server render utilities and client hydration support.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-ssr-package/16-RESEARCH.md

# Reference Plan 01 output
@.planning/phases/16-ssr-package/16-01-SUMMARY.md

# Reference existing files
@packages/ssr/package.json
@packages/ssr/vite.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Hydration Entry Point</name>
  <files>
    packages/ssr/src/hydration.ts
  </files>
  <action>
Create the client-side hydration support module.

**CRITICAL from RESEARCH.md:** lit-element-hydrate-support.js must be imported BEFORE any Lit component modules. This import patches LitElement.

**src/hydration.ts:**
```typescript
/**
 * Client-side hydration support for @lit-ui components.
 *
 * IMPORTANT: This module MUST be imported before any Lit component modules.
 * The hydration support patches LitElement to enable hydration of
 * server-rendered components with Declarative Shadow DOM.
 *
 * @example
 * ```typescript
 * // In your client entry point (FIRST import!)
 * import '@lit-ui/ssr/hydration';
 *
 * // Then import your components
 * import '@lit-ui/button';
 * import '@lit-ui/dialog';
 * ```
 */

// Side-effect import - patches LitElement for hydration
import '@lit-labs/ssr-client/lit-element-hydrate-support.js';

// Re-export hydrate for manual hydration scenarios
export { hydrate } from '@lit-labs/ssr-client';
```

This follows the pattern from RESEARCH.md Pattern 4.
  </action>
  <verify>
    - grep "lit-element-hydrate-support" packages/ssr/src/hydration.ts
    - grep "export.*hydrate" packages/ssr/src/hydration.ts
  </verify>
  <done>
    Hydration module imports @lit-labs/ssr-client support and re-exports hydrate
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Package Exports and Rebuild</name>
  <files>
    packages/ssr/package.json
    packages/ssr/vite.config.ts
  </files>
  <action>
Update package.json and vite.config.ts to include hydration entry point.

**package.json exports:**
Add "./hydration" export pointing to dist/hydration.js:
```json
"exports": {
  ".": {
    "types": "./dist/index.d.ts",
    "import": "./dist/index.js"
  },
  "./hydration": {
    "types": "./dist/hydration.d.ts",
    "import": "./dist/hydration.js"
  }
}
```

**vite.config.ts:**
Add hydration to build entry points:
```typescript
entry: {
  index: 'src/index.ts',
  hydration: 'src/hydration.ts',
},
```

Rebuild the package and verify both entry points are generated.
  </action>
  <verify>
    - grep "./hydration" packages/ssr/package.json
    - grep "hydration" packages/ssr/vite.config.ts
    - pnpm --filter @lit-ui/ssr build
    - ls packages/ssr/dist/hydration.js packages/ssr/dist/hydration.d.ts
  </verify>
  <done>
    Package exports ./hydration, build produces hydration.js and hydration.d.ts
  </done>
</task>

<task type="auto">
  <name>Task 3: End-to-End Package Verification</name>
  <files>None (verification only)</files>
  <action>
Comprehensive verification of the complete @lit-ui/ssr package:

1. **Build verification:**
   - pnpm --filter @lit-ui/ssr build
   - Check dist/ for all expected files

2. **Export verification:**
   - Check index.d.ts exports render, html, renderToString, isServer, collectResult, RenderResultReadable
   - Check hydration.d.ts exports hydrate

3. **Type verification:**
   - Ensure RenderInfo, RenderResult types are present
   - No implicit any types in exports

4. **External dependency verification:**
   - Check that dist/index.js does NOT contain @lit-labs/ssr code (should be external)
   - File size should be small (just re-exports + renderToString helper)

5. **Workspace verification:**
   - pnpm install at root
   - Check that @lit-ui/ssr appears in node_modules

If any verification fails, diagnose and fix before marking complete.
  </action>
  <verify>
    - pnpm --filter @lit-ui/ssr build
    - ls packages/ssr/dist/
    - grep "export.*render" packages/ssr/dist/index.d.ts
    - grep "export.*hydrate" packages/ssr/dist/hydration.d.ts
    - wc -l packages/ssr/dist/index.js (should be small, <50 lines)
  </verify>
  <done>
    - All dist files generated: index.js, index.d.ts, hydration.js, hydration.d.ts
    - Types exported correctly
    - Lit dependencies remain external (not bundled)
  </done>
</task>

</tasks>

<verification>
Phase 16 success criteria (from ROADMAP.md):
1. Developer imports `import { render } from '@lit-ui/ssr'` - VERIFY: grep "export.*render" packages/ssr/dist/index.d.ts
2. Rendered HTML contains `<template shadowrootmode="open">` - VERIFY: inherent from @lit-labs/ssr functionality
3. Developer follows hydration guide - VERIFY: packages/ssr/src/hydration.ts has JSDoc with example
4. Component author uses `import { isServer } from '@lit-ui/ssr'` - VERIFY: grep "export.*isServer" packages/ssr/dist/index.d.ts
</verification>

<success_criteria>
- @lit-ui/ssr/hydration import works and patches LitElement
- hydrate function exported for advanced manual hydration
- All dist files present and properly typed
- Package ready for Phase 17 (Framework Integration) to use
</success_criteria>

<output>
After completion, create `.planning/phases/16-ssr-package/16-02-SUMMARY.md`
</output>
