---
phase: 44-date-picker-core
plan: 04
type: execute
wave: 4
depends_on: [44-03]
files_modified:
  - packages/date-picker/src/date-picker.ts
autonomous: true

must_haves:
  truths:
    - "Focus moves into the calendar when popup opens"
    - "Tab/Shift+Tab is trapped within the popup when open"
    - "Focus returns to the input when popup closes"
    - "Invalid dates show inline error with aria-invalid=true"
    - "Required empty field shows validation error after blur"
    - "Min/max date violations show range validation errors"
  artifacts:
    - path: "packages/date-picker/src/date-picker.ts"
      provides: "Focus trap in popup and validation states"
      contains: "focusCalendar"
  key_links:
    - from: "packages/date-picker/src/date-picker.ts"
      to: "lui-calendar focus"
      via: "querySelector('lui-calendar')?.focus()"
      pattern: "lui-calendar.*focus"
---

<objective>
Add focus management (trap focus in popup, restore to input on close) and complete validation states (inline errors, aria-invalid, min/max range validation) to the date picker.

Purpose: Focus management is critical for accessibility â€” users must be able to navigate the popup with keyboard and have focus return to the input on close (DP-12, DP-13). Validation provides clear feedback for invalid dates (DP-08) with proper ARIA attributes.
Output: Updated date-picker.ts with focus trap and complete validation.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-date-picker-core/44-RESEARCH.md
@.planning/phases/44-date-picker-core/44-03-SUMMARY.md

Reference patterns from:
@packages/dialog/src/dialog.ts (focus trap pattern, triggerElement restoration)
@packages/input/src/input.ts (validation states, setValidity, error display)
@packages/select/src/select.ts (popup Escape key handling)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement focus management for popup open/close</name>
  <files>packages/date-picker/src/date-picker.ts</files>
  <action>
    Add focus management to the date picker popup:

    **Update `openPopup()` to focus calendar after positioning:**
    After `this.positionPopup()` in the updateComplete callback, add:
    ```typescript
    // Focus the calendar inside the popup after positioning
    requestAnimationFrame(() => {
      const calendar = this.renderRoot.querySelector('lui-calendar') as HTMLElement;
      calendar?.focus();
    });
    ```
    Use requestAnimationFrame to ensure Floating UI positioning is complete before focusing.

    **Update `closePopup()` to restore focus:**
    ```typescript
    private closePopup(): void {
      if (!this.open) return;
      this.open = false;
      // Restore focus to the trigger element (input)
      requestAnimationFrame(() => {
        this.triggerElement?.focus();
        this.triggerElement = null;
      });
    }
    ```

    **Add focus trap in `handlePopupKeydown()`:**
    Update the existing handlePopupKeydown to include Tab trapping:
    ```typescript
    private handlePopupKeydown(e: KeyboardEvent): void {
      if (e.key === 'Escape') {
        // Don't close if calendar handled it (e.g., decade->year view drilling)
        if (!e.defaultPrevented) {
          e.preventDefault();
          this.closePopup();
        }
        return;
      }

      if (e.key === 'Tab') {
        // Trap Tab within popup
        const popup = this.popupEl;
        if (!popup) return;

        // Get all focusable elements within the popup shadow DOM
        const calendar = this.renderRoot.querySelector('lui-calendar') as HTMLElement;
        if (!calendar) return;

        // The calendar is the primary focusable element in the popup.
        // Since lui-calendar handles its own internal keyboard nav,
        // Tab/Shift+Tab should stay within the popup.
        // Prevent Tab from leaving the popup entirely.
        e.preventDefault();

        // If we wanted multiple focusable elements in the popup
        // (e.g., a close button), we'd cycle between them here.
        // For now, keep focus on the calendar.
        calendar.focus();
      }
    }
    ```

    **Ensure handleCalendarSelect calls closePopup():**
    Verify that the calendar date selection handler calls `this.closePopup()` which triggers focus restoration.

    **Handle ArrowDown in handleInputKeydown:**
    When ArrowDown is pressed and popup is not open, call `this.openPopup()` to allow keyboard users to open the calendar without clicking.
  </action>
  <verify>
    - `grep "calendar.*focus" packages/date-picker/src/date-picker.ts` shows calendar focusing
    - `grep "triggerElement.*focus" packages/date-picker/src/date-picker.ts` shows focus restoration
    - `grep "Tab" packages/date-picker/src/date-picker.ts` shows Tab trapping
    - `grep "defaultPrevented" packages/date-picker/src/date-picker.ts` shows Escape conflict handling
    - `pnpm --filter @lit-ui/date-picker build` succeeds
  </verify>
  <done>Focus moves to calendar on open, Tab is trapped within popup, focus returns to input on close, Escape respects calendar view drilling</done>
</task>

<task type="auto">
  <name>Task 2: Complete validation states with inline errors</name>
  <files>packages/date-picker/src/date-picker.ts</files>
  <action>
    Enhance the validation logic in date-picker.ts:

    **Update `validate()` method for complete validation:**
    ```typescript
    private validate(): void {
      if (!this.internals) return;

      // Required validation
      if (this.required && !this.value) {
        this.internalError = 'Please select a date';
        this.internals.setValidity(
          { valueMissing: true },
          this.internalError,
          this.inputEl
        );
        return;
      }

      // Only validate further if we have a value
      if (this.value) {
        const date = parseISO(this.value);

        // Min date validation
        if (this.minDate) {
          const min = parseISO(this.minDate);
          if (isBefore(date, min)) {
            const minDisplay = formatDateForDisplay(min, this.effectiveLocale);
            this.internalError = `Date must be on or after ${minDisplay}`;
            this.internals.setValidity(
              { rangeUnderflow: true },
              this.internalError,
              this.inputEl
            );
            return;
          }
        }

        // Max date validation
        if (this.maxDate) {
          const max = parseISO(this.maxDate);
          if (isAfter(date, max)) {
            const maxDisplay = formatDateForDisplay(max, this.effectiveLocale);
            this.internalError = `Date must be on or before ${maxDisplay}`;
            this.internals.setValidity(
              { rangeOverflow: true },
              this.internalError,
              this.inputEl
            );
            return;
          }
        }
      }

      // Valid
      this.internalError = '';
      this.internals.setValidity({});
    }
    ```

    **Call validate() in the right places:**
    - In `handleInputBlur()`: After successful parse, call `this.validate()`. After failed parse, the badInput error is already set.
    - In `handleCalendarSelect()`: After setting value, call `this.validate()`.
    - In `updated()`: When value changes programmatically, call `this.validate()`.

    **Update handleInputBlur() for validation on blur:**
    When input is empty and not required, clear all errors. When input is empty and required and touched, show required error. When input has invalid text, show "Please enter a valid date" error with badInput.

    **Ensure error display template includes aria attributes:**
    The error message `<p>` should have:
    - `role="alert"` (already in Plan 02 template)
    - The input should have `aria-invalid="${this.hasError}"` (already in Plan 02 template)
    - The input should have `aria-describedby` pointing to error element ID (already in Plan 02 template)
    - The input should have `aria-errormessage="${this.inputId}-error"` when hasError is true

    Add `aria-errormessage` attribute to the input element:
    ```typescript
    aria-errormessage="${this.hasError ? `${this.inputId}-error` : nothing}"
    ```

    **Ensure external `error` prop overrides internal validation:**
    In the `hasError` getter, check `this.error` first (external error takes precedence). In the `errorMessage` getter, return `this.error || this.internalError`.
  </action>
  <verify>
    - `grep "valueMissing" packages/date-picker/src/date-picker.ts` shows required validation
    - `grep "rangeUnderflow" packages/date-picker/src/date-picker.ts` shows min date validation
    - `grep "rangeOverflow" packages/date-picker/src/date-picker.ts` shows max date validation
    - `grep "badInput" packages/date-picker/src/date-picker.ts` shows invalid format validation
    - `grep "aria-invalid" packages/date-picker/src/date-picker.ts` shows ARIA error state
    - `grep "aria-errormessage" packages/date-picker/src/date-picker.ts` shows error message association
    - `pnpm --filter @lit-ui/date-picker build` succeeds
  </verify>
  <done>Validation covers required, badInput, rangeUnderflow, rangeOverflow states with inline error display, aria-invalid, and aria-errormessage attributes</done>
</task>

</tasks>

<verification>
- `pnpm --filter @lit-ui/date-picker build` completes without errors
- Focus moves to calendar on popup open
- Tab is trapped within popup
- Focus returns to input on popup close
- Escape key respects calendar defaultPrevented for view drilling
- Required validation shows error on blur when empty
- Min/max date validation shows locale-formatted error messages
- Invalid text input shows badInput error
- aria-invalid and aria-errormessage properly set on input
</verification>

<success_criteria>
1. Focus moves into calendar when popup opens
2. Tab/Shift+Tab trapped within popup
3. Focus returns to input when popup closes (Escape, click-outside, date selection)
4. Required empty field shows "Please select a date" error after blur
5. Date before minDate shows rangeUnderflow error with formatted date
6. Date after maxDate shows rangeOverflow error with formatted date
7. Invalid text shows "Please enter a valid date" error
8. External error prop overrides internal validation errors
9. aria-invalid and aria-errormessage properly associated
10. Package builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/44-date-picker-core/44-04-SUMMARY.md`
</output>
