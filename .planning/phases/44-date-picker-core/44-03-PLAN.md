---
phase: 44-date-picker-core
plan: 03
type: execute
wave: 3
depends_on: [44-02]
files_modified:
  - packages/date-picker/src/date-picker.ts
autonomous: true

must_haves:
  truths:
    - "Calendar popup uses Floating UI fixed positioning below the input trigger"
    - "Popup flips above the input when insufficient space below"
    - "Popup shifts horizontally to avoid viewport clipping"
    - "Clicking outside the component closes the popup"
    - "Click-outside detection works across Shadow DOM boundaries via composedPath()"
    - "Document click listener is cleaned up on disconnectedCallback"
  artifacts:
    - path: "packages/date-picker/src/date-picker.ts"
      provides: "Floating UI positioning and click-outside detection"
      contains: "computePosition"
  key_links:
    - from: "packages/date-picker/src/date-picker.ts"
      to: "@floating-ui/dom"
      via: "import { computePosition, flip, shift, offset }"
      pattern: "import.*computePosition.*floating-ui"
    - from: "packages/date-picker/src/date-picker.ts"
      to: "document click listener"
      via: "composedPath().includes(this)"
      pattern: "composedPath.*includes"
---

<objective>
Add Floating UI popup positioning with flip/shift middleware and click-outside detection with composedPath() to the date picker popup.

Purpose: The calendar popup must position correctly relative to the input trigger, avoid viewport clipping, and close when the user clicks outside. These behaviors follow the exact patterns from lui-select (DP-16, DP-17, DP-18).
Output: Updated date-picker.ts with Floating UI positioning and click-outside close behavior.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-date-picker-core/44-RESEARCH.md
@.planning/phases/44-date-picker-core/44-02-SUMMARY.md

Reference patterns from:
@packages/select/src/select.ts (Floating UI positioning at ~lines 2227-2260, click-outside at ~lines 1186-1193 and 1589-1626)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Floating UI positioning for calendar popup</name>
  <files>packages/date-picker/src/date-picker.ts</files>
  <action>
    Add Floating UI imports and popup positioning to date-picker.ts:

    **Add import:**
    ```typescript
    import { computePosition, flip, shift, offset } from '@floating-ui/dom';
    ```

    **Add private method `positionPopup()`:**
    ```typescript
    private async positionPopup(): Promise<void> {
      if (isServer) return;
      const trigger = this.inputContainerEl;
      const popup = this.popupEl;
      if (!trigger || !popup) return;

      const { x, y } = await computePosition(trigger, popup, {
        placement: 'bottom-start',
        strategy: 'fixed',
        middleware: [
          offset(4),
          flip({ fallbackPlacements: ['top-start'] }),
          shift({ padding: 8 }),
        ],
      });

      Object.assign(popup.style, {
        position: 'fixed',
        left: `${x}px`,
        top: `${y}px`,
      });
    }
    ```

    **Update popup CSS class** in the template: Change the popup `<div>` from `absolute z-50 mt-1` to just `z-50` (position is set by Floating UI via style attribute, not CSS class). Remove `mt-1` since offset middleware handles the gap.

    **Update `togglePopup()` / open logic:** After setting `this.open = true`, call:
    ```typescript
    this.updateComplete.then(() => {
      this.positionPopup();
    });
    ```

    **Update `handleCalendarSelect()`:** Ensure it calls `this.closePopup()` instead of directly setting `this.open = false` (if not already using a closePopup method, create one).

    **Create `openPopup()` method:**
    ```typescript
    private openPopup(): void {
      if (this.disabled || this.open) return;
      this.open = true;
      this.triggerElement = this.inputEl;
      this.updateComplete.then(() => {
        this.positionPopup();
      });
    }
    ```

    **Create `closePopup()` method:**
    ```typescript
    private closePopup(): void {
      if (!this.open) return;
      this.open = false;
      // Focus restoration handled in Plan 04
    }
    ```

    **Update `togglePopup()`** to use openPopup/closePopup.
  </action>
  <verify>
    - `grep "computePosition" packages/date-picker/src/date-picker.ts` shows Floating UI import
    - `grep "positionPopup" packages/date-picker/src/date-picker.ts` shows positioning method
    - `grep "strategy: 'fixed'" packages/date-picker/src/date-picker.ts` shows fixed strategy
    - `grep "flip" packages/date-picker/src/date-picker.ts` shows flip middleware
    - `pnpm --filter @lit-ui/date-picker build` succeeds
  </verify>
  <done>Calendar popup uses Floating UI with fixed strategy, offset(4), flip to top-start, and shift with 8px padding</done>
</task>

<task type="auto">
  <name>Task 2: Add click-outside detection with composedPath()</name>
  <files>packages/date-picker/src/date-picker.ts</files>
  <action>
    Add click-outside detection following the exact lui-select pattern:

    **Add private arrow function (bound method):**
    ```typescript
    private handleDocumentClick = (e: MouseEvent): void => {
      if (this.open && !e.composedPath().includes(this)) {
        this.closePopup();
      }
    };
    ```

    **Override connectedCallback():**
    ```typescript
    override connectedCallback(): void {
      super.connectedCallback();
      if (!isServer) {
        document.addEventListener('click', this.handleDocumentClick);
      }
    }
    ```

    **Override disconnectedCallback():**
    ```typescript
    override disconnectedCallback(): void {
      super.disconnectedCallback();
      if (!isServer) {
        document.removeEventListener('click', this.handleDocumentClick);
      }
    }
    ```

    This ensures:
    - Clicks on the date picker itself (input, button, popup, calendar) do NOT close the popup (they're in composedPath)
    - Clicks anywhere else DO close the popup
    - Shadow DOM boundaries are crossed correctly via composedPath() (DP-18)
    - Listener is cleaned up when component is removed from DOM
  </action>
  <verify>
    - `grep "composedPath" packages/date-picker/src/date-picker.ts` shows click-outside detection
    - `grep "handleDocumentClick" packages/date-picker/src/date-picker.ts` shows the handler
    - `grep "connectedCallback" packages/date-picker/src/date-picker.ts` shows listener setup
    - `grep "disconnectedCallback" packages/date-picker/src/date-picker.ts` shows listener cleanup
    - `pnpm --filter @lit-ui/date-picker build` succeeds
  </verify>
  <done>Click-outside detection closes popup via composedPath() with proper listener cleanup in disconnectedCallback</done>
</task>

</tasks>

<verification>
- `pnpm --filter @lit-ui/date-picker build` completes without errors
- Floating UI imports present (computePosition, flip, shift, offset)
- positionPopup() uses fixed strategy with bottom-start placement
- Click-outside handler uses composedPath().includes(this)
- Listeners added in connectedCallback, removed in disconnectedCallback
- openPopup() positions popup after updateComplete
- closePopup() sets open=false
</verification>

<success_criteria>
1. Popup positioned via Floating UI with fixed strategy below input
2. Popup flips to top-start when insufficient space below
3. Popup shifts horizontally to avoid viewport clipping
4. Clicking outside component closes popup via composedPath()
5. Document click listener cleaned up in disconnectedCallback
6. Package builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/44-date-picker-core/44-03-SUMMARY.md`
</output>
