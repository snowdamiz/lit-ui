---
phase: 92-scatter-bubble-chart-with-webgl
plan: 02
type: execute
wave: 2
depends_on: [92-01]
files_modified:
  - packages/charts/src/scatter/scatter-chart.ts
  - packages/charts/src/index.ts
autonomous: true
requirements: [SCAT-01, SCAT-02, SCAT-03]

must_haves:
  truths:
    - "Developer can use <lui-scatter-chart> with a data prop of [x,y][] and see a scatter chart render"
    - "Developer can set bubble attribute and pass [x,y,size][] data for per-point symbol sizes in Canvas mode"
    - "Developer can set enable-gl attribute for WebGL (scatterGL) rendering path — no API change visible"
    - "Developer can call pushData([x, y]) and have the point added via circular buffer on both Canvas and GL paths"
    - "LuiScatterChart and ScatterPoint + ScatterOptionProps types are exported from @lit-ui/charts public API"
  artifacts:
    - path: "packages/charts/src/scatter/scatter-chart.ts"
      provides: "LuiScatterChart class — Lit custom element extending BaseChartElement"
      exports: ["LuiScatterChart"]
    - path: "packages/charts/src/index.ts"
      provides: "Phase 92 public API exports for LuiScatterChart + types"
      contains: "export { LuiScatterChart }"
  key_links:
    - from: "packages/charts/src/scatter/scatter-chart.ts"
      to: "packages/charts/src/shared/scatter-option-builder.ts"
      via: "_applyData() calls buildScatterOption() with useGl and bubble flags"
      pattern: "buildScatterOption.*this\\.data"
    - from: "packages/charts/src/scatter/scatter-chart.ts"
      to: "packages/charts/src/scatter/scatter-registry.ts"
      via: "_registerModules() calls registerScatterModules()"
      pattern: "registerScatterModules"
    - from: "packages/charts/src/index.ts"
      to: "packages/charts/src/scatter/scatter-chart.ts"
      via: "public API re-export"
      pattern: "export.*LuiScatterChart"
---

<objective>
Implement LuiScatterChart (lui-scatter-chart) — the Lit custom element extending BaseChartElement — and add the Phase 92 public API exports to index.ts.

Purpose: Closes all three SCAT requirements. The component wires together scatter-registry, scatter-option-builder, and BaseChartElement into a working custom element with bubble mode and WebGL path switching.

Output: scatter-chart.ts (LuiScatterChart), updated index.ts with Phase 92 exports
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/92-scatter-bubble-chart-with-webgl/92-01-SUMMARY.md

@packages/charts/src/pie/pie-chart.ts
@packages/charts/src/shared/scatter-option-builder.ts
@packages/charts/src/scatter/scatter-registry.ts
@packages/charts/src/index.ts
</context>

<interfaces>
<!-- Key types and contracts for this plan, extracted from Plan 01 output. -->

From packages/charts/src/shared/scatter-option-builder.ts (created in Plan 01):
```typescript
export type ScatterPoint = [number, number] | [number, number, number];

export type ScatterOptionProps = {
  bubble?: boolean;
  useGl?: boolean;
  symbolSize?: number;
};

export function buildScatterOption(
  data: ScatterPoint[],
  props: ScatterOptionProps
): Record<string, unknown>
```

From packages/charts/src/scatter/scatter-registry.ts (created in Plan 01):
```typescript
export async function registerScatterModules(): Promise<void>
```

From packages/charts/src/pie/pie-chart.ts (the exact pattern to mirror):
```typescript
import { property } from 'lit/decorators.js';
import type { PropertyValues } from 'lit';
import { BaseChartElement } from '../base/base-chart-element.js';
// reactive props via @property decorator
// _registerModules() calls the chart-specific registry
// updated(changed) watches relevant props and calls _applyData()
// _applyData() builds option and calls this._chart.setOption(option, { notMerge: false })
// customElements.define guard + HTMLElementTagNameMap declaration
```

From packages/charts/src/base/base-chart-element.ts (critical fields, after Plan 01 change):
```typescript
@property({ type: Boolean, attribute: 'enable-gl' }) enableGl = false;
protected _webglUnavailable = false;    // protected after Plan 01 change
protected _streamingMode: 'appendData' | 'buffer' = 'buffer';
protected _chart: EChartsType | null = null;
// data, loading, maxPoints, option — inherited reactive props
// pushData(point) — inherited streaming method using circular buffer
// getChart() — inherited ECharts instance accessor
```

Current packages/charts/src/index.ts tail (append Phase 92 section after this):
```typescript
// Phase 91: Pie + Donut Chart
export { LuiPieChart } from './pie/pie-chart.js';
export type { PieSlice, PieOptionProps } from './shared/pie-option-builder.js';
```
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Create LuiScatterChart component (scatter-chart.ts)</name>
  <files>packages/charts/src/scatter/scatter-chart.ts</files>
  <action>
    Create packages/charts/src/scatter/scatter-chart.ts following the exact LuiPieChart pattern (packages/charts/src/pie/pie-chart.ts).

    **Component structure:**

    ```typescript
    /**
     * LuiScatterChart — Scatter/Bubble chart component extending BaseChartElement.
     *
     * SCAT-01: bubble prop adds third dimension driving symbol size (Canvas mode only)
     * SCAT-02: enable-gl attribute (inherited from base) selects type: 'scatterGL' WebGL path
     * SCAT-03: streaming via inherited pushData() — circular buffer path (base default)
     *
     * STRM-04 compliance: DO NOT override _streamingMode — base 'buffer' is correct.
     * scatterGL does NOT support appendData (only linesGL does in echarts-gl 2.0.9).
     * Both Canvas and GL modes use circular buffer + setOption.
     */

    import { property } from 'lit/decorators.js';
    import type { PropertyValues } from 'lit';
    import { BaseChartElement } from '../base/base-chart-element.js';
    import { registerScatterModules } from './scatter-registry.js';
    import { buildScatterOption, type ScatterPoint } from '../shared/scatter-option-builder.js';

    export class LuiScatterChart extends BaseChartElement {
      // NO _streamingMode override — base 'buffer' is correct for scatter charts (SCAT-03).
      // scatterGL uses GPU progressive rendering, not appendData.

      // SCAT-01: When true, data format is [x, y, size]; symbolSize callback reads value[2].
      // Canvas mode only — GL mode uses fixed symbolSize (scatterGL limitation).
      @property({ type: Boolean }) bubble = false;

      protected override async _registerModules(): Promise<void> {
        await registerScatterModules();
      }

      override updated(changed: PropertyValues): void {
        super.updated(changed); // base handles this.option passthrough and this.loading state
        if (!this._chart) return;
        // SCAT-02: Watch enableGl so series type updates if enable-gl is toggled at runtime.
        const scatterProps = ['data', 'bubble', 'enableGl'] as const;
        if (scatterProps.some((k) => changed.has(k))) {
          this._applyData();
        }
      }

      private _applyData(): void {
        if (!this._chart || !this.data) return;
        // SCAT-02: useGl requires BOTH enableGl set AND successful WebGL probe.
        // _webglUnavailable is protected in BaseChartElement (changed in Plan 01).
        const useGl = this.enableGl && !this._webglUnavailable;
        const option = buildScatterOption(this.data as ScatterPoint[], {
          bubble: this.bubble,
          useGl,
        });
        this._chart.setOption(option, { notMerge: false });
      }
    }
    ```

    Add SSR-safe custom element registration at the bottom (same guard as all other chart components):
    ```typescript
    if (typeof customElements !== 'undefined' && !customElements.get('lui-scatter-chart')) {
      customElements.define('lui-scatter-chart', LuiScatterChart);
    }

    declare global {
      interface HTMLElementTagNameMap {
        'lui-scatter-chart': LuiScatterChart;
      }
    }
    ```

    Critical notes:
    - NO constructor — base _streamingMode = 'buffer' is the correct default; do not override it
    - enableGl is a reactive property inherited from BaseChartElement — it IS in the PropertyValues map when it changes
    - The changed.has('enableGl') check with `as const` tuple relies on Lit's PropertyValues which uses the property KEY, not the attribute name. The property is `enableGl` (camelCase) not `enable-gl`
    - _webglUnavailable is now `protected` after Plan 01 — TypeScript will accept `this._webglUnavailable` in this subclass
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components && npx tsc --noEmit -p packages/charts/tsconfig.json 2>&1 | head -20</automated>
  </verify>
  <done>
    - packages/charts/src/scatter/scatter-chart.ts exists and exports LuiScatterChart
    - LuiScatterChart has bubble @property (type: Boolean)
    - _registerModules() calls registerScatterModules()
    - updated() watches data, bubble, enableGl and calls _applyData()
    - _applyData() passes useGl = this.enableGl && !this._webglUnavailable to buildScatterOption()
    - customElements.define('lui-scatter-chart') guard present
    - TypeScript compiles with zero errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Update index.ts with Phase 92 exports and verify full build</name>
  <files>packages/charts/src/index.ts</files>
  <action>
    Append the Phase 92 export section to packages/charts/src/index.ts after the existing Phase 91 block:

    ```typescript
    // Phase 92: Scatter + Bubble Chart
    export { LuiScatterChart } from './scatter/scatter-chart.js';
    export type { ScatterPoint, ScatterOptionProps } from './shared/scatter-option-builder.js';
    ```

    After editing index.ts, run the Vite build to confirm the dist/ output is valid:
    ```bash
    cd /Users/sn0w/Documents/dev/lit-components && npm run build --workspace=packages/charts
    ```

    Verify the build output dist/index.d.ts contains:
    - `export declare class LuiScatterChart`
    - `export declare type ScatterPoint`
    - `export declare type ScatterOptionProps`
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components && npm run build --workspace=packages/charts 2>&1 | tail -10</automated>
  </verify>
  <done>
    - packages/charts/src/index.ts has Phase 92 section exporting LuiScatterChart, ScatterPoint, ScatterOptionProps
    - Vite build completes with zero errors
    - dist/index.d.ts contains LuiScatterChart, ScatterPoint, ScatterOptionProps declarations
  </done>
</task>

</tasks>

<verification>
Full TypeScript compile + build verification:
```bash
cd /Users/sn0w/Documents/dev/lit-components && npx tsc --noEmit -p packages/charts/tsconfig.json && npm run build --workspace=packages/charts
```

Spot-check the public API:
```bash
grep -n "LuiScatterChart\|ScatterPoint\|ScatterOptionProps" /Users/sn0w/Documents/dev/lit-components/packages/charts/dist/index.d.ts
```
</verification>

<success_criteria>
- lui-scatter-chart custom element is registered and exported from @lit-ui/charts
- LuiScatterChart.bubble prop (Boolean) controls scatter vs bubble mode
- LuiScatterChart reads this.enableGl && !this._webglUnavailable to pass useGl to buildScatterOption()
- No _streamingMode override — inherits base 'buffer' for STRM-04 compliance
- Vite build succeeds and dist/index.d.ts exports LuiScatterChart, ScatterPoint, ScatterOptionProps
- SCAT-01, SCAT-02, SCAT-03 requirements all addressed
</success_criteria>

<output>
After completion, create `.planning/phases/92-scatter-bubble-chart-with-webgl/92-02-SUMMARY.md`
</output>
