---
phase: 92-scatter-bubble-chart-with-webgl
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/charts/src/echarts-gl.d.ts
  - packages/charts/src/base/base-chart-element.ts
  - packages/charts/src/shared/scatter-option-builder.ts
  - packages/charts/src/scatter/scatter-registry.ts
autonomous: true
requirements: [SCAT-01, SCAT-02, SCAT-03]

must_haves:
  truths:
    - "TypeScript compiles packages/charts with zero errors after echarts-gl type shim is added"
    - "buildScatterOption() returns type: 'scatter' when useGl is false and type: 'scatterGL' when useGl is true"
    - "buildScatterOption() with bubble:true installs symbolSize callback (Canvas) or fixed symbolSize (GL)"
    - "registerScatterModules() registers both ScatterChart and ScatterGLChart with ECharts use()"
    - "_webglUnavailable field is accessible from subclasses via protected visibility"
  artifacts:
    - path: "packages/charts/src/echarts-gl.d.ts"
      provides: "TypeScript module declarations for echarts-gl, echarts-gl/charts subpaths"
      contains: "declare module 'echarts-gl/charts'"
    - path: "packages/charts/src/base/base-chart-element.ts"
      provides: "protected _webglUnavailable field accessible to LuiScatterChart"
      contains: "protected _webglUnavailable"
    - path: "packages/charts/src/shared/scatter-option-builder.ts"
      provides: "ScatterPoint type + ScatterOptionProps type + buildScatterOption() function"
      exports: ["ScatterPoint", "ScatterOptionProps", "buildScatterOption"]
    - path: "packages/charts/src/scatter/scatter-registry.ts"
      provides: "registerScatterModules() with _scatterRegistered guard"
      exports: ["registerScatterModules"]
  key_links:
    - from: "packages/charts/src/scatter/scatter-registry.ts"
      to: "echarts/core use()"
      via: "registers ScatterChart and ScatterGLChart"
      pattern: "use\\(\\[ScatterChart\\]\\)"
    - from: "packages/charts/src/shared/scatter-option-builder.ts"
      to: "ECharts series config"
      via: "conditional series type string"
      pattern: "useGl.*scatterGL.*scatter"
---

<objective>
Create the foundational contracts for Phase 92: TypeScript type shim for echarts-gl subpath imports, promote _webglUnavailable to protected in BaseChartElement, implement the pure-TypeScript scatter option builder, and implement the scatter ECharts module registry.

Purpose: LuiScatterChart (Plan 02) cannot be written without these contracts in place. The type shim removes the @ts-ignore workaround from Phase 88. The _webglUnavailable visibility change enables the scatter component to select the correct series type at runtime.

Output: echarts-gl.d.ts, base-chart-element.ts (one-line change), scatter-option-builder.ts, scatter-registry.ts
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/92-scatter-bubble-chart-with-webgl/92-RESEARCH.md

@packages/charts/src/base/base-chart-element.ts
@packages/charts/src/shared/pie-option-builder.ts
@packages/charts/src/pie/pie-registry.ts
@packages/charts/src/vite-env.d.ts
</context>

<interfaces>
<!-- Key types and patterns the executor needs. Extracted from codebase. -->

From packages/charts/src/shared/pie-option-builder.ts (mirror this pattern):
```typescript
export type PieSlice = { name: string; value: number; };
export type PieOptionProps = { minPercent?: number; innerRadius?: string | number; centerLabel?: string; };
export function buildPieOption(slices: PieSlice[], props: PieOptionProps): Record<string, unknown>
```

From packages/charts/src/pie/pie-registry.ts (mirror this guard pattern exactly):
```typescript
let _pieRegistered = false;
export async function registerPieModules(): Promise<void> {
  if (_pieRegistered) return;
  _pieRegistered = true;
  const { registerCanvasCore } = await import('../registry/canvas-core.js');
  await registerCanvasCore();
  const [{ PieChart }, { use }] = await Promise.all([
    import('echarts/charts'),
    import('echarts/core'),
  ]);
  use([PieChart]);
}
```

From packages/charts/src/base/base-chart-element.ts (the one-line change):
```typescript
// Line 122 — change from:
private _webglUnavailable = false;
// To:
protected _webglUnavailable = false;
```

From packages/charts/src/vite-env.d.ts (existing file — echarts-gl.d.ts is a NEW separate file, not added here):
```typescript
/// <reference types="vite/client" />
```
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: echarts-gl type shim + BaseChartElement _webglUnavailable visibility</name>
  <files>packages/charts/src/echarts-gl.d.ts, packages/charts/src/base/base-chart-element.ts</files>
  <action>
    **Step 1: Create packages/charts/src/echarts-gl.d.ts**

    This resolves the STATE.md blocker: "echarts-gl 2.0.9 does not ship type definitions as subpath exports — declaration shims needed (Phase 92 scope)".

    Create the file with module declarations for 'echarts-gl' (side-effect default import) and 'echarts-gl/charts' (named exports). Use `EChartsExtensionInstallRegisters` type from 'echarts/core' for the install signature. Declare the following exports in 'echarts-gl/charts': ScatterGLChart, GraphGLChart, FlowGLChart, LinesGLChart, Bar3DChart, Line3DChart, Scatter3DChart. Each is typed as `{ install(registers: EChartsExtensionInstallRegisters): void }`.

    Example structure:
    ```typescript
    declare module 'echarts-gl' {
      const _default: unknown;
      export default _default;
    }

    declare module 'echarts-gl/charts' {
      import type { EChartsExtensionInstallRegisters } from 'echarts/core';
      export type EChartsGLExtension = {
        install(registers: EChartsExtensionInstallRegisters): void;
      };
      export const ScatterGLChart: EChartsGLExtension;
      // ... other GL chart exports
    }
    ```

    **Step 2: Edit packages/charts/src/base/base-chart-element.ts**

    Change line 122 (confirmed by grep: `private _webglUnavailable = false;`) from `private` to `protected`. This is a one-line change. All behavior is identical — the field remains non-public. The change allows LuiScatterChart (a subclass) to read `this._webglUnavailable` to determine whether the WebGL probe succeeded.

    Add JSDoc comment:
    ```typescript
    /** Set to true when WebGL probe fails; readable by subclasses for series type selection. */
    protected _webglUnavailable = false;
    ```

    Do NOT change any other lines. Do NOT remove the @ts-ignore on the existing echarts-gl import in _maybeLoadGl() — that can be optionally cleaned up after the shim is added, but it is out of scope.
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components && npx tsc --noEmit -p packages/charts/tsconfig.json 2>&1 | head -20</automated>
  </verify>
  <done>
    - packages/charts/src/echarts-gl.d.ts exists with declare module 'echarts-gl/charts' block exporting ScatterGLChart
    - packages/charts/src/base/base-chart-element.ts line containing _webglUnavailable has 'protected' (not 'private')
    - TypeScript compiles packages/charts with zero errors
  </done>
</task>

<task type="auto">
  <name>Task 2: scatter-option-builder.ts + scatter-registry.ts</name>
  <files>packages/charts/src/shared/scatter-option-builder.ts, packages/charts/src/scatter/scatter-registry.ts</files>
  <action>
    **Step 1: Create packages/charts/src/shared/scatter-option-builder.ts**

    Export types and the option builder function:

    ```typescript
    // SCAT-01: [x, y] for scatter, [x, y, size] for bubble
    export type ScatterPoint = [number, number] | [number, number, number];

    export type ScatterOptionProps = {
      // SCAT-01: When true, reads value[2] as symbol size (Canvas only).
      bubble?: boolean;
      // SCAT-02: When true, emits type: 'scatterGL'. Default: false (Canvas).
      useGl?: boolean;
      // Fixed symbol size when bubble is false. Default: 10.
      symbolSize?: number;
    };
    ```

    Implement `buildScatterOption(data: ScatterPoint[], props: ScatterOptionProps): Record<string, unknown>`:

    - Series type: `props.useGl ? 'scatterGL' : 'scatter'`
    - symbolSize logic:
      - If `props.bubble && !props.useGl`: use callback `(value: number[]) => value[2] ?? 10` — reads third dimension for per-point bubble size. Canvas scatter supports this.
      - If `props.bubble && props.useGl`: use fixed `symbolSize: props.symbolSize ?? 10` — scatterGL does NOT support per-point callbacks (GPU-side rendering). Log a dev warning: `console.warn('[LuiScatterChart] bubble symbolSize callback not supported in GL mode; using fixed size.')`
      - If not bubble: use fixed `symbolSize: props.symbolSize ?? 10`
    - When `props.useGl` is true, add GL-specific series options: `progressive: 1e5`, `progressiveThreshold: 1e5`, `blendMode: 'source-over'`
    - Return: `{ grid: { containLabel: true }, xAxis: { type: 'value' }, yAxis: { type: 'value' }, tooltip: { trigger: 'item', formatter: <custom formatter when bubble && !useGl showing "(x, y) size: r"> }, series: [series] }`
    - Tooltip formatter for bubble Canvas mode: `(params) => { const val = (params as Record<string, unknown>)['value'] as number[]; return \`(${val[0]}, ${val[1]}) size: ${val[2]}\`; }`

    **Step 2: Create packages/charts/src/scatter/ directory and scatter-registry.ts**

    Mirror pie-registry.ts exactly, replacing pie-specific names:

    ```typescript
    let _scatterRegistered = false;

    export async function registerScatterModules(): Promise<void> {
      if (_scatterRegistered) return;
      _scatterRegistered = true;

      const { registerCanvasCore } = await import('../registry/canvas-core.js');
      await registerCanvasCore();

      const [{ ScatterChart }, { use }] = await Promise.all([
        import('echarts/charts'),
        import('echarts/core'),
      ]);
      use([ScatterChart]);

      // ScatterGLChart: always register so type: 'scatterGL' works when enable-gl is set.
      // _maybeLoadGl() in BaseChartElement side-effect-imports echarts-gl when enableGl is true,
      // but explicit use() ensures the tree-shaken build includes the correct module.
      // Type shim in echarts-gl.d.ts provides TypeScript types for this import.
      const { ScatterGLChart } = await import('echarts-gl/charts');
      use([ScatterGLChart]);
    }
    ```

    Do NOT use @ts-ignore on the echarts-gl/charts import — the type shim from Task 1 makes it type-safe.
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components && npx tsc --noEmit -p packages/charts/tsconfig.json 2>&1 | head -20</automated>
  </verify>
  <done>
    - packages/charts/src/shared/scatter-option-builder.ts exports ScatterPoint, ScatterOptionProps, buildScatterOption
    - buildScatterOption with useGl:false returns series.type === 'scatter'
    - buildScatterOption with useGl:true returns series.type === 'scatterGL' + progressive options
    - buildScatterOption with bubble:true, useGl:false has symbolSize as a function
    - buildScatterOption with bubble:true, useGl:true has symbolSize as a number (with dev warning)
    - packages/charts/src/scatter/scatter-registry.ts exports registerScatterModules() with _scatterRegistered guard
    - TypeScript compiles with zero errors
  </done>
</task>

</tasks>

<verification>
Run TypeScript compile check across all packages to confirm zero regressions:
```bash
cd /Users/sn0w/Documents/dev/lit-components && npx tsc --noEmit -p packages/charts/tsconfig.json
```

Verify file existence:
- packages/charts/src/echarts-gl.d.ts contains `declare module 'echarts-gl/charts'`
- packages/charts/src/base/base-chart-element.ts contains `protected _webglUnavailable`
- packages/charts/src/shared/scatter-option-builder.ts exports ScatterPoint, ScatterOptionProps, buildScatterOption
- packages/charts/src/scatter/scatter-registry.ts exports registerScatterModules
</verification>

<success_criteria>
- TypeScript compile passes with zero errors on packages/charts
- _webglUnavailable is protected (not private) in BaseChartElement
- echarts-gl.d.ts provides module declarations eliminating @ts-ignore requirement for echarts-gl/charts imports
- scatter-option-builder.ts correctly switches series type and symbolSize behavior based on useGl and bubble flags
- scatter-registry.ts registers both ScatterChart and ScatterGLChart via ECharts use()
</success_criteria>

<output>
After completion, create `.planning/phases/92-scatter-bubble-chart-with-webgl/92-01-SUMMARY.md`
</output>
