---
phase: 48-time-picker-core
plan: 05
type: execute
wave: 3
depends_on: ["48-01", "48-02", "48-03", "48-04"]
files_modified:
  - packages/time-picker/src/time-picker.ts
autonomous: true

must_haves:
  truths:
    - "User sees an input field displaying the current time value"
    - "User can click input or clock icon to open time selection popup"
    - "User can switch between clock face and dropdown interfaces in popup"
    - "User can click Now button to set current time"
    - "User can click Morning/Afternoon/Evening preset buttons"
    - "User can clear the time with X button"
    - "User sees timezone label when show-timezone is set"
    - "Component submits ISO 8601 HH:mm:ss value via ElementInternals"
    - "Validation rejects end time before start time when min-time is set"
    - "Popup positions correctly using Floating UI with flip/shift"
    - "Pressing Enter on spinbutton or selecting from clock/dropdown confirms and closes popup"
  artifacts:
    - path: "packages/time-picker/src/time-picker.ts"
      provides: "Main TimePicker component with popup, form integration, validation, presets"
      exports: ["TimePicker"]
      min_lines: 400
  key_links:
    - from: "packages/time-picker/src/time-picker.ts"
      to: "packages/time-picker/src/time-input.ts"
      via: "Composes TimeInput for spinbutton editing"
      pattern: "import.*time-input"
    - from: "packages/time-picker/src/time-picker.ts"
      to: "packages/time-picker/src/clock-face.ts"
      via: "Composes ClockFace in popup"
      pattern: "import.*clock-face"
    - from: "packages/time-picker/src/time-picker.ts"
      to: "packages/time-picker/src/time-dropdown.ts"
      via: "Composes TimeDropdown in popup"
      pattern: "import.*time-dropdown"
    - from: "packages/time-picker/src/time-picker.ts"
      to: "@floating-ui/dom"
      via: "computePosition for popup positioning"
      pattern: "import.*floating-ui"
---

<objective>
Build the main time-picker component that orchestrates input display, popup with clock face/dropdown, form integration, validation, and presets.

Purpose: This is the public-facing component (`lui-time-picker`) that users add to their forms. It composes the internal components (TimeInput, ClockFace, TimeDropdown) and handles all form-related behavior.
Output: Complete `lui-time-picker` component with popup, form integration, validation, and presets.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/48-time-picker-core/48-RESEARCH.md
@.planning/phases/48-time-picker-core/48-01-SUMMARY.md
@.planning/phases/48-time-picker-core/48-02-SUMMARY.md
@.planning/phases/48-time-picker-core/48-03-SUMMARY.md
@.planning/phases/48-time-picker-core/48-04-SUMMARY.md
@packages/date-picker/src/date-picker.ts
@packages/time-picker/src/time-utils.ts
@packages/time-picker/src/time-presets.ts
@packages/time-picker/src/time-input.ts
@packages/time-picker/src/clock-face.ts
@packages/time-picker/src/time-dropdown.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Main component structure with input display and popup</name>
  <files>packages/time-picker/src/time-picker.ts</files>
  <action>
Create `TimePicker` component extending TailwindElement with form association, following the date-picker pattern closely:

**Static and constructor:**
```typescript
static formAssociated = true;
private internals: ElementInternals | null = null;
constructor() {
  super();
  if (!isServer) {
    this.internals = this.attachInternals();
  }
}
```

**Public properties:**
- `value: string = ''` — ISO 8601 time string (HH:mm:ss), reflected as attribute
- `name: string = ''` — form field name
- `label: string = ''` — visible label text
- `placeholder: string = ''` — input placeholder (default: 'Select time')
- `required: boolean = false`
- `disabled: boolean = false`
- `readonly: boolean = false`
- `hour12: boolean` — default auto-detected from locale via `getDefaultHourCycle`
- `locale: string = 'en-US'`
- `step: number = 30` — dropdown interval in minutes
- `minTime: string = ''` — minimum time as HH:mm or HH:mm:ss
- `maxTime: string = ''` — maximum time as HH:mm or HH:mm:ss
- `allowOvernight: boolean = false` — for midnight-crossing validation
- `showTimezone: boolean = false` — show timezone label
- `timezone: string = ''` — specific timezone (defaults to user's local)
- `presets: boolean | TimePreset[] = false` — false=none, true=defaults, array=custom (attribute: false)
- `interfaceMode: 'clock' | 'dropdown' | 'both' = 'both'` — which popup interface to show

**Internal state:**
- `isOpen: boolean = false`
- `internalValue: TimeValue | null = null` — parsed from value string
- `activeInterface: 'clock' | 'dropdown' = 'clock'` — which interface tab is active in popup
- `clockMode: 'hour' | 'minute' = 'hour'` — clock face current mode
- `internalError: string = ''`

**Render structure:**
```
<div class="time-picker-wrapper">
  {if label:} <label class="time-picker-label">${label}</label>
  <div class="time-picker-input-row">
    <div class="input-display" @click=${openPopup}>
      <span class="display-text">${displayValue || placeholder}</span>
      {if showTimezone:} <span class="timezone-label">${timezoneLabel}</span>
      {if value && !readonly && !disabled:} <button class="clear-btn" @click=${clearValue}>✕</button>
      <button class="toggle-btn" @click=${togglePopup} aria-label="Toggle time picker">
        <!-- Clock icon SVG -->
      </button>
    </div>
  </div>
  {if isOpen:}
  <div class="time-picker-popup" role="dialog" aria-label="Select time">
    <!-- TimeInput spinbuttons at top -->
    <lui-time-input .value=${internalValue} .hour12=${hour12}></lui-time-input>

    {if interfaceMode !== 'dropdown':}
    <!-- Interface tabs (if both) -->
    {if interfaceMode === 'both':}
    <div class="interface-tabs" role="tablist">
      <button role="tab" aria-selected=${activeInterface==='clock'} @click=${() => activeInterface='clock'}>Clock</button>
      <button role="tab" aria-selected=${activeInterface==='dropdown'} @click=${() => activeInterface='dropdown'}>List</button>
    </div>

    <!-- Clock face or dropdown -->
    {if activeInterface === 'clock':}
    <lui-clock-face .mode=${clockMode} .hour=${hour} .minute=${minute} .hour12=${hour12}></lui-clock-face>
    {else:}
    <lui-time-dropdown .value=${internalValue} .step=${step} .hour12=${hour12} .locale=${locale}></lui-time-dropdown>

    <!-- Preset buttons -->
    {if presets:}
    <div class="preset-buttons">
      <button class="now-btn" @click=${selectNow}>Now</button>
      ${presetList.map(p => html`<button class="preset-btn" @click=${() => selectPreset(p)}>${p.label}</button>`)}
    </div>

    <!-- Error message -->
    {if internalError:} <div class="error-message" role="alert">${internalError}</div>
  </div>
</div>
```

**Popup positioning (Floating UI):**
- Use `computePosition` with `flip({ fallbackPlacements: ['top-start'] })`, `shift({ padding: 8 })`, `offset(4)` — same middleware as date-picker (Phase 44-03 decision)
- Position strategy: `fixed` (consistent with date-picker)
- Cleanup on close via `autoUpdate` return value

**Click-outside detection:**
- Add document `pointerdown` listener when popup opens
- Use `e.composedPath().includes(this)` for Shadow DOM compatibility (Phase 44-03 decision)
- Remove listener on close

**Display value formatting:**
- If `internalValue` exists: use `formatTimeForDisplay(internalValue, locale, hour12)`
- If showTimezone: append timezone label from `getTimeZoneLabel(locale, timezone)`

**Value synchronization:**
- When `value` property changes: parse via `parseTimeISO` into `internalValue`
- When internal components emit changes: update `internalValue`, convert to ISO via `timeToISO`, set `this.value`, call `updateFormValue()`

**Event handlers:**
- Listen for `ui-time-input-change` on TimeInput: update internalValue
- Listen for `ui-clock-select` on ClockFace: when mode='hour', set hour and switch clockMode to 'minute'; when mode='minute', set minute and close popup
- Listen for `ui-time-dropdown-select` on TimeDropdown: set value and close popup
- Enter key on spinbuttons: confirm and close popup (TP-13)

**Clear button:**
- Sets value to '', internalValue to null, updates form value to null
- stopPropagation to prevent opening popup (same pattern as date-picker)
  </action>
  <verify>Run `npx tsc --noEmit -p packages/time-picker/tsconfig.json` — no type errors.</verify>
  <done>Main TimePicker component renders input display with popup containing TimeInput spinbuttons, clock face / dropdown interface tabs, preset buttons, and Now button.</done>
</task>

<task type="auto">
  <name>Task 2: Form integration, validation, and keyboard confirmation</name>
  <files>packages/time-picker/src/time-picker.ts</files>
  <action>
Add form integration and validation to the TimePicker component:

**Form value management (ElementInternals):**
- `updateFormValue()`: call `this.internals?.setFormValue(this.value || null)`
- Call `updateFormValue()` after every value change
- Value format: ISO 8601 time string `HH:mm:ss` (e.g., "14:30:00")

**Validation:**
1. **Required validation:** If `required` and value is empty → `valueMissing` with message "Please select a time"
2. **Min time validation:** If `minTime` set and value < minTime → `rangeUnderflow` with message "Time must be after ${formatted minTime}"
3. **Max time validation:** If `maxTime` set and value > maxTime → `rangeOverflow` with message "Time must be before ${formatted maxTime}"
4. **End-after-start validation:** If `minTime` set → use `isEndTimeAfterStart(minTime, value, allowOvernight)` (TP-09)
5. **Validation method:** `validate()` runs all checks, calls `this.internals?.setValidity(flags, message, anchor)` where anchor is the input display element
6. Call `validate()` in `updated()` when value changes, and on blur

**Form lifecycle callbacks:**
- `formResetCallback()`: value='', internalValue=null, close popup, clear validity, setFormValue(null)
- `formDisabledCallback(disabled)`: this.disabled = disabled
- `formStateRestoreCallback(state)`: if string, set value = state, parse to internalValue

**Error display:**
- `internalError` string shown below input when validation fails
- `aria-invalid="true"` on input display when error exists
- Error div has `role="alert"` for screen reader announcement

**Keyboard confirmation (TP-13):**
- Enter key pressed while popup is open: confirm current value, close popup
- Escape key: close popup without changing value, restore focus to input

**Focus management:**
- On popup open: focus the hour spinbutton in TimeInput
- On popup close: restore focus to the toggle button
- Tab within popup: trapped between TimeInput fields and preset buttons
- Use `requestAnimationFrame` for focus restoration (consistent with date-picker pattern)

**Preset handling:**
- `presets` property: if `true`, use `DEFAULT_TIME_PRESETS`; if array, use provided presets
- Preset click: call `preset.resolve()`, set as internalValue, update value, close popup
- Now button: call `resolveNow()`, same flow
- Preset buttons get `type="button"` to prevent form submission

**Timezone label:**
- If `showTimezone`: display timezone name using `Intl.DateTimeFormat(locale, { timeZoneName: 'short', ...(timezone && { timeZone: timezone }) }).formatToParts(new Date())`
- Display next to the time value in the input display area (TP-08)
  </action>
  <verify>Run `npx tsc --noEmit -p packages/time-picker/tsconfig.json` — no type errors. Verify formAssociated=true, attachInternals called, setFormValue called after value changes, validate() method exists with required/min/max checks.</verify>
  <done>TimePicker integrates with forms via ElementInternals, submits HH:mm:ss ISO 8601 format, validates required/min/max/end-after-start, displays inline errors, handles form reset/disable/state restore, and confirms with Enter key.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit -p packages/time-picker/tsconfig.json` — no type errors
2. TimePicker class exported from time-picker.ts
3. `static formAssociated = true` and `attachInternals()` with isServer guard
4. setFormValue called with ISO 8601 time string on value change
5. validate() checks required, minTime, maxTime, end-after-start
6. Popup opens/closes with Floating UI positioning
7. Clock face and dropdown both available in popup
8. Presets (Now + Morning/Afternoon/Evening) render and work
9. Enter confirms, Escape cancels, focus managed correctly
</verification>

<success_criteria>
- Input displays formatted time with locale-aware formatting
- Popup opens with clock face and dropdown interfaces (tabs to switch)
- Clock face: hour selection -> auto-switch to minute -> auto-close on minute select
- Dropdown: single click selects time and closes popup
- Form integration: setFormValue('14:30:00'), setValidity for required/min/max
- Presets: Now button + configurable preset buttons
- Timezone label displays when showTimezone=true
- Enter confirms, Escape cancels, click-outside closes
- Focus trapped in popup, restored to input on close
</success_criteria>

<output>
After completion, create `.planning/phases/48-time-picker-core/48-05-SUMMARY.md`
</output>
