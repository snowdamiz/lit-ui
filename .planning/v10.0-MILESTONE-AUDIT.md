---
milestone: v10.0
audited: 2026-03-01T22:00:00Z
status: gaps_found
scores:
  requirements: 11/11 (2 have cross-phase integration gaps)
  phases: 7/7 (all automated checks passed)
  integration: 3/4 checked (Issue 1 blocks STRM-02 + WEBGPU-03 cross-phase path)
  flows: 4/4 (Flow 2 and 4 have partial GPU cleanup gap on streaming reset)
gaps:
  requirements:
    - id: "STRM-02"
      status: "partial"
      phase: "Phase 100 + Phase 101 cross-phase"
      claimed_by_plans: ["100-02-PLAN.md", "100-03-PLAN.md"]
      completed_by_plans: ["100-02-SUMMARY.md", "100-03-SUMMARY.md"]
      verification_status: "passed (phase-level); integration gap found"
      evidence: "_triggerReset() in both line-chart.ts (line 267) and area-chart.ts (line 253) does not dispose the ChartGPU layer or call releaseGpuDevice() before reinitializing ECharts. GPU canvas leak manifests when WebGPU-enabled streaming crosses the 500K maxPoints boundary."
    - id: "WEBGPU-03"
      status: "partial"
      phase: "Phase 98 + Phase 101 cross-phase"
      claimed_by_plans: ["98-01-PLAN.md", "98-02-PLAN.md"]
      completed_by_plans: ["98-01-SUMMARY.md", "98-02-SUMMARY.md"]
      verification_status: "passed (phase-level); integration gap found"
      evidence: "_triggerReset() does not decrement the GPUDevice refcount before re-calling _initChart(), which re-increments it. Repeated streaming resets on WebGPU path leave stale refcount increments, eventually preventing correct device.destroy() when the last chart disconnects."
  integration:
    - "Phase 100+101: _triggerReset() missing GPU cleanup path — affects both LuiLineChart (line-chart.ts:267) and LuiAreaChart (area-chart.ts:253)"
    - "Phase 101: Shadow DOM compatibility of ChartGPU ResizeObserver not formally validated — unverified open risk, no runtime failure documented"
  flows:
    - "Flow 2 (1M+ streaming): _triggerReset() leaks GPU canvas when WebGPU enabled; partial fix needed in line-chart.ts and area-chart.ts"
    - "Flow 4 (WebGPU candlestick): unaffected by _triggerReset() since LuiCandlestickChart uses _barRafId not _triggerReset()"
tech_debt:
  - phase: 103-candlestick-webgpu
    items:
      - "REQUIREMENTS.md not updated — WEBGPU-CNDL-01/02/03 are defined only in ROADMAP.md and plan frontmatter, not in REQUIREMENTS.md"
      - "REQUIREMENTS.md Out of Scope table still lists 'WebGPU render path for Candlestick' — contradicts Phase 103 implementation"
  - phase: 101-webgpu-two-layer-canvas-for-line-area
    items:
      - "REQUIREMENTS.md WEBGPU-02 description mentions convertToPixel() but implementation uses percent-space setZoomRange() — REQUIREMENTS.md description is outdated"
      - "Shadow DOM ChartGPU compatibility: open risk with no formal prototype validation documented"
  - phase: 98-webgpu-detector-renderer-infrastructure
    items:
      - "4 browser-environment tests need human verification (WebGPU device acquisition, singleton behavior, Canvas fallback, SSR safety)"
  - phase: 99-incremental-moving-average-state-machine
    items:
      - "2 browser-environment tests need human verification (CSS token color resolution, showType legend label rendering)"
  - phase: 100-1m-streaming-infrastructure-for-line-area
    items:
      - "4 browser-environment tests need human verification (1M+ stress test, seriesIndex routing, LTTB quality, RAF cancel guard)"
  - phase: 102-docs-skills-update
    items:
      - "Phase 102 pre-dates Phase 103 — shared charts SKILL.md was updated by Phase 103 to include candlestick, but Phase 102 doc commits don't reflect this"
  - phase: 104-update-code-example-blocks-for-all-chart-types-they-are-not-accurate-most-are-displaying-html-for-all-tabs
    items:
      - "3 browser-environment tests need human verification (tab switching, heatmap completeness, OHLC warning visibility)"
---

# v10.0 WebGPU Charts — Milestone Audit Report

**Audited:** 2026-03-01
**Milestone:** v10.0 WebGPU Charts
**Phases in scope:** 98, 99, 100, 101, 102, 103, 104 (7 phases)
**Status:** gaps_found

---

## Executive Summary

All 11 formal REQUIREMENTS.md requirements are satisfied at the phase level. A cross-phase integration check found one medium-severity code gap: `_triggerReset()` in `LuiLineChart` and `LuiAreaChart` does not clean up the ChartGPU GPU canvas layer before reinitializing, leaving stale GPU resources when WebGPU-enabled streaming crosses the 500K-point maxPoints boundary. This gap touches STRM-02 and WEBGPU-03.

Additionally, Phase 103 introduced requirements (WEBGPU-CNDL-01/02/03) that were never added to REQUIREMENTS.md, creating a documentation inconsistency. This does not affect functionality.

---

## Phase Verification Summary

| Phase | Name | Status | Score | Critical Gaps |
|-------|------|--------|-------|---------------|
| 98 | WebGPU Detector + Renderer Infrastructure | ✅ passed | 7/7 | None |
| 99 | Incremental Moving Average State Machine | ✅ passed | 14/14 | None |
| 100 | 1M+ Streaming Infrastructure for Line/Area | ✅ passed | 13/13 | None |
| 101 | WebGPU Two-Layer Canvas for Line/Area | ⚠ human_needed | 13/13 auto | 4 browser tests pending |
| 102 | Docs + Skills Update | ✅ passed | 10/10 | None |
| 103 | Candlestick WebGPU + Docs + Skills | ⚠ human_needed | 10/10 auto | 5 browser tests pending; REQUIREMENTS.md gap |
| 104 | Update Code Example Blocks | ✅ passed | 11/11 | None |

**All 7 phases have VERIFICATION.md files — no unverified phases.**

---

## Requirements Coverage (3-Source Cross-Reference)

| REQ-ID | Description | Phase | VERIFICATION | SUMMARY | REQUIREMENTS.md | Final Status |
|--------|-------------|-------|--------------|---------|-----------------|-------------|
| STRM-01 | 1M+ streaming with Float32Array TypedArray ring buffers | 100 | SATISFIED | 100-02, 100-03 | [x] | **satisfied** |
| STRM-02 | maxPoints truncation + dispose+reinit cycle | 100 | SATISFIED | 100-02, 100-03 | [x] | **partial** (GPU cleanup missing in WebGPU path) |
| STRM-03 | pushData(point, seriesIndex?) multi-series routing | 100 | SATISFIED | 100-02, 100-03 | [x] | **satisfied** |
| STRM-04 | sampling:lttb on all line/area series | 100 | SATISFIED | 100-01 | [x] | **satisfied** |
| MA-01 | O(1) incremental SMA/EMA state machine | 99 | SATISFIED | 99-03 | [x] | **satisfied** |
| MA-02 | CSS token default colors for MA overlays | 99 | SATISFIED | 99-02, 99-03 | [x] | **satisfied** |
| MA-03 | NaN closes produce null gaps in MA series | 99 | SATISFIED | 99-03 | [x] | **satisfied** |
| MA-04 | showType boolean appends type suffix to legend | 99 | SATISFIED | 99-02, 99-03 | [x] | **satisfied** |
| WEBGPU-01 | renderer-selected event + renderer property on all chart types | 98 | SATISFIED | 98-02 | [x] | **satisfied** |
| WEBGPU-02 | ChartGPU two-layer canvas for Line/Area with DataZoom sync | 101 | SATISFIED | 101-01..03 | [x] | **satisfied** (Shadow DOM risk noted) |
| WEBGPU-03 | Single GPUDevice singleton across all chart instances | 98 | SATISFIED | 98-01, 98-02 | [x] | **partial** (refcount leaks on streaming reset) |

**Orphan detection:** All 11 REQ-IDs in REQUIREMENTS.md traceability table appear in their assigned phase VERIFICATION.md files. Zero orphaned requirements.

**Undeclared requirements:** Phase 103 introduces WEBGPU-CNDL-01, WEBGPU-CNDL-02, WEBGPU-CNDL-03. These are covered by Phase 103 VERIFICATION.md but are absent from REQUIREMENTS.md.

---

## Cross-Phase Integration Findings

### Issue 1 — _triggerReset() Missing GPU Cleanup (Medium Severity)

**Affects:** STRM-02, WEBGPU-03
**Files:** `packages/charts/src/line/line-chart.ts:267`, `packages/charts/src/area/area-chart.ts:253`

When `_triggerReset()` is triggered (i.e., streaming exceeds `maxPoints = 500_000` on a WebGPU-enabled chart), the method disposes the ECharts instance and reinitializes via `requestAnimationFrame(() => this._initChart())`, but does **not** first clean up the ChartGPU layer.

**Missing steps before the RAF call:**
```typescript
this._gpuResizeObserver?.disconnect();
this._gpuResizeObserver = undefined;
this._gpuChart?.dispose();
this._gpuChart = null;
if (this._wasWebGpu) void releaseGpuDevice();
```

**Impact:**
- Stale ChartGPU canvas remains in DOM after reset
- `_refCount` is not decremented before `_initChart()` increments it again
- After a streaming session crosses N × 500K points, there are N stale refcount increments
- `device.destroy()` never fires correctly in this scenario

**Trigger condition:** Only manifests when both `enable-webgpu` is set AND streaming data volume exceeds `maxPoints`. Non-WebGPU streaming reset path is unaffected.

**Fix:** Add the five GPU cleanup lines to `_triggerReset()` before the RAF callback in both `line-chart.ts` and `area-chart.ts`.

---

### Issue 2 — Shadow DOM ChartGPU Compatibility (Low Severity)

**Affects:** WEBGPU-02
**Files:** `packages/charts/src/line/line-chart.ts`, `packages/charts/src/area/area-chart.ts`, `packages/charts/src/candlestick/candlestick-chart.ts`

Phase 101's research flagged Shadow DOM ResizeObserver compatibility with ChartGPU as an unresolved open risk. The implementation proceeds with the `insertBefore(gpuHost, ...)` pattern, which is structurally correct for Shadow DOM, but no prototype validation result was formally documented. No runtime failure has been reported.

**Risk:** If ChartGPU's internal ResizeObserver fails in Shadow DOM, the GPU canvas would not resize with the chart container. The external `_gpuResizeObserver` provided by the implementation mitigates this risk by calling `gpuChart.resize()` explicitly.

---

### Issue 3 — REQUIREMENTS.md Description Outdated (Informational)

**Affects:** WEBGPU-02 documentation only
**File:** `.planning/REQUIREMENTS.md` line 25

REQUIREMENTS.md describes WEBGPU-02 coordinate sync as using `convertToPixel()`. Phase 101 implemented percent-space `setZoomRange(start, end)` instead, which is architecturally cleaner. No user-facing skill file or docs page describes the internal mechanism, so there is no user-visible documentation inaccuracy.

---

## E2E User Flow Verification

| Flow | Description | Status | Issue |
|------|-------------|--------|-------|
| Flow 1 | Developer enables WebGPU on line chart (enable-webgpu → renderer-selected → ChartGPU init → DataZoom sync → disconnect cleanup) | ✅ Complete | None |
| Flow 2 | Developer streams 1M+ points (pushData → ring buffer → LTTB rendering → maxPoints → dispose+reinit) | ⚠ Partial | _triggerReset() missing GPU cleanup on WebGPU path |
| Flow 3 | Developer adds MA overlays to candlestick (moving-averages config → MAStateMachine init → _applyData O(n) reset → _flushBarUpdates O(1) push) | ✅ Complete | None |
| Flow 4 | Developer uses WebGPU candlestick (enable-webgpu → ChartGPU OHLC rendering → ECharts MA/axes/volume on top) | ✅ Complete | LuiCandlestickChart uses separate pushData path; not affected by _triggerReset() gap |

---

## Tech Debt Summary

### Documentation Gaps (Phase 103)

1. **REQUIREMENTS.md out-of-date:** WEBGPU-CNDL-01/02/03 IDs referenced in ROADMAP.md and plan files do not exist in REQUIREMENTS.md
2. **Out of Scope table:** Still lists "WebGPU render path for Candlestick" as out of scope — directly contradicts Phase 103 delivery
3. **Recommended fix:** Add WEBGPU-CNDL-01/02/03 definitions to REQUIREMENTS.md and remove the Candlestick row from Out of Scope

### API Description Gap (Phase 101)

4. **REQUIREMENTS.md WEBGPU-02:** Description says "coordinate sync via `convertToPixel()`" but implementation uses percent-space `setZoomRange()` — REQUIREMENTS.md description needs update

### Browser-Environment Verification Pending

The following items require human testing in a live browser — they are not code gaps:

- **Phase 98 (4 items):** WebGPU device acquisition in Chrome/Edge, singleton behavior across 10 instances, Canvas fallback in non-WebGPU browser, SSR safety in Next.js build
- **Phase 99 (2 items):** CSS token color resolution for MA overlays, showType legend label rendering
- **Phase 100 (4 items):** 1.2M-point streaming stress test, seriesIndex routing, LTTB zoom-out quality, disconnectedCallback RAF cancel guard
- **Phase 101 (4 items):** DataZoom coordinate alignment, z-index layering, non-WebGPU fallback, 10-cycle memory leak test
- **Phase 103 (5 items):** WebGPU candle rendering, ECharts layer separation, DataZoom alignment, Canvas fallback, disconnect memory leak
- **Phase 104 (3 items):** Framework tab switching, Heatmap example completeness, Candlestick OHLC warning visibility

**Total browser-verification items: 22** (all non-blocking; 0 code gaps)

---

## Gap Closure

The one code gap requiring fix (Issue 1) is self-contained and well-scoped:

**Files to modify:**
- `packages/charts/src/line/line-chart.ts` — `_triggerReset()` method (~line 267)
- `packages/charts/src/area/area-chart.ts` — `_triggerReset()` method (~line 253)

**Change:** Add GPU canvas cleanup (5 lines) before the `requestAnimationFrame(() => this._initChart())` call in each file. The same pattern is already implemented in `disconnectedCallback()` of both files — copy and adapt.

---

_Audited: 2026-03-01T22:00:00Z_
_Auditor: Claude (gsd-audit-milestone)_
_Phases read: 7/7 VERIFICATION.md files_
_Requirements cross-referenced: 11/11 (3 sources: VERIFICATION + SUMMARY + REQUIREMENTS.md)_
_Integration checker: spawned (gsd-integration-checker)_
