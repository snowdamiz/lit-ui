---
phase: 91-pie-donut-chart
plan: 02
type: execute
wave: 2
depends_on: [91-01]
files_modified:
  - packages/charts/src/pie/pie-chart.ts
  - packages/charts/src/index.ts
autonomous: true
requirements: [PIE-03]

must_haves:
  truths:
    - "Developer can render a pie chart by setting the data prop with PieSlice[] and min-percent attribute"
    - "Developer can render a donut chart by setting inner-radius attribute and center-label attribute"
    - "Developer can call pushData({ name, value }) on a lui-pie-chart element and see proportions update without re-initialization"
    - "LuiPieChart, PieSlice, and PieOptionProps are importable from @lit-ui/charts"
  artifacts:
    - path: "packages/charts/src/pie/pie-chart.ts"
      provides: "LuiPieChart Lit custom element (lui-pie-chart)"
      exports: ["LuiPieChart"]
    - path: "packages/charts/src/index.ts"
      provides: "Public API exports for Phase 91"
      contains: "LuiPieChart"
  key_links:
    - from: "packages/charts/src/pie/pie-chart.ts"
      to: "packages/charts/src/pie/pie-registry.ts"
      via: "_registerModules() override calls registerPieModules()"
      pattern: "registerPieModules"
    - from: "packages/charts/src/pie/pie-chart.ts"
      to: "packages/charts/src/shared/pie-option-builder.ts"
      via: "_applyData() calls buildPieOption(this.data, props)"
      pattern: "buildPieOption"
    - from: "packages/charts/src/index.ts"
      to: "packages/charts/src/pie/pie-chart.ts"
      via: "re-export of LuiPieChart"
      pattern: "LuiPieChart"
---

<objective>
Create the LuiPieChart Lit web component and update index.ts with Phase 91 public API exports.

Purpose: Delivers the working pie/donut chart element that consumers use — wires together the option builder (Plan 01) and registry into an SSR-safe, streaming-capable Lit component.
Output: pie-chart.ts (LuiPieChart), updated index.ts
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/91-pie-donut-chart/91-RESEARCH.md
@.planning/phases/91-pie-donut-chart/91-01-SUMMARY.md

<interfaces>
<!-- Contracts created in Plan 01 that this plan implements against. -->

From packages/charts/src/shared/pie-option-builder.ts (created in Plan 01):
```typescript
export type PieSlice = {
  name: string;
  value: number;
};

export type PieOptionProps = {
  minPercent?: number;
  innerRadius?: string | number;
  centerLabel?: string;
};

export function buildPieOption(
  slices: PieSlice[],
  props: PieOptionProps
): Record<string, unknown>;
```

From packages/charts/src/pie/pie-registry.ts (created in Plan 01):
```typescript
export async function registerPieModules(): Promise<void>;
```

From packages/charts/src/bar/bar-chart.ts (Phase 90 pattern — LuiPieChart mirrors this exactly):
```typescript
export class LuiBarChart extends BaseChartElement {
  @property({ type: Boolean }) stacked = false;
  @property({ type: Boolean }) horizontal = false;
  @property({ type: Boolean, attribute: 'show-labels' }) showLabels = false;
  @property({ type: Boolean, attribute: 'color-by-data' }) colorByData = false;

  protected override async _registerModules(): Promise<void> {
    await registerBarModules();
  }

  override updated(changed: PropertyValues): void {
    super.updated(changed);
    if (!this._chart) return;
    const barProps = ['data', 'stacked', 'horizontal', 'showLabels', 'colorByData'] as const;
    if (barProps.some((k) => changed.has(k))) {
      this._applyData();
    }
  }

  private _applyData(): void {
    if (!this._chart || !this.data) return;
    const option = buildBarOption(this.data as BarChartSeries[], { ... });
    this._chart.setOption(option, { notMerge: false });
  }
}

if (typeof customElements !== 'undefined' && !customElements.get('lui-bar-chart')) {
  customElements.define('lui-bar-chart', LuiBarChart);
}

declare global {
  interface HTMLElementTagNameMap {
    'lui-bar-chart': LuiBarChart;
  }
}
```

From packages/charts/src/index.ts (current state after Plan 01 — append Phase 91 section after this):
```typescript
// Phase 90: Bar Chart
export { LuiBarChart } from './bar/bar-chart.js';
export type { BarChartSeries, BarOptionProps } from './shared/bar-option-builder.js';
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LuiPieChart component (pie-chart.ts)</name>
  <files>packages/charts/src/pie/pie-chart.ts</files>
  <action>
Create `packages/charts/src/pie/pie-chart.ts`. Mirror the Phase 90 LuiBarChart pattern exactly — replace bar-specific props with pie-specific props:

**Imports:**
```typescript
import { property } from 'lit/decorators.js';
import type { PropertyValues } from 'lit';
import { BaseChartElement } from '../base/base-chart-element.js';
import { registerPieModules } from './pie-registry.js';
import { buildPieOption, type PieSlice } from '../shared/pie-option-builder.js';
```

**Class `LuiPieChart extends BaseChartElement`:**

Add JSDoc comment block:
- PIE-01: small-slice merging below min-percent threshold
- PIE-02: donut mode via inner-radius; center-label in donut hole
- PIE-03: streaming via inherited pushData() — circular buffer path (base default)
- STRM-04 compliance: DO NOT override _streamingMode — base 'buffer' is correct for pie charts

**Props:**
```typescript
// PIE-01: Merge slices below this percentage into "Other". 0 = no merging (default).
@property({ type: Number, attribute: 'min-percent' }) minPercent = 0;

// PIE-02: Inner radius for donut mode. 0 or '' = filled pie. Example: '40%'.
// Note: @property without type converter — attribute value is received as string from HTML.
// buildPieOption handles string '0' as pie mode (same as numeric 0).
@property({ attribute: 'inner-radius' }) innerRadius: string | number = 0;

// PIE-02: Text displayed in the donut center hole. Only visible when innerRadius is non-zero.
@property({ attribute: 'center-label' }) centerLabel = '';
```

**`_registerModules()` override:**
```typescript
protected override async _registerModules(): Promise<void> {
  await registerPieModules();
}
```

**`updated(changed: PropertyValues)` override:**
```typescript
override updated(changed: PropertyValues): void {
  super.updated(changed); // base handles this.option passthrough and this.loading
  if (!this._chart) return;
  const pieProps = ['data', 'minPercent', 'innerRadius', 'centerLabel'] as const;
  if (pieProps.some((k) => changed.has(k))) {
    this._applyData();
  }
}
```

**`_applyData()` private method:**
```typescript
private _applyData(): void {
  if (!this._chart || !this.data) return;
  const option = buildPieOption(this.data as PieSlice[], {
    minPercent: this.minPercent,
    innerRadius: this.innerRadius,
    centerLabel: this.centerLabel || undefined,
  });
  // notMerge: false — merge with option prop overrides from the base class.
  this._chart.setOption(option, { notMerge: false });
}
```

Pass `centerLabel: this.centerLabel || undefined` — ensures empty string does not trigger center label injection in buildPieOption (which guards `if (isDonut && props.centerLabel)`).

**Custom element registration (after class declaration):**
```typescript
if (typeof customElements !== 'undefined' && !customElements.get('lui-pie-chart')) {
  customElements.define('lui-pie-chart', LuiPieChart);
}

declare global {
  interface HTMLElementTagNameMap {
    'lui-pie-chart': LuiPieChart;
  }
}
```

No `_streamingMode` override — inherits `'buffer'` from BaseChartElement. STRM-04 compliance.
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components && npx tsc -p packages/charts/tsconfig.json --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>pie-chart.ts compiles with zero TypeScript errors. LuiPieChart is exported. lui-pie-chart custom element registered with SSR guard. minPercent, innerRadius, centerLabel props defined with correct attribute names (min-percent, inner-radius, center-label). No _streamingMode override present.</done>
</task>

<task type="auto">
  <name>Task 2: Update index.ts exports and verify full build</name>
  <files>packages/charts/src/index.ts</files>
  <action>
Append the Phase 91 section to `packages/charts/src/index.ts` after the existing Phase 90 block:

```typescript
// Phase 91: Pie + Donut Chart
export { LuiPieChart } from './pie/pie-chart.js';
export type { PieSlice, PieOptionProps } from './shared/pie-option-builder.js';
```

Then run the full Vite build to confirm the compiled output (dist/index.d.ts) correctly declares all three new exports:
```
cd /Users/sn0w/Documents/dev/lit-components && npm run build -w packages/charts
```

Verify dist/index.d.ts contains `LuiPieChart`, `PieSlice`, `PieOptionProps` declarations.
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components && npm run build -w packages/charts 2>&1 | tail -20</automated>
  </verify>
  <done>Vite build completes with zero errors. dist/index.d.ts exports LuiPieChart (value), PieSlice (type), PieOptionProps (type). index.ts has Phase 91 comment section. All Phase 88-90 exports remain intact.</done>
</task>

</tasks>

<verification>
Confirm the full @lit-ui/charts public API surface after Phase 91 additions:
```
cd /Users/sn0w/Documents/dev/lit-components && npm run build -w packages/charts && grep -E "LuiPieChart|PieSlice|PieOptionProps" packages/charts/dist/index.d.ts
```

Expected output: Three matches — LuiPieChart class declaration, PieSlice type export, PieOptionProps type export.
</verification>

<success_criteria>
- packages/charts/src/pie/pie-chart.ts exists with LuiPieChart class
- lui-pie-chart is defined as a custom element with SSR guard
- minPercent (@property type: Number, attribute: 'min-percent') defaults to 0
- innerRadius (@property attribute: 'inner-radius') defaults to 0, accepts string | number
- centerLabel (@property attribute: 'center-label') defaults to ''
- updated() watches ['data', 'minPercent', 'innerRadius', 'centerLabel']
- _applyData() calls buildPieOption with centerLabel || undefined
- No _streamingMode override (inherits 'buffer' from BaseChartElement — STRM-04)
- packages/charts/src/index.ts has Phase 91 section exporting LuiPieChart, PieSlice, PieOptionProps
- npm run build -w packages/charts completes with zero errors
- dist/index.d.ts declares LuiPieChart, PieSlice, PieOptionProps
</success_criteria>

<output>
After completion, create `.planning/phases/91-pie-donut-chart/91-02-SUMMARY.md`
</output>
