---
phase: 095-treemap-chart
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/charts/src/shared/treemap-option-builder.ts
  - packages/charts/src/treemap/treemap-registry.ts
autonomous: true
requirements:
  - TREE-01
  - TREE-02

must_haves:
  truths:
    - "buildTreemapOption() accepts TreemapNode[] hierarchical data and returns a valid ECharts option object with type: 'treemap'"
    - "breadcrumb navigation is enabled by default (breadcrumb.show: true) and can be toggled off via props"
    - "per-level colors map to ECharts levels[n].color as string[] arrays"
    - "rounded prop maps to borderRadius: 6 on levels[].itemStyle when true, 0 when false"
    - "registerTreemapModules() registers TreemapChart via use() with a double-registration guard"
  artifacts:
    - path: "packages/charts/src/shared/treemap-option-builder.ts"
      provides: "TreemapNode, TreemapOptionProps, buildTreemapOption()"
      exports:
        - TreemapNode
        - TreemapOptionProps
        - buildTreemapOption
    - path: "packages/charts/src/treemap/treemap-registry.ts"
      provides: "registerTreemapModules() async function"
      exports:
        - registerTreemapModules
  key_links:
    - from: "packages/charts/src/shared/treemap-option-builder.ts"
      to: "ECharts series type: 'treemap'"
      via: "buildTreemapOption() return value"
      pattern: "type.*treemap"
    - from: "packages/charts/src/treemap/treemap-registry.ts"
      to: "echarts/charts TreemapChart"
      via: "use([TreemapChart])"
      pattern: "use\\(\\[TreemapChart\\]\\)"
---

<objective>
Create the treemap option builder (pure function + types) and module registry (ECharts registration) for Phase 95.

Purpose: Establishes the domain layer for treemap charts — data types, option construction, and ECharts module registration — following the identical two-file pattern used by every preceding chart phase (89-94).
Output: treemap-option-builder.ts (types + buildTreemapOption) and treemap-registry.ts (registerTreemapModules with double-registration guard)
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/095-treemap-chart/095-RESEARCH.md

<interfaces>
<!-- Authoritative patterns from Phase 94 — executor must follow exactly -->

From packages/charts/src/shared/candlestick-option-builder.ts (Pattern to mirror):
```typescript
export type OhlcBar = [number, number, number, number];
export type MAConfig = { period: number; color: string; type?: 'sma' | 'ema'; };
export type CandlestickBarPoint = { label: string; ohlc: OhlcBar; volume?: number; };
export type CandlestickOptionProps = { bullColor?: string; bearColor?: string; showVolume?: boolean; movingAverages?: MAConfig[]; };
export function buildCandlestickOption(bars: CandlestickBarPoint[], props: CandlestickOptionProps): Record<string, unknown>
```

From packages/charts/src/candlestick/candlestick-registry.ts (Registry pattern to mirror):
```typescript
let _candlestickRegistered = false;
export async function registerCandlestickModules(): Promise<void> {
  if (_candlestickRegistered) return;
  _candlestickRegistered = true;
  const { registerCanvasCore } = await import('../registry/canvas-core.js');
  await registerCanvasCore();
  const [{ CandlestickChart, BarChart, LineChart }, { use }] = await Promise.all([
    import('echarts/charts'),
    import('echarts/core'),
  ]);
  use([CandlestickChart, BarChart, LineChart]);
}
```

From packages/charts/src/index.ts (Existing export pattern):
```typescript
export { LuiCandlestickChart } from './candlestick/candlestick-chart.js';
export type { OhlcBar, MAConfig, CandlestickBarPoint, CandlestickOptionProps } from './shared/candlestick-option-builder.js';
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create treemap-option-builder.ts (types + buildTreemapOption)</name>
  <files>packages/charts/src/shared/treemap-option-builder.ts</files>
  <action>
Create `packages/charts/src/shared/treemap-option-builder.ts` with:

**Types (export all three):**

```typescript
export type TreemapNode = {
  name: string;
  value: number;
  children?: TreemapNode[];
};

export type TreemapOptionProps = {
  /** Show ECharts built-in breadcrumb navigation. Default: true */
  breadcrumb?: boolean;
  /** Apply borderRadius to cells. Maps to itemStyle.borderRadius per level. Default: 0 */
  borderRadius?: number;
  /** Per-level color arrays. levels[0] applies to depth-0 nodes. Each inner array is the palette for that level. */
  levelColors?: string[][];
};
```

**buildTreemapOption function:**

```typescript
export function buildTreemapOption(
  data: TreemapNode[],
  props: TreemapOptionProps
): Record<string, unknown>
```

Implementation logic:
1. Apply defaults: `breadcrumb = props.breadcrumb ?? true`, `borderRadius = props.borderRadius ?? 0`, `levelColors = props.levelColors ?? []`
2. Build `levels` array from `levelColors`:
   - For each `(colors, i)` in `levelColors`, produce:
     ```
     {
       color: colors,
       itemStyle: {
         borderRadius: borderRadius > 0 ? Math.max(0, borderRadius - i) : 0,
         gapWidth: i === 0 ? 4 : 2,
         borderWidth: i === 0 ? 3 : 1,
         borderColor: '#fff',
       },
     }
     ```
3. When `levelColors` is empty but `borderRadius > 0`, set `seriesItemStyle = { borderRadius }`. Otherwise `seriesItemStyle = {}`.
4. Return option object:
   ```
   {
     tooltip: { trigger: 'item' },
     series: [{
       type: 'treemap',
       width: '100%',
       height: showBreadcrumb ? '90%' : '100%',
       // IMPORTANT: Do NOT use calc() — ECharts layout engine does not resolve CSS calc().
       // '90%' gives room for the breadcrumb bar (Pitfall 1 from RESEARCH.md).
       nodeClick: 'zoomToNode',  // enables breadcrumb drill-down navigation (TREE-02)
       roam: false,
       animationDurationUpdate: 900,
       breadcrumb: {
         show: showBreadcrumb,
         height: 22,
         left: 'center',
         bottom: 0,
       },
       visibleMin: 10,  // ECharts hides nodes below 10px² area automatically
       levels: levels.length > 0 ? levels : undefined,
       itemStyle: seriesItemStyle,
       data,
     }],
   }
   ```
   Note: No `legend` or `grid` needed for treemap — it is self-contained.

Add JSDoc comment at top noting: TREE-01 data format, TREE-02 breadcrumb/rounded/levelColors prop mapping, Pitfall 1 (no calc()), Pitfall 3 (level-colors must be array of arrays, not flat array).
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components && npx tsc --noEmit -p packages/charts/tsconfig.json 2>&1 | grep -E "treemap-option-builder|error TS" | head -20</automated>
  </verify>
  <done>File exists at packages/charts/src/shared/treemap-option-builder.ts; exports TreemapNode, TreemapOptionProps, buildTreemapOption; TypeScript compiles without errors referencing this file</done>
</task>

<task type="auto">
  <name>Task 2: Create treemap-registry.ts (ECharts module registration)</name>
  <files>packages/charts/src/treemap/treemap-registry.ts</files>
  <action>
Create directory `packages/charts/src/treemap/` and file `treemap-registry.ts` following the exact Phase 94 registry pattern:

```typescript
/**
 * Treemap chart ECharts module registry.
 *
 * Called by LuiTreemapChart._registerModules() during chart initialization.
 * TreemapChart is NOT in canvas-core.ts — it must be registered here.
 *
 * CRITICAL: Breadcrumb navigation is built into TreemapChart itself.
 * There is NO separate BreadcrumbComponent export in 'echarts/components'.
 * Importing a non-existent module causes a runtime error (Pitfall 2 from RESEARCH.md).
 *
 * _treemapRegistered guard prevents double-registration when multiple LuiTreemapChart
 * instances are on the same page.
 */

let _treemapRegistered = false;

export async function registerTreemapModules(): Promise<void> {
  if (_treemapRegistered) return;
  _treemapRegistered = true;

  const { registerCanvasCore } = await import('../registry/canvas-core.js');
  await registerCanvasCore();

  const [{ TreemapChart }, { use }] = await Promise.all([
    import('echarts/charts'),
    import('echarts/core'),
  ]);

  use([TreemapChart]);
}
```

Key constraints:
- Import path uses `.js` extension (per project ESM conventions — check other registry files)
- Only `TreemapChart` in the `use()` call — no BarChart, no LineChart, no BreadcrumbComponent (breadcrumb is built into TreemapChart, Pitfall 2)
- Double-registration guard with module-level boolean is mandatory
- `registerCanvasCore()` must be called first (provides Tooltip, Grid, LabelLayout, etc.)
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components && npx tsc --noEmit -p packages/charts/tsconfig.json 2>&1 | grep -E "treemap-registry|error TS" | head -20</automated>
  </verify>
  <done>File exists at packages/charts/src/treemap/treemap-registry.ts; exports registerTreemapModules; TypeScript compiles without errors referencing this file</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `packages/charts/src/shared/treemap-option-builder.ts` exists and exports `TreemapNode`, `TreemapOptionProps`, `buildTreemapOption`
2. `packages/charts/src/treemap/treemap-registry.ts` exists and exports `registerTreemapModules`
3. `npx tsc --noEmit -p packages/charts/tsconfig.json` exits with 0 errors relating to these new files
4. The `levels` array in `buildTreemapOption` uses `color: string[]` per level entry (array of string arrays from levelColors), NOT a flat string array
5. `height: '90%'` (not `calc(100% - 30px)`) when breadcrumb is shown
6. Only `TreemapChart` in `use([TreemapChart])` — no BreadcrumbComponent import
</verification>

<success_criteria>
- treemap-option-builder.ts: pure function accepting TreemapNode[] + TreemapOptionProps, returning Record&lt;string, unknown&gt; ECharts option with type: 'treemap', breadcrumb config, and levels[] for per-level colors
- treemap-registry.ts: async function with double-registration guard, calls registerCanvasCore() then registers TreemapChart via use()
- Zero TypeScript errors on both files
- All anti-patterns from RESEARCH.md avoided: no BreadcrumbComponent import, no calc() in height, no flat level-colors array
</success_criteria>

<output>
After completion, create `.planning/phases/095-treemap-chart/095-01-SUMMARY.md`
</output>
