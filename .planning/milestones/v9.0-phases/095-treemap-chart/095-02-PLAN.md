---
phase: 095-treemap-chart
plan: 02
type: execute
wave: 2
depends_on:
  - 095-01
files_modified:
  - packages/charts/src/treemap/treemap-chart.ts
  - packages/charts/src/index.ts
autonomous: true
requirements:
  - TREE-01
  - TREE-02

must_haves:
  truths:
    - "LuiTreemapChart renders a treemap from hierarchical { name, value, children[] } data passed via the data property"
    - "breadcrumb prop (default true) toggles ECharts built-in breadcrumb navigation; drill-down resets to root when breadcrumb=false"
    - "rounded prop (default false) applies borderRadius: 6 to treemap cells when true"
    - "level-colors attribute accepts JSON array of arrays ([[colors-depth-0], [colors-depth-1]]) and passes them to buildTreemapOption as levelColors"
    - "LuiTreemapChart and its types are exported from packages/charts/src/index.ts"
    - "customElements.get('lui-treemap-chart') returns the class after import"
  artifacts:
    - path: "packages/charts/src/treemap/treemap-chart.ts"
      provides: "LuiTreemapChart Lit component extending BaseChartElement"
      exports:
        - LuiTreemapChart
    - path: "packages/charts/src/index.ts"
      provides: "Phase 95 public API exports"
      contains: "LuiTreemapChart"
  key_links:
    - from: "packages/charts/src/treemap/treemap-chart.ts"
      to: "packages/charts/src/shared/treemap-option-builder.ts"
      via: "_applyData() calling buildTreemapOption()"
      pattern: "buildTreemapOption"
    - from: "packages/charts/src/treemap/treemap-chart.ts"
      to: "packages/charts/src/treemap/treemap-registry.ts"
      via: "_registerModules() calling registerTreemapModules()"
      pattern: "registerTreemapModules"
    - from: "packages/charts/src/index.ts"
      to: "packages/charts/src/treemap/treemap-chart.ts"
      via: "named export"
      pattern: "LuiTreemapChart"
---

<objective>
Create the LuiTreemapChart Lit component and add Phase 95 public API exports to index.ts.

Purpose: Delivers the user-facing web component (`lui-treemap-chart`) that wires together the option builder and registry from Plan 01, and exposes LuiTreemapChart + types via the @lit-ui/charts package public API.
Output: treemap-chart.ts (LuiTreemapChart component) + index.ts (Phase 95 exports appended)
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/095-treemap-chart/095-RESEARCH.md
@.planning/phases/095-treemap-chart/095-01-SUMMARY.md

<interfaces>
<!-- Types and exports established in Plan 01 that this plan depends on -->

From packages/charts/src/shared/treemap-option-builder.ts (created in 095-01):
```typescript
export type TreemapNode = {
  name: string;
  value: number;
  children?: TreemapNode[];
};

export type TreemapOptionProps = {
  breadcrumb?: boolean;
  borderRadius?: number;
  levelColors?: string[][];
};

export function buildTreemapOption(
  data: TreemapNode[],
  props: TreemapOptionProps
): Record<string, unknown>
```

From packages/charts/src/treemap/treemap-registry.ts (created in 095-01):
```typescript
export async function registerTreemapModules(): Promise<void>
```

From packages/charts/src/candlestick/candlestick-chart.ts (authoritative pattern — follow exactly):
```typescript
export class LuiCandlestickChart extends BaseChartElement {
  @property({ attribute: 'bull-color' }) bullColor: string | null = null;
  @property({ attribute: 'bear-color' }) bearColor: string | null = null;
  @property({ type: Boolean, attribute: 'show-volume' }) showVolume = false;
  @property({ attribute: 'moving-averages' }) movingAverages: string | null = null;

  protected override async _registerModules(): Promise<void> { await registerCandlestickModules(); }

  override updated(changed: PropertyValues): void {
    super.updated(changed);
    if (!this._chart) return;
    const candlestickProps = ['data', 'bullColor', 'bearColor', 'showVolume', 'movingAverages'] as const;
    if (candlestickProps.some((k) => changed.has(k))) { this._applyData(); }
  }

  private _applyData(): void {
    if (!this._chart) return;
    // ... sets option with notMerge: false
    this._chart.setOption(option, { notMerge: false });
  }
}
if (typeof customElements !== 'undefined' && !customElements.get('lui-candlestick-chart')) {
  customElements.define('lui-candlestick-chart', LuiCandlestickChart);
}
declare global {
  interface HTMLElementTagNameMap { 'lui-candlestick-chart': LuiCandlestickChart; }
}
```

From packages/charts/src/index.ts (current state — append Phase 95 block AFTER line 33):
```typescript
// Phase 94: Candlestick Chart
export { LuiCandlestickChart } from './candlestick/candlestick-chart.js';
export type { OhlcBar, MAConfig, CandlestickBarPoint, CandlestickOptionProps } from './shared/candlestick-option-builder.js';
// <-- append Phase 95 block here
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create treemap-chart.ts (LuiTreemapChart component)</name>
  <files>packages/charts/src/treemap/treemap-chart.ts</files>
  <action>
Create `packages/charts/src/treemap/treemap-chart.ts` following the Phase 94 candlestick-chart.ts pattern exactly. The component has NO streaming requirement — do NOT add pushData() override (the base class default is correct per RESEARCH.md Pitfall 4 guidance: base pushData() with circular buffer is acceptable for treemap, but to prevent accidental flat-array overwrite of hierarchical data, add a pushData() override that logs a console.warn and returns without calling super).

Full implementation:

```typescript
/**
 * LuiTreemapChart — Treemap chart component extending BaseChartElement.
 *
 * TREE-01: Renders hierarchical { name, value, children[] } data as a space-filling treemap
 * TREE-02: breadcrumb prop toggles ECharts built-in navigation; rounded prop applies borderRadius;
 *          level-colors prop configures per-depth color palettes
 *
 * No streaming requirement (TREE-01/TREE-02 have no pushData() requirement).
 * pushData() is overridden with a no-op + console.warn to prevent the base class
 * circular-buffer path from overwriting hierarchical tree data with a flat array (Pitfall 4).
 */

import { property } from 'lit/decorators.js';
import type { PropertyValues } from 'lit';
import { BaseChartElement } from '../base/base-chart-element.js';
import { registerTreemapModules } from './treemap-registry.js';
import {
  buildTreemapOption,
  type TreemapNode,
} from '../shared/treemap-option-builder.js';

export class LuiTreemapChart extends BaseChartElement {
  // TREE-02: Breadcrumb navigation — toggles ECharts built-in breadcrumb bar. Default: true.
  @property({ type: Boolean }) breadcrumb = true;

  // TREE-02: Rounded cells — maps to itemStyle.borderRadius: 6 when true, 0 when false.
  @property({ type: Boolean }) rounded = false;

  // TREE-02: Per-level color arrays — arrives as JSON string from HTML attribute.
  // Format: '[["#color1","#color2"],["#color3","#color4"]]' — array of arrays (Pitfall 3).
  // Parsed in _applyData() via _parseLevelColors().
  @property({ attribute: 'level-colors' }) levelColors: string | null = null;

  protected override async _registerModules(): Promise<void> {
    await registerTreemapModules();
  }

  override updated(changed: PropertyValues): void {
    super.updated(changed); // base handles this.option passthrough and this.loading state
    if (!this._chart) return;
    const treemapProps = ['data', 'breadcrumb', 'rounded', 'levelColors'] as const;
    if (treemapProps.some((k) => changed.has(k))) {
      this._applyData();
    }
  }

  private _applyData(): void {
    if (!this._chart) return;
    const data = this.data ? (this.data as TreemapNode[]) : [];
    const levelColors = this._parseLevelColors(this.levelColors);
    const option = buildTreemapOption(data, {
      breadcrumb: this.breadcrumb,
      borderRadius: this.rounded ? 6 : 0,
      levelColors,
    });
    // notMerge: false — preserves current drill-down state when props change (Pitfall 5).
    // notMerge: true would reset to root view on every prop update.
    this._chart.setOption(option, { notMerge: false });
  }

  /**
   * Parse 'level-colors' JSON attribute into string[][].
   * Validates that parsed value is array of arrays.
   * Returns [] on null input, empty string, or malformed JSON.
   * Pitfall 3: validates inner elements are arrays (not a flat string array).
   */
  private _parseLevelColors(raw: string | null): string[][] {
    if (!raw) return [];
    try {
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed)) return [];
      // Validate array of arrays — reject flat string array (Pitfall 3)
      return parsed.filter((entry: unknown) => Array.isArray(entry));
    } catch {
      return [];
    }
  }

  /**
   * Treemap has no streaming requirement.
   * Override pushData() with console.warn to prevent base class circular-buffer path
   * from overwriting hierarchical tree data with a flat array (Pitfall 4 from RESEARCH.md).
   */
  override pushData(_point: unknown): void {
    console.warn('[LuiTreemapChart] pushData() is not supported on treemap charts. Update the data property to change treemap data.');
  }
}

// Custom element registration — same guard pattern as all other chart components.
if (typeof customElements !== 'undefined' && !customElements.get('lui-treemap-chart')) {
  customElements.define('lui-treemap-chart', LuiTreemapChart);
}

declare global {
  interface HTMLElementTagNameMap {
    'lui-treemap-chart': LuiTreemapChart;
  }
}
```

Key constraints:
- Import paths use `.js` extension (ESM project convention)
- `notMerge: false` in `_applyData()` (NOT `notMerge: true` — Pitfall 5)
- No `disconnectedCallback()` override needed — no component-owned RAF handle (unlike candlestick which has `_barRafId`)
- `_parseLevelColors` validates inner entries with `Array.isArray(entry)` to reject flat string arrays
- `pushData()` override uses `console.warn` — does NOT call `super.pushData()`
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components && npx tsc --noEmit -p packages/charts/tsconfig.json 2>&1 | grep -E "treemap-chart|error TS" | head -20</automated>
  </verify>
  <done>File exists at packages/charts/src/treemap/treemap-chart.ts; LuiTreemapChart class exported; TypeScript compiles without errors referencing this file; lui-treemap-chart custom element registered</done>
</task>

<task type="auto">
  <name>Task 2: Add Phase 95 exports to index.ts</name>
  <files>packages/charts/src/index.ts</files>
  <action>
Append the Phase 95 export block to `packages/charts/src/index.ts` after the Phase 94 candlestick exports (after line 33, the last existing export line).

Add exactly:
```typescript

// Phase 95: Treemap Chart
export { LuiTreemapChart } from './treemap/treemap-chart.js';
export type { TreemapNode, TreemapOptionProps } from './shared/treemap-option-builder.js';
```

This follows the exact pattern of all preceding phase exports in index.ts:
- Named class export from component file
- Type-only exports from option builder file
- Comment header with phase number and chart name

Do NOT export `LevelColorConfig` — it was decided in RESEARCH.md (Open Question 3) to use `string[][]` directly, keeping the public API minimal. `TreemapOptionProps` already exposes `levelColors: string[][]`.

After editing, run `npx tsc --noEmit -p packages/charts/tsconfig.json` to confirm zero errors.
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components && npx tsc --noEmit -p packages/charts/tsconfig.json 2>&1 | tail -5 && grep -n "LuiTreemapChart\|TreemapNode\|TreemapOptionProps" packages/charts/src/index.ts</automated>
  </verify>
  <done>index.ts contains Phase 95 export block; LuiTreemapChart, TreemapNode, and TreemapOptionProps are all exported; npx tsc --noEmit exits with 0 errors</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `packages/charts/src/treemap/treemap-chart.ts` exists and exports `LuiTreemapChart`
2. `packages/charts/src/index.ts` exports `LuiTreemapChart`, `TreemapNode`, `TreemapOptionProps`
3. `npx tsc --noEmit -p packages/charts/tsconfig.json` exits with zero errors
4. `lui-treemap-chart` custom element is registered via the `customElements.define` guard
5. `_parseLevelColors` validates array-of-arrays structure (Pitfall 3 defense)
6. `pushData()` override emits console.warn and does NOT call super (Pitfall 4 defense)
7. `_applyData()` uses `notMerge: false` (Pitfall 5 defense)
</verification>

<success_criteria>
- LuiTreemapChart component wires together treemap-option-builder + treemap-registry from Plan 01
- All TREE-01 and TREE-02 requirements delivered: hierarchical data rendering, breadcrumb navigation, rounded cells, per-level colors
- @lit-ui/charts public API exports LuiTreemapChart, TreemapNode, TreemapOptionProps
- Full TypeScript compilation clean with zero errors
- Phase 95 complete: all 2 plans executed, all 2 requirements (TREE-01, TREE-02) delivered
</success_criteria>

<output>
After completion, create `.planning/phases/095-treemap-chart/095-02-SUMMARY.md`
</output>
