---
phase: 94-candlestick-chart
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/charts/src/shared/candlestick-option-builder.ts
  - packages/charts/src/candlestick/candlestick-registry.ts
autonomous: true
requirements: [CNDL-01, CNDL-02, CNDL-03]

must_haves:
  truths:
    - "buildCandlestickOption() produces a single-grid ECharts option with candlestick series and correct bull/bear itemStyle when showVolume is false"
    - "buildCandlestickOption() produces a two-grid option with synchronized DataZoom when showVolume is true"
    - "buildCandlestickOption() appends MA line series (type: 'line', xAxisIndex: 0, yAxisIndex: 0) for each MAConfig entry"
    - "registerCandlestickModules() registers CandlestickChart, BarChart, and LineChart via use()"
  artifacts:
    - path: "packages/charts/src/shared/candlestick-option-builder.ts"
      provides: "OhlcBar, MAConfig, CandlestickBarPoint, CandlestickOptionProps types + buildCandlestickOption() + _computeSMA() + _computeEMA()"
      exports: [OhlcBar, MAConfig, CandlestickBarPoint, CandlestickOptionProps, buildCandlestickOption]
    - path: "packages/charts/src/candlestick/candlestick-registry.ts"
      provides: "registerCandlestickModules() with CandlestickChart + BarChart + LineChart"
      exports: [registerCandlestickModules]
  key_links:
    - from: "packages/charts/src/candlestick/candlestick-registry.ts"
      to: "echarts/charts"
      via: "import { CandlestickChart, BarChart, LineChart } from 'echarts/charts'"
      pattern: "CandlestickChart.*BarChart.*LineChart"
    - from: "packages/charts/src/shared/candlestick-option-builder.ts"
      to: "itemStyle"
      via: "color (bull fill) and color0 (bear fill) — NOT upColor/downColor"
      pattern: "color0.*bearColor|bearColor.*color0"
    - from: "packages/charts/src/shared/candlestick-option-builder.ts"
      to: "dataZoom"
      via: "xAxisIndex: [0, 1] when showVolume is true"
      pattern: "xAxisIndex.*\\[0.*1\\]"
---

<objective>
Create the candlestick chart option builder and ECharts module registry — the pure-function and registration foundations that LuiCandlestickChart (Plan 02) will depend on.

Purpose: Establishes all types, the buildCandlestickOption() pure function (single-grid or dual-grid depending on showVolume), SMA/EMA computation helpers, and the candlestick-registry.ts that registers CandlestickChart + BarChart + LineChart with ECharts.

Output: candlestick-option-builder.ts (types + builder + MA helpers) and candlestick-registry.ts (ECharts module registration).
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/94-candlestick-chart/94-RESEARCH.md
@.planning/phases/93-heatmap-chart/93-01-SUMMARY.md

<interfaces>
<!-- Key patterns the executor needs. Extracted from codebase. -->
<!-- Do not deviate from these contracts — Plan 02 depends on them. -->

From packages/charts/src/heatmap/heatmap-registry.ts (mirror pattern):
```typescript
let _heatmapRegistered = false;

export async function registerHeatmapModules(): Promise<void> {
  if (_heatmapRegistered) return;
  _heatmapRegistered = true;
  const { registerCanvasCore } = await import('../registry/canvas-core.js');
  await registerCanvasCore();
  const [{ HeatmapChart, VisualMapContinuousComponent }, { use }] = await Promise.all([
    import('echarts/charts'),   // NOTE: VisualMapContinuousComponent is in 'echarts/components'
    import('echarts/core'),
  ]);
  use([HeatmapChart, VisualMapContinuousComponent]);
}
```

Phase 94 registry variant — registers three chart modules from 'echarts/charts':
```typescript
// CandlestickChart, BarChart, LineChart are ALL in 'echarts/charts' (not components)
// Confirmed: echarts/types/dist/charts.d.ts — install$14 as CandlestickChart, install$1 as BarChart, install as LineChart
let _candlestickRegistered = false;

export async function registerCandlestickModules(): Promise<void> {
  if (_candlestickRegistered) return;
  _candlestickRegistered = true;
  const { registerCanvasCore } = await import('../registry/canvas-core.js');
  await registerCanvasCore();
  const [{ CandlestickChart, BarChart, LineChart }, { use }] = await Promise.all([
    import('echarts/charts'),
    import('echarts/core'),
  ]);
  use([CandlestickChart, BarChart, LineChart]);
}
```

From packages/charts/src/shared/heatmap-option-builder.ts (type pattern to mirror):
```typescript
export type HeatmapCell = [number, number, number];
export type HeatmapOptionProps = { xCategories: string[]; yCategories: string[]; ... };
export function buildHeatmapOption(data: HeatmapCell[], props: HeatmapOptionProps): Record<string, unknown>;
```

Phase 94 type contracts (from RESEARCH.md — Plan 02 will import these exactly):
```typescript
// OhlcBar — ECharts candlestick data order is [open, close, low, high] NOT [open, high, low, close]
export type OhlcBar = [number, number, number, number]; // [open, close, low, high]

export type MAConfig = {
  period: number;
  color: string;
  type?: 'sma' | 'ema'; // default 'sma'
};

export type CandlestickBarPoint = {
  label: string;       // x-axis category label (timestamp string)
  ohlc: OhlcBar;       // [open, close, low, high]
  volume?: number;     // optional volume value
};

export type CandlestickOptionProps = {
  bullColor?: string;      // default '#26a69a' (ECharts: itemStyle.color)
  bearColor?: string;      // default '#ef5350' (ECharts: itemStyle.color0)
  showVolume?: boolean;    // default false
  movingAverages?: MAConfig[];  // default []
};

export function buildCandlestickOption(
  bars: CandlestickBarPoint[],
  props: CandlestickOptionProps
): Record<string, unknown>;
```

ECharts bull/bear naming (verified from echarts/types/dist/shared.d.ts lines 10428-10460):
- itemStyle.color  = bull (rising, close >= open) candle fill AND wick
- itemStyle.color0 = bear (falling, close < open) candle fill AND wick
- itemStyle.borderColor  = bull wick/border color
- itemStyle.borderColor0 = bear wick/border color
- NEVER use upColor / downColor — these do not exist in ECharts CandlestickItemStyleOption

Multi-grid layout for volume panel (verified from echarts/types/dist/shared.d.ts lines 3018-3035):
```typescript
// Single-grid (showVolume: false):
{
  grid: [{ containLabel: true }],
  xAxis: [{ type: 'category', data: labels, gridIndex: 0, boundaryGap: false }],
  yAxis: [{ scale: true, gridIndex: 0 }],
  dataZoom: [
    { type: 'inside', xAxisIndex: [0] },
    { type: 'slider', xAxisIndex: [0], bottom: 2 },
  ],
  series: [candlestickSeries, ...maSeries],
}

// Two-grid (showVolume: true):
{
  grid: [
    { top: '5%',  height: '60%', containLabel: true },   // grid[0]: candlestick
    { top: '73%', height: '22%', containLabel: true },   // grid[1]: volume
  ],
  xAxis: [
    { type: 'category', data: labels, gridIndex: 0, boundaryGap: false, axisLine: { onZero: false } },
    { type: 'category', data: labels, gridIndex: 1, boundaryGap: false, axisLine: { onZero: false } },
  ],
  yAxis: [
    { scale: true, gridIndex: 0 },
    { scale: true, gridIndex: 1 },
  ],
  dataZoom: [
    { type: 'inside', xAxisIndex: [0, 1] },   // MUST bind both x axes — Pitfall 3
    { type: 'slider', xAxisIndex: [0, 1], bottom: 2 },
  ],
  series: [candlestickSeries, volumeBarSeries, ...maSeries],
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create candlestick-option-builder.ts</name>
  <files>packages/charts/src/shared/candlestick-option-builder.ts</files>
  <action>
Create `packages/charts/src/shared/candlestick-option-builder.ts` as a pure-function module with the following exports:

**Types (all exported):**
- `OhlcBar = [number, number, number, number]` — document explicitly: order is `[open, close, low, high]`, NOT the OHLC acronym order `[open, high, low, close]`. Add a JSDoc comment warning about this.
- `MAConfig = { period: number; color: string; type?: 'sma' | 'ema' }` — type defaults to 'sma'
- `CandlestickBarPoint = { label: string; ohlc: OhlcBar; volume?: number }`
- `CandlestickOptionProps = { bullColor?: string; bearColor?: string; showVolume?: boolean; movingAverages?: MAConfig[] }`

**Module-level private helpers (NOT exported):**
- `_computeSMA(closes: number[], period: number): (number | null)[]` — returns null for warm-up period (indices 0..period-2), then sliding window average. Use `closes.map((_, i) => { if (i < period - 1) return null; ... })`.
- `_computeEMA(closes: number[], period: number): (number | null)[]` — returns null for warm-up, then EMA using `k = 2 / (period + 1)`. Seed with SMA of first `period` closes, then recursively `ema[i] = close[i] * k + ema[i-1] * (1 - k)`.

**Exported function:**
`buildCandlestickOption(bars: CandlestickBarPoint[], props: CandlestickOptionProps): Record<string, unknown>`

Implementation:
1. Apply defaults: `bullColor = props.bullColor ?? '#26a69a'`, `bearColor = props.bearColor ?? '#ef5350'`, `showVolume = props.showVolume ?? false`, `movingAverages = props.movingAverages ?? []`
2. Derive: `labels = bars.map(b => b.label)`, `ohlcData = bars.map(b => b.ohlc)` (type: `OhlcBar[]`)
3. Build `candlestickSeries` with `type: 'candlestick'`, `xAxisIndex: 0`, `yAxisIndex: 0`, `data: ohlcData`, `itemStyle: { color: bullColor, color0: bearColor, borderColor: bullColor, borderColor0: bearColor }`
4. Build `maSeries` array: for each `MAConfig` in `movingAverages`, extract `closes = bars.map(b => b.ohlc[1])` (index 1 = close), compute using `_computeSMA` or `_computeEMA` based on `ma.type ?? 'sma'`, produce `{ name: 'MA${ma.period}', type: 'line', xAxisIndex: 0, yAxisIndex: 0, data: computed, smooth: true, lineStyle: { color: ma.color, width: 1.5, opacity: 0.85 }, symbol: 'none', tooltip: { show: true } }`
5. Branch on `showVolume`:
   - **false (single-grid):** `grid: [{ containLabel: true }]`, `xAxis: [{ type: 'category', data: labels, gridIndex: 0, boundaryGap: false }]`, `yAxis: [{ scale: true, gridIndex: 0 }]`, `dataZoom: [{ type: 'inside', xAxisIndex: [0] }, { type: 'slider', xAxisIndex: [0], bottom: 2 }]`, `series: [candlestickSeries, ...maSeries]`
   - **true (two-grid):** Use the verified two-grid structure from RESEARCH.md. Volume bar series: `{ type: 'bar', xAxisIndex: 1, yAxisIndex: 1, data: bars.map(b => b.volume ?? 0), barWidth: '60%', itemStyle: { color: 'rgba(150,150,150,0.5)' } }`. DataZoom MUST use `xAxisIndex: [0, 1]` to synchronize both panels (Pitfall 3 from RESEARCH.md). Series: `[candlestickSeries, volumeBarSeries, ...maSeries]`
6. Add `tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } }` and `legend: { data: ['Candlestick', ...movingAverages.map(m => 'MA' + m.period)] }` to both branches.

Run `npx tsc --noEmit -p packages/charts/tsconfig.json` after creation — zero errors required.
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components && npx tsc --noEmit -p packages/charts/tsconfig.json 2>&1 | head -30</automated>
  </verify>
  <done>packages/charts/src/shared/candlestick-option-builder.ts exists; exports OhlcBar, MAConfig, CandlestickBarPoint, CandlestickOptionProps, buildCandlestickOption; TypeScript compiles with zero errors</done>
</task>

<task type="auto">
  <name>Task 2: Create candlestick-registry.ts</name>
  <files>packages/charts/src/candlestick/candlestick-registry.ts</files>
  <action>
Create directory `packages/charts/src/candlestick/` and file `candlestick-registry.ts`.

Mirror the heatmap-registry.ts pattern exactly. The registry must:
1. Guard with `let _candlestickRegistered = false` at module level
2. Export `async function registerCandlestickModules(): Promise<void>`
3. If `_candlestickRegistered`, return early
4. Set `_candlestickRegistered = true`
5. Import and await `registerCanvasCore()` from `'../registry/canvas-core.js'` (registers Grid, Tooltip, Legend, DataZoom, CanvasRenderer — DataZoomComponent already included, no extra registration needed for zoom sync)
6. Use `Promise.all` to import `{ CandlestickChart, BarChart, LineChart }` from `'echarts/charts'` AND `{ use }` from `'echarts/core'` simultaneously
7. Call `use([CandlestickChart, BarChart, LineChart])`

CRITICAL: Register ALL THREE — CandlestickChart alone is insufficient:
- `BarChart` required for volume panel `type: 'bar'` series (Pitfall 1 from RESEARCH.md: silently renders nothing without it)
- `LineChart` required for MA overlay `type: 'line'` series (same pitfall — silent failure)

Do NOT register anything from 'echarts/components' for DataZoom — it is already in canvas-core.

Run `npx tsc --noEmit -p packages/charts/tsconfig.json` after creation — zero errors required.
  </action>
  <verify>
    <automated>cd /Users/sn0w/Documents/dev/lit-components && npx tsc --noEmit -p packages/charts/tsconfig.json 2>&1 | head -30</automated>
  </verify>
  <done>packages/charts/src/candlestick/candlestick-registry.ts exists; exports registerCandlestickModules; registers CandlestickChart + BarChart + LineChart; TypeScript compiles with zero errors</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npx tsc --noEmit -p packages/charts/tsconfig.json` — zero errors
2. `grep -n "OhlcBar\|MAConfig\|CandlestickBarPoint\|CandlestickOptionProps\|buildCandlestickOption" packages/charts/src/shared/candlestick-option-builder.ts` — all five names present
3. `grep -n "color0\|bearColor" packages/charts/src/shared/candlestick-option-builder.ts` — confirms bull/bear use ECharts-native `color0` naming
4. `grep -n "xAxisIndex.*\[0.*1\]\|xAxisIndex.*\[0, 1\]" packages/charts/src/shared/candlestick-option-builder.ts` — confirms DataZoom bound to both axes in showVolume branch
5. `grep -n "CandlestickChart.*BarChart.*LineChart\|BarChart.*LineChart" packages/charts/src/candlestick/candlestick-registry.ts` — confirms all three registered
</verification>

<success_criteria>
- candlestick-option-builder.ts exports all 4 types + buildCandlestickOption function
- buildCandlestickOption produces single-grid option when showVolume=false, two-grid option when showVolume=true
- Two-grid option has dataZoom binding xAxisIndex: [0, 1] for synchronized pan/zoom
- Volume series uses xAxisIndex: 1, yAxisIndex: 1 (bound to second grid)
- Bull/bear use ECharts-native itemStyle.color / itemStyle.color0 (not upColor/downColor)
- MA lines use type: 'line', xAxisIndex: 0, yAxisIndex: 0 (bound to main price panel)
- EMA computation is implemented alongside SMA
- candlestick-registry.ts registers CandlestickChart + BarChart + LineChart
- TypeScript: zero errors across both files
</success_criteria>

<output>
After completion, create `.planning/phases/94-candlestick-chart/94-01-SUMMARY.md`
</output>
