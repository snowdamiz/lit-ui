---
phase: 83-popover
plan: "03"
type: execute
wave: 3
depends_on:
  - "83-01"
  - "83-02"
files_modified:
  - skill/skills/popover/SKILL.md
autonomous: true
requirements:
  - POP-03

must_haves:
  truths:
    - "SKILL.md CSS Custom Properties table shows correct double-fallback var() defaults for color tokens"
    - "SKILL.md has a Behavior Notes section with at least 10 entries covering popover-specific behaviors"
    - "An agent reading SKILL.md can implement lui-popover correctly without consulting PopoverPage.tsx or source"
  artifacts:
    - path: "skill/skills/popover/SKILL.md"
      provides: "Accurate popover skill file with correct CSS token defaults and Behavior Notes"
      contains: "var(--color-card, var(--ui-color-card))"
  key_links:
    - from: "skill/skills/popover/SKILL.md (CSS Custom Properties table)"
      to: "packages/core/src/styles/tailwind.css :root popover block"
      via: "token defaults must match exactly"
      pattern: "SKILL.md default column = tailwind.css :root values"
---

<objective>
Update `skill/skills/popover/SKILL.md` to fix the CSS token defaults (currently showing `—` dashes instead of actual values) and add a Behavior Notes section describing popover-specific behaviors that an agent needs to know.

Purpose: Agents using the skill file to implement popover need accurate defaults for theme overrides and behavioral knowledge for correct usage. Missing defaults and no Behavior Notes makes the skill file incomplete.
Output: `SKILL.md` with 9 accurate CSS token defaults (double-fallback form for color tokens, exact values for structural tokens) and a Behavior Notes section with ~12 entries.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

<interfaces>
<!-- Key context the executor needs. -->

Actual :root token values from packages/core/src/styles/tailwind.css (ground truth for Default column):
```
--ui-popover-bg:         var(--color-card, var(--ui-color-card))
--ui-popover-text:       var(--color-card-foreground, var(--ui-color-card-foreground))
--ui-popover-border:     var(--color-border, var(--ui-color-border))
--ui-popover-radius:     0.5rem
--ui-popover-padding:    1rem
--ui-popover-shadow:     0 10px 15px -3px rgb(0 0 0 / 0.08), 0 4px 6px -4px rgb(0 0 0 / 0.08)
--ui-popover-arrow-size: 8px
--ui-popover-max-width:  20rem
--ui-popover-z-index:    45
```

Current SKILL.md CSS Custom Properties table (stale — all color tokens show `—`):
| --ui-popover-bg    | —       | Background color of the popover. |
| --ui-popover-text  | —       | Text color of the popover.       |
| --ui-popover-border| —       | Border color of the popover.     |
| --ui-popover-radius| 0.5rem  | Border radius of the popover.    |
| --ui-popover-padding| 1rem   | Inner padding of the popover.    |
| --ui-popover-shadow| —       | Box shadow of the popover.       |
| --ui-popover-arrow-size| 8px | Size of the arrow indicator.     |
| --ui-popover-max-width| 20rem| Maximum width of the popover.    |
| --ui-popover-z-index| 50     | Z-index of the popover panel.    |

Note: --ui-popover-z-index is currently documented as 50 but tailwind.css :root has 45 — correct it to 45.

Key behavioral facts from packages/popover/src/popover.ts:
- Trigger: click to toggle (handleTriggerClick), Enter/Space keyboard (handleTriggerKeydown)
- Closing: Escape via native Popover API toggle event OR document keydown fallback
- Light dismiss: native Popover API auto mode (popover="auto") — clicks outside close automatically
- Positioning: Floating UI with flip, shift (8px), offset (default 8px), optional arrow middleware
- Focus management: moveFocusToContent() on open, restoreFocusToTrigger() on close
- Modal mode: sentinel elements trap focus (handleSentinelStartFocus/handleSentinelEndFocus)
- Controlled mode: setting `open` prop enables controlled mode; fires open-changed event instead of toggling internally
- Nested popovers: dispatches 'popover-close-children' event (POP-09); nested popovers listen and close
- Auto-update: autoUpdatePosition() runs while open; cleans up on close
- Popover API fallback: position:fixed positioning when native Popover API not supported
- SSR safe: isServer guard prevents panel render on server; panel only exists while open=true
- Cleanup: AbortController.abort() in disconnectedCallback prevents listener leaks

Established Behavior Notes pattern: See skill/skills/tooltip/SKILL.md Behavior Notes section (12 entries).
Each entry is a single bullet with: trigger → behavior → edge case/exception.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix CSS token defaults and add Behavior Notes to SKILL.md</name>
  <files>skill/skills/popover/SKILL.md</files>
  <action>
    In `skill/skills/popover/SKILL.md`, make two changes:

    **1. Update the CSS Custom Properties table** — replace all stale defaults with exact tailwind.css :root values:

    Replace the entire CSS Custom Properties table with:

    | Property | Default | Description |
    |----------|---------|-------------|
    | `--ui-popover-bg` | `var(--color-card, var(--ui-color-card))` | Background color of the popover. |
    | `--ui-popover-text` | `var(--color-card-foreground, var(--ui-color-card-foreground))` | Text color of the popover. |
    | `--ui-popover-border` | `var(--color-border, var(--ui-color-border))` | Border color of the popover. |
    | `--ui-popover-radius` | `0.5rem` | Border radius of the popover. |
    | `--ui-popover-padding` | `1rem` | Inner padding of the popover content. |
    | `--ui-popover-shadow` | `0 10px 15px -3px rgb(0 0 0 / 0.08), 0 4px 6px -4px rgb(0 0 0 / 0.08)` | Box shadow of the popover. |
    | `--ui-popover-arrow-size` | `8px` | Size of the arrow indicator. |
    | `--ui-popover-max-width` | `20rem` | Maximum width of the popover. |
    | `--ui-popover-z-index` | `45` | Z-index of the popover panel. |

    Key corrections:
    - bg, text, border: add double-fallback var() form (was `—`)
    - shadow: add two-layer value with 0.08 opacity (was `—`)
    - z-index: correct from 50 to 45 (tailwind.css :root value is 45)

    **2. Add Behavior Notes section** at the end of the file (after CSS Parts table):

    ```markdown
    ## Behavior Notes

    - Trigger model: click or Enter/Space keydown on the default slot element toggles the popover. The trigger wrapper has `aria-haspopup="dialog"` and `aria-expanded` reflecting the open state. `aria-controls` links trigger to panel by ID.
    - Light dismiss: uses native Popover API `popover="auto"` mode — clicking outside the popover closes it automatically. Falls back to a document click listener when the Popover API is not supported.
    - Escape key: dismissed via the native Popover API `toggle` event (newState === 'closed') when supported. Falls back to a document `keydown` listener in older browsers.
    - Floating UI positioning: `computePosition` with `flip`, `shift` (8px edge padding), and `offset` (default 8px) middleware. Strategy is `fixed`. `autoUpdatePosition` repositions on scroll and resize while open.
    - Arrow element: a `--ui-popover-arrow-size` square (default 8px) rotated 45° using `background: var(--ui-popover-bg)` and `border: 1px solid var(--ui-popover-border)`. Enabled with the `arrow` boolean prop. Arrow position tracks placement flips via Floating UI arrow middleware.
    - Focus management: on open, `moveFocusToContent()` moves focus to the first focusable element in the `content` slot (or the panel itself if none). On close, focus returns to the trigger element via `restoreFocusToTrigger()`.
    - Modal mode (`modal` attribute): sentinel `<div tabindex="0">` elements at start and end of the panel implement a focus trap. Focus wraps from last to first (and vice versa) without leaving the popover. Non-modal mode instead closes the popover on `focusout` if focus moves outside the host.
    - Controlled mode: setting the `open` prop programmatically enables controlled mode. In controlled mode, user interactions fire `open-changed` custom event (`detail: { open: boolean }`) instead of toggling internally. The consumer must update the `open` prop in response.
    - Nested popovers: when a parent popover closes, it dispatches `popover-close-children` on itself (bubbles, composed). Child `<lui-popover>` elements listen for this event and close themselves. This ensures nested menus collapse properly.
    - Match trigger width (`match-trigger-width` attribute): Floating UI `size` middleware sets the popover's inline width to match the trigger's bounding rect width. Useful for dropdown-style patterns where the menu should align to the input or button width.
    - Dark mode: all 9 `--ui-popover-*` tokens cascade automatically via the semantic `.dark` system. `--ui-popover-bg` resolves to `--color-card` (dark: gray-900), `--ui-popover-text` resolves to `--color-card-foreground` (dark: gray-50), `--ui-popover-border` resolves to `--color-border` (dark: gray-800). No explicit `.dark` overrides are needed.
    - SSR safety: `isServer` guard prevents the popover panel from rendering on the server. Panel DOM is only created while `open=true`; it is removed from the DOM when closed. The Popover API `showPopover()` call is also guarded by `isServer`.
    - Cleanup: `AbortController.abort()` in `disconnectedCallback` cleans up all event listeners. `autoUpdatePosition` cleanup runs on close and on disconnect. No listener or rAF leaks.
    ```

    Do NOT change the frontmatter, Usage examples, Props table, Slots table, Events table, or CSS Parts table.
  </action>
  <verify>
    <automated>grep -n "var(--color-card, var(--ui-color-card))\|0 10px 15px -3px rgb(0 0 0 / 0.08)\|Behavior Notes" /Users/sn0w/Documents/dev/lit-components/skill/skills/popover/SKILL.md</automated>
    Expect: 3 matches — the corrected bg default, the corrected shadow, and the Behavior Notes heading.
    Also: grep "z-index.*45" skill/skills/popover/SKILL.md should return a match.
    Also: grep "\-\-\s*$" skill/skills/popover/SKILL.md (dash-only defaults) should return zero matches.
  </verify>
  <done>
    - CSS token table has 9 entries with exact tailwind.css :root defaults
    - Color tokens (bg, text, border) use double-fallback var() form
    - Shadow uses two-layer value with 0.08 opacity
    - z-index corrected to 45
    - Behavior Notes section appended with ~12 bullet entries
    - No `—` dashes remain in the Default column
  </done>
</task>

</tasks>

<verification>
grep -c "Behavior Notes" /Users/sn0w/Documents/dev/lit-components/skill/skills/popover/SKILL.md
Expected: 1

grep "ui-popover-z-index" /Users/sn0w/Documents/dev/lit-components/skill/skills/popover/SKILL.md
Expected: contains "45" (not "50")

grep "ui-popover-bg" /Users/sn0w/Documents/dev/lit-components/skill/skills/popover/SKILL.md
Expected: contains "var(--color-card, var(--ui-color-card))" — not a bare dash
</verification>

<success_criteria>
- All 9 CSS token defaults in SKILL.md match tailwind.css :root exactly
- Color tokens show double-fallback var() form (bg, text, border)
- Shadow shows two-layer value with 0.08 opacity
- z-index is 45 (corrected from stale 50)
- Behavior Notes section exists with 12 entries covering: trigger model, light dismiss, Escape, Floating UI, arrow, focus management, modal mode, controlled mode, nested popovers, match trigger width, dark mode cascade, SSR safety, cleanup
</success_criteria>

<output>
After completion, create `.planning/phases/83-popover/83-03-SUMMARY.md`
</output>
